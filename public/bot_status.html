<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WhatsApp Bot Status Panel</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #000000; /* Pure black background */
            color: #ffffff; /* Pure white text */
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            padding: 1rem;
            box-sizing: border-box;
        }
        .container {
            background-color: #1a1a1a; /* Very dark gray */
            padding: 2rem;
            border-radius: 0.75rem;
            box-shadow: 0 10px 15px rgba(0, 0, 0, 0.5);
            text-align: center;
            max-width: 500px;
            width: 100%;
        }
        .status-indicator {
            width: 1.5rem;
            height: 1.5rem;
            border-radius: 50%;
            display: inline-block;
            vertical-align: middle;
            margin-right: 0.75rem;
        }
        .status-text {
            font-size: 1.25rem;
            font-weight: 600;
            display: inline-block;
            vertical-align: middle;
        }
        .qr-code-img {
            width: 12rem;
            height: 12rem;
            margin: 1.5rem auto;
            border: 1px solid #444444;
            border-radius: 0.5rem;
            padding: 0.5rem;
            background-color: #ffffff; /* White background for QR */
        }
        button {
            background-color: #666666; /* Medium gray */
            color: #ffffff;
            font-weight: 600;
            padding: 0.75rem 1.5rem;
            border-radius: 0.5rem;
            transition: all 0.2s ease-in-out;
            cursor: pointer;
        }
        button:hover {
            background-color: #888888; /* Lighter gray on hover */
        }
        button:disabled {
            background-color: #333333;
            color: #888888;
            cursor: not-allowed;
        }
        .loading-spinner {
            border: 4px solid rgba(255, 255, 255, 0.3);
            border-top: 4px solid #ffffff;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
            display: inline-block;
            vertical-align: middle;
            margin-right: 0.5rem;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1 class="text-3xl font-bold mb-6">WhatsApp Bot Status</h1>

        <div class="flex items-center justify-center mb-6">
            <div id="bot-status-indicator" class="status-indicator bg-gray-500 animate-pulse"></div>
            <p id="bot-status-text" class="status-text">Loading status...</p>
        </div>

        <div id="qr-display-area" class="mt-4">
            <p id="qr-status-message" class="text-gray-300 mb-4">Initializing bot, please wait for QR code...</p>
            <img id="qr-code-img" src="" alt="QR Code" class="qr-code-img hidden">
            <p id="qr-expiry-message" class="text-red-400 mt-2 text-sm hidden">QR code expired. Please generate a new one.</p>
        </div>

        <div class="mt-6">
            <button id="generate-qr-btn">
                <span id="button-loading-spinner" class="loading-spinner hidden"></span>
                <span id="button-text">Generate New QR</span>
            </button>
        </div>
        <p class="text-gray-400 text-sm mt-4">This panel is public. Do not share your QR code with unauthorized persons.</p>
    </div>

    <script src="https://cdn.socket.io/4.0.0/socket.io.min.js"></script>
    <script>
        const socket = io(); // Connect to Socket.IO

        const botStatusIndicator = document.getElementById('bot-status-indicator');
        const botStatusText = document.getElementById('bot-status-text');
        const qrStatusMessage = document.getElementById('qr-status-message');
        const qrCodeImg = document.getElementById('qr-code-img');
        const qrExpiryMessage = document.getElementById('qr-expiry-message');
        const generateQrBtn = document.getElementById('generate-qr-btn');
        const buttonLoadingSpinner = document.getElementById('button-loading-spinner');
        const buttonText = document.getElementById('button-text');

        // Function to update the UI based on bot status and QR data
        function updateBotStatusDisplay(status, qrDataURL = null) {
            // Update main bot status section
            switch (status) {
                case 'initializing':
                    botStatusIndicator.className = 'status-indicator bg-gray-500 animate-pulse';
                    botStatusText.textContent = 'Initializing WhatsApp client...';
                    break;
                case 'qr_received':
                    botStatusIndicator.className = 'status-indicator bg-yellow-500 animate-pulse';
                    botStatusText.textContent = 'Scan QR Code to connect!';
                    break;
                case 'qr_error':
                    botStatusIndicator.className = 'status-indicator bg-red-500';
                    botStatusText.textContent = 'QR Code error. Check server logs.';
                    break;
                case 'qr_expired':
                    botStatusIndicator.className = 'status-indicator bg-red-500';
                    botStatusText.textContent = 'QR Code expired.';
                    break;
                case 'authenticated':
                    botStatusIndicator.className = 'status-indicator bg-blue-500';
                    botStatusText.textContent = 'Authenticated. Waiting for ready...';
                    break;
                case 'ready':
                    botStatusIndicator.className = 'status-indicator bg-green-500';
                    botStatusText.textContent = 'WhatsApp Bot is Ready and Online!';
                    break;
                case 'auth_failure':
                    botStatusIndicator.className = 'status-indicator bg-red-500';
                    botStatusText.textContent = 'Authentication Failed! Generating new QR...';
                    break;
                case 'disconnected':
                    botStatusIndicator.className = 'status-indicator bg-orange-500 animate-pulse';
                    botStatusText.textContent = 'Disconnected. Reconnecting...';
                    break;
                case 'reconnecting':
                    botStatusIndicator.className = 'status-indicator bg-yellow-500 animate-pulse';
                    botStatusText.textContent = 'Reconnecting...';
                    break;
                default:
                    botStatusIndicator.className = 'status-indicator bg-gray-500';
                    botStatusText.textContent = `Status: ${status}`;
            }

            // Update QR Management section
            qrCodeImg.classList.add('hidden');
            qrExpiryMessage.classList.add('hidden');
            generateQrBtn.disabled = false; // Enable button by default
            buttonText.textContent = 'Generate New QR';
            buttonLoadingSpinner.classList.add('hidden');


            if (status === 'qr_received' && qrDataURL) {
                qrCodeImg.src = qrDataURL;
                qrCodeImg.classList.remove('hidden');
                qrStatusMessage.textContent = 'Scan this QR code with your WhatsApp to connect the bot:';
            } else if (status === 'qr_expired') {
                qrStatusMessage.textContent = 'QR code expired. Please generate a new one.';
                qrExpiryMessage.classList.remove('hidden');
            } else if (status === 'ready' || status === 'authenticated') {
                qrStatusMessage.textContent = 'Bot is connected and online. No QR needed.';
                generateQrBtn.disabled = true; // Disable button if already connected
            } else if (status === 'initializing' || status === 'reconnecting' || status === 'auth_failure' || status === 'disconnected') {
                qrStatusMessage.textContent = 'Bot is attempting to connect or re-generate QR. Please wait...';
                generateQrBtn.disabled = true; // Disable button while auto-reconnecting/initializing
                buttonText.textContent = 'Generating QR...';
                buttonLoadingSpinner.classList.remove('hidden');
            } else { // Fallback for other states or errors
                qrStatusMessage.textContent = 'No QR code available. Click "Generate New QR" if bot is offline.';
            }
        }

        // Socket.IO listeners for real-time updates
        socket.on('status', (status) => {
            // When status changes, we need to fetch the QR code separately if it's a 'qr_received' status
            // The backend emits 'qrCode' specifically when a new QR is available.
            // So, for 'status' updates, we just update the status text.
            updateBotStatusDisplay(status, qrCodeImg.src); // Pass current QR data, will be updated by 'qrCode' event
        });

        socket.on('qrCode', (qrDataURL) => {
            // This listener specifically handles new QR codes being pushed
            updateBotStatusDisplay('qr_received', qrDataURL);
        });

        // Event listener for the "Generate New QR" button
        generateQrBtn.addEventListener('click', async () => {
            generateQrBtn.disabled = true;
            buttonText.textContent = 'Generating QR...';
            buttonLoadingSpinner.classList.remove('hidden');
            qrStatusMessage.textContent = 'Requesting new QR code...';
            qrCodeImg.classList.add('hidden');
            qrExpiryMessage.classList.add('hidden');

            try {
                const response = await fetch('/api/public/request-qr', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' }
                });
                const result = await response.json();
                if (!response.ok) {
                    throw new Error(result.message || 'Failed to request QR.');
                }
                // UI will be updated by Socket.IO 'status' or 'qrCode' events
                // No alert needed here, status messages will guide the user
            } catch (error) {
                console.error('Error requesting new QR:', error);
                qrStatusMessage.textContent = `Error: ${error.message}. Please try again.`;
                generateQrBtn.disabled = false;
                buttonText.textContent = 'Generate New QR';
                buttonLoadingSpinner.classList.add('hidden');
            }
        });

        // Initial fetch for bot status when page loads
        // This will trigger the display update based on current backend state
        // We don't have a direct API to get QR data on page load for the public panel,
        // it relies on Socket.IO 'qrCode' event or manual 'generate QR'
        // So, initially, we just set a loading status.
        updateBotStatusDisplay('initializing');
    </script>
</body>
</html>

