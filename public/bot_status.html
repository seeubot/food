<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WhatsApp Bot Status</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; }
        .dark-mode { background-color: #1a202c; color: #e2e8f0; }
        .dark-mode .bg-white { background-color: #2d3748; }
        .dark-mode .text-gray-800 { color: #e2e8f0; }
        .dark-mode .text-gray-700 { color: #cbd5e0; }
        .dark-mode .text-gray-500 { color: #a0aec0; }
        .dark-mode .border-gray-200 { border-color: #4a5568; }

        .spinner {
            border: 4px solid rgba(0, 0, 0, 0.1);
            border-left-color: #3b82f6; /* Tailwind blue-500 */
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }
        .dark-mode .spinner {
            border: 4px solid rgba(255, 255, 255, 0.1);
            border-left-color: #63b3ed; /* Lighter blue for dark mode */
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="bg-gray-100 text-gray-800 dark:bg-gray-900 dark:text-gray-100 min-h-screen flex items-center justify-center">
    <div class="bg-white dark:bg-gray-800 p-8 rounded-lg shadow-xl max-w-md w-full text-center">
        <h1 class="text-3xl font-bold mb-6 text-gray-800 dark:text-white">WhatsApp Bot Status</h1>

        <div id="loadingSpinner" class="spinner mx-auto mb-6"></div>
        <p id="statusMessage" class="text-lg font-semibold mb-6 text-gray-700 dark:text-gray-300">Initializing...</p>

        <div id="qrCodeContainer" class="flex flex-col items-center justify-center">
            <img id="qrCodeImage" src="" alt="QR Code" class="w-64 h-64 border border-gray-200 dark:border-gray-700 rounded-lg mb-4 hidden">
            <p id="qrInstructions" class="text-gray-600 dark:text-gray-400 hidden">Scan this QR code with your WhatsApp app to connect the bot.</p>
        </div>

        <p class="text-sm text-gray-500 dark:text-gray-400 mt-8">This page updates automatically.</p>
    </div>

    <!-- Socket.IO client script -->
    <script src="/socket.io/socket.io.js"></script>
    <script>
        // Dark Mode Toggle (for consistency, though not a toggle button on this page)
        function setDarkMode(isDark) {
            if (isDark) {
                document.body.classList.add('dark-mode');
                document.body.classList.remove('text-gray-800');
                document.body.classList.add('dark:bg-gray-900', 'dark:text-gray-100');
            } else {
                document.body.classList.remove('dark-mode');
                document.body.classList.add('text-gray-800');
                document.body.classList.remove('dark:bg-gray-900', 'dark:text-gray-100');
            }
            localStorage.setItem('darkMode', isDark);
        }

        // Initialize dark mode based on local storage or system preference
        const savedDarkMode = localStorage.getItem('darkMode');
        if (savedDarkMode === 'true') {
            setDarkMode(true);
        } else if (savedDarkMode === null && window.matchMedia('(prefers-color-scheme: dark)').matches) {
            setDarkMode(true);
        } else {
            setDarkMode(false);
        }

        const socket = io();
        const statusMessage = document.getElementById('statusMessage');
        const qrCodeImage = document.getElementById('qrCodeImage');
        const qrInstructions = document.getElementById('qrInstructions');
        const loadingSpinner = document.getElementById('loadingSpinner');

        function updateStatus(status, qrData = null) {
            loadingSpinner.classList.add('hidden');
            qrCodeImage.classList.add('hidden');
            qrInstructions.classList.add('hidden');
            qrCodeImage.src = ''; // Clear image source

            switch (status) {
                case 'initializing':
                    statusMessage.textContent = 'Initializing WhatsApp bot...';
                    loadingSpinner.classList.remove('hidden');
                    break;
                case 'reconnecting':
                    statusMessage.textContent = 'Reconnecting WhatsApp bot...';
                    loadingSpinner.classList.remove('hidden');
                    break;
                case 'qr_received':
                    statusMessage.textContent = 'Scan QR code with WhatsApp';
                    qrCodeImage.src = qrData;
                    qrCodeImage.classList.remove('hidden');
                    qrInstructions.classList.remove('hidden');
                    break;
                case 'qr_expired':
                    statusMessage.textContent = 'QR code expired. Waiting for a new one...';
                    loadingSpinner.classList.remove('hidden');
                    break;
                case 'qr_error':
                    statusMessage.textContent = 'Error generating QR code. Retrying...';
                    loadingSpinner.classList.remove('hidden');
                    break;
                case 'authenticated':
                    statusMessage.textContent = 'Authenticated successfully!';
                    loadingSpinner.classList.remove('hidden'); // Spinner for a brief moment before ready
                    break;
                case 'ready':
                    statusMessage.textContent = 'WhatsApp Bot is Ready and Online!';
                    break;
                case 'auth_failure':
                    statusMessage.textContent = 'Authentication failed! Please scan a new QR code.';
                    loadingSpinner.classList.remove('hidden');
                    break;
                case 'disconnected':
                    statusMessage.textContent = 'Bot disconnected. Attempting to reconnect...';
                    loadingSpinner.classList.remove('hidden');
                    break;
                default:
                    statusMessage.textContent = `Status: ${status}`;
                    loadingSpinner.classList.remove('hidden');
            }
        }

        // Listen for status updates from the server
        socket.on('status', (status) => {
            updateStatus(status);
        });

        // Listen for QR code data
        socket.on('qrCode', (qrData) => {
            if (qrData) {
                updateStatus('qr_received', qrData);
            } else {
                // If qrData is null, it means QR was cleared (e.g., expired)
                updateStatus('qr_expired');
            }
        });

        // Initial state when the page loads
        updateStatus('initializing');
    </script>
</body>
</html>

