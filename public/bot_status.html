<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WhatsApp Bot Status</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        /* Base styles for the black and white theme */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #000000 !important; /* Pure black background */
            color: #ffffff !important; /* Pure white text */
        }

        /* General text colors to ensure visibility */
        .text-gray-700, .text-gray-800 {
            color: #ffffff !important; /* All main text is white */
        }
        .text-gray-600 {
            color: #cccccc !important; /* Lighter gray for secondary text */
        }
        .text-gray-500 {
            color: #888888 !important; /* Medium gray for placeholders/disabled */
        }
        .text-gray-400 {
            color: #aaaaaa !important; /* Slightly lighter gray for icons/subtle elements */
        }
        .text-gray-300 {
            color: #dddddd !important; /* Very light gray */
        }
        .text-gray-200 {
            color: #eeeeee !important; /* Almost white */
        }

        /* Backgrounds for main panels/cards */
        .bg-gray-100 { /* Override default body background if still present */
            background-color: #000000 !important;
        }
        .bg-white, .bg-gray-800 { /* Main content cards, modals, headers */
            background-color: #1a1a1a !important; /* Very dark gray */
        }
        .bg-gray-900 { /* Modal overlay */
            background-color: #0a0a0a !important; /* Slightly darker for deeper contrast */
        }

        /* Inputs, Textareas */
        input, textarea {
            background-color: #222222 !important; /* Darker background for inputs */
            border-color: #444444 !important; /* Dark gray border */
            color: #ffffff !important; /* White text in inputs */
            padding: 0.75rem 1rem !important; /* More padding for touch targets */
            border-radius: 0.375rem !important; /* Rounded corners */
        }
        input::placeholder, textarea::placeholder {
            color: #888888 !important; /* Placeholder text color */
        }

        /* Buttons */
        button {
            border-radius: 0.5rem !important; /* More rounded buttons */
            padding: 0.75rem 1.5rem !important; /* Generous padding */
            font-weight: 600 !important; /* Semi-bold text */
            transition: all 0.2s ease-in-out !important; /* Smooth transitions */
        }
        /* Primary buttons (Add to Cart, Checkout, Place Order, Active Filter) */
        .bg-green-500, .bg-blue-500 { /* Reusing Tailwind classes but overriding colors */
            background-color: #ffffff !important; /* White background */
            color: #000000 !important; /* Black text */
            box-shadow: 0 4px 6px -1px rgba(255, 255, 255, 0.2), 0 2px 4px -1px rgba(255, 255, 255, 0.1) !important;
        }
        .bg-green-500:hover, .bg-blue-500:hover {
            background-color: #e0e0e0 !important; /* Slightly darker white on hover */
        }
        /* Secondary buttons (Cancel, Close, Get Location, Inactive Filter) */
        .bg-gray-500, .bg-gray-200 { /* Reusing Tailwind classes but overriding colors */
            background-color: #333333 !important; /* Dark gray background */
            color: #ffffff !important; /* White text */
        }
        .bg-gray-500:hover, .bg-gray-200:hover {
            background-color: #444444 !important; /* Lighter gray on hover */
        }
        /* Red buttons (e.g., quantity decrease) */
        .bg-red-500 {
            background-color: #555555 !important; /* Darker gray for subtle delete */
            color: #ffffff !important;
        }
        .bg-red-500:hover {
            background-color: #777777 !important;
        }

        /* Borders and Dividers */
        .border-gray-200, .border-gray-700 {
            border-color: #333333 !important; /* Consistent dark gray borders */
        }

        /* Shadows */
        .shadow-md {
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.4) !important; /* Deeper shadows for depth */
        }
        .shadow-xl {
            box-shadow: 0 20px 30px rgba(0, 0, 0, 0.6) !important;
        }

        /* Specific text colors for status/icons */
        .text-green-600 { color: #ffffff !important; } /* White for prices/available status */
        .text-red-500 { color: #cccccc !important; } /* Light gray for "Out of Stock" */

        /* Custom scrollbar for cart on small screens */
        .overflow-y-auto::-webkit-scrollbar {
            width: 8px;
        }
        .overflow-y-auto::-webkit-scrollbar-track {
            background: #222222;
            border-radius: 10px;
        }
        .overflow-y-auto::-webkit-scrollbar-thumb {
            background: #555555;
            border-radius: 10px;
        }
        .overflow-y-auto::-webkit-scrollbar-thumb:hover {
            background: #777777;
        }
    </style>
</head>
<body class="min-h-screen flex items-center justify-center p-4">
    <div class="bg-gray-800 p-8 rounded-lg shadow-xl max-w-md w-full text-center">
        <h1 class="text-3xl font-bold text-white mb-6">WhatsApp Bot Status</h1>

        <div class="flex flex-col items-center mb-6">
            <div id="status-indicator" class="w-8 h-8 rounded-full bg-gray-500 animate-pulse mb-3"></div>
            <p id="status-text" class="text-lg text-gray-300">Connecting to WhatsApp...</p>
        </div>

        <div id="qr-code-container" class="mb-6 hidden">
            <p class="text-gray-300 mb-3">Scan this QR code with your WhatsApp app:</p>
            <img id="qr-code-img" src="" alt="QR Code" class="w-64 h-64 mx-auto border-2 border-gray-600 rounded-md p-2 bg-white">
            <p id="qr-expiry-message" class="text-red-500 text-sm mt-2 hidden">QR code expired. Request a new one.</p>
        </div>

        <button id="request-qr-button" class="bg-blue-500 hover:bg-blue-600 text-black font-bold py-3 px-6 rounded-lg transition duration-200 mt-4">
            Request New QR Code
        </button>

        <p class="text-gray-500 text-sm mt-6">
            This panel shows the real-time status of your WhatsApp bot.
            <br>Admin Dashboard: <a href="/admin/dashboard" class="text-blue-400 hover:underline">/admin/dashboard</a>
            <br>Public Menu: <a href="/menu" class="text-blue-400 hover:underline">/menu</a>
        </p>
    </div>

    <script src="https://cdn.socket.io/4.0.0/socket.io.min.js"></script>
    <script>
        const socket = io();

        const statusIndicator = document.getElementById('status-indicator');
        const statusText = document.getElementById('status-text');
        const qrCodeContainer = document.getElementById('qr-code-container');
        const qrCodeImg = document.getElementById('qr-code-img');
        const qrExpiryMessage = document.getElementById('qr-expiry-message');
        const requestQrButton = document.getElementById('request-qr-button');

        function updateStatusDisplay(status) {
            qrExpiryMessage.classList.add('hidden'); // Hide expiry message by default

            switch (status) {
                case 'initializing':
                    statusIndicator.className = 'w-8 h-8 rounded-full bg-gray-500 animate-pulse mb-3';
                    statusText.textContent = 'Initializing WhatsApp client...';
                    qrCodeContainer.classList.add('hidden');
                    requestQrButton.disabled = true; // Disable while initializing
                    requestQrButton.classList.add('opacity-50', 'cursor-not-allowed');
                    break;
                case 'qr_received':
                    statusIndicator.className = 'w-8 h-8 rounded-full bg-yellow-500 animate-pulse mb-3';
                    statusText.textContent = 'QR Code received. Scan with WhatsApp.';
                    qrCodeContainer.classList.remove('hidden');
                    requestQrButton.disabled = true; // Disable while QR is active
                    requestQrButton.classList.add('opacity-50', 'cursor-not-allowed');
                    break;
                case 'qr_error':
                    statusIndicator.className = 'w-8 h-8 rounded-full bg-red-500 mb-3';
                    statusText.textContent = 'QR Code error. Please request a new QR.';
                    qrCodeContainer.classList.add('hidden');
                    requestQrButton.disabled = false; // Enable to request new QR
                    requestQrButton.classList.remove('opacity-50', 'cursor-not-allowed');
                    break;
                case 'qr_expired':
                    statusIndicator.className = 'w-8 h-8 rounded-full bg-red-500 mb-3';
                    statusText.textContent = 'QR Code expired. Please request a new QR.';
                    qrCodeContainer.classList.add('hidden');
                    qrExpiryMessage.classList.remove('hidden'); // Show expiry message
                    requestQrButton.disabled = false; // Enable to request new QR
                    requestQrButton.classList.remove('opacity-50', 'cursor-not-allowed');
                    break;
                case 'authenticated':
                    statusIndicator.className = 'w-8 h-8 rounded-full bg-blue-500 mb-3';
                    statusText.textContent = 'Authenticated. Waiting for ready...';
                    qrCodeContainer.classList.add('hidden');
                    requestQrButton.disabled = true; // Disable while authenticated
                    requestQrButton.classList.add('opacity-50', 'cursor-not-allowed');
                    break;
                case 'ready':
                    statusIndicator.className = 'w-8 h-8 rounded-full bg-green-500 mb-3';
                    statusText.textContent = 'WhatsApp Bot is Ready and Online!';
                    qrCodeContainer.classList.add('hidden');
                    requestQrButton.disabled = true; // Disable while ready
                    requestQrButton.classList.add('opacity-50', 'cursor-not-allowed');
                    break;
                case 'auth_failure':
                    statusIndicator.className = 'w-8 h-8 rounded-full bg-red-500 mb-3';
                    statusText.textContent = 'Authentication Failed! Please request new QR.';
                    qrCodeContainer.classList.add('hidden');
                    requestQrButton.disabled = false; // Enable to request new QR
                    requestQrButton.classList.remove('opacity-50', 'cursor-not-allowed');
                    break;
                case 'disconnected':
                    statusIndicator.className = 'w-8 h-8 rounded-full bg-orange-500 animate-pulse mb-3';
                    statusText.textContent = 'Disconnected. Reconnecting...';
                    qrCodeContainer.classList.add('hidden');
                    requestQrButton.disabled = true; // Disable while reconnecting automatically
                    requestQrButton.classList.add('opacity-50', 'cursor-not-allowed');
                    break;
                case 'reconnecting':
                    statusIndicator.className = 'w-8 h-8 rounded-full bg-yellow-500 animate-pulse mb-3';
                    statusText.textContent = 'Reconnecting...';
                    qrCodeContainer.classList.add('hidden');
                    requestQrButton.disabled = true; // Disable while reconnecting automatically
                    requestQrButton.classList.add('opacity-50', 'cursor-not-allowed');
                    break;
                default:
                    statusIndicator.className = 'w-8 h-8 rounded-full bg-gray-500 mb-3';
                    statusText.textContent = `Status: ${status}`;
                    qrCodeContainer.classList.add('hidden');
                    requestQrButton.disabled = true; // Default to disabled if unknown status
                    requestQrButton.classList.add('opacity-50', 'cursor-not-allowed');
            }
        }

        // Listen for status updates from the server
        socket.on('status', (status) => {
            console.log('Received status:', status);
            updateStatusDisplay(status);
        });

        // Listen for QR code data from the server
        socket.on('qrCode', (qrDataUrl) => {
            if (qrDataUrl) {
                qrCodeImg.src = qrDataUrl;
                qrCodeContainer.classList.remove('hidden');
                qrExpiryMessage.classList.add('hidden'); // Hide expiry message if new QR received
                updateStatusDisplay('qr_received'); // Force status update to QR received
            } else {
                qrCodeContainer.classList.add('hidden');
                qrCodeImg.src = ''; // Clear image source
            }
        });

        // Handle requesting a new QR code
        requestQrButton.addEventListener('click', async () => {
            requestQrButton.disabled = true; // Disable button immediately
            requestQrButton.classList.add('opacity-50', 'cursor-not-allowed');
            statusText.textContent = 'Requesting new QR...';
            statusIndicator.className = 'w-8 h-8 rounded-full bg-gray-500 animate-pulse mb-3';
            qrCodeContainer.classList.add('hidden');
            qrExpiryMessage.classList.add('hidden');

            try {
                const response = await fetch('/api/public/request-qr', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' }
                });
                const result = await response.json();
                console.log('Request QR response:', result);
                if (response.ok) {
                    statusText.textContent = 'New QR requested. Please wait for it to appear.';
                } else {
                    statusText.textContent = `Error: ${result.message || 'Failed to request new QR.'}`;
                    requestQrButton.disabled = false; // Re-enable on error
                    requestQrButton.classList.remove('opacity-50', 'cursor-not-allowed');
                }
            } catch (error) {
                console.error('Error requesting new QR:', error);
                statusText.textContent = 'Network error requesting new QR. Check console.';
                requestQrButton.disabled = false; // Re-enable on network error
                requestQrButton.classList.remove('opacity-50', 'cursor-not-allowed');
            }
        });

        // Initial status fetch on page load
        // This will request the current status and QR code (if available) from the server
        // and update the display accordingly.
        socket.emit('requestInitialStatus'); // Custom event to request initial status if needed by backend
    </script>
</body>
</html>

