<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Our Delicious Menu</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        body { font-family: 'Inter', sans-serif; }
        .dark-mode { background-color: #1a202c; color: #e2e8f0; }
        .dark-mode .bg-white { background-color: #2d3748; }
        .dark-mode .text-gray-700 { color: #e2e8f0; }
        .dark-mode .border-gray-200 { border-color: #4a5568; }
        .dark-mode input, .dark-mode textarea { background-color: #2d3748; border-color: #4a5568; color: #e2e8f0; }
        .dark-mode button:not(.bg-red-500):not(.bg-gray-500) { background-color: #48bb78; }

        /* Custom scrollbar for cart on small screens */
        .overflow-y-auto::-webkit-scrollbar {
            width: 8px;
        }
        .overflow-y-auto::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 10px;
        }
        .overflow-y-auto::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 10px;
        }
        .overflow-y-auto::-webkit-scrollbar-thumb:hover {
            background: #555;
        }
        .dark-mode .overflow-y-auto::-webkit-scrollbar-track {
            background: #4a5568;
        }
        .dark-mode .overflow-y-auto::-webkit-scrollbar-thumb {
            background: #a0aec0;
        }
    </style>
</head>
<body class="bg-gray-100 dark-mode min-h-screen flex flex-col">
    <!-- Header -->
    <header class="bg-white dark:bg-gray-800 shadow-md py-4 px-6 flex justify-between items-center sticky top-0 z-40">
        <h1 class="text-3xl font-bold text-gray-800 dark:text-white">Delicious Bites</h1>
        <div class="relative">
            <button id="cart-button" class="bg-green-500 hover:bg-green-600 text-white font-bold py-2 px-4 rounded-full transition duration-200 relative focus:outline-none focus:ring-2 focus:ring-green-500 focus:ring-opacity-50">
                <i class="fas fa-shopping-cart mr-2"></i>
                Cart (<span id="cart-count">0</span>)
                <span id="cart-total-display" class="ml-2">₹0.00</span>
            </button>
            <!-- Cart Dropdown/Modal for Mobile -->
            <div id="cart-dropdown" class="hidden absolute right-0 mt-3 w-80 bg-white dark:bg-gray-800 rounded-lg shadow-xl z-50 p-4">
                <h3 class="text-xl font-bold text-gray-800 dark:text-white mb-4">Your Cart</h3>
                <div id="cart-items-display" class="max-h-60 overflow-y-auto mb-4 border-b border-gray-200 dark:border-gray-700 pb-4">
                    <!-- Cart items will be rendered here -->
                    <p id="empty-cart-message" class="text-gray-500 dark:text-gray-400 text-center">Your cart is empty.</p>
                </div>
                <div class="text-right text-gray-800 dark:text-white font-semibold mb-2">Subtotal: <span id="cart-subtotal-dropdown">₹0.00</span></div>
                <div class="text-right text-gray-800 dark:text-white font-semibold mb-4">Transport Tax: <span id="cart-tax-dropdown">₹0.00</span></div>
                <div class="text-right text-gray-800 dark:text-white text-xl font-bold mb-4">Total: <span id="cart-grand-total-dropdown">₹0.00</span></div>
                <button id="checkout-button-dropdown" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded-md w-full transition duration-200">Proceed to Checkout</button>
            </div>
        </div>
    </header>

    <!-- Main Content Area -->
    <main class="flex-1 p-4 sm:p-6 lg:p-8">
        <!-- Loading Indicator -->
        <div id="loading-indicator" class="fixed inset-0 bg-gray-900 bg-opacity-50 flex items-center justify-center z-[100] hidden">
            <div class="flex flex-col items-center">
                <div class="animate-spin rounded-full h-16 w-16 border-t-4 border-b-4 border-green-500"></div>
                <p class="mt-4 text-white text-lg">Loading menu...</p>
            </div>
        </div>

        <!-- Menu Categories Filter (Optional, for larger menus) -->
        <div class="mb-6 flex flex-wrap gap-2 justify-center">
            <button class="filter-button bg-gray-200 dark:bg-gray-700 text-gray-800 dark:text-gray-200 py-2 px-4 rounded-full text-sm font-semibold hover:bg-gray-300 dark:hover:bg-gray-600 transition duration-200" data-category="All">All</button>
            <!-- Categories will be dynamically added here -->
        </div>

        <!-- Menu Items Grid -->
        <section id="menu-items-grid" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6">
            <!-- Menu items will be loaded here by JavaScript -->
            <p id="no-items-message" class="col-span-full text-center text-gray-500 dark:text-gray-400 hidden">No menu items available.</p>
        </section>
    </main>

    <!-- Product Detail Modal -->
    <div id="product-detail-modal" class="fixed inset-0 bg-gray-900 bg-opacity-50 flex items-center justify-center z-50 hidden">
        <div class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow-xl w-11/12 md:w-2/3 lg:w-1/2 max-h-[90vh] overflow-y-auto">
            <div class="flex justify-between items-center mb-4">
                <h3 id="product-detail-name" class="text-xl font-bold text-gray-800 dark:text-white"></h3>
                <button class="text-gray-500 hover:text-gray-700 dark:text-gray-400 dark:hover:text-gray-200 text-2xl" onclick="closeModal('product-detail-modal')">&times;</button>
            </div>
            <div class="space-y-4">
                <img id="product-detail-image" src="" onerror="this.onerror=null;this.src='https://placehold.co/600x400/cccccc/333333?text=Food+Item';" alt="Product Image" class="w-full h-64 object-cover rounded-md">
                <p id="product-detail-description" class="text-gray-700 dark:text-gray-300"></p>
                <p class="text-gray-700 dark:text-gray-300"><strong>Category:</strong> <span id="product-detail-category"></span></p>
                <p class="text-gray-700 dark:text-gray-300"><strong>Availability:</strong> <span id="product-detail-availability"></span></p>
                <div class="flex justify-between items-center pt-4 border-t border-gray-200 dark:border-gray-700">
                    <span id="product-detail-price" class="text-3xl font-bold text-green-600"></span>
                    <button id="product-detail-add-to-cart" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded-md transition duration-200">
                        <i class="fas fa-cart-plus mr-1"></i> Add to Cart
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Checkout Modal -->
    <div id="checkout-modal" class="fixed inset-0 bg-gray-900 bg-opacity-50 flex items-center justify-center z-50 hidden">
        <div class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow-xl w-11/12 md:w-2/3 lg:w-1/2 max-h-[90vh] overflow-y-auto">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-xl font-bold text-gray-800 dark:text-white">Checkout</h3>
                <button class="text-gray-500 hover:text-gray-700 dark:text-gray-400 dark:hover:text-gray-200 text-2xl" onclick="closeModal('checkout-modal')">&times;</button>
            </div>
            <form id="checkout-form" class="space-y-4">
                <div>
                    <label for="customer-name" class="block text-gray-700 dark:text-gray-300 text-sm font-bold mb-2">Your Name:</label>
                    <input type="text" id="customer-name" name="customerName" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline dark:bg-gray-700 dark:border-gray-600 dark:text-white" required>
                </div>
                <div>
                    <label for="customer-phone" class="block text-gray-700 dark:text-gray-300 text-sm font-bold mb-2">Your WhatsApp Number (e.g., 91XXXXXXXXXX):</label>
                    <input type="tel" id="customer-phone" name="customerPhone" pattern="[0-9]{10,15}" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline dark:bg-gray-700 dark:border-gray-600 dark:text-white" required>
                </div>
                <div>
                    <label for="delivery-address" class="block text-gray-700 dark:text-gray-300 text-sm font-bold mb-2">Delivery Address:</label>
                    <textarea id="delivery-address" name="deliveryAddress" rows="3" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline dark:bg-gray-700 dark:border-gray-600 dark:text-white" required></textarea>
                </div>
                <div>
                    <label class="block text-gray-700 dark:text-gray-300 text-sm font-bold mb-2">Your Location (for delivery cost calculation):</label>
                    <button type="button" id="get-location-btn" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded-md transition duration-200 mb-2">Get My Location</button>
                    <p id="location-status" class="text-sm text-gray-600 dark:text-gray-400"></p>
                    <input type="hidden" id="customer-latitude" name="customerLatitude">
                    <input type="hidden" id="customer-longitude" name="customerLongitude">
                </div>

                <div class="border-t border-gray-200 dark:border-gray-700 pt-4 mt-4">
                    <div class="flex justify-between text-gray-700 dark:text-gray-300 mb-2">
                        <span>Items Subtotal:</span>
                        <span id="checkout-subtotal">₹0.00</span>
                    </div>
                    <div class="flex justify-between text-gray-700 dark:text-gray-300 mb-2">
                        <span>Transport Tax:</span>
                        <span id="checkout-transport-tax">₹0.00</span>
                    </div>
                    <div class="flex justify-between text-gray-800 dark:text-white text-xl font-bold">
                        <span>Total Amount:</span>
                        <span id="checkout-total-amount">₹0.00</span>
                    </div>
                </div>

                <div class="flex justify-end space-x-3 mt-6">
                    <button type="button" class="bg-gray-500 hover:bg-gray-600 text-white font-bold py-2 px-4 rounded-md transition duration-200" onclick="closeModal('checkout-modal')">Cancel</button>
                    <button type="submit" class="bg-green-500 hover:bg-green-600 text-white font-bold py-2 px-4 rounded-md transition duration-200">Place Order</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Order Tracking Modal -->
    <div id="order-tracking-modal" class="fixed inset-0 bg-gray-900 bg-opacity-50 flex items-center justify-center z-50 hidden">
        <div class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow-xl w-11/12 md:w-2/3 lg:w-1/2 max-h-[90vh] overflow-y-auto">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-xl font-bold text-gray-800 dark:text-white">Order Status</h3>
                <button class="text-gray-500 hover:text-gray-700 dark:text-gray-400 dark:hover:text-gray-200 text-2xl" onclick="closeModal('order-tracking-modal')">&times;</button>
            </div>
            <div id="order-tracking-content" class="text-gray-700 dark:text-gray-300 space-y-3">
                <!-- Order status details will be loaded here -->
            </div>
            <div class="mt-6 flex justify-end">
                <button class="bg-gray-500 hover:bg-gray-600 text-white font-bold py-2 px-4 rounded-md transition duration-200" onclick="closeModal('order-tracking-modal')">Close</button>
            </div>
        </div>
    </div>

    <script>
        // Dark mode toggle
        if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
            document.body.classList.add('dark-mode');
        }

        const loadingIndicator = document.getElementById('loading-indicator');

        function showLoading() { loadingIndicator.classList.remove('hidden'); }
        function hideLoading() { loadingIndicator.classList.add('hidden'); }

        let cart = [];
        let products = []; // Store all fetched products
        let shopLocation = { latitude: 0, longitude: 0 };
        let deliveryRates = [];
        let currentCustomerLocation = null;
        let transportTax = 0;

        const cartCountSpan = document.getElementById('cart-count');
        const cartTotalDisplaySpan = document.getElementById('cart-total-display');
        const cartItemsDisplayDiv = document.getElementById('cart-items-display');
        const emptyCartMessage = document.getElementById('empty-cart-message');
        const cartSubtotalDropdown = document.getElementById('cart-subtotal-dropdown');
        const cartTaxDropdown = document.getElementById('cart-tax-dropdown');
        const cartGrandTotalDropdown = document.getElementById('cart-grand-total-dropdown');

        const checkoutSubtotalSpan = document.getElementById('checkout-subtotal');
        const checkoutTransportTaxSpan = document.getElementById('checkout-transport-tax');
        const checkoutTotalAmountSpan = document.getElementById('checkout-total-amount');

        // --- Modals ---
        function openModal(modalId) {
            document.getElementById(modalId).classList.remove('hidden');
            // If opening checkout modal, automatically trigger location request
            if (modalId === 'checkout-modal') {
                document.getElementById('get-location-btn').click();
            }
        }

        function closeModal(modalId) {
            document.getElementById(modalId).classList.add('hidden');
        }

        // --- Fetch Menu Items and Settings ---
        async function fetchMenuAndSettings() {
            showLoading();
            try {
                const [menuResponse, settingsResponse] = await Promise.all([
                    fetch('/api/menu'),
                    fetch('/api/public/settings')
                ]);

                products = await menuResponse.json();
                const settings = await settingsResponse.json();

                shopLocation = settings.shopLocation;
                deliveryRates = settings.deliveryRates.sort((a, b) => a.kms - b.kms); // Ensure rates are sorted

                renderMenu(products);
                renderCategories(products);
            } catch (error) {
                console.error('Error fetching menu or settings:', error);
                document.getElementById('menu-items-grid').innerHTML = '<p class="col-span-full text-center text-red-500">Failed to load menu. Please try again later.</p>';
            } finally {
                hideLoading();
            }
        }

        function renderMenu(itemsToRender) {
            const menuGrid = document.getElementById('menu-items-grid');
            menuGrid.innerHTML = ''; // Clear previous items

            if (itemsToRender.length === 0) {
                document.getElementById('no-items-message').classList.remove('hidden');
                return;
            } else {
                document.getElementById('no-items-message').classList.add('hidden');
            }

            itemsToRender.forEach(product => {
                const productCard = `
                    <div class="bg-white dark:bg-gray-800 rounded-lg shadow-md overflow-hidden flex flex-col transform transition-transform duration-300 hover:scale-105 cursor-pointer" onclick="showProductDetails('${product._id}')">
                        <img src="${product.imageUrl}" onerror="this.onerror=null;this.src='https://placehold.co/400x300/cccccc/333333?text=Food+Item';" alt="${product.name}" class="w-full h-48 object-cover">
                        <div class="p-4 flex-grow flex flex-col">
                            <h3 class="text-xl font-semibold text-gray-800 dark:text-white mb-2">${product.name}</h3>
                            <p class="text-gray-600 dark:text-gray-300 text-sm mb-3 flex-grow">${product.description ? product.description.substring(0, 70) + '...' : 'No description available.'}</p>
                            <div class="flex justify-between items-center mt-auto">
                                <span class="text-2xl font-bold text-green-600">₹${product.price.toFixed(2)}</span>
                                <button onclick="event.stopPropagation(); addToCart('${product._id}')" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded-md transition duration-200 text-sm">
                                    <i class="fas fa-cart-plus mr-1"></i> Add to Cart
                                </button>
                            </div>
                        </div>
                    </div>
                `;
                menuGrid.innerHTML += productCard;
            });
        }

        function renderCategories(allProducts) {
            const categoriesContainer = document.querySelector('.filter-button').parentNode;
            const uniqueCategories = [...new Set(allProducts.map(p => p.category))].filter(Boolean); // Get unique non-empty categories

            // Clear existing dynamic categories, keep 'All' button
            document.querySelectorAll('.filter-button:not([data-category="All"])').forEach(btn => btn.remove());

            uniqueCategories.forEach(category => {
                const button = document.createElement('button');
                button.className = 'filter-button bg-gray-200 dark:bg-gray-700 text-gray-800 dark:text-gray-200 py-2 px-4 rounded-full text-sm font-semibold hover:bg-gray-300 dark:hover:bg-gray-600 transition duration-200';
                button.dataset.category = category;
                button.textContent = category;
                categoriesContainer.appendChild(button);
            });

            // Add event listeners to new category buttons
            document.querySelectorAll('.filter-button').forEach(button => {
                button.addEventListener('click', (e) => {
                    const selectedCategory = e.target.dataset.category;
                    document.querySelectorAll('.filter-button').forEach(btn => {
                        btn.classList.remove('bg-green-500', 'text-white', 'dark:bg-green-600');
                        btn.classList.add('bg-gray-200', 'text-gray-800', 'dark:bg-gray-700', 'dark:text-gray-200');
                    });
                    e.target.classList.add('bg-green-500', 'text-white', 'dark:bg-green-600');
                    e.target.classList.remove('bg-gray-200', 'text-gray-800', 'dark:bg-gray-700', 'dark:text-gray-200');

                    if (selectedCategory === 'All') {
                        renderMenu(products);
                    } else {
                        const filteredProducts = products.filter(p => p.category === selectedCategory);
                        renderMenu(filteredProducts);
                    }
                });
            });

            // Set 'All' button as active by default
            document.querySelector('.filter-button[data-category="All"]').classList.add('bg-green-500', 'text-white', 'dark:bg-green-600');
            document.querySelector('.filter-button[data-category="All"]').classList.remove('bg-gray-200', 'text-gray-800', 'dark:bg-gray-700', 'dark:text-gray-200');
        }


        // --- Cart Management ---
        function addToCart(productId) {
            const product = products.find(p => p._id === productId);
            if (!product) return;

            const existingItem = cart.find(item => item.productId === productId);
            if (existingItem) {
                existingItem.quantity++;
            } else {
                cart.push({
                    productId: product._id,
                    name: product.name,
                    price: product.price,
                    quantity: 1
                });
            }
            updateCartDisplay();
        }

        function updateCartItemQuantity(productId, change) {
            const itemIndex = cart.findIndex(item => item.productId === productId);
            if (itemIndex > -1) {
                cart[itemIndex].quantity += change;
                if (cart[itemIndex].quantity <= 0) {
                    cart.splice(itemIndex, 1); // Remove if quantity is 0 or less
                }
            }
            updateCartDisplay();
        }

        function calculateCartTotals() {
            let subtotal = cart.reduce((sum, item) => sum + (item.price * item.quantity), 0);
            let totalAmount = subtotal + transportTax;
            return { subtotal, totalAmount };
        }

        function updateCartDisplay() {
            const { subtotal, totalAmount } = calculateCartTotals();

            cartCountSpan.textContent = cart.reduce((sum, item) => sum + item.quantity, 0);
            cartTotalDisplaySpan.textContent = `₹${totalAmount.toFixed(2)}`;

            cartItemsDisplayDiv.innerHTML = '';
            if (cart.length === 0) {
                emptyCartMessage.classList.remove('hidden');
            } else {
                emptyCartMessage.classList.add('hidden');
                cart.forEach(item => {
                    const itemDiv = `
                        <div class="flex justify-between items-center py-2 border-b border-gray-100 dark:border-gray-700 last:border-b-0">
                            <div class="flex-grow">
                                <p class="font-semibold text-gray-800 dark:text-white">${item.name}</p>
                                <p class="text-sm text-gray-600 dark:text-gray-400">₹${item.price.toFixed(2)} each</p>
                            </div>
                            <div class="flex items-center">
                                <button onclick="updateCartItemQuantity('${item.productId}', -1)" class="bg-red-500 hover:bg-red-600 text-white w-7 h-7 rounded-full flex items-center justify-center text-sm mr-2">-</button>
                                <span class="font-bold text-gray-800 dark:text-white">${item.quantity}</span>
                                <button onclick="updateCartItemQuantity('${item.productId}', 1)" class="bg-green-500 hover:bg-green-600 text-white w-7 h-7 rounded-full flex items-center justify-center text-sm ml-2">+</button>
                            </div>
                            <span class="font-semibold text-gray-800 dark:text-white ml-4">₹${(item.price * item.quantity).toFixed(2)}</span>
                        </div>
                    `;
                    cartItemsDisplayDiv.innerHTML += itemDiv;
                });
            }

            cartSubtotalDropdown.textContent = `₹${subtotal.toFixed(2)}`;
            cartTaxDropdown.textContent = `₹${transportTax.toFixed(2)}`;
            cartGrandTotalDropdown.textContent = `₹${totalAmount.toFixed(2)}`;
        }

        // Toggle cart dropdown visibility
        document.getElementById('cart-button').addEventListener('click', () => {
            document.getElementById('cart-dropdown').classList.toggle('hidden');
        });

        // Close cart dropdown if clicked outside
        window.addEventListener('click', (event) => {
            const cartButton = document.getElementById('cart-button');
            const cartDropdown = document.getElementById('cart-dropdown');
            if (!cartButton.contains(event.target) && !cartDropdown.contains(event.target)) {
                cartDropdown.classList.add('hidden');
            }
        });


        // --- Product Details ---
        function showProductDetails(productId) {
            const product = products.find(p => p._id === productId);
            if (!product) return;

            document.getElementById('product-detail-name').textContent = product.name;
            document.getElementById('product-detail-image').src = product.imageUrl;
            document.getElementById('product-detail-description').textContent = product.description || 'No description available.';
            document.getElementById('product-detail-category').textContent = product.category || 'N/A';
            document.getElementById('product-detail-availability').textContent = product.isAvailable ? 'Available' : 'Out of Stock';
            document.getElementById('product-detail-availability').className = product.isAvailable ? 'text-green-500 font-semibold' : 'text-red-500 font-semibold';
            document.getElementById('product-detail-price').textContent = `₹${product.price.toFixed(2)}`;

            const addToCartBtn = document.getElementById('product-detail-add-to-cart');
            addToCartBtn.onclick = () => {
                addToCart(product._id);
                closeModal('product-detail-modal');
            };
            addToCartBtn.disabled = !product.isAvailable;
            addToCartBtn.classList.toggle('opacity-50', !product.isAvailable);
            addToCartBtn.classList.toggle('cursor-not-allowed', !product.isAvailable);

            openModal('product-detail-modal');
        }


        // --- Checkout Process ---
        document.getElementById('checkout-button-dropdown').addEventListener('click', () => {
            if (cart.length === 0) {
                alert('Your cart is empty. Please add items before checking out.'); // Replace with custom modal
                return;
            }
            const { subtotal, totalAmount } = calculateCartTotals();
            checkoutSubtotalSpan.textContent = `₹${subtotal.toFixed(2)}`;
            checkoutTransportTaxSpan.textContent = `₹${transportTax.toFixed(2)}`;
            checkoutTotalAmountSpan.textContent = `₹${totalAmount.toFixed(2)}`;
            openModal('checkout-modal');
            document.getElementById('cart-dropdown').classList.add('hidden'); // Close cart dropdown
        });

        document.getElementById('get-location-btn').addEventListener('click', () => {
            const locationStatus = document.getElementById('location-status');
            locationStatus.textContent = 'Getting your location...';
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(
                    async (position) => {
                        currentCustomerLocation = {
                            latitude: position.coords.latitude,
                            longitude: position.coords.longitude
                        };
                        document.getElementById('customer-latitude').value = currentCustomerLocation.latitude;
                        document.getElementById('customer-longitude').value = currentCustomerLocation.longitude;
                        locationStatus.textContent = `Location found! Lat: ${currentCustomerLocation.latitude.toFixed(4)}, Lon: ${currentCustomerLocation.longitude.toFixed(4)}`;
                        await calculateDeliveryCost(currentCustomerLocation);
                    },
                    (error) => {
                        console.error('Error getting location:', error);
                        locationStatus.textContent = 'Could not get location. Please enter address manually or try again.';
                        currentCustomerLocation = null;
                        transportTax = 0; // Reset transport tax if location fails
                        updateCartDisplay(); // Update totals
                    },
                    { enableHighAccuracy: true, timeout: 10000, maximumAge: 0 }
                );
            } else {
                locationStatus.textContent = 'Geolocation is not supported by your browser.';
                currentCustomerLocation = null;
                transportTax = 0; // Reset transport tax if geolocation not supported
                updateCartDisplay(); // Update totals
            }
        });

        async function calculateDeliveryCost(customerLoc) {
            if (!customerLoc || !shopLocation) {
                transportTax = 0;
                updateCartDisplay();
                return;
            }
            showLoading();
            try {
                const response = await fetch('/api/calculate-delivery-cost', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ customerLocation: customerLoc })
                });
                const data = await response.json();
                transportTax = data.transportTax;
                document.getElementById('location-status').textContent += ` (Delivery Tax: ₹${transportTax.toFixed(2)})`;
                updateCartDisplay(); // Update cart totals with new tax
                // Also update checkout modal totals if it's open
                const { subtotal, totalAmount } = calculateCartTotals();
                checkoutSubtotalSpan.textContent = `₹${subtotal.toFixed(2)}`;
                checkoutTransportTaxSpan.textContent = `₹${transportTax.toFixed(2)}`;
                checkoutTotalAmountSpan.textContent = `₹${totalAmount.toFixed(2)}`;
            } catch (error) {
                console.error('Error calculating delivery cost:', error);
                transportTax = 0; // Default to 0 on error
                document.getElementById('location-status').textContent += ' (Error calculating delivery cost)';
                updateCartDisplay();
            } finally {
                hideLoading();
            }
        }


        document.getElementById('checkout-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            showLoading();

            const formData = new FormData(e.target);
            const customerName = formData.get('customerName');
            const customerPhone = formData.get('customerPhone');
            const deliveryAddress = formData.get('deliveryAddress');
            const customerLatitude = formData.get('customerLatitude');
            const customerLongitude = formData.get('customerLongitude');

            const { subtotal, totalAmount } = calculateCartTotals();

            const orderData = {
                items: cart.map(item => ({
                    productId: item.productId,
                    name: item.name,
                    price: item.price,
                    quantity: item.quantity
                })),
                customerName,
                customerPhone,
                deliveryAddress,
                customerLocation: customerLatitude && customerLongitude ? {
                    latitude: parseFloat(customerLatitude),
                    longitude: parseFloat(customerLongitude)
                } : undefined,
                subtotal,
                transportTax,
                totalAmount
            };

            try {
                const response = await fetch('/api/order', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(orderData)
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.message || 'Failed to place order.');
                }

                const result = await response.json();
                closeModal('checkout-modal');
                cart = []; // Clear cart after successful order
                transportTax = 0; // Reset transport tax
                updateCartDisplay();

                // Show order tracking modal
                viewOrderTracking(result.orderId);

            } catch (error) {
                console.error('Error placing order:', error);
                alert(`Error placing order: ${error.message}`); // Replace with custom modal
            } finally {
                hideLoading();
            }
        });

        // --- Order Tracking ---
        async function viewOrderTracking(orderId) {
            showLoading();
            try {
                const response = await fetch(`/api/order/${orderId}`);
                const order = await response.json();
                const trackingContent = document.getElementById('order-tracking-content');
                trackingContent.innerHTML = `
                    <p><strong>Order ID:</strong> ${order._id}</p>
                    <p><strong>Status:</strong> <span class="font-bold text-green-600">${order.status}</span></p>
                    <p><strong>Total Amount:</strong> ₹${order.totalAmount.toFixed(2)}</p>
                    <p><strong>Order Date:</strong> ${new Date(order.orderDate).toLocaleString()}</p>
                    <h4 class="font-bold mt-4 mb-2">Items:</h4>
                    <ul class="list-disc list-inside space-y-1">
                        ${order.items.map(item => `
                            <li>${item.name} (x${item.quantity}) - ₹${(item.price * item.quantity).toFixed(2)}</li>
                        `).join('')}
                    </ul>
                    <p class="mt-4 text-sm text-gray-600 dark:text-gray-400">You can track your order status here. For more details, please contact us via WhatsApp using the number you provided.</p>
                `;
                openModal('order-tracking-modal');
            } catch (error) {
                console.error('Error fetching order for tracking:', error);
                alert('Failed to fetch order status. Please try again or contact support.'); // Replace with custom modal
            } finally {
                hideLoading();
            }
        }


        // Initial load
        fetchMenuAndSettings();
        updateCartDisplay(); // Initialize cart display
    </script>
</body>
</html>

