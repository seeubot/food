<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Delicious Bites - Online Menu</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        /* Base styles for black and white theme */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #000000; /* Pure black background */
            color: #ffffff; /* Pure white text */
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 1rem;
        }
        header {
            background-color: #1a1a1a; /* Dark gray for header */
            border-bottom: 1px solid #333333;
            padding: 1rem;
            box-shadow: 0 2px 4px rgba(255,255,255,0.05);
        }
        h1, h2, h3 {
            color: #ffffff; /* White for headings */
        }
        /* Card/Panel backgrounds */
        .bg-panel {
            background-color: #1a1a1a; /* Dark gray for main content panels */
            border-radius: 0.75rem;
            box-shadow: 0 4px 8px rgba(255,255,255,0.08);
            padding: 1.5rem;
        }
        /* Input field styling */
        input[type="text"],
        input[type="number"],
        input[type="url"],
        textarea,
        select {
            background-color: #222222; /* Slightly lighter dark gray for inputs */
            border: 1px solid #444444;
            color: #ffffff;
            padding: 0.5rem 0.75rem;
            border-radius: 0.375rem;
            width: 100%;
        }
        input::placeholder, textarea::placeholder {
            color: #888888; /* Lighter gray for placeholders */
        }
        /* Button styling */
        .btn-primary {
            background-color: #ffffff; /* White background */
            color: #000000; /* Black text */
            padding: 0.6rem 1.2rem;
            border-radius: 0.5rem;
            font-weight: 600;
            transition: background-color 0.2s ease-in-out;
        }
        .btn-primary:hover {
            background-color: #e0e0e0;
        }
        .btn-secondary {
            background-color: #666666; /* Darker gray for utility buttons */
            color: #ffffff;
            padding: 0.6rem 1.2rem;
            border-radius: 0.5rem;
            font-weight: 600;
            transition: background-color 0.2s ease-in-out;
        }
        .btn-secondary:hover {
            background-color: #888888;
        }
        .btn-danger {
            background-color: #ff6666; /* Light red for danger */
            color: #000000; /* Black text */
            padding: 0.6rem 1.2rem;
            border-radius: 0.5rem;
            font-weight: 600;
            transition: background-color 0.2s ease-in-out;
        }
        .btn-danger:hover {
            background-color: #ee4444;
        }
        /* Alert styling */
        .alert {
            padding: 1rem;
            border-radius: 0.5rem;
            margin-bottom: 1rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        .alert-red {
            background-color: #440000;
            color: #ff6666;
            border: 1px solid #ff6666;
        }
        .alert-yellow {
            background-color: #444400;
            color: #ffff66;
            border: 1px solid #ffff66;
        }
        .alert-green {
            background-color: #004400;
            color: #66ff66;
            border: 1px solid #66ff66;
        }

        /* Specific styles for menu items */
        .menu-item-card {
            background-color: #2a2a2a; /* Slightly lighter dark gray for cards */
            border-radius: 0.5rem;
            padding: 1rem;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            height: 100%; /* Ensure cards in a row have equal height */
        }
        .menu-item-card img {
            border-radius: 0.375rem;
            object-fit: cover;
            width: 100%;
            height: 150px; /* Fixed height for images */
        }
        .trending-badge {
            background-color: #ff6666; /* Red for trending */
            color: #000000;
            padding: 0.25rem 0.5rem;
            border-radius: 0.25rem;
            font-size: 0.75rem;
            font-weight: 700;
        }

        /* Cart specific styles */
        .cart-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.5rem 0;
            border-bottom: 1px dashed #333333;
        }
        .cart-item:last-child {
            border-bottom: none;
        }
        .cart-quantity-btn {
            background-color: #444444;
            color: #ffffff;
            border-radius: 0.25rem;
            padding: 0.1rem 0.4rem;
            font-size: 0.8rem;
            transition: background-color 0.2s;
        }
        .cart-quantity-btn:hover {
            background-color: #666666;
        }

        /* Responsive layout for main content */
        @media (min-width: 768px) {
            .main-content-grid {
                display: grid;
                grid-template-columns: 3fr 1fr; /* Menu takes 3/4, cart takes 1/4 */
                gap: 2rem;
            }
        }
        @media (max-width: 767px) {
            .main-content-grid {
                display: flex;
                flex-direction: column;
            }
            .cart-summary {
                order: -1; /* Move cart to top on small screens */
                margin-bottom: 1.5rem;
            }
        }
    </style>
</head>
<body class="min-h-screen">
    <div class="container mx-auto p-4">
        <header class="flex justify-between items-center py-4 border-b border-gray-700 mb-6">
            <h1 class="text-4xl font-bold text-white">Delicious Bites</h1>
            <nav>
                <!-- Optional: Link to admin dashboard if needed -->
                <!-- <a href="/admin/login" class="btn-secondary">Admin Login</a> -->
            </nav>
        </header>

        <main class="mt-8 main-content-grid">
            <!-- Menu Items Section -->
            <section class="menu-section">
                <h2 class="text-3xl font-bold text-white mb-6">Our Delicious Menu</h2>
                <div id="menu-items-container" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6">
                    <p class="text-gray-400 text-center col-span-full">Loading menu items...</p>
                </div>
            </section>

            <!-- Cart Summary & Checkout Section -->
            <aside class="cart-summary bg-panel p-6">
                <h2 class="text-2xl font-bold text-white mb-4">Your Cart</h2>
                <div id="cart-items-list" class="mb-4">
                    <p class="text-gray-400">Your cart is empty.</p>
                </div>
                <div class="border-t border-dashed border-gray-600 pt-4 mb-4">
                    <p class="flex justify-between text-lg font-semibold text-white">Subtotal: <span id="cart-subtotal">₹0.00</span></p>
                    <p class="flex justify-between text-lg font-semibold text-white mt-2">Delivery Fee: <span id="cart-delivery-fee">₹0.00</span></p>
                    <p class="flex justify-between text-xl font-bold text-white mt-4">Total: <span id="cart-total">₹0.00</span></p>
                </div>

                <!-- Location Input -->
                <div class="mb-6">
                    <h3 class="text-xl font-bold text-white mb-2">Your Location</h3>
                    <button id="get-my-location-btn" class="btn-secondary w-full mb-2">Get My Location</button>
                    <p id="location-display" class="text-gray-300 text-sm mb-2">Location: Not set</p>
                    <p id="location-message" class="text-sm text-gray-400 mt-2">Click "Get My Location" to automatically fill your address.</p>
                    <button id="calculate-delivery-btn" class="btn-primary w-full mt-4">Calculate Delivery Fee</button>
                </div>

                <!-- Checkout Form -->
                <form id="checkout-form" class="space-y-4">
                    <h3 class="text-xl font-bold text-white mb-2">Your Details</h3>
                    <div>
                        <label for="customer-name" class="block text-gray-300 text-sm font-bold mb-2">Your Name:</label>
                        <input type="text" id="customer-name" required>
                    </div>
                    <div>
                        <label for="customer-phone" class="block text-gray-300 text-sm font-bold mb-2">Your Phone (WhatsApp):</label>
                        <input type="text" id="customer-phone" placeholder="e.g., 91xxxxxxxxxx" required>
                    </div>
                    <div>
                        <label for="delivery-address" class="block text-gray-300 text-sm font-bold mb-2">Delivery Address:</label>
                        <textarea id="delivery-address" rows="3" required></textarea>
                    </div>
                    <div>
                        <label for="payment-method" class="block text-gray-300 text-sm font-bold mb-2">Payment Method:</label>
                        <select id="payment-method" class="w-full">
                            <option value="COD">Cash on Delivery</option>
                            <option value="Online">Online Payment</option>
                        </select>
                    </div>
                    <button type="submit" id="place-order-btn" class="btn-primary w-full">Place Order</button>
                    <p id="order-message" class="text-sm text-center mt-2"></p>
                </form>

                <!-- Order Tracking Section (Initially Hidden) -->
                <div id="order-tracking-section" class="hidden mt-8 bg-panel p-6">
                    <h3 class="text-xl font-bold text-white mb-4">Your Order Status</h3>
                    <p class="text-gray-300 mb-2">Order ID: <span id="tracking-order-id" class="font-semibold"></span></p>
                    <p class="text-gray-300 mb-2">Status: <span id="tracking-order-status" class="font-semibold"></span></p>
                    <p class="text-gray-300 mb-4">Total: <span id="tracking-order-total" class="font-semibold"></span></p>
                    <button id="refresh-order-status-btn" class="btn-secondary w-full">Refresh Status</button>
                    <p id="tracking-message" class="text-sm text-center mt-2"></p>
                </div>
            </aside>
        </main>
    </div>

    <script>
        const menuItemsContainer = document.getElementById('menu-items-container');
        const cartItemsList = document.getElementById('cart-items-list');
        const cartSubtotalSpan = document.getElementById('cart-subtotal');
        const cartDeliveryFeeSpan = document.getElementById('cart-delivery-fee');
        const cartTotalSpan = document.getElementById('cart-total');

        const getMyLocationBtn = document.getElementById('get-my-location-btn');
        const locationDisplay = document.getElementById('location-display'); // New element
        const calculateDeliveryBtn = document.getElementById('calculate-delivery-btn');
        const locationMessage = document.getElementById('location-message');

        const checkoutForm = document.getElementById('checkout-form');
        const customerNameInput = document.getElementById('customer-name');
        const customerPhoneInput = document.getElementById('customer-phone');
        const deliveryAddressInput = document.getElementById('delivery-address');
        const paymentMethodSelect = document.getElementById('payment-method');
        const placeOrderBtn = document.getElementById('place-order-btn');
        const orderMessage = document.getElementById('order-message');

        const orderTrackingSection = document.getElementById('order-tracking-section');
        const trackingOrderIdSpan = document.getElementById('tracking-order-id');
        const trackingOrderStatusSpan = document.getElementById('tracking-order-status');
        const trackingOrderTotalSpan = document.getElementById('tracking-order-total');
        const refreshOrderStatusBtn = document.getElementById('refresh-order-status-btn');
        const trackingMessage = document.getElementById('tracking-message');

        let cart = {}; // { productId: { item: {}, quantity: N } }
        let shopSettings = null;
        let currentCustomerLocation = null; // Stores {latitude, longitude}
        let currentDeliveryFee = 0;
        let currentOrderId = null; // To store the order ID for tracking

        // --- Utility Functions ---

        // Haversine distance function
        function haversineDistance(lat1, lon1, lat2, lon2) {
            const R = 6371; // Radius of Earth in kilometers
            const dLat = (lat2 - lat1) * Math.PI / 180;
            const dLon = (lon2 - lon1) * Math.PI / 180;
            const a =
                Math.sin(dLat / 2) * Math.sin(dLat / 2) +
                Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
                Math.sin(dLon / 2) * Math.sin(dLon / 2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
            return R * c; // Distance in km
        }

        function showMessage(element, message, type = 'info') {
            element.textContent = message;
            element.className = `text-sm text-center mt-2 ${type === 'error' ? 'text-red-500' : (type === 'success' ? 'text-green-500' : 'text-gray-400')}`;
        }

        function clearMessage(element) {
            element.textContent = '';
            element.className = '';
        }

        // --- Fetch Data Functions ---

        async function fetchMenuItems() {
            menuItemsContainer.innerHTML = '<p class="text-gray-400 text-center col-span-full">Loading menu items...</p>';
            try {
                const response = await fetch('/api/menu');
                if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                const menuItems = await response.json();
                displayMenuItems(menuItems);
            } catch (error) {
                console.error('Error fetching menu items:', error);
                menuItemsContainer.innerHTML = `<p class="text-red-500 text-center col-span-full">Failed to load menu: ${error.message}</p>`;
            }
        }

        async function fetchShopSettings() {
            try {
                const response = await fetch('/api/public/settings');
                if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                shopSettings = await response.json();
                console.log('Shop settings loaded:', shopSettings);
            } catch (error) {
                console.error('Error fetching shop settings:', error);
                showMessage(locationMessage, `Failed to load shop settings for delivery calculation: ${error.message}`, 'error');
            }
        }

        // --- Display Functions ---

        function displayMenuItems(items) {
            menuItemsContainer.innerHTML = '';
            if (items.length === 0) {
                menuItemsContainer.innerHTML = '<p class="text-gray-400 text-center col-span-full">No menu items available at the moment. Please check back later!</p>';
                return;
            }

            items.forEach(item => {
                const card = document.createElement('div');
                card.className = 'menu-item-card flex flex-col';
                card.innerHTML = `
                    <img src="${item.imageUrl}" alt="${item.name}" class="mb-4" onerror="this.onerror=null;this.src='https://placehold.co/300x200/cccccc/333333?text=Food+Item';">
                    <h3 class="text-xl font-bold text-white mb-2">${item.name}</h3>
                    <p class="text-gray-300 text-sm mb-3 flex-grow">${item.description || 'No description available.'}</p>
                    <div class="flex items-center justify-between mb-4">
                        <span class="text-2xl font-bold text-white">₹${item.price.toFixed(2)}</span>
                        ${item.isTrending ? '<span class="trending-badge">TRENDING</span>' : ''}
                    </div>
                    <button data-id="${item._id}" class="add-to-cart-btn btn-primary w-full">Add to Cart</button>
                `;
                menuItemsContainer.appendChild(card);
            });

            document.querySelectorAll('.add-to-cart-btn').forEach(button => {
                button.addEventListener('click', (e) => {
                    const itemId = e.target.dataset.id;
                    const item = items.find(i => i._id === itemId);
                    if (item) {
                        addToCart(item);
                    }
                });
            });
        }

        function renderCart() {
            cartItemsList.innerHTML = '';
            let subtotal = 0;

            const cartItemKeys = Object.keys(cart);
            if (cartItemKeys.length === 0) {
                cartItemsList.innerHTML = '<p class="text-gray-400">Your cart is empty.</p>';
                cartSubtotalSpan.textContent = '₹0.00';
                cartTotalSpan.textContent = '₹0.00';
                cartDeliveryFeeSpan.textContent = '₹0.00';
                currentDeliveryFee = 0; // Reset delivery fee if cart is empty
                placeOrderBtn.disabled = true;
                return;
            }

            placeOrderBtn.disabled = false; // Enable if cart has items

            cartItemKeys.forEach(productId => {
                const cartItem = cart[productId];
                const itemDiv = document.createElement('div');
                itemDiv.className = 'cart-item';
                itemDiv.innerHTML = `
                    <div>
                        <p class="text-white font-semibold">${cartItem.item.name}</p>
                        <p class="text-gray-400 text-sm">₹${cartItem.item.price.toFixed(2)} each</p>
                    </div>
                    <div class="flex items-center space-x-2">
                        <button class="cart-quantity-btn decrease-quantity" data-id="${productId}">-</button>
                        <span class="text-white">${cartItem.quantity}</span>
                        <button class="cart-quantity-btn increase-quantity" data-id="${productId}">+</button>
                        <button class="cart-quantity-btn remove-item btn-danger text-xs" data-id="${productId}">X</button>
                    </div>
                `;
                cartItemsList.appendChild(itemDiv);
                subtotal += cartItem.item.price * cartItem.quantity;
            });

            cartSubtotalSpan.textContent = `₹${subtotal.toFixed(2)}`;
            updateTotal(subtotal, currentDeliveryFee);

            // Add event listeners for quantity buttons and remove button
            document.querySelectorAll('.decrease-quantity').forEach(button => {
                button.addEventListener('click', (e) => updateCartQuantity(e.target.dataset.id, -1));
            });
            document.querySelectorAll('.increase-quantity').forEach(button => {
                button.addEventListener('click', (e) => updateCartQuantity(e.target.dataset.id, 1));
            });
            document.querySelectorAll('.remove-item').forEach(button => {
                button.addEventListener('click', (e) => removeFromCart(e.target.dataset.id));
            });
        }

        function addToCart(item) {
            if (cart[item._id]) {
                cart[item._id].quantity++;
            } else {
                cart[item._id] = { item: item, quantity: 1 };
            }
            renderCart();
            calculateDeliveryFee(); // Recalculate delivery fee when cart changes
        }

        function updateCartQuantity(productId, change) {
            if (cart[productId]) {
                cart[productId].quantity += change;
                if (cart[productId].quantity <= 0) {
                    delete cart[productId];
                }
            }
            renderCart();
            calculateDeliveryFee(); // Recalculate delivery fee when cart changes
        }

        function removeFromCart(productId) {
            delete cart[productId];
            renderCart();
            calculateDeliveryFee(); // Recalculate delivery fee when cart changes
        }

        function updateTotal(subtotal, deliveryFee) {
            const total = subtotal + deliveryFee;
            cartTotalSpan.textContent = `₹${total.toFixed(2)}`;
        }

        // --- Location & Delivery Fee Logic ---

        // New function to reverse geocode coordinates to an address
        async function reverseGeocode(lat, lon) {
            const nominatimUrl = `https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lon}&zoom=18&addressdetails=1`;
            try {
                const response = await fetch(nominatimUrl, {
                    headers: {
                        'User-Agent': 'DeliciousBitesFoodApp/1.0 (your-email@example.com)' // Required by Nominatim
                    }
                });
                if (!response.ok) throw new Error(`HTTP error! Status: ${response.status}`);
                const data = await response.json();
                return data.display_name || `Lat: ${lat.toFixed(4)}, Lon: ${lon.toFixed(4)}`;
            } catch (error) {
                console.error('Error reverse geocoding:', error);
                return `Could not get address for Lat: ${lat.toFixed(4)}, Lon: ${lon.toFixed(4)}`;
            }
        }

        getMyLocationBtn.addEventListener('click', () => {
            clearMessage(locationMessage);
            locationDisplay.textContent = 'Location: Getting...';
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(
                    async (position) => {
                        const lat = position.coords.latitude;
                        const lon = position.coords.longitude;
                        currentCustomerLocation = { latitude: lat, longitude: lon };

                        // Reverse geocode and populate address field
                        const address = await reverseGeocode(lat, lon);
                        deliveryAddressInput.value = address;
                        locationDisplay.textContent = `Location: ${address}`;
                        showMessage(locationMessage, 'Location retrieved and address filled. You can edit the address if needed.', 'success');
                        calculateDeliveryFee();
                    },
                    (error) => {
                        console.error('Geolocation error:', error);
                        locationDisplay.textContent = 'Location: Not set';
                        showMessage(locationMessage, `Error getting location: ${error.message}. Please try again.`, 'error');
                        currentCustomerLocation = null;
                        deliveryAddressInput.value = ''; // Clear address if location fails
                    },
                    { enableHighAccuracy: true, timeout: 10000, maximumAge: 0 }
                );
            } else {
                locationDisplay.textContent = 'Location: Not set';
                showMessage(locationMessage, 'Geolocation is not supported by your browser. Please manually enter your full delivery address.', 'error');
                currentCustomerLocation = null;
            }
        });

        calculateDeliveryBtn.addEventListener('click', calculateDeliveryFee);

        async function calculateDeliveryFee() {
            clearMessage(locationMessage);

            if (!currentCustomerLocation || isNaN(currentCustomerLocation.latitude) || isNaN(currentCustomerLocation.longitude)) {
                showMessage(locationMessage, 'Please use "Get My Location" first to determine your coordinates.', 'error');
                cartDeliveryFeeSpan.textContent = '₹0.00';
                currentDeliveryFee = 0;
                updateTotal(parseFloat(cartSubtotalSpan.textContent.replace('₹', '')), currentDeliveryFee);
                return;
            }

            if (!shopSettings || !shopSettings.shopLocation || !shopSettings.deliveryRates) {
                showMessage(locationMessage, 'Shop settings not loaded. Cannot calculate delivery fee.', 'error');
                cartDeliveryFeeSpan.textContent = '₹0.00';
                currentDeliveryFee = 0;
                updateTotal(parseFloat(cartSubtotalSpan.textContent.replace('₹', '')), currentDeliveryFee);
                return;
            }

            try {
                const response = await fetch('/api/calculate-delivery-cost', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ customerLocation: currentCustomerLocation })
                });
                const result = await response.json();
                if (response.ok) {
                    currentDeliveryFee = result.transportTax;
                    cartDeliveryFeeSpan.textContent = `₹${currentDeliveryFee.toFixed(2)}`;
                    updateTotal(parseFloat(cartSubtotalSpan.textContent.replace('₹', '')), currentDeliveryFee);
                    showMessage(locationMessage, `Delivery to your location (${result.distance.toFixed(2)} km) costs ₹${currentDeliveryFee.toFixed(2)}.`, 'success');
                } else {
                    currentDeliveryFee = 0;
                    cartDeliveryFeeSpan.textContent = '₹0.00';
                    updateTotal(parseFloat(cartSubtotalSpan.textContent.replace('₹', '')), currentDeliveryFee);
                    showMessage(locationMessage, `Error calculating delivery: ${result.message || response.statusText}`, 'error');
                }
            } catch (error) {
                console.error('Error calculating delivery fee:', error);
                currentDeliveryFee = 0;
                cartDeliveryFeeSpan.textContent = '₹0.00';
                updateTotal(parseFloat(cartSubtotalSpan.textContent.replace('₹', '')), currentDeliveryFee);
                showMessage(locationMessage, `Network error calculating delivery: ${error.message}`, 'error');
            }
        }

        // --- Order Placement Logic ---

        checkoutForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            clearMessage(orderMessage);

            const customerName = customerNameInput.value.trim();
            const customerPhone = customerPhoneInput.value.trim();
            const deliveryAddress = deliveryAddressInput.value.trim();
            const paymentMethod = paymentMethodSelect.value;

            if (Object.keys(cart).length === 0) {
                showMessage(orderMessage, 'Your cart is empty. Please add items before placing an order.', 'error');
                return;
            }
            if (!customerName || !customerPhone || !deliveryAddress) {
                showMessage(orderMessage, 'Please fill in all your details (Name, Phone, Address).', 'error');
                return;
            }
            if (!currentCustomerLocation || isNaN(currentCustomerLocation.latitude) || isNaN(currentCustomerLocation.longitude)) {
                 showMessage(orderMessage, 'Please use "Get My Location" to determine your coordinates before placing an order.', 'error');
                 return;
            }

            const orderItems = Object.values(cart).map(cartItem => ({
                menuItemId: cartItem.item._id,
                name: cartItem.item.name,
                quantity: cartItem.quantity,
                price: cartItem.item.price
            }));

            const subtotal = parseFloat(cartSubtotalSpan.textContent.replace('₹', ''));
            const totalAmount = parseFloat(cartTotalSpan.textContent.replace('₹', ''));

            const orderData = {
                customerName,
                customerPhone,
                items: orderItems,
                deliveryAddress,
                customerLocation: currentCustomerLocation,
                subtotal,
                transportTax: currentDeliveryFee,
                totalAmount,
                paymentMethod
            };

            placeOrderBtn.disabled = true;
            showMessage(orderMessage, 'Placing your order...', 'info');

            try {
                const response = await fetch('/api/orders', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(orderData)
                });
                const result = await response.json();

                if (response.ok) {
                    showMessage(orderMessage, 'Order placed successfully! You will receive a WhatsApp confirmation.', 'success');
                    currentOrderId = result.order.order._id; // Store full order ID for tracking
                    displayOrderTracking(result.order.order); // Show tracking section
                    cart = {}; // Clear cart after successful order
                    renderCart(); // Update cart display
                    checkoutForm.reset(); // Clear form
                    clearMessage(locationMessage); // Clear location message
                    locationDisplay.textContent = 'Location: Not set';
                    currentCustomerLocation = null;
                } else {
                    showMessage(orderMessage, `Error placing order: ${result.message || response.statusText}`, 'error');
                }
            } catch (error) {
                console.error('Error placing order:', error);
                showMessage(orderMessage, `Network error placing order: ${error.message}`, 'error');
            } finally {
                placeOrderBtn.disabled = false;
            }
        });

        // --- Order Tracking Logic ---

        function displayOrderTracking(order) {
            orderTrackingSection.classList.remove('hidden');
            trackingOrderIdSpan.textContent = order._id.substring(0, 8) + '...';
            trackingOrderStatusSpan.textContent = order.status;
            trackingOrderTotalSpan.textContent = `₹${order.totalAmount.toFixed(2)}`;
            trackingMessage.textContent = ''; // Clear previous messages
        }

        refreshOrderStatusBtn.addEventListener('click', async () => {
            if (!currentOrderId) {
                showMessage(trackingMessage, 'No order to track.', 'error');
                return;
            }
            showMessage(trackingMessage, 'Refreshing status...', 'info');
            refreshOrderStatusBtn.disabled = true;

            try {
                const response = await fetch(`/api/order/${currentOrderId}`);
                const result = await response.json();

                if (response.ok) {
                    trackingOrderStatusSpan.textContent = result.status;
                    showMessage(trackingMessage, 'Status updated!', 'success');
                } else {
                    showMessage(trackingMessage, `Error refreshing status: ${result.message || response.statusText}`, 'error');
                }
            } catch (error) {
                console.error('Error refreshing order status:', error);
                showMessage(trackingMessage, `Network error: ${error.message}`, 'error');
            } finally {
                refreshOrderStatusBtn.disabled = false;
            }
        });


        // --- Initial Load ---
        document.addEventListener('DOMContentLoaded', () => {
            fetchMenuItems();
            fetchShopSettings();
            renderCart(); // Initialize cart display
        });
    </script>
</body>
</html>

