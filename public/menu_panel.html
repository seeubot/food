<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Delicious Bites - Online Menu</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" xintegrity="sha512-Fo3rlrZj/k7ujTnHg4CGR2D7kSs0V4LLanw2qksYuRlEzO+tcaEPQogQ0KaoGN26/zrn20ImR1DfuLWnN Oo7aBA==" crossorigin="anonymous" referrerpolicy="no-referrer" />
    <style>
        body { font-family: 'Inter', sans-serif; }
        .dark-mode { background-color: #1a202c; color: #e2e8f0; }
        .dark-mode .bg-white { background-color: #2d3748; }
        .dark-mode .text-gray-800 { color: #e2e8f0; }
        .dark-mode input, .dark-mode textarea { background-color: #4a5568; border-color: #4a5568; color: #e2e8f0; }
        .dark-mode input:focus, .dark-mode textarea:focus { border-color: #63b3ed; }
        .dark-mode .shadow-md { box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06); }
        .dark-mode .border-gray-200 { border-color: #4a5568; }
        .dark-mode .text-gray-700 { color: #cbd5e0; }
        .dark-mode .hover\\:bg-gray-100:hover { background-color: #4a5568; }
        .dark-mode .placeholder-gray-500::placeholder { color: #cbd5e0; }
        .dark-mode .text-gray-500 { color: #a0aec0; }
        .dark-mode .bg-gray-50 { background-color: #4a5568; }
        .dark-mode .bg-gray-100 { background-color: #2d3748; }
        .dark-mode .border { border-color: #4a5568; }
        .dark-mode .text-gray-600 { color: #a0aec0; }

        /* Custom scrollbar for dark mode */
        .dark-mode ::-webkit-scrollbar {
            width: 8px;
        }
        .dark-mode ::-webkit-scrollbar-track {
            background: #2d3748;
        }
        .dark-mode ::-webkit-scrollbar-thumb {
            background: #63b3ed;
            border-radius: 4px;
        }
        .dark-mode ::-webkit-scrollbar-thumb:hover {
            background: #4299e1;
        }

        /* Modal specific styles */
        .modal {
            display: none; /* Hidden by default */
            position: fixed; /* Stay in place */
            z-index: 1000; /* Sit on top */
            left: 0;
            top: 0;
            width: 100%; /* Full width */
            height: 100%; /* Full height */
            overflow: auto; /* Enable scroll if needed */
            background-color: rgba(0,0,0,0.4); /* Black w/ opacity */
            align-items: center;
            justify-content: center;
        }
        .modal-content {
            background-color: #fefefe;
            margin: auto;
            padding: 20px;
            border-radius: 8px;
            width: 90%;
            max-width: 600px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
            position: relative;
        }
        .dark-mode .modal-content {
            background-color: #2d3748;
            color: #e2e8f0;
        }
        .close-button {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
            position: absolute;
            top: 10px;
            right: 20px;
        }
        .close-button:hover,
        .close-button:focus {
            color: #000;
            text-decoration: none;
            cursor: pointer;
        }
        .dark-mode .close-button {
            color: #e2e8f0;
        }
        .dark-mode .close-button:hover,
        .dark-mode .close-button:focus {
            color: #cbd5e0;
        }
        .cart-item-image {
            width: 60px;
            height: 60px;
            object-fit: cover;
            border-radius: 8px;
        }
    </style>
</head>
<body class="bg-gray-100 text-gray-800 dark-mode min-h-screen flex flex-col">

    <!-- Header -->
    <header class="bg-white shadow-md p-4 flex justify-between items-center sticky top-0 z-50">
        <h1 id="shopNameHeader" class="text-2xl font-bold">Delicious Bites</h1>
        <div class="flex items-center space-x-4">
            <button id="darkModeToggle" class="p-2 rounded-full bg-gray-200 dark:bg-gray-700 text-gray-700 dark:text-gray-300 hover:bg-gray-300 dark:hover:bg-gray-600 transition duration-200">
                <i class="fas fa-moon" id="moonIcon"></i>
                <i class="fas fa-sun hidden" id="sunIcon"></i>
            </button>
            <button id="viewCartButton" class="relative bg-blue-500 hover:bg-blue-600 text-white font-semibold py-2 px-4 rounded-full transition duration-300 ease-in-out">
                <i class="fas fa-shopping-cart mr-2"></i>View Cart
                <span id="cartItemCount" class="absolute -top-2 -right-2 bg-red-600 text-white text-xs font-bold rounded-full h-5 w-5 flex items-center justify-center">0</span>
            </button>
        </div>
    </header>

    <!-- Main Content Area -->
    <main class="flex-1 p-4 md:p-8">
        <h2 class="text-3xl font-bold mb-6 text-center">Our Delicious Menu</h2>

        <div id="menuCategories" class="flex flex-wrap justify-center gap-2 mb-6">
            <!-- Category buttons will be loaded here -->
        </div>

        <div id="menuList" class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-6">
            <!-- Menu items will be loaded here -->
            <p class="text-center text-gray-500 dark:text-gray-400 col-span-full">Loading menu items...</p>
        </div>
    </main>

    <!-- Modals -->

    <!-- Product Details Modal -->
    <div id="productDetailsModal" class="modal">
        <div class="modal-content dark:bg-gray-800">
            <span class="close-button">&times;</span>
            <div id="modalProductDetails" class="flex flex-col md:flex-row gap-6">
                <img id="modalProductImage" src="" alt="Product Image" class="w-full md:w-1/2 h-64 object-cover rounded-lg shadow-md">
                <div class="flex-1">
                    <h3 id="modalProductName" class="text-3xl font-bold mb-2 text-gray-800 dark:text-white"></h3>
                    <p id="modalProductDescription" class="text-gray-700 dark:text-gray-300 mb-4"></p>
                    <p class="text-2xl font-bold text-green-600 mb-4">₹<span id="modalProductPrice"></span></p>
                    <p class="text-sm text-gray-500 dark:text-gray-400 mb-2">Category: <span id="modalProductCategory"></span></p>
                    <p class="text-sm text-gray-500 dark:text-gray-400 mb-4">Status: <span id="modalProductAvailability" class="font-semibold"></span></p>
                    <div class="flex items-center space-x-4 mt-4">
                        <button id="decreaseQuantity" class="bg-gray-300 dark:bg-gray-700 text-gray-800 dark:text-white px-3 py-1 rounded-full text-lg font-bold hover:bg-gray-400 dark:hover:bg-gray-600 transition duration-200">-</button>
                        <span id="productQuantity" class="text-xl font-bold">1</span>
                        <button id="increaseQuantity" class="bg-gray-300 dark:bg-gray-700 text-gray-800 dark:text-white px-3 py-1 rounded-full text-lg font-bold hover:bg-gray-400 dark:hover:bg-gray-600 transition duration-200">+</button>
                    </div>
                    <button id="addToCartModalButton" class="mt-6 bg-blue-500 hover:bg-blue-600 text-white font-bold py-3 px-6 rounded-full w-full transition duration-300 ease-in-out">
                        Add to Cart
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Cart Modal -->
    <div id="cartModal" class="modal">
        <div class="modal-content dark:bg-gray-800">
            <span class="close-button">&times;</span>
            <h3 class="text-2xl font-bold mb-4 text-gray-800 dark:text-white">Your Cart</h3>
            <div id="cartItemsList" class="space-y-4 max-h-80 overflow-y-auto pr-2">
                <!-- Cart items will be loaded here -->
                <p class="text-center text-gray-500 dark:text-gray-400">Your cart is empty.</p>
            </div>
            <div class="mt-6 border-t pt-4 dark:border-gray-700">
                <div class="flex justify-between items-center mb-2">
                    <span class="text-lg font-semibold">Subtotal:</span>
                    <span id="cartSubtotal" class="text-lg font-semibold">₹0.00</span>
                </div>
                <div class="flex justify-between items-center mb-2">
                    <span class="text-lg font-semibold">Transport Tax:</span>
                    <span id="cartTransportTax" class="text-lg font-semibold text-orange-500">₹0.00</span>
                </div>
                <div class="flex justify-between items-center text-xl font-bold mb-4">
                    <span>Total:</span>
                    <span id="cartTotal">₹0.00</span>
                </div>

                <div id="locationInputSection" class="space-y-3 mb-4">
                    <p class="text-sm text-gray-600 dark:text-gray-400">Enter your location to calculate delivery tax:</p>
                    <button id="detectLocationButton" class="bg-purple-500 hover:bg-purple-600 text-white font-semibold py-2 px-4 rounded-full w-full transition duration-300 ease-in-out flex items-center justify-center">
                        <i class="fas fa-map-marker-alt mr-2"></i> Detect My Location
                    </button>
                    <p id="locationStatus" class="text-sm text-gray-500 dark:text-gray-400 text-center"></p>
                </div>

                <div id="checkoutFormSection" class="space-y-4 hidden">
                    <h4 class="text-xl font-semibold mb-2">Delivery Details</h4>
                    <div>
                        <label for="customerName" class="block text-gray-700 dark:text-gray-300 text-sm font-bold mb-1">Your Name:</label>
                        <input type="text" id="customerName" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline dark:bg-gray-700 dark:border-gray-600 dark:text-white" placeholder="John Doe" required>
                    </div>
                    <div>
                        <label for="customerPhone" class="block text-gray-700 dark:text-gray-300 text-sm font-bold mb-1">WhatsApp Number (e.g., 91XXXXXXXXXX):</label>
                        <input type="tel" id="customerPhone" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline dark:bg-gray-700 dark:border-gray-600 dark:text-white" placeholder="918897350151" required>
                    </div>
                    <div>
                        <label for="deliveryAddress" class="block text-gray-700 dark:text-gray-300 text-sm font-bold mb-1">Delivery Address:</label>
                        <textarea id="deliveryAddress" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline dark:bg-gray-700 dark:border-gray-600 dark:text-white" rows="3" placeholder="Flat No, Building, Street, Landmark" required></textarea>
                    </div>
                    <button id="placeOrderButton" class="bg-green-500 hover:bg-green-600 text-white font-bold py-3 px-6 rounded-full w-full transition duration-300 ease-in-out">
                        Place Order
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Order Confirmation/Tracking Modal -->
    <div id="orderConfirmationModal" class="modal">
        <div class="modal-content dark:bg-gray-800 text-center">
            <span class="close-button">&times;</span>
            <h3 class="text-2xl font-bold mb-4 text-gray-800 dark:text-white">Order Placed!</h3>
            <p class="text-gray-700 dark:text-gray-300 mb-4">Thank you for your order!</p>
            <p class="text-lg font-semibold mb-2">Your Order ID: <span id="confirmedOrderId" class="text-blue-600"></span></p>
            <p class="text-gray-700 dark:text-gray-300 mb-6">You will receive updates on your WhatsApp number.</p>
            <button id="trackOrderButton" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-3 px-6 rounded-full w-full transition duration-300 ease-in-out">
                Track My Order
            </button>
        </div>
    </div>

    <!-- Order Tracking Details Modal -->
    <div id="orderTrackingModal" class="modal">
        <div class="modal-content dark:bg-gray-800">
            <span class="close-button">&times;</span>
            <h3 class="text-2xl font-bold mb-4 text-gray-800 dark:text-white">Order Tracking</h3>
            <div id="trackingDetails" class="space-y-2 text-gray-700 dark:text-gray-300">
                <!-- Tracking details will be populated here -->
            </div>
            <div id="mapContainer" class="mt-4 h-64 bg-gray-200 dark:bg-gray-700 rounded-lg overflow-hidden">
                <!-- Map will be loaded here -->
            </div>
            <p class="text-sm text-gray-600 dark:text-gray-400 mt-2">Map shows shop location (red) and customer location (blue).</p>
        </div>
    </div>


    <script>
        const API_BASE = ''; // Base path for API calls (empty string for relative path)

        // Dark Mode Toggle
        const darkModeToggle = document.getElementById('darkModeToggle');
        const moonIcon = document.getElementById('moonIcon');
        const sunIcon = document.getElementById('sunIcon');

        function setDarkMode(isDark) {
            if (isDark) {
                document.body.classList.add('dark-mode');
                moonIcon.classList.add('hidden');
                sunIcon.classList.remove('hidden');
            } else {
                document.body.classList.remove('dark-mode');
                moonIcon.classList.remove('hidden');
                sunIcon.classList.add('hidden');
            }
            localStorage.setItem('darkMode', isDark);
        }

        // Initialize dark mode based on local storage or system preference
        const savedDarkMode = localStorage.getItem('darkMode');
        if (savedDarkMode === 'true') {
            setDarkMode(true);
        } else if (savedDarkMode === null && window.matchMedia('(prefers-color-scheme: dark)').matches) {
            setDarkMode(true);
        } else {
            setDarkMode(false);
        }

        darkModeToggle.addEventListener('click', () => {
            setDarkMode(!document.body.classList.contains('dark-mode'));
        });

        // Global state
        let menuItems = [];
        let cart = JSON.parse(localStorage.getItem('cart')) || [];
        let shopSettings = null;
        let customerCurrentLocation = null;
        let currentTransportTax = 0;

        // Elements
        const shopNameHeader = document.getElementById('shopNameHeader');
        const menuList = document.getElementById('menuList');
        const menuCategories = document.getElementById('menuCategories');
        const cartItemCount = document.getElementById('cartItemCount');
        const viewCartButton = document.getElementById('viewCartButton');
        const cartModal = document.getElementById('cartModal');
        const cartItemsList = document.getElementById('cartItemsList');
        const cartSubtotalSpan = document.getElementById('cartSubtotal');
        const cartTransportTaxSpan = document.getElementById('cartTransportTax');
        const cartTotalSpan = document.getElementById('cartTotal');
        const detectLocationButton = document.getElementById('detectLocationButton');
        const locationStatus = document.getElementById('locationStatus');
        const checkoutFormSection = document.getElementById('checkoutFormSection');
        const customerNameInput = document.getElementById('customerName');
        const customerPhoneInput = document.getElementById('customerPhone');
        const deliveryAddressInput = document.getElementById('deliveryAddress');
        const placeOrderButton = document.getElementById('placeOrderButton');
        const productDetailsModal = document.getElementById('productDetailsModal');
        const modalProductImage = document.getElementById('modalProductImage');
        const modalProductName = document.getElementById('modalProductName');
        const modalProductDescription = document.getElementById('modalProductDescription');
        const modalProductPrice = document.getElementById('modalProductPrice');
        const modalProductCategory = document.getElementById('modalProductCategory');
        const modalProductAvailability = document.getElementById('modalProductAvailability');
        const decreaseQuantityButton = document.getElementById('decreaseQuantity');
        const increaseQuantityButton = document.getElementById('increaseQuantity');
        const productQuantitySpan = document.getElementById('productQuantity');
        const addToCartModalButton = document.getElementById('addToCartModalButton');
        let currentProductForModal = null;
        let currentProductQuantity = 1;

        const orderConfirmationModal = document.getElementById('orderConfirmationModal');
        const confirmedOrderIdSpan = document.getElementById('confirmedOrderId');
        const trackOrderButton = document.getElementById('trackOrderButton');
        const orderTrackingModal = document.getElementById('orderTrackingModal');
        const trackingDetailsDiv = document.getElementById('trackingDetails');
        const mapContainer = document.getElementById('mapContainer');

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            fetchShopSettings();
            fetchMenu();
            updateCartDisplay();
        });

        // --- Utility Functions ---
        function alertMessage(message, type = 'info') {
            const existingAlert = document.getElementById('customAlert');
            if (existingAlert) existingAlert.remove();

            const alertDiv = document.createElement('div');
            alertDiv.id = 'customAlert';
            alertDiv.className = `fixed top-4 right-4 p-4 rounded-lg shadow-lg text-white z-[1001] transition-all duration-300 ease-in-out transform translate-x-0 opacity-100`;

            if (type === 'success') {
                alertDiv.classList.add('bg-green-500');
            } else if (type === 'error') {
                alertDiv.classList.add('bg-red-500');
            } else {
                alertDiv.classList.add('bg-blue-500');
            }

            alertDiv.innerHTML = `
                <div class="flex items-center justify-between">
                    <span>${message}</span>
                    <button class="ml-4 text-white opacity-75 hover:opacity-100" onclick="this.parentElement.parentElement.remove();">&times;</button>
                </div>
            `;
            document.body.appendChild(alertDiv);

            setTimeout(() => {
                alertDiv.classList.add('translate-x-full', 'opacity-0');
                alertDiv.addEventListener('transitionend', () => alertDiv.remove());
            }, 3000);
        }

        // Close modal
        document.querySelectorAll('.modal .close-button').forEach(button => {
            button.addEventListener('click', (event) => {
                event.target.closest('.modal').style.display = 'none';
            });
        });

        // Close modal when clicking outside
        window.addEventListener('click', (event) => {
            if (event.target.classList.contains('modal')) {
                event.target.style.display = 'none';
            }
        });

        // --- Shop Settings ---
        async function fetchShopSettings() {
            try {
                const response = await fetch(`${API_BASE}/api/public/settings`);
                shopSettings = await response.json();
                if (shopSettings && shopSettings.shopName) {
                    shopNameHeader.textContent = shopSettings.shopName;
                }
            } catch (error) {
                console.error('Error fetching shop settings:', error);
                alertMessage('Failed to load shop settings.', 'error');
            }
        }

        // --- Menu Display ---
        async function fetchMenu() {
            menuList.innerHTML = '<p class="text-center text-gray-500 dark:text-gray-400 col-span-full">Loading menu items...</p>';
            try {
                const response = await fetch(`${API_BASE}/api/menu`);
                menuItems = await response.json();
                if (menuItems.length === 0) {
                    menuList.innerHTML = '<p class="text-center text-gray-500 dark:text-gray-400 col-span-full">No menu items available at the moment. Please check back later!</p>';
                    return;
                }
                renderCategories(menuItems);
                renderMenuItems(menuItems);
            } catch (error) {
                console.error('Error fetching menu:', error);
                menuList.innerHTML = '<p class="text-center text-red-500 col-span-full">Failed to load menu. Please try again.</p>';
            }
        }

        function renderCategories(items) {
            const categories = [...new Set(items.map(item => item.category))].sort();
            menuCategories.innerHTML = '<button class="category-button bg-blue-500 text-white font-semibold py-2 px-4 rounded-full transition duration-300 ease-in-out active-category" data-category="all">All</button>';
            categories.forEach(category => {
                menuCategories.insertAdjacentHTML('beforeend', `
                    <button class="category-button bg-gray-200 dark:bg-gray-700 text-gray-700 dark:text-gray-300 font-semibold py-2 px-4 rounded-full hover:bg-gray-300 dark:hover:bg-gray-600 transition duration-200" data-category="${category}">${category}</button>
                `);
            });

            document.querySelectorAll('.category-button').forEach(button => {
                button.addEventListener('click', (event) => {
                    document.querySelectorAll('.category-button').forEach(btn => {
                        btn.classList.remove('active-category', 'bg-blue-500', 'text-white');
                        btn.classList.add('bg-gray-200', 'dark:bg-gray-700', 'text-gray-700', 'dark:text-gray-300');
                    });
                    event.target.classList.add('active-category', 'bg-blue-500', 'text-white');
                    event.target.classList.remove('bg-gray-200', 'dark:bg-gray-700', 'text-gray-700', 'dark:text-gray-300');

                    const selectedCategory = event.target.dataset.category;
                    const filteredItems = selectedCategory === 'all' ? menuItems : menuItems.filter(item => item.category === selectedCategory);
                    renderMenuItems(filteredItems);
                });
            });
        }

        function renderMenuItems(items) {
            menuList.innerHTML = '';
            if (items.length === 0) {
                menuList.innerHTML = '<p class="text-center text-gray-500 dark:text-gray-400 col-span-full">No items in this category.</p>';
                return;
            }
            items.forEach(item => {
                const itemCard = `
                    <div class="bg-white dark:bg-gray-800 p-4 rounded-lg shadow-md flex flex-col items-center text-center cursor-pointer hover:shadow-lg transition duration-200" data-product-id="${item._id}">
                        <img src="${item.imageUrl || 'https://placehold.co/300x200/cccccc/333333?text=Food+Item'}" alt="${item.name}" class="w-full h-40 object-cover rounded-md mb-3">
                        <h3 class="text-xl font-semibold">${item.name}</h3>
                        <p class="text-gray-600 dark:text-gray-400 text-sm mb-2 line-clamp-2">${item.description || 'No description'}</p>
                        <p class="text-2xl font-bold text-green-600 mt-auto">₹${item.price.toFixed(2)}</p>
                        <button class="add-to-cart-button mt-4 bg-blue-500 hover:bg-blue-600 text-white font-semibold py-2 px-4 rounded-full transition duration-300 ease-in-out" data-product-id="${item._id}">
                            Add to Cart
                        </button>
                    </div>
                `;
                menuList.insertAdjacentHTML('beforeend', itemCard);
            });

            document.querySelectorAll('.add-to-cart-button').forEach(button => {
                button.addEventListener('click', (event) => {
                    event.stopPropagation(); // Prevent opening product details modal
                    const productId = event.target.dataset.productId;
                    const product = menuItems.find(item => item._id === productId);
                    if (product) {
                        addToCart(product, 1);
                    }
                });
            });

            document.querySelectorAll('#menuList > div').forEach(card => {
                card.addEventListener('click', (event) => {
                    const productId = event.currentTarget.dataset.productId;
                    const product = menuItems.find(item => item._id === productId);
                    if (product) {
                        showProductDetails(product);
                    }
                });
            });
        }

        function showProductDetails(product) {
            currentProductForModal = product;
            currentProductQuantity = 1; // Reset quantity for new modal opening

            modalProductImage.src = product.imageUrl || 'https://placehold.co/300x200/cccccc/333333?text=Food+Item';
            modalProductName.textContent = product.name;
            modalProductDescription.textContent = product.description || 'No description available.';
            modalProductPrice.textContent = product.price.toFixed(2);
            modalProductCategory.textContent = product.category;
            modalProductAvailability.textContent = product.isAvailable ? 'Available' : 'Not Available';
            modalProductAvailability.classList.toggle('text-green-500', product.isAvailable);
            modalProductAvailability.classList.toggle('text-red-500', !product.isAvailable);
            productQuantitySpan.textContent = currentProductQuantity;

            addToCartModalButton.disabled = !product.isAvailable;
            addToCartModalButton.textContent = product.isAvailable ? 'Add to Cart' : 'Not Available';

            productDetailsModal.style.display = 'flex';
        }

        decreaseQuantityButton.addEventListener('click', () => {
            if (currentProductQuantity > 1) {
                currentProductQuantity--;
                productQuantitySpan.textContent = currentProductQuantity;
            }
        });

        increaseQuantityButton.addEventListener('click', () => {
            currentProductQuantity++;
            productQuantitySpan.textContent = currentProductQuantity;
        });

        addToCartModalButton.addEventListener('click', () => {
            if (currentProductForModal && currentProductForModal.isAvailable) {
                addToCart(currentProductForModal, currentProductQuantity);
                productDetailsModal.style.display = 'none';
            }
        });


        // --- Cart Management ---
        function addToCart(product, quantity) {
            const existingItemIndex = cart.findIndex(item => item.productId === product._id);
            if (existingItemIndex > -1) {
                cart[existingItemIndex].quantity += quantity;
            } else {
                cart.push({
                    productId: product._id,
                    name: product.name,
                    price: product.price,
                    imageUrl: product.imageUrl,
                    quantity: quantity
                });
            }
            localStorage.setItem('cart', JSON.stringify(cart));
            updateCartDisplay();
            alertMessage(`${quantity}x ${product.name} added to cart!`, 'success');
        }

        function removeFromCart(productId) {
            cart = cart.filter(item => item.productId !== productId);
            localStorage.setItem('cart', JSON.stringify(cart));
            updateCartDisplay();
            alertMessage('Item removed from cart.', 'info');
        }

        function updateCartItemQuantity(productId, newQuantity) {
            const item = cart.find(item => item.productId === productId);
            if (item) {
                item.quantity = newQuantity;
                if (item.quantity <= 0) {
                    removeFromCart(productId);
                } else {
                    localStorage.setItem('cart', JSON.stringify(cart));
                    updateCartDisplay();
                }
            }
        }

        function calculateCartTotals() {
            const subtotal = cart.reduce((sum, item) => sum + (item.price * item.quantity), 0);
            const total = subtotal + currentTransportTax;
            return { subtotal, total };
        }

        function updateCartDisplay() {
            cartItemCount.textContent = cart.reduce((sum, item) => sum + item.quantity, 0);
            cartItemsList.innerHTML = '';

            if (cart.length === 0) {
                cartItemsList.innerHTML = '<p class="text-center text-gray-500 dark:text-gray-400">Your cart is empty.</p>';
                checkoutFormSection.classList.add('hidden');
                document.getElementById('locationInputSection').classList.remove('hidden');
                customerCurrentLocation = null;
                currentTransportTax = 0;
                locationStatus.textContent = '';
            } else {
                cart.forEach(item => {
                    const cartItemHtml = `
                        <div class="flex items-center space-x-4 bg-gray-50 dark:bg-gray-700 p-3 rounded-lg shadow-sm">
                            <img src="${item.imageUrl || 'https://placehold.co/60x60/cccccc/333333?text=Item'}" alt="${item.name}" class="cart-item-image">
                            <div class="flex-1">
                                <p class="font-semibold">${item.name}</p>
                                <p class="text-sm text-gray-600 dark:text-gray-400">₹${item.price.toFixed(2)} x ${item.quantity}</p>
                            </div>
                            <div class="flex items-center space-x-2">
                                <button class="cart-quantity-decrease bg-gray-200 dark:bg-gray-600 text-gray-800 dark:text-white px-2 py-1 rounded-full text-sm" data-product-id="${item.productId}">-</button>
                                <span class="font-medium">${item.quantity}</span>
                                <button class="cart-quantity-increase bg-gray-200 dark:bg-gray-600 text-gray-800 dark:text-white px-2 py-1 rounded-full text-sm" data-product-id="${item.productId}">+</button>
                                <button class="remove-from-cart-button text-red-500 hover:text-red-700 p-1 rounded-full" data-product-id="${item.productId}">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </div>
                    `;
                    cartItemsList.insertAdjacentHTML('beforeend', cartItemHtml);
                });

                document.querySelectorAll('.remove-from-cart-button').forEach(button => {
                    button.addEventListener('click', (event) => {
                        removeFromCart(event.target.closest('button').dataset.productId);
                    });
                });

                document.querySelectorAll('.cart-quantity-decrease').forEach(button => {
                    button.addEventListener('click', (event) => {
                        const productId = event.target.closest('button').dataset.productId;
                        const item = cart.find(i => i.productId === productId);
                        if (item && item.quantity > 1) {
                            updateCartItemQuantity(productId, item.quantity - 1);
                        } else if (item && item.quantity === 1) {
                            removeFromCart(productId); // Remove if quantity becomes 0
                        }
                    });
                });

                document.querySelectorAll('.cart-quantity-increase').forEach(button => {
                    button.addEventListener('click', (event) => {
                        const productId = event.target.closest('button').dataset.productId;
                        const item = cart.find(i => i.productId === productId);
                        if (item) {
                            updateCartItemQuantity(productId, item.quantity + 1);
                        }
                    });
                });
            }

            const { subtotal, total } = calculateCartTotals();
            cartSubtotalSpan.textContent = `₹${subtotal.toFixed(2)}`;
            cartTransportTaxSpan.textContent = `₹${currentTransportTax.toFixed(2)}`;
            cartTotalSpan.textContent = `₹${total.toFixed(2)}`;
        }

        viewCartButton.addEventListener('click', () => {
            cartModal.style.display = 'flex';
            updateCartDisplay(); // Ensure cart is up-to-date when opened
            if (cart.length > 0 && customerCurrentLocation) {
                checkoutFormSection.classList.remove('hidden');
                document.getElementById('locationInputSection').classList.add('hidden');
            } else if (cart.length > 0) {
                checkoutFormSection.classList.add('hidden');
                document.getElementById('locationInputSection').classList.remove('hidden');
                locationStatus.textContent = 'Please detect your location for delivery tax calculation.';
            }
        });

        // --- Geolocation and Delivery Tax Calculation ---
        detectLocationButton.addEventListener('click', () => {
            locationStatus.textContent = 'Detecting location...';
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(
                    async (position) => {
                        customerCurrentLocation = {
                            latitude: position.coords.latitude,
                            longitude: position.coords.longitude
                        };
                        locationStatus.textContent = `Location detected! Lat: ${customerCurrentLocation.latitude.toFixed(4)}, Lon: ${customerCurrentLocation.longitude.toFixed(4)}`;
                        await calculateDeliveryCost();
                        checkoutFormSection.classList.remove('hidden');
                        document.getElementById('locationInputSection').classList.add('hidden');
                    },
                    (error) => {
                        console.error('Error getting location:', error);
                        locationStatus.textContent = 'Failed to detect location. Please allow location access or try again.';
                        alertMessage('Failed to detect location. Please allow location access or enter address manually.', 'error');
                        customerCurrentLocation = null;
                        currentTransportTax = 0;
                        updateCartDisplay();
                        checkoutFormSection.classList.add('hidden');
                        document.getElementById('locationInputSection').classList.remove('hidden');
                    },
                    {
                        enableHighAccuracy: true,
                        timeout: 10000,
                        maximumAge: 0
                    }
                );
            } else {
                locationStatus.textContent = 'Geolocation is not supported by your browser.';
                alertMessage('Geolocation is not supported by your browser. Cannot calculate delivery tax automatically.', 'error');
                customerCurrentLocation = null;
                currentTransportTax = 0;
                updateCartDisplay();
                checkoutFormSection.classList.add('hidden');
                document.getElementById('locationInputSection').classList.remove('hidden');
            }
        });

        async function calculateDeliveryCost() {
            if (!customerCurrentLocation || cart.length === 0) {
                currentTransportTax = 0;
                updateCartDisplay();
                return;
            }
            try {
                const response = await fetch(`${API_BASE}/api/calculate-delivery-cost`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ customerLocation: customerCurrentLocation })
                });
                const result = await response.json();
                if (response.ok) {
                    currentTransportTax = result.transportTax;
                    locationStatus.textContent += ` (Delivery Tax: ₹${currentTransportTax.toFixed(2)})`;
                } else {
                    currentTransportTax = 0;
                    locationStatus.textContent = result.message || 'Could not calculate delivery tax.';
                    alertMessage(result.message || 'Failed to calculate delivery tax.', 'error');
                }
            } catch (error) {
                console.error('Error calculating delivery cost:', error);
                currentTransportTax = 0;
                locationStatus.textContent = 'Error calculating delivery tax.';
                alertMessage('An error occurred while calculating delivery tax.', 'error');
            } finally {
                updateCartDisplay();
            }
        }

        // --- Place Order ---
        placeOrderButton.addEventListener('click', async () => {
            if (cart.length === 0) {
                alertMessage('Your cart is empty!', 'error');
                return;
            }
            if (!customerCurrentLocation) {
                alertMessage('Please detect your location to calculate delivery tax before placing order.', 'error');
                return;
            }

            const customerName = customerNameInput.value.trim();
            const customerPhone = customerPhoneInput.value.trim();
            const deliveryAddress = deliveryAddressInput.value.trim();

            if (!customerName || !customerPhone || !deliveryAddress) {
                alertMessage('Please fill in all delivery details.', 'error');
                return;
            }

            if (!/^\d{10,15}$/.test(customerPhone)) { // Basic phone number validation
                alertMessage('Please enter a valid WhatsApp phone number (10-15 digits, no country code prefix like +91).', 'error');
                return;
            }

            const { subtotal, total } = calculateCartTotals();

            const orderData = {
                items: cart.map(item => ({
                    productId: item.productId,
                    name: item.name,
                    price: item.price,
                    quantity: item.quantity
                })),
                customerName,
                customerPhone,
                deliveryAddress,
                customerLocation: customerCurrentLocation,
                subtotal,
                transportTax: currentTransportTax,
                totalAmount: total
            };

            placeOrderButton.disabled = true;
            placeOrderButton.textContent = 'Placing Order...';

            try {
                const response = await fetch(`${API_BASE}/api/order`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(orderData)
                });
                const result = await response.json();

                if (response.ok) {
                    alertMessage('Order placed successfully!', 'success');
                    cart = []; // Clear cart
                    localStorage.removeItem('cart');
                    updateCartDisplay();
                    cartModal.style.display = 'none';

                    confirmedOrderIdSpan.textContent = result.orderId;
                    orderConfirmationModal.style.display = 'flex';
                } else {
                    alertMessage(result.message || 'Failed to place order.', 'error');
                }
            } catch (error) {
                console.error('Error placing order:', error);
                alertMessage('An error occurred while placing your order.', 'error');
            } finally {
                placeOrderButton.disabled = false;
                placeOrderButton.textContent = 'Place Order';
            }
        });

        // --- Order Tracking ---
        trackOrderButton.addEventListener('click', async () => {
            const orderId = confirmedOrderIdSpan.textContent;
            if (!orderId) {
                alertMessage('No order ID found to track.', 'error');
                return;
            }

            orderConfirmationModal.style.display = 'none';
            orderTrackingModal.style.display = 'flex';
            trackingDetailsDiv.innerHTML = '<p class="text-center text-gray-500 dark:text-gray-400">Loading tracking details...</p>';
            mapContainer.innerHTML = ''; // Clear previous map

            try {
                const response = await fetch(`${API_BASE}/api/order/${orderId}`);
                const order = await response.json();

                if (!order) {
                    trackingDetailsDiv.innerHTML = '<p class="text-red-500">Order not found.</p>';
                    return;
                }

                trackingDetailsDiv.innerHTML = `
                    <p><strong>Order ID:</strong> ${order._id}</p>
                    <p><strong>Customer Name:</strong> ${order.customerName}</p>
                    <p><strong>Total Amount:</strong> ₹${order.totalAmount.toFixed(2)}</p>
                    <p><strong>Current Status:</strong> <span class="font-bold ${getStatusColor(order.status)}">${order.status}</span></p>
                    <p><strong>Order Date:</strong> ${new Date(order.orderDate).toLocaleString()}</p>
                    <p><strong>Delivery Address:</strong> ${order.deliveryAddress}</p>
                `;

                // Render map if shop and customer locations are available
                if (order.deliveryFromLocation && order.customerLocation) {
                    initMap(order.deliveryFromLocation, order.customerLocation);
                } else {
                    mapContainer.innerHTML = '<p class="text-center text-gray-500 dark:text-gray-400 p-4">Location data not available for map tracking.</p>';
                }

            } catch (error) {
                console.error('Error fetching order for tracking:', error);
                trackingDetailsDiv.innerHTML = '<p class="text-red-500">Failed to load tracking details.</p>';
            }
        });

        function getStatusColor(status) {
            switch (status) {
                case 'Pending': return 'text-yellow-500';
                case 'Confirmed': return 'text-blue-500';
                case 'Preparing': return 'text-purple-500';
                case 'Out for Delivery': return 'text-orange-500';
                case 'Delivered': return 'text-green-500';
                case 'Cancelled': return 'text-red-500';
                default: return 'text-gray-500';
            }
        }

        // Basic Map Integration (using OpenStreetMap via iframe for simplicity)
        // For a more interactive map, you'd integrate a library like Leaflet.js or Google Maps API.
        function initMap(shopLoc, customerLoc) {
            const mapUrl = `https://www.openstreetmap.org/export/embed.html?bbox=${Math.min(shopLoc.longitude, customerLoc.longitude) - 0.01},${Math.min(shopLoc.latitude, customerLoc.latitude) - 0.01},${Math.max(shopLoc.longitude, customerLoc.longitude) + 0.01},${Math.max(shopLoc.latitude, customerLoc.latitude) + 0.01}&layer=mapnik&marker=${shopLoc.latitude},${shopLoc.longitude}&marker=${customerLoc.latitude},${customerLoc.longitude}`;
            mapContainer.innerHTML = `<iframe width="100%" height="100%" frameborder="0" scrolling="no" marginheight="0" marginwidth="0" src="${mapUrl}" style="border: 1px solid black"></iframe>`;
        }

    </script>
</body>
</html>

