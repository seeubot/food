<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Our Delicious Menu</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        /* Base styles for the black and white theme */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #000000 !important; /* Pure black background */
            color: #ffffff !important; /* Pure white text */
        }

        /* General text colors to ensure visibility */
        .text-gray-700, .text-gray-800 {
            color: #ffffff !important; /* All main text is white */
        }
        .text-gray-600 {
            color: #cccccc !important; /* Lighter gray for secondary text */
        }
        .text-gray-500 {
            color: #888888 !important; /* Medium gray for placeholders/disabled */
        }
        .text-gray-400 {
            color: #aaaaaa !important; /* Slightly lighter gray for icons/subtle elements */
        }
        .text-gray-300 {
            color: #dddddd !important; /* Very light gray */
        }
        .text-gray-200 {
            color: #eeeeee !important; /* Almost white */
        }

        /* Backgrounds for main panels/cards */
        .bg-gray-100 { /* Override default body background if still present */
            background-color: #000000 !important;
        }
        .bg-white, .bg-gray-800 { /* Main content cards, modals, headers */
            background-color: #1a1a1a !important; /* Very dark gray */
        }
        .bg-gray-900 { /* Modal overlay */
            background-color: #0a0a0a !important; /* Slightly darker for deeper contrast */
        }

        /* Inputs, Textareas */
        input, textarea {
            background-color: #222222 !important; /* Darker background for inputs */
            border-color: #444444 !important; /* Dark gray border */
            color: #ffffff !important; /* White text in inputs */
            padding: 0.75rem 1rem !important; /* More padding for touch targets */
            border-radius: 0.375rem !important; /* Rounded corners */
        }
        input::placeholder, textarea::placeholder {
            color: #888888 !important; /* Placeholder text color */
        }

        /* Buttons */
        button {
            border-radius: 0.5rem !important; /* More rounded buttons */
            padding: 0.75rem 1.5rem !important; /* Generous padding */
            font-weight: 600 !important; /* Semi-bold text */
            transition: all 0.2s ease-in-out !important; /* Smooth transitions */
        }
        /* Primary buttons (Add to Cart, Checkout, Place Order, Active Filter) */
        .bg-green-500, .bg-blue-500 { /* Reusing Tailwind classes but overriding colors */
            background-color: #ffffff !important; /* White background */
            color: #000000 !important; /* Black text */
            box-shadow: 0 4px 6px -1px rgba(255, 255, 255, 0.2), 0 2px 4px -1px rgba(255, 255, 255, 0.1) !important;
        }
        .bg-green-500:hover, .bg-blue-500:hover {
            background-color: #e0e0e0 !important; /* Slightly darker white on hover */
        }
        /* Secondary buttons (Cancel, Close, Get Location, Inactive Filter) */
        .bg-gray-500, .bg-gray-200 { /* Reusing Tailwind classes but overriding colors */
            background-color: #333333 !important; /* Dark gray background */
            color: #ffffff !important; /* White text */
        }
        .bg-gray-500:hover, .bg-gray-200:hover {
            background-color: #444444 !important; /* Lighter gray on hover */
        }
        /* Red buttons (e.g., quantity decrease) */
        .bg-red-500 {
            background-color: #555555 !important; /* Darker gray for subtle delete */
            color: #ffffff !important;
        }
        .bg-red-500:hover {
            background-color: #777777 !important;
        }

        /* Borders and Dividers */
        .border-gray-200, .border-gray-700 {
            border-color: #333333 !important; /* Consistent dark gray borders */
        }

        /* Shadows */
        .shadow-md {
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.4) !important; /* Deeper shadows for depth */
        }
        .shadow-xl {
            box-shadow: 0 20px 30px rgba(0, 0, 0, 0.6) !important;
        }

        /* Specific text colors for status/icons */
        .text-green-600 { color: #ffffff !important; } /* White for prices/available status */
        .text-red-500 { color: #cccccc !important; } /* Light gray for "Out of Stock" */

        /* Custom scrollbar for cart on small screens */
        .overflow-y-auto::-webkit-scrollbar {
            width: 8px;
        }
        .overflow-y-auto::-webkit-scrollbar-track {
            background: #222222;
            border-radius: 10px;
        }
        .overflow-y-auto::-webkit-scrollbar-thumb {
            background: #555555;
            border-radius: 10px;
        }
        .overflow-y-auto::-webkit-scrollbar-thumb:hover {
            background: #777777;
        }
    </style>
</head>
<body class="min-h-screen flex flex-col">
    <!-- Header -->
    <header class="bg-gray-800 shadow-md py-4 px-6 flex justify-between items-center sticky top-0 z-40">
        <h1 class="text-3xl font-bold text-white">Delicious Bites</h1>
        <div class="relative">
            <button id="cart-button" class="bg-green-500 hover:bg-green-600 text-black font-bold py-2 px-4 rounded-full transition duration-200 relative focus:outline-none focus:ring-2 focus:ring-white focus:ring-opacity-50">
                <i class="fas fa-shopping-cart mr-2"></i>
                Cart (<span id="cart-count">0</span>)
                <span id="cart-total-display" class="ml-2">₹0.00</span>
            </button>
            <!-- Cart Dropdown/Modal for Mobile -->
            <div id="cart-dropdown" class="hidden absolute right-0 mt-3 w-80 bg-gray-800 rounded-lg shadow-xl z-50 p-4">
                <h3 class="text-xl font-bold text-white mb-4">Your Cart</h3>
                <div id="cart-items-display" class="max-h-60 overflow-y-auto mb-4 border-b border-gray-700 pb-4">
                    <!-- Cart items will be rendered here -->
                    <p id="empty-cart-message" class="text-gray-500 text-center">Your cart is empty.</p>
                </div>
                <div class="text-right text-white font-semibold mb-2">Subtotal: <span id="cart-subtotal-dropdown">₹0.00</span></div>
                <div class="text-right text-white font-semibold mb-4">Transport Tax: <span id="cart-tax-dropdown">₹0.00</span></div>
                <div class="text-right text-white text-xl font-bold mb-4">Total: <span id="cart-grand-total-dropdown">₹0.00</span></div>
                <button id="checkout-button-dropdown" class="bg-blue-500 hover:bg-blue-600 text-black font-bold py-2 px-4 rounded-md w-full transition duration-200">Proceed to Checkout</button>
            </div>
        </div>
    </header>

    <!-- Main Content Area -->
    <main class="flex-1 p-4 sm:p-6 lg:p-8">
        <!-- Loading Indicator -->
        <div id="loading-indicator" class="fixed inset-0 bg-gray-900 bg-opacity-70 flex items-center justify-center z-[100] hidden">
            <div class="flex flex-col items-center">
                <div class="animate-spin rounded-full h-16 w-16 border-t-4 border-b-4 border-white"></div>
                <p class="mt-4 text-white text-lg">Loading menu...</p>
            </div>
        </div>

        <!-- Menu Categories Filter -->
        <div class="mb-8 flex flex-wrap gap-3 justify-center">
            <button class="filter-button bg-gray-200 hover:bg-gray-500 text-white py-2 px-5 rounded-full text-base font-semibold transition duration-200" data-category="All">All</button>
            <!-- Categories will be dynamically added here -->
        </div>

        <!-- Menu Items Grid -->
        <section id="menu-items-grid" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6">
            <!-- Menu items will be loaded here by JavaScript -->
            <p id="no-items-message" class="col-span-full text-center text-gray-500">No menu items available.</p>
        </section>
    </main>

    <!-- Product Detail Modal -->
    <div id="product-detail-modal" class="fixed inset-0 bg-gray-900 bg-opacity-70 flex items-center justify-center z-50 hidden">
        <div class="bg-gray-800 p-8 rounded-lg shadow-xl w-11/12 md:w-2/3 lg:w-1/2 max-h-[90vh] overflow-y-auto">
            <div class="flex justify-between items-center mb-6">
                <h3 id="product-detail-name" class="text-2xl font-bold text-white"></h3>
                <button class="text-gray-400 hover:text-white text-3xl focus:outline-none" onclick="closeModal('product-detail-modal')">&times;</button>
            </div>
            <div class="space-y-5">
                <img id="product-detail-image" src="" onerror="this.onerror=null;this.src='https://placehold.co/600x400/cccccc/333333?text=Food+Item';" alt="Product Image" class="w-full h-64 object-cover rounded-md">
                <p id="product-detail-description" class="text-gray-300 text-lg"></p>
                <p class="text-gray-300 text-lg"><strong>Category:</strong> <span id="product-detail-category"></span></p>
                <p class="text-gray-300 text-lg"><strong>Availability:</strong> <span id="product-detail-availability"></span></p>
                <div class="flex justify-between items-center pt-6 border-t border-gray-700">
                    <span id="product-detail-price" class="text-4xl font-bold text-green-600"></span>
                    <button id="product-detail-add-to-cart" class="bg-blue-500 hover:bg-blue-600 text-black font-bold py-3 px-6 rounded-lg transition duration-200">
                        <i class="fas fa-cart-plus mr-2"></i> Add to Cart
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Checkout Modal -->
    <div id="checkout-modal" class="fixed inset-0 bg-gray-900 bg-opacity-70 flex items-center justify-center z-50 hidden">
        <div class="bg-gray-800 p-8 rounded-lg shadow-xl w-11/12 md:w-2/3 lg:w-1/2 max-h-[90vh] overflow-y-auto">
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-2xl font-bold text-white">Checkout</h3>
                <button class="text-gray-400 hover:text-white text-3xl focus:outline-none" onclick="closeModal('checkout-modal')">&times;</button>
            </div>
            <form id="checkout-form" class="space-y-5">
                <div>
                    <label for="customer-name" class="block text-gray-300 text-base font-bold mb-2">Your Name:</label>
                    <input type="text" id="customer-name" name="customerName" class="w-full" required>
                </div>
                <div>
                    <label for="customer-phone" class="block text-gray-300 text-base font-bold mb-2">Your WhatsApp Number (e.g., 91XXXXXXXXXX):</label>
                    <input type="tel" id="customer-phone" name="customerPhone" pattern="[0-9]{10,15}" class="w-full" required>
                </div>
                <div>
                    <label for="delivery-address" class="block text-gray-300 text-base font-bold mb-2">Delivery Address:</label>
                    <textarea id="delivery-address" name="deliveryAddress" rows="3" class="w-full" required></textarea>
                </div>
                <div>
                    <label class="block text-gray-300 text-base font-bold mb-2">Your Location (for delivery cost calculation):</label>
                    <button type="button" id="get-location-btn" class="bg-gray-500 hover:bg-gray-600 text-white font-bold py-3 px-6 rounded-lg transition duration-200 mb-2">Get My Location</button>
                    <p id="location-status" class="text-sm text-gray-500"></p>
                    <input type="hidden" id="customer-latitude" name="customerLatitude">
                    <input type="hidden" id="customer-longitude" name="customerLongitude">
                </div>

                <div class="border-t border-gray-700 pt-6 mt-6">
                    <div class="flex justify-between text-gray-300 text-lg mb-3">
                        <span>Items Subtotal:</span>
                        <span id="checkout-subtotal">₹0.00</span>
                    </div>
                    <div class="flex justify-between text-gray-300 text-lg mb-3">
                        <span>Transport Tax:</span>
                        <span id="checkout-transport-tax">₹0.00</span>
                    </div>
                    <div class="flex justify-between text-white text-3xl font-bold">
                        <span>Total Amount:</span>
                        <span id="checkout-total-amount">₹0.00</span>
                    </div>
                </div>

                <div class="flex justify-end space-x-4 mt-8">
                    <button type="button" class="bg-gray-500 hover:bg-gray-600 text-white font-bold py-3 px-6 rounded-lg transition duration-200" onclick="closeModal('checkout-modal')">Cancel</button>
                    <button type="submit" class="bg-green-500 hover:bg-green-600 text-black font-bold py-3 px-6 rounded-lg transition duration-200">Place Order</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Order Tracking Modal -->
    <div id="order-tracking-modal" class="fixed inset-0 bg-gray-900 bg-opacity-70 flex items-center justify-center z-50 hidden">
        <div class="bg-gray-800 p-8 rounded-lg shadow-xl w-11/12 md:w-2/3 lg:w-1/2 max-h-[90vh] overflow-y-auto">
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-2xl font-bold text-white">Order Status</h3>
                <button class="text-gray-400 hover:text-white text-3xl focus:outline-none" onclick="closeModal('order-tracking-modal')">&times;</button>
            </div>
            <div id="order-tracking-content" class="text-gray-300 space-y-4 text-lg">
                <!-- Order status details will be loaded here -->
            </div>
            <div class="mt-8 flex justify-end">
                <button class="bg-gray-500 hover:bg-gray-600 text-white font-bold py-3 px-6 rounded-lg transition duration-200" onclick="closeModal('order-tracking-modal')">Close</button>
            </div>
        </div>
    </div>

    <script>
        // No dark mode toggle needed, as the theme is now consistently dark.

        const loadingIndicator = document.getElementById('loading-indicator');

        function showLoading() { loadingIndicator.classList.remove('hidden'); }
        function hideLoading() { loadingIndicator.classList.add('hidden'); }

        let cart = [];
        let products = []; // Store all fetched products
        let shopLocation = { latitude: 0, longitude: 0 };
        let deliveryRates = [];
        let currentCustomerLocation = null;
        let transportTax = 0;

        const cartCountSpan = document.getElementById('cart-count');
        const cartTotalDisplaySpan = document.getElementById('cart-total-display');
        const cartItemsDisplayDiv = document.getElementById('cart-items-display');
        const emptyCartMessage = document.getElementById('empty-cart-message');
        const cartSubtotalDropdown = document.getElementById('cart-subtotal-dropdown');
        const cartTaxDropdown = document.getElementById('cart-tax-dropdown');
        const cartGrandTotalDropdown = document.getElementById('cart-grand-total-dropdown');

        const checkoutSubtotalSpan = document.getElementById('checkout-subtotal');
        const checkoutTransportTaxSpan = document.getElementById('checkout-transport-tax');
        const checkoutTotalAmountSpan = document.getElementById('checkout-total-amount');

        // --- Modals ---
        function openModal(modalId) {
            document.getElementById(modalId).classList.remove('hidden');
            // If opening checkout modal, automatically trigger location request
            if (modalId === 'checkout-modal') {
                document.getElementById('get-location-btn').click();
            }
        }

        function closeModal(modalId) {
            document.getElementById(modalId).classList.add('hidden');
        }

        // --- Fetch Menu Items and Settings ---
        async function fetchMenuAndSettings() {
            showLoading();
            try {
                const [menuResponse, settingsResponse] = await Promise.all([
                    fetch('/api/menu'),
                    fetch('/api/public/settings')
                ]);

                products = await menuResponse.json();
                const settings = await settingsResponse.json();

                shopLocation = settings.shopLocation;
                deliveryRates = settings.deliveryRates.sort((a, b) => a.kms - b.kms); // Ensure rates are sorted

                renderMenu(products);
                renderCategories(products);
            } catch (error) {
                console.error('Error fetching menu or settings:', error);
                document.getElementById('menu-items-grid').innerHTML = '<p class="col-span-full text-center text-red-500">Failed to load menu. Please try again later.</p>';
            } finally {
                hideLoading();
            }
        }

        function renderMenu(itemsToRender) {
            const menuGrid = document.getElementById('menu-items-grid');
            menuGrid.innerHTML = ''; // Clear previous items

            if (itemsToRender.length === 0) {
                document.getElementById('no-items-message').classList.remove('hidden');
                return;
            } else {
                document.getElementById('no-items-message').classList.add('hidden');
            }

            itemsToRender.forEach(product => {
                const productCard = `
                    <div class="bg-white rounded-lg shadow-md overflow-hidden flex flex-col transform transition-transform duration-300 hover:scale-105 cursor-pointer" onclick="showProductDetails('${product._id}')">
                        <img src="${product.imageUrl}" onerror="this.onerror=null;this.src='https://placehold.co/400x300/cccccc/333333?text=Food+Item';" alt="${product.name}" class="w-full h-48 object-cover">
                        <div class="p-4 flex-grow flex flex-col">
                            <h3 class="text-xl font-semibold text-white mb-2">${product.name}</h3>
                            <p class="text-gray-300 text-sm mb-3 flex-grow">${product.description ? product.description.substring(0, 70) + '...' : 'No description available.'}</p>
                            <div class="flex justify-between items-center mt-auto">
                                <span class="text-2xl font-bold text-green-600">₹${product.price.toFixed(2)}</span>
                                <button onclick="event.stopPropagation(); addToCart('${product._id}')" class="bg-blue-500 hover:bg-blue-600 text-black font-bold py-2 px-4 rounded-md transition duration-200 text-sm">
                                    <i class="fas fa-cart-plus mr-1"></i> Add to Cart
                                </button>
                            </div>
                        </div>
                    </div>
                `;
                menuGrid.innerHTML += productCard;
            });
        }

        function renderCategories(allProducts) {
            const categoriesContainer = document.querySelector('.filter-button').parentNode;
            const uniqueCategories = [...new Set(allProducts.map(p => p.category))].filter(Boolean); // Get unique non-empty categories

            // Clear existing dynamic categories, keep 'All' button
            document.querySelectorAll('.filter-button:not([data-category="All"])').forEach(btn => btn.remove());

            uniqueCategories.forEach(category => {
                const button = document.createElement('button');
                button.className = 'filter-button bg-gray-200 hover:bg-gray-500 text-white py-2 px-5 rounded-full text-base font-semibold transition duration-200';
                button.dataset.category = category;
                button.textContent = category;
                categoriesContainer.appendChild(button);
            });

            // Add event listeners to new category buttons
            document.querySelectorAll('.filter-button').forEach(button => {
                button.addEventListener('click', (e) => {
                    const selectedCategory = e.target.dataset.category;
                    document.querySelectorAll('.filter-button').forEach(btn => {
                        btn.classList.remove('bg-green-500', 'text-black');
                        btn.classList.add('bg-gray-200', 'text-white');
                    });
                    e.target.classList.add('bg-green-500', 'text-black');
                    e.target.classList.remove('bg-gray-200', 'text-white');

                    if (selectedCategory === 'All') {
                        renderMenu(products);
                    } else {
                        const filteredProducts = products.filter(p => p.category === selectedCategory);
                        renderMenu(filteredProducts);
                    }
                });
            });

            // Set 'All' button as active by default
            document.querySelector('.filter-button[data-category="All"]').classList.add('bg-green-500', 'text-black');
            document.querySelector('.filter-button[data-category="All"]').classList.remove('bg-gray-200', 'text-white');
        }


        // --- Cart Management ---
        function addToCart(productId) {
            const product = products.find(p => p._id === productId);
            if (!product) return;

            const existingItem = cart.find(item => item.productId === productId);
            if (existingItem) {
                existingItem.quantity++;
            } else {
                cart.push({
                    productId: product._id,
                    name: product.name,
                    price: product.price,
                    quantity: 1
                });
            }
            updateCartDisplay();
        }

        function updateCartItemQuantity(productId, change) {
            const itemIndex = cart.findIndex(item => item.productId === productId);
            if (itemIndex > -1) {
                cart[itemIndex].quantity += change;
                if (cart[itemIndex].quantity <= 0) {
                    cart.splice(itemIndex, 1); // Remove if quantity is 0 or less
                }
            }
            updateCartDisplay();
        }

        function calculateCartTotals() {
            let subtotal = cart.reduce((sum, item) => sum + (item.price * item.quantity), 0);
            let totalAmount = subtotal + transportTax;
            return { subtotal, totalAmount };
        }

        function updateCartDisplay() {
            const { subtotal, totalAmount } = calculateCartTotals();

            cartCountSpan.textContent = cart.reduce((sum, item) => sum + item.quantity, 0);
            cartTotalDisplaySpan.textContent = `₹${totalAmount.toFixed(2)}`;

            cartItemsDisplayDiv.innerHTML = '';
            if (cart.length === 0) {
                emptyCartMessage.classList.remove('hidden');
            } else {
                emptyCartMessage.classList.add('hidden');
                cart.forEach(item => {
                    const itemDiv = `
                        <div class="flex justify-between items-center py-3 border-b border-gray-700 last:border-b-0">
                            <div class="flex-grow">
                                <p class="font-semibold text-white text-lg">${item.name}</p>
                                <p class="text-sm text-gray-400">₹${item.price.toFixed(2)} each</p>
                            </div>
                            <div class="flex items-center">
                                <button onclick="updateCartItemQuantity('${item.productId}', -1)" class="bg-red-500 hover:bg-red-600 text-white w-8 h-8 rounded-full flex items-center justify-center text-lg mr-2">-</button>
                                <span class="font-bold text-white text-xl">${item.quantity}</span>
                                <button onclick="updateCartItemQuantity('${item.productId}', 1)" class="bg-green-500 hover:bg-green-600 text-black w-8 h-8 rounded-full flex items-center justify-center text-lg ml-2">+</button>
                            </div>
                            <span class="font-semibold text-white ml-4 text-xl">₹${(item.price * item.quantity).toFixed(2)}</span>
                        </div>
                    `;
                    cartItemsDisplayDiv.innerHTML += itemDiv;
                });
            }

            cartSubtotalDropdown.textContent = `₹${subtotal.toFixed(2)}`;
            cartTaxDropdown.textContent = `₹${transportTax.toFixed(2)}`;
            cartGrandTotalDropdown.textContent = `₹${totalAmount.toFixed(2)}`;
        }

        // Toggle cart dropdown visibility
        document.getElementById('cart-button').addEventListener('click', () => {
            document.getElementById('cart-dropdown').classList.toggle('hidden');
        });

        // Close cart dropdown if clicked outside
        window.addEventListener('click', (event) => {
            const cartButton = document.getElementById('cart-button');
            const cartDropdown = document.getElementById('cart-dropdown');
            if (!cartButton.contains(event.target) && !cartDropdown.contains(event.target)) {
                cartDropdown.classList.add('hidden');
            }
        });


        // --- Product Details ---
        function showProductDetails(productId) {
            const product = products.find(p => p._id === productId);
            if (!product) return;

            document.getElementById('product-detail-name').textContent = product.name;
            document.getElementById('product-detail-image').src = product.imageUrl;
            document.getElementById('product-detail-description').textContent = product.description || 'No description available.';
            document.getElementById('product-detail-category').textContent = product.category || 'N/A';
            document.getElementById('product-detail-availability').textContent = product.isAvailable ? 'Available' : 'Out of Stock';
            document.getElementById('product-detail-availability').className = product.isAvailable ? 'text-green-600 font-semibold' : 'text-red-500 font-semibold';
            document.getElementById('product-detail-price').textContent = `₹${product.price.toFixed(2)}`;

            const addToCartBtn = document.getElementById('product-detail-add-to-cart');
            addToCartBtn.onclick = () => {
                addToCart(product._id);
                closeModal('product-detail-modal');
            };
            addToCartBtn.disabled = !product.isAvailable;
            addToCartBtn.classList.toggle('opacity-50', !product.isAvailable);
            addToCartBtn.classList.toggle('cursor-not-allowed', !product.isAvailable);

            openModal('product-detail-modal');
        }


        // --- Checkout Process ---
        document.getElementById('checkout-button-dropdown').addEventListener('click', () => {
            if (cart.length === 0) {
                alert('Your cart is empty. Please add items before checking out.'); // Replace with custom modal
                return;
            }
            const { subtotal, totalAmount } = calculateCartTotals();
            checkoutSubtotalSpan.textContent = `₹${subtotal.toFixed(2)}`;
            checkoutTransportTaxSpan.textContent = `₹${transportTax.toFixed(2)}`;
            checkoutTotalAmountSpan.textContent = `₹${totalAmount.toFixed(2)}`;
            openModal('checkout-modal');
            document.getElementById('cart-dropdown').classList.add('hidden'); // Close cart dropdown
        });

        document.getElementById('get-location-btn').addEventListener('click', () => {
            const locationStatus = document.getElementById('location-status');
            locationStatus.textContent = 'Getting your location...';
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(
                    async (position) => {
                        currentCustomerLocation = {
                            latitude: position.coords.latitude,
                            longitude: position.coords.longitude
                        };
                        document.getElementById('customer-latitude').value = currentCustomerLocation.latitude;
                        document.getElementById('customer-longitude').value = currentCustomerLocation.longitude;
                        locationStatus.textContent = `Location found! Lat: ${currentCustomerLocation.latitude.toFixed(4)}, Lon: ${currentCustomerLocation.longitude.toFixed(4)}`;
                        await calculateDeliveryCost(currentCustomerLocation);
                    },
                    (error) => {
                        console.error('Error getting location:', error);
                        locationStatus.textContent = 'Could not get location. Please enter address manually or try again.';
                        currentCustomerLocation = null;
                        transportTax = 0; // Reset transport tax if location fails
                        updateCartDisplay(); // Update totals
                    },
                    { enableHighAccuracy: true, timeout: 10000, maximumAge: 0 }
                );
            } else {
                locationStatus.textContent = 'Geolocation is not supported by your browser.';
                currentCustomerLocation = null;
                transportTax = 0; // Reset transport tax if geolocation not supported
                updateCartDisplay(); // Update totals
            }
        });

        async function calculateDeliveryCost(customerLoc) {
            if (!customerLoc || !shopLocation) {
                transportTax = 0;
                updateCartDisplay();
                return;
            }
            showLoading();
            try {
                const response = await fetch('/api/calculate-delivery-cost', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ customerLocation: customerLoc })
                });
                const data = await response.json();
                transportTax = data.transportTax;
                document.getElementById('location-status').textContent += ` (Delivery Tax: ₹${transportTax.toFixed(2)})`;
                updateCartDisplay(); // Update cart totals with new tax
                // Also update checkout modal totals if it's open
                const { subtotal, totalAmount } = calculateCartTotals();
                checkoutSubtotalSpan.textContent = `₹${subtotal.toFixed(2)}`;
                checkoutTransportTaxSpan.textContent = `₹${transportTax.toFixed(2)}`;
                checkoutTotalAmountSpan.textContent = `₹${totalAmount.toFixed(2)}`;
            } catch (error) {
                console.error('Error calculating delivery cost:', error);
                transportTax = 0; // Default to 0 on error
                document.getElementById('location-status').textContent += ' (Error calculating delivery cost)';
                updateCartDisplay();
            } finally {
                hideLoading();
            }
        }


        document.getElementById('checkout-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            showLoading();

            const formData = new FormData(e.target);
            const customerName = formData.get('customerName');
            const customerPhone = formData.get('customerPhone');
            const deliveryAddress = formData.get('deliveryAddress');
            const customerLatitude = formData.get('customerLatitude');
            const customerLongitude = formData.get('customerLongitude');

            const { subtotal, totalAmount } = calculateCartTotals();

            const orderData = {
                items: cart.map(item => ({
                    productId: item.productId,
                    name: item.name,
                    price: item.price,
                    quantity: item.quantity
                })),
                customerName,
                customerPhone,
                deliveryAddress,
                customerLocation: customerLatitude && customerLongitude ? {
                    latitude: parseFloat(customerLatitude),
                    longitude: parseFloat(customerLongitude)
                } : undefined,
                subtotal,
                transportTax,
                totalAmount
            };

            try {
                const response = await fetch('/api/order', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(orderData)
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.message || 'Failed to place order.');
                }

                const result = await response.json();
                closeModal('checkout-modal');
                cart = []; // Clear cart after successful order
                transportTax = 0; // Reset transport tax
                updateCartDisplay();

                // Show order tracking modal
                viewOrderTracking(result.orderId);

            } catch (error) {
                console.error('Error placing order:', error);
                alert(`Error placing order: ${error.message}`); // Replace with custom modal
            } finally {
                hideLoading();
            }
        });

        // --- Order Tracking ---
        async function viewOrderTracking(orderId) {
            showLoading();
            try {
                const response = await fetch(`/api/order/${orderId}`);
                const order = await response.json();
                const trackingContent = document.getElementById('order-tracking-content');
                trackingContent.innerHTML = `
                    <p><strong>Order ID:</strong> ${order._id}</p>
                    <p><strong>Status:</strong> <span class="font-bold text-green-600">${order.status}</span></p>
                    <p><strong>Total Amount:</strong> ₹${order.totalAmount.toFixed(2)}</p>
                    <p><strong>Order Date:</strong> ${new Date(order.orderDate).toLocaleString()}</p>
                    <h4 class="font-bold mt-4 mb-2">Items:</h4>
                    <ul class="list-disc list-inside space-y-1">
                        ${order.items.map(item => `
                            <li>${item.name} (x${item.quantity}) - ₹${(item.price * item.quantity).toFixed(2)}</li>
                        `).join('')}
                    </ul>
                    <p class="mt-4 text-sm text-gray-500">You can track your order status here. For more details, please contact us via WhatsApp using the number you provided.</p>
                `;
                openModal('order-tracking-modal');
            } catch (error) {
                console.error('Error fetching order for tracking:', error);
                alert('Failed to fetch order status. Please try again or contact support.'); // Replace with custom modal
            } finally {
                hideLoading();
            }
        }


        // Initial load
        fetchMenuAndSettings();
        updateCartDisplay(); // Initialize cart display
    </script>
</body>
</html>

