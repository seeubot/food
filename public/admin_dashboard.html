<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        /* Base styles for the black and white theme */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #000000 !important; /* Pure black background */
            color: #ffffff !important; /* Pure white text */
        }

        /* General text colors to ensure visibility */
        .text-gray-700, .text-gray-800 {
            color: #ffffff !important; /* All main text is white */
        }
        .text-gray-600 {
            color: #cccccc !important; /* Lighter gray for secondary text */
        }
        .text-gray-500 {
            color: #888888 !important; /* Medium gray for placeholders/disabled */
        }
        .text-gray-400 {
            color: #aaaaaa !important; /* Slightly lighter gray for icons/subtle elements */
        }
        .text-gray-300 {
            color: #dddddd !important; /* Very light gray */
        }
        .text-gray-200 {
            color: #eeeeee !important; /* Almost white */
        }

        /* Backgrounds for main panels/cards */
        .bg-gray-100 { /* Override default body background if still present */
            background-color: #000000 !important;
        }
        .bg-white, .bg-gray-800 { /* Main content cards, modals, headers */
            background-color: #1a1a1a !important; /* Very dark gray */
        }
        .bg-gray-900 { /* Sidebar, modal overlay */
            background-color: #0a0a0a !important; /* Slightly darker for deeper contrast */
        }

        /* Inputs, Textareas, Selects */
        input, textarea, select {
            background-color: #222222 !important; /* Darker background for inputs */
            border-color: #444444 !important; /* Dark gray border */
            color: #ffffff !important; /* White text in inputs */
            padding: 0.75rem 1rem !important; /* More padding for touch targets */
            border-radius: 0.375rem !important; /* Rounded corners */
        }
        input::placeholder, textarea::placeholder {
            color: #888888 !important; /* Placeholder text color */
        }
        select {
            appearance: none; /* Remove default select arrow */
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 20 20' fill='white'%3E%3Cpath fill-rule='evenodd' d='M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z' clip-rule='evenodd'%3E%3C/path%3E%3C/svg%3E") !important;
            background-repeat: no-repeat !important;
            background-position: right 0.75rem center !important;
            background-size: 1.5em 1.5em !important;
        }


        /* Buttons */
        button {
            border-radius: 0.5rem !important; /* More rounded buttons */
            padding: 0.75rem 1.5rem !important; /* Generous padding */
            font-weight: 600 !important; /* Semi-bold text */
            transition: all 0.2s ease-in-out !important; /* Smooth transitions */
        }
        /* Primary buttons (Save, Add) */
        .bg-green-500 {
            background-color: #ffffff !important; /* White background */
            color: #000000 !important; /* Black text */
            box-shadow: 0 4px 6px -1px rgba(255, 255, 255, 0.2), 0 2px 4px -1px rgba(255, 255, 255, 0.1) !important;
        }
        .bg-green-500:hover {
            background-color: #e0e0e0 !important; /* Slightly darker white on hover */
        }
        /* Secondary buttons (Cancel, Close, Neutral actions) */
        .bg-gray-500 {
            background-color: #333333 !important; /* Dark gray background */
            color: #ffffff !important; /* White text */
        }
        .bg-gray-500:hover {
            background-color: #444444 !important; /* Lighter gray on hover */
        }
        /* Blue buttons (e.g., Add Rate, Get Location) */
        .bg-blue-500 {
            background-color: #666666 !important; /* Medium gray */
            color: #ffffff !important;
        }
        .bg-blue-500:hover {
            background-color: #888888 !important; /* Lighter gray on hover */
        }
        /* Action icons (Edit, Delete, View) - using specific text colors for visibility */
        .text-blue-500, .text-blue-400 { color: #aaaaaa !important; } /* Light gray for icons */
        .text-yellow-500, .text-yellow-400 { color: #aaaaaa !important; }
        .text-red-500, .text-red-400 { color: #aaaaaa !important; }


        /* Borders and Dividers */
        .border-gray-200, .border-gray-700 {
            border-color: #333333 !important; /* Consistent dark gray borders */
        }

        /* Shadows */
        .shadow-md {
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.4) !important; /* Deeper shadows for depth */
        }
        .shadow-lg {
            box-shadow: 0 10px 15px rgba(0, 0, 0, 0.5) !important;
        }
        .shadow-xl {
            box-shadow: 0 20px 30px rgba(0, 0, 0, 0.6) !important;
        }

        /* Specific table styles */
        table {
            background-color: #1a1a1a !important; /* Table background matches card */
            border-collapse: separate; /* Allows for rounded corners on table */
            border-spacing: 0;
            border-radius: 0.5rem; /* Rounded corners for table */
            overflow: hidden; /* Ensures content stays within rounded corners */
        }
        table thead tr {
            background-color: #0a0a0a !important; /* Table header background */
            color: #ffffff !important; /* Table header text */
        }
        table th, table td {
            padding: 1rem 1.5rem !important; /* More padding for table cells */
            border-bottom: 1px solid #333333 !important; /* Darker row dividers */
        }
        table tbody tr:last-child td {
            border-bottom: none !important; /* No border on last row */
        }
        table tbody tr:nth-child(odd) {
            background-color: #1a1a1a !important; /* Alternating row background */
        }
        table tbody tr:nth-child(even) {
            background-color: #222222 !important; /* Alternating row background */
        }
        table tbody tr:hover {
            background-color: #333333 !important; /* Darker hover effect */
        }

        /* Status indicators for consistency */
        .text-green-600 { color: #ffffff !important; } /* White for 'Available' text */
        .text-blue-600 { color: #cccccc !important; } /* Light gray for 'Trending' checkbox */
        .form-checkbox {
            background-color: #333333 !important;
            border-color: #555555 !important;
        }
        .form-checkbox:checked {
            background-color: #ffffff !important; /* White checkmark */
            border-color: #ffffff !important;
        }

        /* Custom scrollbar for tables on small screens */
        .overflow-x-auto::-webkit-scrollbar {
            height: 8px;
        }
        .overflow-x-auto::-webkit-scrollbar-track {
            background: #222222;
            border-radius: 10px;
        }
        .overflow-x-auto::-webkit-scrollbar-thumb {
            background: #555555;
            border-radius: 10px;
        }
        .overflow-x-auto::-webkit-scrollbar-thumb:hover {
            background: #777777;
        }
    </style>
</head>
<body class="min-h-screen flex flex-col lg:flex-row">
    <!-- Sidebar / Mobile Navbar -->
    <aside id="sidebar" class="bg-gray-900 text-white w-full lg:w-64 p-4 lg:p-6 flex flex-col shadow-lg lg:shadow-none transition-all duration-300 ease-in-out transform -translate-x-full lg:translate-x-0 fixed lg:static inset-y-0 z-50">
        <div class="flex items-center justify-between lg:justify-center mb-8">
            <h1 class="text-3xl font-bold">Admin Panel</h1>
            <button id="close-sidebar" class="lg:hidden text-white text-3xl focus:outline-none">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <nav class="flex-grow">
            <ul class="space-y-4">
                <li><a href="#" class="nav-link flex items-center py-3 px-4 rounded-lg text-xl hover:bg-gray-800 transition duration-200" data-section="whatsapp-bot"><i class="fab fa-whatsapp mr-3"></i>WhatsApp Bot</a></li>
                <li><a href="#" class="nav-link flex items-center py-3 px-4 rounded-lg text-xl hover:bg-gray-800 transition duration-200" data-section="orders"><i class="fas fa-clipboard-list mr-3"></i>Orders</a></li>
                <li><a href="#" class="nav-link flex items-center py-3 px-4 rounded-lg text-xl hover:bg-gray-800 transition duration-200" data-section="menu"><i class="fas fa-utensils mr-3"></i>Menu</a></li>
                <li><a href="#" class="nav-link flex items-center py-3 px-4 rounded-lg text-xl hover:bg-gray-800 transition duration-200" data-section="customers"><i class="fas fa-users mr-3"></i>Customers</a></li>
                <li><a href="#" class="nav-link flex items-center py-3 px-4 rounded-lg text-xl hover:bg-gray-800 transition duration-200" data-section="settings"><i class="fas fa-cogs mr-3"></i>Settings</a></li>
                <li><a href="/admin/logout" class="flex items-center py-3 px-4 rounded-lg text-xl hover:bg-red-700 transition duration-200 text-red-400"><i class="fas fa-sign-out-alt mr-3"></i>Logout</a></li>
            </ul>
        </nav>
    </aside>

    <!-- Main Content Area -->
    <div class="flex-1 flex flex-col overflow-hidden">
        <!-- Top Bar for Mobile -->
        <header class="bg-gray-800 shadow-md lg:hidden p-4 flex items-center justify-between">
            <button id="open-sidebar" class="text-white text-3xl focus:outline-none">
                <i class="fas fa-bars"></i>
            </button>
            <h1 class="text-2xl font-bold text-white">Admin Dashboard</h1>
            <a href="/admin/logout" class="text-red-400 text-2xl"><i class="fas fa-sign-out-alt"></i></a>
        </header>

        <main class="flex-1 overflow-y-auto p-4 sm:p-6 lg:p-8">
            <!-- Loading Indicator -->
            <div id="loading-indicator" class="fixed inset-0 bg-gray-900 bg-opacity-70 flex items-center justify-center z-[100] hidden">
                <div class="flex flex-col items-center">
                    <div class="animate-spin rounded-full h-16 w-16 border-t-4 border-b-4 border-white"></div>
                    <p class="mt-4 text-white text-lg">Loading...</p>
                </div>
            </div>

            <!-- WhatsApp Bot Status Section -->
            <section id="whatsapp-bot-section" class="dashboard-section bg-gray-800 p-6 rounded-lg shadow-md mb-8 hidden">
                <h2 class="text-3xl font-bold text-white mb-4">WhatsApp Bot Status</h2>
                <div class="flex items-center space-x-4 mb-6">
                    <div id="bot-status-indicator" class="w-4 h-4 rounded-full bg-gray-500 animate-pulse"></div>
                    <p id="bot-status-text" class="text-lg text-gray-300">Loading status...</p>
                </div>
                <div class="mt-4 text-center">
                    <p class="text-gray-300">For QR code generation and connection, please visit the <a href="/" target="_blank" class="text-blue-400 hover:underline">public bot status panel</a>.</p>
                </div>
            </section>


            <!-- Orders Section -->
            <section id="orders-section" class="dashboard-section bg-gray-800 p-6 rounded-lg shadow-md mb-8 hidden">
                <h2 class="text-3xl font-bold text-white mb-6">Recent Orders</h2>
                <div class="overflow-x-auto">
                    <table class="min-w-full bg-gray-700 rounded-lg shadow-md">
                        <thead>
                            <tr class="bg-gray-600 text-gray-200 uppercase text-sm leading-normal">
                                <th class="py-3 px-6 text-left">Order ID</th>
                                <th class="py-3 px-6 text-left">Customer</th>
                                <th class="py-3 px-6 text-left">Phone</th>
                                <th class="py-3 px-6 text-left">Total</th>
                                <th class="py-3 px-6 text-center">Status</th>
                                <th class="py-3 px-6 text-center">Date</th>
                                <th class="py-3 px-6 text-center">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="orders-table-body" class="text-gray-300 text-sm font-light">
                            <!-- Orders will be loaded here by JavaScript -->
                            <tr><td colspan="7" class="py-4 text-center text-gray-500">No orders found.</td></tr>
                        </tbody>
                    </table>
                </div>
                <!-- Order Detail Modal -->
                <div id="order-detail-modal" class="fixed inset-0 bg-gray-900 bg-opacity-70 flex items-center justify-center z-50 hidden">
                    <div class="bg-gray-800 p-8 rounded-lg shadow-xl w-11/12 md:w-2/3 lg:w-1/2 max-h-[90vh] overflow-y-auto">
                        <div class="flex justify-between items-center mb-6">
                            <h3 class="text-2xl font-bold text-white">Order Details</h3>
                            <button class="text-gray-400 hover:text-white text-3xl focus:outline-none" onclick="closeModal('order-detail-modal')">&times;</button>
                        </div>
                        <div id="order-detail-content" class="text-gray-300 space-y-4 text-lg">
                            <!-- Order details will be loaded here -->
                        </div>
                        <div class="mt-8 flex justify-end">
                            <button class="bg-gray-500 hover:bg-gray-600 text-white font-bold py-3 px-6 rounded-lg transition duration-200" onclick="closeModal('order-detail-modal')">Close</button>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Menu Management Section -->
            <section id="menu-section" class="dashboard-section bg-gray-800 p-6 rounded-lg shadow-md mb-8 hidden">
                <h2 class="text-3xl font-bold text-white mb-6">Menu Management</h2>
                <button class="bg-green-500 hover:bg-green-600 text-white font-bold py-3 px-6 rounded-lg mb-6 transition duration-200" onclick="openProductModal()">Add New Product</button>
                <div class="overflow-x-auto">
                    <table class="min-w-full bg-gray-700 rounded-lg shadow-md">
                        <thead>
                            <tr class="bg-gray-600 text-gray-200 uppercase text-sm leading-normal">
                                <th class="py-3 px-6 text-left">Image</th>
                                <th class="py-3 px-6 text-left">Name</th>
                                <th class="py-3 px-6 text-left">Category</th>
                                <th class="py-3 px-6 text-right">Price</th>
                                <th class="py-3 px-6 text-center">Available</th>
                                <th class="py-3 px-6 text-center">Trending</th>
                                <th class="py-3 px-6 text-center">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="menu-table-body" class="text-gray-300 text-sm font-light">
                            <!-- Menu items will be loaded here by JavaScript -->
                            <tr><td colspan="7" class="py-4 text-center">Loading menu items...</td></tr>
                        </tbody>
                    </table>
                </div>

                <!-- Product Add/Edit Modal -->
                <div id="product-modal" class="fixed inset-0 bg-gray-900 bg-opacity-70 flex items-center justify-center z-50 hidden">
                    <div class="bg-gray-800 p-8 rounded-lg shadow-xl w-11/12 md:w-2/3 lg:w-1/2 max-h-[90vh] overflow-y-auto">
                        <div class="flex justify-between items-center mb-6">
                            <h3 id="product-modal-title" class="text-2xl font-bold text-white">Add Product</h3>
                            <button class="text-gray-400 hover:text-white text-3xl focus:outline-none" onclick="closeModal('product-modal')">&times;</button>
                        </div>
                        <form id="product-form" class="space-y-5">
                            <input type="hidden" id="product-id">
                            <div>
                                <label for="product-name" class="block text-gray-300 text-base font-bold mb-2">Name:</label>
                                <input type="text" id="product-name" name="name" class="w-full" required>
                            </div>
                            <div>
                                <label for="product-description" class="block text-gray-300 text-base font-bold mb-2">Description:</label>
                                <textarea id="product-description" name="description" rows="3" class="w-full"></textarea>
                            </div>
                            <div>
                                <label for="product-price" class="block text-gray-300 text-base font-bold mb-2">Price:</label>
                                <input type="number" id="product-price" name="price" step="0.01" class="w-full" required>
                            </div>
                            <div>
                                <label for="product-imageUrl" class="block text-gray-300 text-base font-bold mb-2">Image URL:</label>
                                <input type="text" id="product-imageUrl" name="imageUrl" class="w-full">
                            </div>
                            <div>
                                <label for="product-category" class="block text-gray-300 text-base font-bold mb-2">Category:</label>
                                <input type="text" id="product-category" name="category" class="w-full">
                            </div>
                            <div class="flex flex-col sm:flex-row items-start sm:items-center space-y-3 sm:space-y-0 sm:space-x-6">
                                <label class="flex items-center text-gray-300 text-base">
                                    <input type="checkbox" id="product-isAvailable" name="isAvailable" class="form-checkbox h-6 w-6 text-white rounded-md border-gray-500 bg-gray-700">
                                    <span class="ml-3">Available</span>
                                </label>
                                <label class="flex items-center text-gray-300 text-base">
                                    <input type="checkbox" id="product-isTrending" name="isTrending" class="form-checkbox h-6 w-6 text-white rounded-md border-gray-500 bg-gray-700">
                                    <span class="ml-3">Trending</span>
                                </label>
                            </div>
                            <div class="flex justify-end space-x-4 mt-8">
                                <button type="button" class="bg-gray-500 hover:bg-gray-600 text-white py-3 px-6 rounded-lg transition duration-200" onclick="closeModal('product-modal')">Cancel</button>
                                <button type="submit" class="bg-green-500 hover:bg-green-600 text-black py-3 px-6 rounded-lg transition duration-200">Save Product</button>
                            </div>
                        </form>
                    </div>
                </div>
            </section>

            <!-- Customers Section -->
            <section id="customers-section" class="dashboard-section bg-gray-800 p-6 rounded-lg shadow-md mb-8 hidden">
                <h2 class="text-3xl font-bold text-white mb-6">Customer Info & Location</h2>
                <div class="overflow-x-auto">
                    <table class="min-w-full bg-gray-700 rounded-lg shadow-md">
                        <thead>
                            <tr class="bg-gray-600 text-gray-200 uppercase text-sm leading-normal">
                                <th class="py-3 px-6 text-left">Customer Name</th>
                                <th class="py-3 px-6 text-left">Phone</th>
                                <th class="py-3 px-6 text-left">Last Location</th>
                                <th class="py-3 px-6 text-center">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="customers-table-body" class="text-gray-300 text-sm font-light">
                            <!-- Customer data will be loaded here -->
                            <tr><td colspan="4" class="py-4 text-center">Loading customers...</td></tr>
                        </tbody>
                    </table>
                </div>
            </section>

            <!-- Settings Section -->
            <section id="settings-section" class="dashboard-section bg-gray-800 p-6 rounded-lg shadow-md hidden">
                <h2 class="text-3xl font-bold text-white mb-6">Shop Settings</h2>
                <form id="settings-form" class="space-y-5">
                    <div>
                        <label for="shop-name" class="block text-gray-300 text-base font-bold mb-2">Shop Name:</label>
                        <input type="text" id="shop-name" name="shopName" class="w-full" required>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-5">
                        <div>
                            <label for="shop-latitude" class="block text-gray-300 text-base font-bold mb-2">Shop Latitude:</label>
                            <input type="number" id="shop-latitude" name="shopLocation.latitude" step="0.000001" class="w-full" required>
                        </div>
                        <div>
                            <label for="shop-longitude" class="block text-gray-300 text-base font-bold mb-2">Shop Longitude:</label>
                            <input type="number" id="shop-longitude" name="shopLocation.longitude" step="0.000001" class="w-full" required>
                        </div>
                    </div>
                    <div>
                        <h3 class="text-xl font-bold text-gray-200 mb-3">Delivery Rates (KMs vs. Amount):</h3>
                        <div id="delivery-rates-container" class="space-y-4">
                            <!-- Delivery rates will be loaded here -->
                        </div>
                        <button type="button" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-3 px-6 rounded-lg mt-5 transition duration-200" onclick="addDeliveryRateField()">Add Rate</button>
                    </div>
                    <div class="flex justify-end mt-8">
                        <button type="submit" class="bg-green-500 hover:bg-green-600 text-black py-3 px-6 rounded-lg transition duration-200">Save Settings</button>
                    </div>
                </form>
            </section>
        </main>
    </div>

    <script src="https://cdn.socket.io/4.0.0/socket.io.min.js"></script>
    <script>
        const loadingIndicator = document.getElementById('loading-indicator');

        function showLoading() { loadingIndicator.classList.remove('hidden'); }
        function hideLoading() { loadingIndicator.classList.add('hidden'); }

        // Sidebar functionality for mobile
        const sidebar = document.getElementById('sidebar');
        const openSidebarBtn = document.getElementById('open-sidebar');
        const closeSidebarBtn = document.getElementById('close-sidebar');

        openSidebarBtn.addEventListener('click', () => {
            sidebar.classList.remove('-translate-x-full');
        });

        closeSidebarBtn.addEventListener('click', () => {
            sidebar.classList.add('-translate-x-full');
        });

        // Close sidebar when a nav link is clicked on mobile
        document.querySelectorAll('.nav-link').forEach(link => {
            link.addEventListener('click', () => {
                if (window.innerWidth < 1024) { // Check if on mobile/tablet
                    sidebar.classList.add('-translate-x-full');
                }
            });
        });

        // Section switching
        const sections = document.querySelectorAll('.dashboard-section');
        const navLinks = document.querySelectorAll('.nav-link');

        function showSection(sectionId) {
            sections.forEach(section => {
                section.classList.add('hidden');
            });
            document.getElementById(sectionId).classList.remove('hidden');

            navLinks.forEach(link => {
                link.classList.remove('bg-gray-800'); /* Active link background */
            });
            document.querySelector(`.nav-link[data-section="${sectionId.replace('-section', '')}"]`).classList.add('bg-gray-800'); /* Active link background */
        }

        navLinks.forEach(link => {
            link.addEventListener('click', (e) => {
                e.preventDefault();
                const section = e.target.dataset.section;
                showSection(`${section}-section`);
                // Trigger data fetch for the newly shown section
                if (section === 'orders') fetchOrders();
                if (section === 'menu') fetchMenuItems();
                if (section === 'customers') fetchCustomers();
                if (section === 'settings') fetchSettings();
                if (section === 'whatsapp-bot') fetchBotStatus(); // Fetch bot status when navigating to its section
            });
        });

        // Initial section display: WhatsApp Bot (default)
        showSection('whatsapp-bot-section');
        fetchBotStatus(); // Initial fetch for bot status on page load


        // --- Modals ---
        function openModal(modalId) {
            document.getElementById(modalId).classList.remove('hidden');
        }

        function closeModal(modalId) {
            document.getElementById(modalId).classList.add('hidden');
        }

        // --- WhatsApp Bot Status Display (Admin Dashboard) ---
        const socket = io(); // Connect to Socket.IO

        const botStatusIndicator = document.getElementById('bot-status-indicator');
        const botStatusText = document.getElementById('bot-status-text');

        async function fetchBotStatus() {
            try {
                const response = await fetch('/api/admin/bot-status');
                if (!response.ok) {
                    if (response.status === 401) {
                        window.location.href = '/admin/login'; // Redirect to login on unauthorized
                        return;
                    }
                    throw new Error('Failed to fetch bot status.');
                }
                const data = await response.json();
                updateBotStatusDisplay(data.status); // No QR data expected here
            } catch (error) {
                console.error('Error fetching bot status for admin dashboard:', error);
                updateBotStatusDisplay('error'); // Set a general error status
            }
        }

        function updateBotStatusDisplay(status) {
            // Update main bot status section
            switch (status) {
                case 'initializing':
                    botStatusIndicator.className = 'w-4 h-4 rounded-full bg-gray-500 animate-pulse';
                    botStatusText.textContent = 'Initializing WhatsApp client...';
                    break;
                case 'qr_received':
                    botStatusIndicator.className = 'w-4 h-4 rounded-full bg-yellow-500 animate-pulse';
                    botStatusText.textContent = 'QR Code received. Scan on public panel.';
                    break;
                case 'qr_error':
                    botStatusIndicator.className = 'w-4 h-4 rounded-full bg-red-500';
                    botStatusText.textContent = 'QR Code error. Check server logs.';
                    break;
                case 'qr_expired':
                    botStatusIndicator.className = 'w-4 h-4 rounded-full bg-red-500';
                    botStatusText.textContent = 'QR Code expired. Generate new on public panel.';
                    break;
                case 'authenticated':
                    botStatusIndicator.className = 'w-4 h-4 rounded-full bg-blue-500';
                    botStatusText.textContent = 'Authenticated. Waiting for ready...';
                    break;
                case 'ready':
                    botStatusIndicator.className = 'w-4 h-4 rounded-full bg-green-500';
                    botStatusText.textContent = 'WhatsApp Bot is Ready and Online!';
                    break;
                case 'auth_failure':
                    botStatusIndicator.className = 'w-4 h-4 rounded-full bg-red-500';
                    botStatusText.textContent = 'Authentication Failed! Please check public panel.';
                    break;
                case 'disconnected':
                    botStatusIndicator.className = 'w-4 h-4 rounded-full bg-orange-500 animate-pulse';
                    botStatusText.textContent = 'Disconnected. Reconnecting...';
                    break;
                case 'reconnecting':
                    botStatusIndicator.className = 'w-4 h-4 rounded-full bg-yellow-500 animate-pulse';
                    botStatusText.textContent = 'Reconnecting...';
                    break;
                case 'error': // General error state from frontend fetch
                    botStatusIndicator.className = 'w-4 h-4 rounded-full bg-red-500';
                    botStatusText.textContent = 'Error fetching bot status.';
                    break;
                default:
                    botStatusIndicator.className = 'w-4 h-4 rounded-full bg-gray-500';
                    botStatusText.textContent = `Status: ${status}`;
            }
        }

        // Socket.IO listener for real-time status updates
        socket.on('status', (status) => {
            updateBotStatusDisplay(status);
        });


        // --- Orders Management ---
        async function fetchOrders() {
            showLoading();
            try {
                const response = await fetch('/api/admin/orders');
                if (!response.ok) {
                    if (response.status === 401) {
                        window.location.href = '/admin/login'; // Redirect to login on unauthorized
                        return;
                    }
                    const errorData = await response.json();
                    throw new Error(errorData.message || 'Failed to fetch orders.');
                }
                const orders = await response.json();
                const tableBody = document.getElementById('orders-table-body');
                tableBody.innerHTML = ''; // Clear previous orders

                if (orders.length === 0) {
                    tableBody.innerHTML = '<tr><td colspan="7" class="py-4 text-center text-gray-500">No orders found.</td></tr>';
                    return;
                }

                orders.forEach(order => {
                    const row = `
                        <tr class="border-b border-gray-700 hover:bg-gray-700">
                            <td class="py-3 px-6 text-left whitespace-nowrap">${order._id.substring(0, 6)}...</td>
                            <td class="py-3 px-6 text-left">${order.customerName}</td>
                            <td class="py-3 px-6 text-left">${order.customerPhone}</td>
                            <td class="py-3 px-6 text-left">₹${order.totalAmount ? order.totalAmount.toFixed(2) : '0.00'}</td>
                            <td class="py-3 px-6 text-center">
                                <select onchange="updateOrderStatus('${order._id}', this.value)"
                                    class="bg-gray-700 text-gray-200 py-1 px-2 rounded-md text-sm focus:outline-none">
                                    ${['Pending', 'Confirmed', 'Preparing', 'Out for Delivery', 'Delivered', 'Cancelled'].map(status => `
                                        <option value="${status}" ${order.status === status ? 'selected' : ''}>${status}</option>
                                    `).join('')}
                                </select>
                            </td>
                            <td class="py-3 px-6 text-center">${new Date(order.orderDate).toLocaleDateString()}</td>
                            <td class="py-3 px-6 text-center">
                                <button onclick="viewOrderDetails('${order._id}')" class="text-blue-400 hover:text-white mr-2"><i class="fas fa-eye"></i></button>
                            </td>
                        </tr>
                    `;
                    tableBody.innerHTML += row;
                });
            } catch (error) {
                console.error('Error fetching orders:', error);
                const tableBody = document.getElementById('orders-table-body');
                tableBody.innerHTML = `<tr><td colspan="7" class="py-4 text-center text-red-500">Error loading orders: ${error.message}</td></tr>`;
            } finally {
                hideLoading();
            }
        }

        async function updateOrderStatus(orderId, newStatus) {
            showLoading();
            try {
                const response = await fetch(`/api/admin/orders/${orderId}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ status: newStatus })
                });
                if (!response.ok) {
                    if (response.status === 401) {
                        window.location.href = '/admin/login'; // Redirect to login on unauthorized
                        return;
                    }
                    const errorData = await response.json();
                    throw new Error(errorData.message || 'Failed to update order status.');
                }
                await fetchOrders(); // Refresh orders
            } catch (error) {
                console.error('Error updating order status:', error);
                // Use a custom modal or message box instead of alert
                // For now, using a simple console log and temporary message
                const errorMessage = `Failed to update order status. Please try again. Details: ${error.message}`;
                console.error(errorMessage);
                // alert(errorMessage); // Replaced with a more user-friendly approach if possible
                showTemporaryMessage(errorMessage, 'error');
            } finally {
                hideLoading();
            }
        }

        async function viewOrderDetails(orderId) {
            showLoading();
            try {
                const response = await fetch(`/api/admin/orders/${orderId}`);
                if (!response.ok) {
                    if (response.status === 401) {
                        window.location.href = '/admin/login'; // Redirect to login on unauthorized
                        return;
                    }
                    const errorData = await response.json();
                    throw new Error(errorData.message || 'Failed to fetch order details.');
                }
                const order = await response.json();
                const detailContent = document.getElementById('order-detail-content');

                // Robust checks for undefined/null values before accessing properties or calling toFixed
                const subtotalDisplay = order.subtotal !== undefined && order.subtotal !== null ? `₹${order.subtotal.toFixed(2)}` : 'N/A';
                const transportTaxDisplay = order.transportTax !== undefined && order.transportTax !== null ? `₹${order.transportTax.toFixed(2)}` : 'N/A';
                const totalAmountDisplay = order.totalAmount !== undefined && order.totalAmount !== null ? `₹${order.totalAmount.toFixed(2)}` : 'N/A';

                const customerLocationDisplay = order.customerLocation && order.customerLocation.latitude !== undefined && order.customerLocation.longitude !== undefined
                    ? `<h4 class="font-bold mt-6 mb-3 text-xl">Customer Location:</h4><p>Latitude: ${order.customerLocation.latitude}, Longitude: ${order.customerLocation.longitude}</p>`
                    : '';
                const shopLocationDisplay = order.deliveryFromLocation && order.deliveryFromLocation.latitude !== undefined && order.deliveryFromLocation.longitude !== undefined
                    ? `<h4 class="font-bold mt-6 mb-3 text-xl">Shop Location at Order:</h4><p>Latitude: ${order.deliveryFromLocation.latitude}, Longitude: ${order.deliveryFromLocation.longitude}</p>`
                    : '';

                detailContent.innerHTML = `
                    <p><strong>Order ID:</strong> ${order._id}</p>
                    <p><strong>Customer Name:</strong> ${order.customerName || 'N/A'}</p>
                    <p><strong>Customer Phone:</strong> ${order.customerPhone || 'N/A'}</p>
                    <p><strong>Delivery Address:</strong> ${order.deliveryAddress || 'N/A'}</p>
                    <p><strong>Order Date:</strong> ${order.orderDate ? new Date(order.orderDate).toLocaleString() : 'N/A'}</p>
                    <p><strong>Status:</strong> ${order.status || 'N/A'}</p>
                    <p><strong>Subtotal:</strong> ${subtotalDisplay}</p>
                    <p><strong>Transport Tax:</strong> ${transportTaxDisplay}</p>
                    <p><strong>Total Amount:</strong> ${totalAmountDisplay}</p>
                    <h4 class="font-bold mt-6 mb-3 text-xl">Items:</h4>
                    <ul class="list-disc list-inside space-y-2 ml-4">
                        ${order.items && order.items.length > 0 ? order.items.map(item => `
                            <li>${item.name || 'Unknown Item'} (x${item.quantity || 0}) - ₹${(item.price !== undefined && item.price !== null && item.quantity !== undefined && item.quantity !== null) ? (item.price * item.quantity).toFixed(2) : '0.00'}</li>
                        `).join('') : '<li>No items found.</li>'}
                    </ul>
                    ${customerLocationDisplay}
                    ${shopLocationDisplay}
                `;
                openModal('order-detail-modal');
            } catch (error) {
                console.error('Error fetching order details:', error);
                // Use a custom modal or message box instead of alert
                // For now, using a simple console log and temporary message
                const errorMessage = `Failed to fetch order details. Details: ${error.message}`;
                console.error(errorMessage);
                // alert(errorMessage); // Replaced with a more user-friendly approach if possible
                showTemporaryMessage(errorMessage, 'error');
            } finally {
                hideLoading();
            }
        }

        // Simple temporary message display (can be replaced with a full modal/toast system)
        function showTemporaryMessage(message, type = 'info') {
            const messageDiv = document.createElement('div');
            messageDiv.className = `fixed top-4 right-4 p-4 rounded-md shadow-lg text-white z-[101] transition-all duration-300 transform translate-x-0 opacity-100`;
            if (type === 'error') {
                messageDiv.classList.add('bg-red-600');
            } else if (type === 'success') {
                messageDiv.classList.add('bg-green-600');
            } else {
                messageDiv.classList.add('bg-gray-700');
            }
            messageDiv.textContent = message;
            document.body.appendChild(messageDiv);

            setTimeout(() => {
                messageDiv.classList.remove('opacity-100');
                messageDiv.classList.add('opacity-0', 'translate-x-full');
                messageDiv.addEventListener('transitionend', () => messageDiv.remove());
            }, 3000);
        }


        // Listen for new orders via Socket.IO
        socket.on('newOrder', (order) => {
            console.log('New order received via Socket.IO:', order);
            // Only refresh if the orders section is currently visible
            if (!document.getElementById('orders-section').classList.contains('hidden')) {
                fetchOrders();
            }
            // Optionally, show a toast notification for new order
            showTemporaryMessage('New Order Received!', 'success');
        });


        // --- Menu Management ---
        async function fetchMenuItems() {
            showLoading();
            try {
                const response = await fetch('/api/admin/menu');
                if (!response.ok) {
                    if (response.status === 401) {
                        window.location.href = '/admin/login'; // Redirect to login on unauthorized
                        return;
                    }
                    const errorData = await response.json();
                    throw new Error(errorData.message || 'Failed to fetch menu items.');
                }
                const products = await response.json();
                const tableBody = document.getElementById('menu-table-body');
                tableBody.innerHTML = '';

                if (products.length === 0) {
                    tableBody.innerHTML = '<tr><td colspan="7" class="py-4 text-center text-gray-500">No menu items found.</td></tr>';
                    return;
                }

                products.forEach(product => {
                    const row = `
                        <tr class="border-b border-gray-700 hover:bg-gray-700">
                            <td class="py-3 px-6 text-left">
                                <img src="${product.imageUrl}" onerror="this.onerror=null;this.src='https://placehold.co/50x50/cccccc/333333?text=Food';" alt="${product.name}" class="w-12 h-12 rounded-full object-cover">
                            </td>
                            <td class="py-3 px-6 text-left">${product.name}</td>
                            <td class="py-3 px-6 text-left">${product.category || 'N/A'}</td>
                            <td class="py-3 px-6 text-right">₹${product.price ? product.price.toFixed(2) : '0.00'}</td>
                            <td class="py-3 px-6 text-center">
                                <input type="checkbox" ${product.isAvailable ? 'checked' : ''} disabled class="form-checkbox h-4 w-4 text-white rounded">
                            </td>
                            <td class="py-3 px-6 text-center">
                                <input type="checkbox" ${product.isTrending ? 'checked' : ''} disabled class="form-checkbox h-4 w-4 text-white rounded">
                            </td>
                            <td class="py-3 px-6 text-center">
                                <button onclick="editProduct('${product._id}')" class="text-yellow-400 hover:text-white mr-2"><i class="fas fa-edit"></i></button>
                                <button onclick="deleteProduct('${product._id}')" class="text-red-400 hover:text-white"><i class="fas fa-trash-alt"></i></button>
                            </td>
                        </tr>
                    `;
                    tableBody.innerHTML += row;
                });
            } catch (error) {
                console.error('Error fetching menu items:', error);
                const tableBody = document.getElementById('menu-table-body');
                tableBody.innerHTML = `<tr><td colspan="7" class="py-4 text-center text-red-500">Error loading menu items: ${error.message}</td></tr>`;
            } finally {
                hideLoading();
            }
        }

        function openProductModal(product = null) {
            const modal = document.getElementById('product-modal');
            const form = document.getElementById('product-form');
            const title = document.getElementById('product-modal-title');

            form.reset(); // Clear form fields
            document.getElementById('product-id').value = ''; // Clear ID

            if (product) {
                title.textContent = 'Edit Product';
                document.getElementById('product-id').value = product._id;
                document.getElementById('product-name').value = product.name;
                document.getElementById('product-description').value = product.description || '';
                document.getElementById('product-price').value = product.price;
                document.getElementById('product-imageUrl').value = product.imageUrl || '';
                document.getElementById('product-category').value = product.category || '';
                document.getElementById('product-isAvailable').checked = product.isAvailable;
                document.getElementById('product-isTrending').checked = product.isTrending;
            } else {
                title.textContent = 'Add New Product';
                document.getElementById('product-isAvailable').checked = true; // Default new product to available
                document.getElementById('product-isTrending').checked = false;
            }
            openModal('product-modal');
        }

        async function editProduct(productId) {
            showLoading();
            try {
                const response = await fetch(`/api/admin/menu/${productId}`);
                if (!response.ok) {
                    if (response.status === 401) {
                        window.location.href = '/admin/login'; // Redirect to login on unauthorized
                        return;
                    }
                    const errorData = await response.json();
                    throw new Error(errorData.message || 'Failed to fetch product for edit.');
                }
                const product = await response.json();
                openProductModal(product);
            } catch (error) {
                console.error('Error fetching product for edit:', error);
                showTemporaryMessage(`Failed to load product for editing. Details: ${error.message}`, 'error');
            } finally {
                hideLoading();
            }
        }

        document.getElementById('product-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            showLoading();
            const productId = document.getElementById('product-id').value;
            const formData = new FormData(e.target);
            const productData = Object.fromEntries(formData.entries());

            // Convert checkboxes to boolean
            productData.isAvailable = productData.isAvailable === 'on';
            productData.isTrending = productData.isTrending === 'on';
            productData.price = parseFloat(productData.price);

            console.log('Sending product data:', productData); // Frontend log of data being sent

            try {
                let response;
                if (productId) {
                    response = await fetch(`/api/admin/menu/${productId}`, {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(productData)
                    });
                } else {
                    response = await fetch('/api/admin/menu', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(productData)
                    });
                }
                if (!response.ok) {
                    if (response.status === 401) {
                        window.location.href = '/admin/login'; // Redirect to login on unauthorized
                        return;
                    }
                    const errorData = await response.json();
                    throw new Error(errorData.message || `Failed to save product. Server response: ${response.status}`);
                }
                closeModal('product-modal');
                await fetchMenuItems(); // Refresh menu
                showTemporaryMessage('Product saved successfully!', 'success');
            } catch (error) {
                console.error('Error saving product:', error);
                showTemporaryMessage(`Failed to save product. Please check your input. Details: ${error.message}`, 'error');
            } finally {
                hideLoading();
            }
        });

        async function deleteProduct(productId) {
            // Replaced confirm with a custom modal if needed, for now using a simple check
            if (!confirm('Are you sure you want to delete this product?')) {
                return;
            }
            showLoading();
            try {
                const response = await fetch(`/api/admin/menu/${productId}`, {
                    method: 'DELETE'
                });
                if (!response.ok) {
                    if (response.status === 401) {
                        window.location.href = '/admin/login'; // Redirect to login on unauthorized
                        return;
                    }
                    const errorData = await response.json();
                    throw new Error(errorData.message || 'Failed to delete product.');
                }
                await fetchMenuItems(); // Refresh menu
                showTemporaryMessage('Product deleted successfully!', 'success');
            } catch (error) {
                console.error('Error deleting product:', error);
                showTemporaryMessage(`Failed to delete product. Details: ${error.message}`, 'error');
            } finally {
                hideLoading();
            }
        }

        // --- Customer Management ---
        async function fetchCustomers() {
            showLoading();
            try {
                const response = await fetch('/api/admin/customers');
                if (!response.ok) {
                    if (response.status === 401) {
                        window.location.href = '/admin/login'; // Redirect to login on unauthorized
                        return;
                    }
                    const errorData = await response.json();
                    throw new Error(errorData.message || 'Failed to fetch customer data.');
                }
                const customers = await response.json();
                const tableBody = document.getElementById('customers-table-body');
                tableBody.innerHTML = '';

                if (customers.length === 0) {
                    tableBody.innerHTML = '<tr><td colspan="4" class="py-4 text-center text-gray-500">No customer data found.</td></tr>';
                    return;
                }

                customers.forEach(customer => {
                    const locationText = customer.lastKnownLocation && customer.lastKnownLocation.latitude !== undefined && customer.lastKnownLocation.longitude !== undefined
                        ? `Lat: ${customer.lastKnownLocation.latitude.toFixed(4)}, Lon: ${customer.lastKnownLocation.longitude.toFixed(4)}`
                        : 'N/A';
                    const trackButton = customer.lastKnownLocation && customer.lastKnownLocation.latitude !== undefined && customer.lastKnownLocation.longitude !== undefined &&
                                         customer.shopLocation && customer.shopLocation.latitude !== undefined && customer.shopLocation.longitude !== undefined
                        ? `<button onclick="trackCustomer('${customer.lastKnownLocation.latitude}', '${customer.lastKnownLocation.longitude}', '${customer.shopLocation.latitude}', '${customer.shopLocation.longitude}')" class="text-blue-400 hover:text-white ml-2"><i class="fas fa-map-marker-alt"></i> Track</button>`
                        : `<button class="text-gray-500 cursor-not-allowed ml-2" disabled><i class="fas fa-map-marker-alt"></i> Track</button>`;

                    const row = `
                        <tr class="border-b border-gray-700 hover:bg-gray-700">
                            <td class="py-3 px-6 text-left">${customer.customerName || 'Unknown'}</td>
                            <td class="py-3 px-6 text-left">${customer.customerPhone || 'N/A'}</td>
                            <td class="py-3 px-6 text-left">${locationText}</td>
                            <td class="py-3 px-6 text-center whitespace-nowrap">
                                <a href="tel:+${customer.customerPhone}" class="text-green-400 hover:text-white mr-2"><i class="fas fa-phone"></i> Call</a>
                                ${trackButton}
                            </td>
                        </tr>
                    `;
                    tableBody.innerHTML += row;
                });
            } catch (error) {
                console.error('Error fetching customers:', error);
                const tableBody = document.getElementById('customers-table-body');
                tableBody.innerHTML = `<tr><td colspan="4" class="py-4 text-center text-red-500">Error loading customer data: ${error.message}</td></tr>`;
            } finally {
                hideLoading();
            }
        }

        function callCustomer(phoneNumber) {
            window.location.href = `tel:+${phoneNumber}`;
        }

        function trackCustomer(customerLat, customerLon, shopLat, shopLon) {
            const googleMapsUrl = `https://www.google.com/maps/dir/?api=1&origin=${shopLat},${shopLon}&destination=${customerLat},${customerLon}`;
            window.open(googleMapsUrl, '_blank');
        }


        // --- Settings Management ---
        async function fetchSettings() {
            showLoading();
            try {
                const response = await fetch('/api/admin/settings');
                if (!response.ok) {
                    if (response.status === 401) {
                        window.location.href = '/admin/login'; // Redirect to login on unauthorized
                        return;
                    }
                    const errorData = await response.json();
                    throw new Error(errorData.message || 'Failed to fetch settings.');
                }
                const settings = await response.json();
                document.getElementById('shop-name').value = settings.shopName || '';
                document.getElementById('shop-latitude').value = settings.shopLocation?.latitude || 0;
                document.getElementById('shop-longitude').value = settings.shopLocation?.longitude || 0;

                const ratesContainer = document.getElementById('delivery-rates-container');
                ratesContainer.innerHTML = ''; // Clear existing rates
                if (settings.deliveryRates && settings.deliveryRates.length > 0) {
                    settings.deliveryRates.forEach(rate => addDeliveryRateField(rate.kms, rate.amount));
                } else {
                    addDeliveryRateField(); // Add one empty field if none exist
                }
            } catch (error) {
                console.error('Error fetching settings:', error);
                showTemporaryMessage(`Failed to load settings. Details: ${error.message}`, 'error');
            } finally {
                hideLoading();
            }
        }

        function addDeliveryRateField(kms = '', amount = '') {
            const ratesContainer = document.getElementById('delivery-rates-container');
            const div = document.createElement('div');
            div.className = 'flex flex-col sm:flex-row gap-4 items-center'; /* Increased gap */
            div.innerHTML = `
                <input type="number" placeholder="KMs" value="${kms}" class="w-full sm:w-1/2" required>
                <input type="number" placeholder="Amount" value="${amount}" step="0.01" class="w-full sm:w-1/2" required>
                <button type="button" class="bg-red-500 hover:bg-red-600 text-white font-bold py-3 px-6 rounded-lg transition duration-200 flex-shrink-0 w-full sm:w-auto" onclick="this.parentNode.remove()">Remove</button>
            `;
            ratesContainer.appendChild(div);
        }

        document.getElementById('settings-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            showLoading();
            const formData = new FormData(e.target);
            const settingsData = {
                shopName: formData.get('shopName'),
                shopLocation: {
                    latitude: parseFloat(formData.get('shopLocation.latitude')),
                    longitude: parseFloat(formData.get('shopLocation.longitude'))
                },
                deliveryRates: []
            };

            const rateInputs = document.querySelectorAll('#delivery-rates-container > div');
            rateInputs.forEach(div => {
                const kmsInput = div.querySelector('input[placeholder="KMs"]');
                const amountInput = div.querySelector('input[placeholder="Amount"]');
                if (kmsInput && amountInput && kmsInput.value && amountInput.value) {
                    settingsData.deliveryRates.push({
                        kms: parseFloat(kmsInput.value),
                        amount: parseFloat(amountInput.value)
                    });
                }
            });

            console.log('Sending settings data:', settingsData); // Frontend log of data being sent

            try {
                const response = await fetch('/api/admin/settings', {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(settingsData)
                });
                if (!response.ok) {
                    if (response.status === 401) {
                        window.location.href = '/admin/login'; // Redirect to login on unauthorized
                        return;
                    }
                    const errorData = await response.json();
                    throw new Error(errorData.message || `Failed to save settings. Server response: ${response.status}`);
                }
                showTemporaryMessage('Settings saved successfully!', 'success');
            } catch (error) {
                console.error('Error saving settings:', error);
                showTemporaryMessage(`Failed to save settings. Please check your input. Details: ${error.message}`, 'error');
            } finally {
                hideLoading();
            }
        });

        // Initial fetch for orders when page loads
        fetchOrders();
    </script>
</body>
</html>

