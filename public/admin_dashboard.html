<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard - Delicious Bites</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <script src="/socket.io/socket.io.js"></script>
    <style>
        /* Base styles for black and white theme */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #000000; /* Pure black background */
            color: #ffffff; /* Pure white text */
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 1rem;
        }
        header {
            background-color: #1a1a1a; /* Dark gray for header */
            border-bottom: 1px solid #333333;
            padding: 1rem;
            box-shadow: 0 2px 4px rgba(255,255,255,0.05);
        }
        h1, h2, h3 {
            color: #ffffff; /* White for headings */
        }
        /* Card/Panel backgrounds */
        .bg-panel {
            background-color: #1a1a1a; /* Dark gray for main content panels */
            border-radius: 0.75rem;
            box-shadow: 0 4px 8px rgba(255,255,255,0.08);
            padding: 1.5rem;
        }
        /* Input field styling */
        input[type="text"],
        input[type="number"],
        input[type="url"],
        textarea,
        select {
            background-color: #222222; /* Slightly lighter dark gray for inputs */
            border: 1px solid #444444;
            color: #ffffff;
            padding: 0.5rem 0.75rem;
            border-radius: 0.375rem;
            width: 100%;
        }
        input::placeholder, textarea::placeholder {
            color: #888888; /* Lighter gray for placeholders */
        }
        /* Button styling */
        .btn-primary {
            background-color: #ffffff; /* White background */
            color: #000000; /* Black text */
            padding: 0.6rem 1.2rem;
            border-radius: 0.5rem;
            font-weight: 600;
            transition: background-color 0.2s ease-in-out;
        }
        .btn-primary:hover {
            background-color: #e0e0e0;
        }
        .btn-secondary {
            background-color: #666666; /* Darker gray for utility buttons */
            color: #ffffff;
            padding: 0.6rem 1.2rem;
            border-radius: 0.5rem;
            font-weight: 600;
            transition: background-color 0.2s ease-in-out;
        }
        .btn-secondary:hover {
            background-color: #888888;
        }
        .btn-danger {
            background-color: #ff6666; /* Light red for danger */
            color: #000000; /* Black text */
            padding: 0.6rem 1.2rem;
            border-radius: 0.5rem;
            font-weight: 600;
            transition: background-color 0.2s ease-in-out;
        }
        .btn-danger:hover {
            background-color: #ee4444;
        }
        /* New action buttons for Call/Track */
        .btn-action {
            background-color: #66ff66; /* Light green for actions */
            color: #000000; /* Black text */
            padding: 0.4rem 0.8rem;
            border-radius: 0.3rem;
            font-weight: 600;
            transition: background-color 0.2s ease-in-out;
            white-space: nowrap; /* Prevent text wrapping */
            display: inline-flex; /* Use flex for icon/text alignment if needed */
            align-items: center;
            justify-content: center;
        }
        .btn-action:hover {
            background-color: #44ee44;
        }
        .btn-action.disabled {
            opacity: 0.5;
            cursor: not-allowed;
            background-color: #333333; /* Darker background when disabled */
            color: #999999; /* Lighter text when disabled */
        }

        /* Alert styling */
        .alert {
            padding: 1rem;
            border-radius: 0.5rem;
            margin-bottom: 1rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        .alert-red {
            background-color: #440000;
            color: #ff6666;
            border: 1px solid #ff6666;
        }
        .alert-yellow {
            background-color: #444400;
            color: #ffff66;
            border: 1px solid #ffff66;
        }
        .alert-green {
            background-color: #004400;
            color: #66ff66;
            border: 1px solid #66ff66;
        }
        /* Loader styling */
        .loader {
            border: 4px solid #333333;
            border-top: 4px solid #66ff66; /* Green loader */
            border-radius: 50%;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
            display: inline-block;
            vertical-align: middle;
            margin-right: 8px;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        /* Modal styling */
        .modal {
            display: none; /* Hidden by default */
            position: fixed; /* Stay in place */
            z-index: 1000; /* Sit on top */
            left: 0;
            top: 0;
            width: 100%; /* Full width */
            height: 100%; /* Full height */
            overflow: auto; /* Enable scroll if needed */
            background-color: rgba(0,0,0,0.8); /* Darker overlay */
            justify-content: center;
            align-items: center;
        }
        .modal-content {
            background-color: #1a1a1a; /* Dark gray for modal content */
            margin: auto;
            padding: 2rem;
            border-radius: 0.75rem;
            box-shadow: 0 5px 15px rgba(255,255,255,0.1);
            width: 90%;
            max-width: 600px;
            position: relative;
            color: #ffffff;
        }
        .close-button {
            color: #aaaaaa;
            position: absolute;
            top: 1rem;
            right: 1rem;
            font-size: 1.75rem;
            font-weight: bold;
            cursor: pointer;
        }
        .close-button:hover,
        .close-button:focus {
            color: #ffffff;
            text-decoration: none;
            cursor: pointer;
        }
        /* Table styling */
        table {
            width: 100%;
            border-collapse: collapse;
        }
        th, td {
            padding: 0.75rem 1rem;
            text-align: left;
            border-bottom: 1px solid #333333; /* Darker border for table rows */
        }
        th {
            background-color: #333333; /* Darker header background */
            font-weight: 600;
            color: #ffffff;
        }
        tr:hover {
            background-color: #2a2a2a; /* Slightly lighter hover for rows */
        }
        /* Status Badges */
        .status-badge {
            padding: 0.25rem 0.75rem;
            border-radius: 9999px; /* Fully rounded */
            font-size: 0.75rem;
            font-weight: 700;
            display: inline-block;
        }
        .status-pending { background-color: #ffff66; color: #333300; } /* Yellow */
        .status-confirmed, .status-preparing { background-color: #66ccff; color: #003366; } /* Light Blue */
        .status-out-for-delivery { background-color: #cc66ff; color: #330066; } /* Light Purple */
        .status-delivered { background-color: #66ff66; color: #003300; } /* Light Green */
        .status-cancelled { background-color: #ff6666; color: #330000; } /* Light Red */

        /* Responsive adjustments */
        @media (max-width: 768px) {
            .tab-button {
                flex-grow: 1; /* Make tabs take full width on small screens */
                text-align: center;
            }
            .flex-col-md {
                flex-direction: column;
            }
            .w-1/2-md {
                width: 100%;
            }
            /* For tables on small screens, allow horizontal scroll */
            .table-responsive {
                overflow-x: auto;
            }
        }
    </style>
</head>
<body class="min-h-screen">
    <div class="container mx-auto p-4">
        <header class="flex justify-between items-center py-4 border-b border-gray-700 mb-6">
            <h1 class="text-4xl font-bold text-white">Admin Dashboard</h1>
            <nav>
                <a href="/admin/logout" class="btn-danger">Logout</a>
            </nav>
        </header>

        <main class="mt-8">
            <h2 class="text-3xl font-bold text-white mb-4">WhatsApp Bot Status</h2>
            <div id="bot-status-alert" class="alert hidden">
                <span id="alert-message"></span>
                <div class="flex flex-col sm:flex-row space-y-2 sm:space-y-0 sm:space-x-2">
                    <button id="load-session-btn" class="btn-secondary hidden">Load Saved Session</button>
                    <button id="request-qr-btn" class="btn-secondary hidden">Request New QR</button>
                </div>
            </div>
            <p class="text-gray-400 mb-6">Current Status: <span id="bot-status" class="font-semibold text-white">Loading...</span></p>

            <!-- Tabs for navigation -->
            <div class="flex flex-wrap border-b border-gray-700 mb-6">
                <button class="tab-button px-4 py-2 text-lg font-medium focus:outline-none text-gray-400 hover:text-white transition duration-200" data-tab="orders">Orders</button>
                <button class="tab-button px-4 py-2 text-lg font-medium focus:outline-none text-gray-400 hover:text-white transition duration-200" data-tab="menu">Menu</button>
                <button class="tab-button px-4 py-2 text-lg font-medium focus:outline-none text-gray-400 hover:text-white transition duration-200" data-tab="settings">Settings</button>
                <button class="tab-button px-4 py-2 text-lg font-medium focus:outline-none text-gray-400 hover:text-white transition duration-200" data-tab="customers">Customers</button>
            </div>

            <!-- Orders Tab Content -->
            <div id="orders-tab" class="tab-content">
                <h2 class="text-3xl font-bold text-white mb-6">Recent Orders</h2>
                <div class="bg-panel p-4 table-responsive">
                    <div id="orders-list">
                        <p class="text-gray-400 text-center">Loading orders...</p>
                    </div>
                </div>
            </div>

            <!-- Menu Tab Content -->
            <div id="menu-tab" class="tab-content hidden">
                <h2 class="text-3xl font-bold text-white mb-6">Menu Management</h2>
                <button id="add-menu-item-btn" class="btn-primary mb-4">Add New Menu Item</button>
                <div class="bg-panel p-4 table-responsive">
                    <div id="menu-items-list">
                        <p class="text-gray-400 text-center">Loading menu items...</p>
                    </div>
                </div>
            </div>

            <!-- Settings Tab Content -->
            <div id="settings-tab" class="tab-content hidden">
                <h2 class="text-3xl font-bold text-white mb-6">Shop Settings</h2>
                <form id="settings-form" class="bg-panel p-6 space-y-4">
                    <div>
                        <label for="shop-name" class="block text-gray-300 text-sm font-bold mb-2">Shop Name:</label>
                        <input type="text" id="shop-name" name="shopName" required>
                    </div>
                    <div>
                        <label class="block text-gray-300 text-sm font-bold mb-2">Shop Location (Latitude, Longitude):</label>
                        <input type="number" step="any" id="shop-latitude" name="shopLocation.latitude" placeholder="Latitude" required class="mb-2">
                        <input type="number" step="any" id="shop-longitude" name="shopLocation.longitude" placeholder="Longitude" required>
                    </div>
                    <div>
                        <h3 class="text-xl font-bold text-white mb-2">Delivery Rates (KMs, Amount)</h3>
                        <div id="delivery-rates-container" class="space-y-2">
                            <!-- Delivery rates will be dynamically added here -->
                        </div>
                        <button type="button" id="add-delivery-rate-btn" class="mt-4 btn-secondary">Add Rate</button>
                    </div>
                    <button type="submit" class="btn-primary">Save Settings</button>
                    <p id="settings-message" class="mt-2 text-sm text-center"></p>
                </form>
            </div>

            <!-- Customers Tab Content -->
            <div id="customers-tab" class="tab-content hidden">
                <h2 class="text-3xl font-bold text-white mb-6">Customer Locations</h2>
                <div class="bg-panel p-4 table-responsive">
                    <div id="customers-list">
                        <p class="text-gray-400 text-center">Loading customer data...</p>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Modals (Order Details, Menu Item Form) -->

    <!-- Order Details Modal -->
    <div id="order-details-modal" class="modal">
        <div class="modal-content">
            <span class="close-button">&times;</span>
            <h2 class="text-2xl font-bold text-white mb-4">Order Details</h2>
            <div id="order-details-content" class="text-gray-300 mb-4">
                <!-- Details will be loaded here -->
            </div>
            <div class="mt-4">
                <label for="order-status-select" class="block text-gray-300 text-sm font-bold mb-2">Update Status:</label>
                <select id="order-status-select">
                    <option value="Pending">Pending</option>
                    <option value="Confirmed">Confirmed</option>
                    <option value="Preparing">Preparing</option>
                    <option value="Out for Delivery">Out for Delivery</option>
                    <option value="Delivered">Delivered</option>
                    <option value="Cancelled">Cancelled</option>
                </select>
                <button id="update-order-status-btn" class="mt-4 btn-secondary">Update Status</button>
                <p id="order-update-message" class="mt-2 text-sm text-center"></p>
            </div>
        </div>
    </div>

    <!-- Menu Item Form Modal -->
    <div id="menu-item-modal" class="modal">
        <div class="modal-content">
            <span class="close-button">&times;</span>
            <h2 id="menu-item-modal-title" class="text-2xl font-bold text-white mb-4">Add New Menu Item</h2>
            <form id="menu-item-form" class="space-y-4">
                <input type="hidden" id="menu-item-id">
                <div>
                    <label for="item-name" class="block text-gray-300 text-sm font-bold mb-2">Name:</label>
                    <input type="text" id="item-name" name="name" required>
                </div>
                <div>
                    <label for="item-description" class="block text-gray-300 text-sm font-bold mb-2">Description:</label>
                    <textarea id="item-description" name="description"></textarea>
                </div>
                <div>
                    <label for="item-price" class="block text-gray-300 text-sm font-bold mb-2">Price:</label>
                    <input type="number" step="0.01" id="item-price" name="price" required min="0">
                </div>
                <div>
                    <label for="item-image-url" class="block text-gray-300 text-sm font-bold mb-2">Image URL:</label>
                    <input type="url" id="item-image-url" name="imageUrl" placeholder="https://placehold.co/300x200/cccccc/333333?text=Food+Item">
                </div>
                <div>
                    <label for="item-category" class="block text-gray-300 text-sm font-bold mb-2">Category:</label>
                    <input type="text" id="item-category" name="category" value="Main Course">
                </div>
                <div class="flex items-center">
                    <input type="checkbox" id="item-is-available" name="isAvailable" class="mr-2 h-4 w-4 text-green-600 focus:ring-green-500 border-gray-300 rounded bg-gray-700">
                    <label for="item-is-available" class="text-gray-300 text-sm">Available</label>
                </div>
                <div class="flex items-center">
                    <input type="checkbox" id="item-is-trending" name="isTrending" class="mr-2 h-4 w-4 text-green-600 focus:ring-green-500 border-gray-300 rounded bg-gray-700">
                    <label for="item-is-trending" class="text-gray-300 text-sm">Trending</label>
                </div>
                <button type="submit" class="btn-primary">Save Item</button>
                <p id="menu-item-message" class="mt-2 text-sm text-center"></p>
            </form>
        </div>
    </div>


    <script>
        const socket = io();
        const botStatusSpan = document.getElementById('bot-status');
        const botStatusAlert = document.getElementById('bot-status-alert');
        const alertMessage = document.getElementById('alert-message');
        const requestQrBtn = document.getElementById('request-qr-btn');
        const loadSessionBtn = document.getElementById('load-session-btn'); // New button

        const ordersTabBtn = document.querySelector('[data-tab="orders"]');
        const menuTabBtn = document.querySelector('[data-tab="menu"]');
        const settingsTabBtn = document.querySelector('[data-tab="settings"]');
        const customersTabBtn = document.querySelector('[data-tab="customers"]');

        const ordersTabContent = document.getElementById('orders-tab');
        const menuTabContent = document.getElementById('menu-tab');
        const settingsTabContent = document.getElementById('settings-tab');
        const customersTabContent = document.getElementById('customers-tab');

        const ordersList = document.getElementById('orders-list');
        const menuItemsList = document.getElementById('menu-items-list');
        const addMenuItemBtn = document.getElementById('add-menu-item-btn');
        const settingsForm = document.getElementById('settings-form');
        const deliveryRatesContainer = document.getElementById('delivery-rates-container');
        const addDeliveryRateBtn = document.getElementById('add-delivery-rate-btn');
        const settingsMessage = document.getElementById('settings-message');
        const customersList = document.getElementById('customers-list');

        const orderDetailsModal = document.getElementById('order-details-modal');
        const closeOrderDetailsModalBtn = orderDetailsModal.querySelector('.close-button');
        const orderDetailsContent = document.getElementById('order-details-content');
        const orderStatusSelect = document.getElementById('order-status-select');
        const updateOrderStatusBtn = document.getElementById('update-order-status-btn');
        const orderUpdateMessage = document.getElementById('order-update-message');
        let currentOrderId = null;

        const menuItemModal = document.getElementById('menu-item-modal');
        const closeMenuItemModalBtn = menuItemModal.querySelector('.close-button');
        const menuItemModalTitle = document.getElementById('menu-item-modal-title');
        const menuItemForm = document.getElementById('menu-item-form');
        const menuItemIdInput = document.getElementById('menu-item-id');
        const itemNameInput = document.getElementById('item-name');
        const itemDescriptionInput = document.getElementById('item-description');
        const itemPriceInput = document.getElementById('item-price');
        const itemImageUrlInput = document.getElementById('item-image-url');
        const itemCategoryInput = document.getElementById('item-category');
        const itemIsAvailableInput = document.getElementById('item-is-available');
        const itemIsTrendingInput = document.getElementById('item-is-trending');
        const menuItemMessage = document.getElementById('menu-item-message');

        let currentActiveTab = 'orders'; // Default active tab
        let shopLocationData = null; // To store shop location for customer tracking

        // --- Tab Switching Logic ---
        function switchTab(tabName) {
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.add('hidden');
            });
            document.querySelectorAll('.tab-button').forEach(button => {
                button.classList.remove('bg-gray-700', 'text-white');
                button.classList.add('text-gray-400', 'hover:text-white');
            });

            document.getElementById(`${tabName}-tab`).classList.remove('hidden');
            document.querySelector(`[data-tab="${tabName}"]`).classList.add('bg-gray-700', 'text-white');
            document.querySelector(`[data-tab="${tabName}"]`).classList.remove('text-gray-400', 'hover:text-white');
            currentActiveTab = tabName;

            // Fetch data for the active tab
            if (tabName === 'orders') fetchOrders();
            else if (tabName === 'menu') fetchMenuItems();
            else if (tabName === 'settings') fetchSettings();
            else if (tabName === 'customers') fetchCustomers();
        }

        ordersTabBtn.addEventListener('click', () => switchTab('orders'));
        menuTabBtn.addEventListener('click', () => switchTab('menu'));
        settingsTabBtn.addEventListener('click', () => switchTab('settings'));
        customersTabBtn.addEventListener('click', () => switchTab('customers'));

        // Initialize with the default tab
        switchTab(currentActiveTab);


        // --- WhatsApp Bot Status ---
        socket.on('status', (status) => {
            botStatusSpan.textContent = status;
            botStatusAlert.classList.remove('alert-red', 'alert-yellow', 'alert-green', 'hidden');
            requestQrBtn.classList.add('hidden'); // Hide by default
            loadSessionBtn.classList.add('hidden'); // Hide by default

            let message = '';
            let alertClass = '';

            switch (status) {
                case 'ready':
                    message = 'WhatsApp bot is connected and ready!';
                    alertClass = 'alert-green';
                    break;
                case 'authenticated':
                    message = 'WhatsApp bot authenticated. Waiting for ready state...';
                    alertClass = 'alert-yellow';
                    break;
                case 'qr_received':
                    message = 'QR Code received. Scan it with your WhatsApp app.';
                    alertClass = 'alert-yellow';
                    requestQrBtn.classList.remove('hidden'); // Show QR button
                    break;
                case 'qr_expired':
                    message = 'QR Code expired. Please request a new one.';
                    alertClass = 'alert-red';
                    requestQrBtn.classList.remove('hidden'); // Show QR button
                    loadSessionBtn.classList.remove('hidden'); // Show Load Session button
                    break;
                case 'auth_failure':
                    message = 'Authentication failed. Please request a new QR code and re-scan.';
                    alertClass = 'alert-red';
                    requestQrBtn.classList.remove('hidden'); // Show QR button
                    loadSessionBtn.classList.remove('hidden'); // Show Load Session button
                    break;
                case 'disconnected':
                    message = 'WhatsApp bot disconnected. Attempting to reconnect or waiting for new QR.';
                    alertClass = 'alert-red';
                    requestQrBtn.classList.remove('hidden'); // Show QR button
                    loadSessionBtn.classList.remove('hidden'); // Show Load Session button
                    break;
                case 'initializing':
                    message = 'WhatsApp bot is initializing...';
                    alertClass = 'alert-yellow';
                    break;
                case 'reconnecting':
                    message = 'WhatsApp bot is reconnecting...';
                    alertClass = 'alert-yellow';
                    break;
                case 'qr_error':
                    message = 'Error generating QR code. Check server logs.';
                    alertClass = 'alert-red';
                    requestQrBtn.classList.remove('hidden'); // Show QR button
                    loadSessionBtn.classList.remove('hidden'); // Show Load Session button
                    break;
                default:
                    message = `Unknown status: ${status}`;
                    alertClass = 'alert-yellow';
            }

            alertMessage.textContent = message;
            botStatusAlert.classList.add(alertClass);
            botStatusAlert.classList.remove('hidden');
        });

        requestQrBtn.addEventListener('click', async () => {
            requestQrBtn.disabled = true;
            loadSessionBtn.disabled = true;
            alertMessage.textContent = 'Requesting new QR...';
            botStatusAlert.classList.remove('alert-red', 'alert-yellow', 'alert-green');
            botStatusAlert.classList.add('alert-yellow');

            try {
                const response = await fetch('/api/public/request-qr', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' }
                });
                const result = await response.json();
                if (response.ok) {
                    alertMessage.textContent = result.message;
                    // Status update will come via socket.io
                } else {
                    alertMessage.textContent = `Error: ${result.message || 'Failed to request new QR.'}`;
                    botStatusAlert.classList.remove('alert-yellow');
                    botStatusAlert.classList.add('alert-red');
                }
            } catch (error) {
                alertMessage.textContent = `Network error requesting QR: ${error.message}`;
                botStatusAlert.classList.remove('alert-yellow');
                botStatusAlert.classList.add('alert-red');
            } finally {
                requestQrBtn.disabled = false;
                loadSessionBtn.disabled = false;
            }
        });

        loadSessionBtn.addEventListener('click', async () => {
            loadSessionBtn.disabled = true;
            requestQrBtn.disabled = true;
            alertMessage.textContent = 'Attempting to load saved session...';
            botStatusAlert.classList.remove('alert-red', 'alert-yellow', 'alert-green');
            botStatusAlert.classList.add('alert-yellow');

            try {
                const response = await fetch('/api/admin/load-session', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' }
                });
                const result = await response.json();
                if (response.ok) {
                    alertMessage.textContent = result.message;
                    // Status update will come via socket.io
                } else {
                    alertMessage.textContent = `Error: ${result.message || 'Failed to load session.'}`;
                    botStatusAlert.classList.remove('alert-yellow');
                    botStatusAlert.classList.add('alert-red');
                }
            } catch (error) {
                alertMessage.textContent = `Network error loading session: ${error.message}`;
                botStatusAlert.classList.remove('alert-yellow');
                botStatusAlert.classList.add('alert-red');
            } finally {
                loadSessionBtn.disabled = false;
                requestQrBtn.disabled = false;
            }
        });


        // --- Orders Tab Functions ---
        async function fetchOrders() {
            ordersList.innerHTML = '<p class="text-gray-400 text-center py-4">Loading orders...</p>';
            try {
                const response = await fetch('/api/admin/orders');
                if (!response.ok) {
                    if (response.status === 401) {
                        window.location.href = '/admin/login'; // Redirect to login if unauthorized
                        return;
                    }
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                const orders = await response.json();
                displayOrders(orders);
            } catch (error) {
                console.error('Error fetching orders:', error);
                ordersList.innerHTML = `<p class="text-red-500 text-center py-4">Failed to load orders: ${error.message}</p>`;
            }
        }

        function displayOrders(orders) {
            ordersList.innerHTML = '';
            if (orders.length === 0) {
                ordersList.innerHTML = '<p class="text-gray-400 text-center py-4">No orders found.</p>';
                return;
            }

            const table = document.createElement('table');
            table.className = 'min-w-full'; // Tailwind's default table styles are applied via global CSS
            table.innerHTML = `
                <thead>
                    <tr>
                        <th>Order ID</th>
                        <th>Customer</th>
                        <th>Phone</th>
                        <th>Total</th>
                        <th>Payment</th>
                        <th>Status</th>
                        <th>Date</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="orders-table-body"></tbody>
            `;
            ordersList.appendChild(table);
            const tbody = document.getElementById('orders-table-body');

            orders.forEach(order => {
                const row = tbody.insertRow();
                row.innerHTML = `
                    <td>${order._id.substring(0, 8)}...</td>
                    <td>${order.customerName}</td>
                    <td>${order.customerPhone}</td>
                    <td>₹${order.totalAmount.toFixed(2)}</td>
                    <td>${order.paymentMethod || 'N/A'}</td>
                    <td>
                        <span class="status-badge
                            ${order.status === 'Pending' ? 'status-pending' : ''}
                            ${order.status === 'Confirmed' ? 'status-confirmed' : ''}
                            ${order.status === 'Preparing' ? 'status-preparing' : ''}
                            ${order.status === 'Out for Delivery' ? 'status-out-for-delivery' : ''}
                            ${order.status === 'Delivered' ? 'status-delivered' : ''}
                            ${order.status === 'Cancelled' ? 'status-cancelled' : ''}
                        ">${order.status}</span>
                    </td>
                    <td>${new Date(order.orderDate).toLocaleString()}</td>
                    <td>
                        <button data-id="${order._id}" class="view-order-btn btn-secondary text-sm py-1 px-3">View</button>
                    </td>
                `;
            });

            ordersList.querySelectorAll('.view-order-btn').forEach(button => {
                button.addEventListener('click', (e) => openOrderDetailsModal(e.target.dataset.id));
            });
        }

        async function openOrderDetailsModal(orderId) {
            currentOrderId = orderId;
            orderDetailsContent.innerHTML = '<p class="text-gray-400">Loading order details...</p>';
            orderDetailsModal.style.display = 'flex';
            orderUpdateMessage.textContent = ''; // Clear previous messages

            try {
                const response = await fetch(`/api/admin/orders/${orderId}`);
                if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                const order = await response.json();

                orderDetailsContent.innerHTML = `
                    <p><strong>Order ID:</strong> ${order._id}</p>
                    <p><strong>Customer Name:</strong> ${order.customerName}</p>
                    <p><strong>Phone:</strong> ${order.customerPhone}</p>
                    <p><strong>Delivery Address:</strong> ${order.deliveryAddress}</p>
                    <p><strong>Customer Location:</strong> ${order.customerLocation ? `Lat: ${order.customerLocation.latitude.toFixed(4)}, Lon: ${order.customerLocation.longitude.toFixed(4)}` : 'N/A'}</p>
                    <p><strong>Payment Method:</strong> ${order.paymentMethod || 'COD'}</p>
                    <p><strong>Subtotal:</strong> ₹${order.subtotal.toFixed(2)}</p>
                    <p><strong>Transport Tax:</strong> ₹${order.transportTax.toFixed(2)}</p>
                    <p><strong>Total Amount:</strong> ₹${order.totalAmount.toFixed(2)}</p>
                    <p><strong>Order Date:</strong> ${new Date(order.orderDate).toLocaleString()}</p>
                    <h4 class="text-xl font-bold mt-4 mb-2">Items:</h4>
                    <ul class="list-disc pl-5">
                        ${order.items.map(item => `<li>${item.name} x ${item.quantity} (₹${item.price.toFixed(2)} each)</li>`).join('')}
                    </ul>
                `;
                orderStatusSelect.value = order.status; // Set current status in dropdown
            } catch (error) {
                console.error('Error fetching order details:', error);
                orderDetailsContent.innerHTML = `<p class="text-red-500">Failed to load order details: ${error.message}</p>`;
            }
        }

        closeOrderDetailsModalBtn.addEventListener('click', () => {
            orderDetailsModal.style.display = 'none';
            currentOrderId = null;
        });

        updateOrderStatusBtn.addEventListener('click', async () => {
            if (!currentOrderId) return;

            const newStatus = orderStatusSelect.value;
            updateOrderStatusBtn.disabled = true;
            orderUpdateMessage.textContent = 'Updating status...';
            orderUpdateMessage.className = 'mt-2 text-sm text-yellow-500';

            try {
                const response = await fetch(`/api/admin/orders/${currentOrderId}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ status: newStatus })
                });

                const result = await response.json();
                if (response.ok) {
                    orderUpdateMessage.textContent = `Status updated to ${result.status}!`;
                    orderUpdateMessage.className = 'mt-2 text-sm text-green-500';
                    fetchOrders(); // Refresh orders list
                } else {
                    orderUpdateMessage.textContent = `Error updating status: ${result.message || response.statusText}`;
                    orderUpdateMessage.className = 'mt-2 text-sm text-red-500';
                }
            } catch (error) {
                console.error('Error updating order status:', error);
                orderUpdateMessage.textContent = `Network error: ${error.message}`;
                orderUpdateMessage.className = 'mt-2 text-sm text-red-500';
            } finally {
                updateOrderStatusBtn.disabled = false;
            }
        });

        // --- Menu Tab Functions ---
        async function fetchMenuItems() {
            menuItemsList.innerHTML = '<p class="text-gray-400 text-center py-4">Loading menu items...</p>';
            try {
                const response = await fetch('/api/admin/menu');
                if (!response.ok) {
                    if (response.status === 401) {
                        window.location.href = '/admin/login';
                        return;
                    }
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                const items = await response.json();
                displayMenuItems(items);
            } catch (error) {
                console.error('Error fetching menu items:', error);
                menuItemsList.innerHTML = `<p class="text-red-500 text-center py-4">Failed to load menu items: ${error.message}</p>`;
            }
        }

        function displayMenuItems(items) {
            menuItemsList.innerHTML = '';
            if (items.length === 0) {
                menuItemsList.innerHTML = '<p class="text-gray-400 text-center py-4">No menu items added yet.</p>';
                return;
            }

            const table = document.createElement('table');
            table.className = 'min-w-full';
            table.innerHTML = `
                <thead>
                    <tr>
                        <th>Name</th>
                        <th>Price</th>
                        <th>Category</th>
                        <th>Available</th>
                        <th>Trending</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="menu-items-table-body"></tbody>
            `;
            menuItemsList.appendChild(table);
            const tbody = document.getElementById('menu-items-table-body');

            items.forEach(item => {
                const row = tbody.insertRow();
                row.innerHTML = `
                    <td>${item.name}</td>
                    <td>₹${item.price.toFixed(2)}</td>
                    <td>${item.category}</td>
                    <td>${item.isAvailable ? 'Yes' : 'No'}</td>
                    <td>${item.isTrending ? 'Yes' : 'No'}</td>
                    <td>
                        <button data-id="${item._id}" class="edit-menu-item-btn btn-secondary text-sm py-1 px-3 mr-2">Edit</button>
                        <button data-id="${item._id}" class="delete-menu-item-btn btn-danger text-sm py-1 px-3">Delete</button>
                    </td>
                `;
            });

            menuItemsList.querySelectorAll('.edit-menu-item-btn').forEach(button => {
                button.addEventListener('click', (e) => openMenuItemModalForEdit(e.target.dataset.id));
            });
            menuItemsList.querySelectorAll('.delete-menu-item-btn').forEach(button => {
                button.addEventListener('click', (e) => deleteMenuItem(e.target.dataset.id));
            });
        }

        addMenuItemBtn.addEventListener('click', () => {
            menuItemModalTitle.textContent = 'Add New Menu Item';
            menuItemForm.reset(); // Clear form for new entry
            menuItemIdInput.value = ''; // Ensure ID is empty for new item
            menuItemModal.style.display = 'flex';
            menuItemMessage.textContent = '';
        });

        closeMenuItemModalBtn.addEventListener('click', () => {
            menuItemModal.style.display = 'none';
        });

        async function openMenuItemModalForEdit(itemId) {
            menuItemModalTitle.textContent = 'Edit Menu Item';
            menuItemForm.reset();
            menuItemMessage.textContent = 'Loading item details...';
            menuItemMessage.className = 'mt-2 text-sm text-yellow-500';
            menuItemModal.style.display = 'flex';

            try {
                const response = await fetch(`/api/admin/menu/${itemId}`);
                if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                const item = await response.json();

                menuItemIdInput.value = item._id;
                itemNameInput.value = item.name;
                itemDescriptionInput.value = item.description;
                itemPriceInput.value = item.price;
                itemImageUrlInput.value = item.imageUrl;
                itemCategoryInput.value = item.category;
                itemIsAvailableInput.checked = item.isAvailable;
                itemIsTrendingInput.checked = item.isTrending;

                menuItemMessage.textContent = '';
            } catch (error) {
                console.error('Error fetching menu item for edit:', error);
                menuItemMessage.textContent = `Failed to load item for edit: ${error.message}`;
                menuItemMessage.className = 'mt-2 text-sm text-red-500';
            }
        }

        menuItemForm.addEventListener('submit', async (e) => {
            e.preventDefault();

            const itemId = menuItemIdInput.value;
            const method = itemId ? 'PUT' : 'POST';
            const url = itemId ? `/api/admin/menu/${itemId}` : '/api/admin/menu';

            const formData = {
                name: itemNameInput.value,
                description: itemDescriptionInput.value,
                price: parseFloat(itemPriceInput.value),
                imageUrl: itemImageUrlInput.value,
                category: itemCategoryInput.value,
                isAvailable: itemIsAvailableInput.checked,
                isTrending: itemIsTrendingInput.checked
            };

            menuItemMessage.textContent = 'Saving item...';
            menuItemMessage.className = 'mt-2 text-sm text-yellow-500';
            menuItemForm.querySelector('button[type="submit"]').disabled = true;

            try {
                const response = await fetch(url, {
                    method: method,
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(formData)
                });

                const result = await response.json();
                if (response.ok) {
                    menuItemMessage.textContent = `Item saved successfully!`;
                    menuItemMessage.className = 'mt-2 text-sm text-green-500';
                    fetchMenuItems(); // Refresh list
                    setTimeout(() => menuItemModal.style.display = 'none', 1500);
                } else {
                    menuItemMessage.textContent = `Error saving item: ${result.message || response.statusText}`;
                    menuItemMessage.className = 'mt-2 text-sm text-red-500';
                }
            } catch (error) {
                console.error('Error saving menu item:', error);
                menuItemMessage.textContent = `Network error: ${error.message}`;
                menuItemMessage.className = 'mt-2 text-sm text-red-500';
            } finally {
                menuItemForm.querySelector('button[type="submit"]').disabled = false;
            }
        });

        async function deleteMenuItem(itemId) {
            // Using browser's native confirm for simplicity as per previous turns,
            // but a custom modal would be better for consistent UI.
            if (!confirm('Are you sure you want to delete this menu item?')) {
                return;
            }

            try {
                const response = await fetch(`/api/admin/menu/${itemId}`, {
                    method: 'DELETE'
                });

                if (response.ok) {
                    alert('Menu item deleted successfully!');
                    fetchMenuItems(); // Refresh list
                } else {
                    const result = await response.json();
                    alert(`Error deleting item: ${result.message || response.statusText}`);
                }
            } catch (error) {
                console.error('Error deleting menu item:', error);
                alert(`Network error deleting item: ${error.message}`);
            }
        }

        // --- Settings Tab Functions ---
        async function fetchSettings() {
            settingsMessage.textContent = 'Loading settings...';
            settingsMessage.className = 'mt-2 text-sm text-yellow-500 text-center';
            try {
                const response = await fetch('/api/admin/settings');
                if (!response.ok) {
                    if (response.status === 401) {
                        window.location.href = '/admin/login';
                        return;
                    }
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                const settings = await response.json();
                document.getElementById('shop-name').value = settings.shopName || '';
                document.getElementById('shop-latitude').value = settings.shopLocation ? settings.shopLocation.latitude : 0;
                document.getElementById('shop-longitude').value = settings.shopLocation ? settings.shopLocation.longitude : 0;
                displayDeliveryRates(settings.deliveryRates || []);
                settingsMessage.textContent = '';
                shopLocationData = settings.shopLocation; // Store shop location for customer tracking
            } catch (error) {
                console.error('Error fetching settings:', error);
                settingsMessage.textContent = `Failed to load settings: ${error.message}`;
                settingsMessage.className = 'mt-2 text-sm text-red-500 text-center';
            }
        }

        function displayDeliveryRates(rates) {
            deliveryRatesContainer.innerHTML = '';
            rates.forEach((rate, index) => {
                const rateDiv = document.createElement('div');
                rateDiv.className = 'flex flex-col sm:flex-row space-y-2 sm:space-y-0 sm:space-x-2 items-center';
                rateDiv.innerHTML = `
                    <input type="number" step="any" class="delivery-kms w-full sm:w-1/2" placeholder="KMs" value="${rate.kms}" required>
                    <input type="number" step="0.01" class="delivery-amount w-full sm:w-1/2" placeholder="Amount" value="${rate.amount}" required>
                    <button type="button" class="remove-delivery-rate-btn btn-danger text-sm py-1 px-2 mt-2 sm:mt-0">Remove</button>
                `;
                deliveryRatesContainer.appendChild(rateDiv);
            });
            addRemoveRateListeners();
        }

        function addRemoveRateListeners() {
            deliveryRatesContainer.querySelectorAll('.remove-delivery-rate-btn').forEach(button => {
                button.onclick = (e) => e.target.closest('.flex').remove();
            });
        }

        addDeliveryRateBtn.addEventListener('click', () => {
            const rateDiv = document.createElement('div');
            rateDiv.className = 'flex flex-col sm:flex-row space-y-2 sm:space-y-0 sm:space-x-2 items-center';
            rateDiv.innerHTML = `
                <input type="number" step="any" class="delivery-kms w-full sm:w-1/2" placeholder="KMs" required>
                <input type="number" step="0.01" class="delivery-amount w-full sm:w-1/2" placeholder="Amount" required>
                <button type="button" class="remove-delivery-rate-btn btn-danger text-sm py-1 px-2 mt-2 sm:mt-0">Remove</button>
            `;
            deliveryRatesContainer.appendChild(rateDiv);
            addRemoveRateListeners();
        });

        settingsForm.addEventListener('submit', async (e) => {
            e.preventDefault();

            const shopName = document.getElementById('shop-name').value;
            const shopLatitude = parseFloat(document.getElementById('shop-latitude').value);
            const shopLongitude = parseFloat(document.getElementById('shop-longitude').value);

            const deliveryRates = [];
            deliveryRatesContainer.querySelectorAll('.flex').forEach(rateDiv => {
                const kms = parseFloat(rateDiv.querySelector('.delivery-kms').value);
                const amount = parseFloat(rateDiv.querySelector('.delivery-amount').value);
                if (!isNaN(kms) && !isNaN(amount)) {
                    deliveryRates.push({ kms, amount });
                }
            });

            const settingsData = {
                shopName,
                shopLocation: { latitude: shopLatitude, longitude: shopLongitude },
                deliveryRates
            };

            settingsMessage.textContent = 'Saving settings...';
            settingsMessage.className = 'mt-2 text-sm text-yellow-500 text-center';
            settingsForm.querySelector('button[type="submit"]').disabled = true;

            try {
                const response = await fetch('/api/admin/settings', {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(settingsData)
                });

                const result = await response.json();
                if (response.ok) {
                    settingsMessage.textContent = 'Settings saved successfully!';
                    settingsMessage.className = 'mt-2 text-sm text-green-500 text-center';
                    shopLocationData = result.shopLocation; // Update shop location data after saving
                } else {
                    settingsMessage.textContent = `Error saving settings: ${result.message || response.statusText}`;
                    settingsMessage.className = 'mt-2 text-sm text-red-500 text-center';
                }
            } catch (error) {
                console.error('Error saving settings:', error);
                settingsMessage.textContent = `Network error: ${error.message}`;
                settingsMessage.className = 'mt-2 text-sm text-red-500 text-center';
            } finally {
                settingsForm.querySelector('button[type="submit"]').disabled = false;
            }
        });

        // --- Customer Tab Functions ---
        async function fetchCustomers() {
            customersList.innerHTML = '<p class="text-gray-400 text-center py-4">Loading customer data...</p>';
            try {
                const response = await fetch('/api/admin/customers');
                if (!response.ok) {
                    if (response.status === 401) {
                        window.location.href = '/admin/login';
                        return;
                    }
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                const customers = await response.json();
                displayCustomers(customers);
            } catch (error) {
                console.error('Error fetching customers:', error);
                customersList.innerHTML = `<p class="text-red-500 text-center py-4">Failed to load customer data: ${error.message}</p>`;
            }
        }

        function displayCustomers(customers) {
            customersList.innerHTML = '';
            if (customers.length === 0) {
                customersList.innerHTML = '<p class="text-gray-400 text-center py-4">No customer data found.</p>';
                return;
            }

            const table = document.createElement('table');
            table.className = 'min-w-full';
            table.innerHTML = `
                <thead>
                    <tr>
                        <th>Customer Name</th>
                        <th>Phone</th>
                        <th>Last Known Location</th>
                        <th>Distance from Shop (km)</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="customers-table-body"></tbody>
            `;
            customersList.appendChild(table);
            const tbody = document.getElementById('customers-table-body');

            customers.forEach(customer => {
                const row = tbody.insertRow();
                // Use the phone number directly for tel: link, as it handles formatting
                const customerPhoneNumber = customer.customerPhone;

                let locationText = 'N/A';
                let distanceFromShop = 'N/A';
                let trackButtonHtml = `<button class="btn-action disabled text-sm py-1 px-3">Track</button>`; // Disabled by default

                if (customer.lastKnownLocation && customer.lastKnownLocation.latitude && customer.lastKnownLocation.longitude) {
                    locationText = `Lat: ${customer.lastKnownLocation.latitude.toFixed(4)}, Lon: ${customer.lastKnownLocation.longitude.toFixed(4)}`;
                    if (shopLocationData && shopLocationData.latitude && shopLocationData.longitude) {
                        const dist = haversineDistance(
                            shopLocationData.latitude,
                            shopLocationData.longitude,
                            customer.lastKnownLocation.latitude,
                            customer.lastKnownLocation.longitude
                        );
                        distanceFromShop = dist.toFixed(2);
                        // Enable track button if shop and customer locations are available
                        const googleMapsUrl = `https://www.google.com/maps/dir/?api=1&origin=${shopLocationData.latitude},${shopLocationData.longitude}&destination=${customer.lastKnownLocation.latitude},${customer.lastKnownLocation.longitude}&travelmode=driving`;
                        trackButtonHtml = `<a href="${googleMapsUrl}" target="_blank" class="btn-action text-sm py-1 px-3">Track</a>`;
                    }
                }

                row.innerHTML = `
                    <td>${customer.customerName || 'N/A'}</td>
                    <td>${customer.customerPhone}</td>
                    <td>${locationText}</td>
                    <td>${distanceFromShop}</td>
                    <td>
                        <a href="tel:${customerPhoneNumber}" class="btn-action text-sm py-1 px-3 mr-2">Call</a>
                        ${trackButtonHtml}
                    </td>
                `;
            });
        }

        // Haversine distance function (duplicated from menu_panel for self-containment)
        function haversineDistance(lat1, lon1, lat2, lon2) {
            const R = 6371; // Radius of Earth in kilometers
            const dLat = (lat2 - lat1) * Math.PI / 180;
            const dLon = (lon2 - lon1) * Math.PI / 180;
            const a =
                Math.sin(dLat / 2) * Math.sin(dLat / 2) +
                Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
                Math.sin(dLon / 2) * Math.sin(dLon / 2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
            return R * c; // Distance in km
        }

        // Initial fetch for the default tab
        switchTab(currentActiveTab);

        // Periodically fetch bot status to keep the dashboard updated
        setInterval(() => {
            fetch('/api/admin/bot-status')
                .then(response => {
                    if (response.status === 401) {
                        // If session expired, redirect to login
                        window.location.href = '/admin/login';
                        return Promise.reject('Unauthorized');
                    }
                    return response.json();
                })
                .then(data => {
                    // Status update is handled by the socket.io listener now
                    // This fetch is primarily for initial load or if socket.io fails
                    // The socket.io 'status' event will trigger the display logic
                })
                .catch(error => {
                    console.error('Error fetching bot status:', error);
                    // Handle network errors or server issues
                    botStatusSpan.textContent = 'Error: Could not connect to server.';
                    alertMessage.textContent = 'Could not connect to bot server. Please check server logs.';
                    botStatusAlert.classList.remove('alert-yellow', 'alert-green');
                    botStatusAlert.classList.add('alert-red');
                    requestQrBtn.classList.remove('hidden');
                    loadSessionBtn.classList.remove('hidden'); // Also show load session button on error
                });
        }, 5000); // Poll every 5 seconds
    </script>
</body>
</html>
