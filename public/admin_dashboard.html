<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard - Delicious Bites</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <script src="/socket.io/socket.io.js"></script>
    <style>
        /* Base styles for black and white theme */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #000000; /* Pure black background */
            color: #ffffff; /* Pure white text */
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }
        .header {
            background-color: #1a1a1a; /* Dark gray for header */
            border-bottom: 1px solid #333333;
            padding: 1rem;
            box-shadow: 0 2px 4px rgba(255,255,255,0.05);
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
        }
        .header h1 {
            font-size: 2rem;
            font-weight: 700;
            color: #ffffff;
            margin-bottom: 0.5rem;
        }
        .header-actions {
            display: flex;
            gap: 0.75rem;
            flex-wrap: wrap;
        }
        .dashboard-container {
            display: flex;
            flex-grow: 1;
            flex-direction: column; /* Default to column for mobile */
        }
        .sidebar {
            background-color: #1a1a1a;
            padding: 1.5rem 1rem;
            border-right: 1px solid #333333;
            min-width: 200px;
            box-shadow: 2px 0 5px rgba(255,255,255,0.05);
        }
        .sidebar-nav a {
            display: block;
            padding: 0.75rem 1rem;
            margin-bottom: 0.5rem;
            border-radius: 0.5rem;
            color: #cccccc;
            font-weight: 600;
            transition: background-color 0.2s, color 0.2s;
        }
        .sidebar-nav a:hover {
            background-color: #2a2a2a;
            color: #ffffff;
        }
        .sidebar-nav a.active {
            background-color: #0066cc; /* Highlight active section */
            color: #ffffff;
        }
        .content-area {
            flex-grow: 1;
            padding: 1.5rem;
            max-width: 100%; /* Ensure it auto-fits */
            overflow-x: auto; /* Allow horizontal scroll for tables */
        }
        .section-content {
            display: none; /* Hidden by default */
        }
        .section-content.active {
            display: block; /* Show active section */
        }
        .card {
            background-color: #1a1a1a;
            border-radius: 0.75rem;
            box-shadow: 0 4px 8px rgba(255,255,255,0.08);
            padding: 1.5rem;
            margin-bottom: 1.5rem;
        }
        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }
        .card-header h2 {
            font-size: 1.75rem;
            font-weight: 600;
            color: #ffffff;
        }
        /* Button styles */
        .btn-primary {
            background-color: #ffffff;
            color: #000000;
            padding: 0.6rem 1.2rem;
            border-radius: 0.5rem;
            font-weight: 600;
            transition: background-color 0.2s ease-in-out;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            white-space: nowrap;
        }
        .btn-primary:hover {
            background-color: #e0e0e0;
        }
        .btn-secondary {
            background-color: #333333;
            color: #ffffff;
            padding: 0.6rem 1.2rem;
            border-radius: 0.5rem;
            font-weight: 600;
            transition: background-color 0.2s ease-in-out;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            white-space: nowrap;
        }
        .btn-secondary:hover {
            background-color: #555555;
        }
        .btn-danger {
            background-color: #cc0000;
            color: #ffffff;
            padding: 0.4rem 0.8rem;
            border-radius: 0.375rem;
            font-weight: 600;
            transition: background-color 0.2s ease-in-out;
        }
        .btn-danger:hover {
            background-color: #ff3333;
        }
        .btn-success {
            background-color: #00cc00;
            color: #000000;
            padding: 0.4rem 0.8rem;
            border-radius: 0.375rem;
            font-weight: 600;
            transition: background-color 0.2s ease-in-out;
        }
        .btn-success:hover {
            background-color: #00ee00;
        }
        .btn-small {
            padding: 0.4rem 0.8rem;
            font-size: 0.875rem;
        }

        /* Table styles */
        .data-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 1rem;
        }
        .data-table th, .data-table td {
            padding: 0.75rem;
            text-align: left;
            border-bottom: 1px solid #333333;
        }
        .data-table th {
            background-color: #2a2a2a;
            font-weight: 700;
            color: #cccccc;
            text-transform: uppercase;
            font-size: 0.875rem;
        }
        .data-table tbody tr:hover {
            background-color: #222222;
        }
        .data-table td {
            color: #ffffff;
        }

        /* Form input styles */
        .form-group {
            margin-bottom: 1rem;
        }
        .form-group label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 600;
            color: #cccccc;
        }
        .form-group input[type="text"],
        .form-group input[type="number"],
        .form-group input[type="url"],
        .form-group textarea,
        .form-group select {
            background-color: #222222;
            border: 1px solid #444444;
            color: #ffffff;
            padding: 0.5rem 0.75rem;
            border-radius: 0.375rem;
            width: 100%;
        }
        .form-group input::placeholder,
        .form-group textarea::placeholder {
            color: #888888;
        }
        .form-group select option {
            background-color: #222222;
            color: #ffffff;
        }
        .form-group input[type="checkbox"] {
            margin-right: 0.5rem;
        }

        /* Modal styles */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.8);
            justify-content: center;
            align-items: center;
            padding: 1rem;
        }
        .modal-content {
            background-color: #1a1a1a;
            margin: auto;
            padding: 2rem;
            border-radius: 0.75rem;
            box-shadow: 0 5px 15px rgba(255,255,255,0.1);
            width: 90%;
            max-width: 700px;
            position: relative;
            color: #ffffff;
        }
        .close-button {
            color: #aaaaaa;
            position: absolute;
            top: 1rem;
            right: 1rem;
            font-size: 1.75rem;
            font-weight: bold;
            cursor: pointer;
        }
        .close-button:hover,
        .close-button:focus {
            color: #ffffff;
            text-decoration: none;
            cursor: pointer;
        }

        /* Loader styles */
        .loader {
            border: 4px solid #333333;
            border-top: 4px solid #66ff66;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            animation: spin 1s linear infinite;
            display: inline-block;
            vertical-align: middle;
            margin-right: 8px;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .message {
            margin-top: 1rem;
            font-weight: 600;
        }
        .message.error {
            color: #ff6666;
        }
        .message.success {
            color: #66ff66;
        }
        .message.info {
            color: #ffff66;
        }

        /* Specific styles for delivery rates in settings */
        .delivery-rate-item {
            display: flex;
            gap: 1rem;
            align-items: center;
            margin-bottom: 0.5rem;
        }
        .delivery-rate-item input {
            flex: 1;
        }
        .delivery-rate-item button {
            flex-shrink: 0;
        }
        .add-rate-btn {
            background-color: #0066cc;
            color: #ffffff;
            padding: 0.5rem 1rem;
            border-radius: 0.5rem;
            transition: background-color 0.2s;
        }
        .add-rate-btn:hover {
            background-color: #0077dd;
        }
        .remove-rate-btn {
            background-color: #cc0000;
            color: #ffffff;
            padding: 0.5rem 1rem;
            border-radius: 0.5rem;
            transition: background-color 0.2s;
        }
        .remove-rate-btn:hover {
            background-color: #ff3333;
        }
        .qr-code-img {
            max-width: 100%;
            height: auto;
            border-radius: 0.5rem;
            margin-bottom: 1.5rem;
            border: 1px solid #333333;
            background-color: #ffffff; /* White background for QR code */
            padding: 1rem;
        }

        /* Responsive adjustments */
        @media (min-width: 768px) { /* Medium screens and up */
            .dashboard-container {
                flex-direction: row; /* Row layout for larger screens */
            }
            .sidebar {
                flex-shrink: 0;
                height: 100vh; /* Full height sidebar */
                position: sticky; /* Sticky sidebar */
                top: 0;
            }
            .header {
                flex-direction: row;
                margin-bottom: 0;
            }
            .header h1 {
                margin-bottom: 0;
            }
            .content-area {
                padding: 1.5rem 2rem;
                max-width: calc(100% - 200px); /* Adjust max-width based on sidebar */
            }
            .data-table th:nth-child(n+4), .data-table td:nth-child(n+4) {
                display: table-cell; /* Show all columns on larger screens */
            }
        }
        @media (max-width: 767px) { /* Small screens */
            .sidebar {
                width: 100%;
                border-right: none;
                border-bottom: 1px solid #333333;
                padding-bottom: 1rem;
            }
            .sidebar-nav {
                display: flex; /* Horizontal nav for small screens */
                flex-wrap: wrap;
                justify-content: center;
                gap: 0.5rem;
            }
            .sidebar-nav a {
                flex-grow: 1;
                text-align: center;
                padding: 0.5rem 0.75rem;
                margin-bottom: 0;
            }
            .header-actions {
                width: 100%;
                justify-content: center;
                margin-top: 1rem;
            }
            .header-actions button {
                width: auto; /* Allow buttons to size naturally */
                flex-grow: 1;
            }
        }
    </style>
</head>
<body>
    <header class="header">
        <h1 class="text-white">Admin Dashboard</h1>
        <div class="header-actions">
            <button id="logout-btn" class="btn-secondary">Logout</button>
        </div>
    </header>

    <div class="dashboard-container">
        <nav class="sidebar">
            <div class="sidebar-nav">
                <a href="#bot-status-section" class="nav-link active" data-section="bot-status-section">Bot Status</a>
                <a href="#orders-section" class="nav-link" data-section="orders-section">Orders</a>
                <a href="#menu-section" class="nav-link" data-section="menu-section">Menu</a>
                <a href="#customers-section" class="nav-link" data-section="customers-section">Customers</a>
                <a href="#settings-section" class="nav-link" data-section="settings-section">Settings</a>
            </div>
        </nav>

        <main class="content-area">
            <!-- Bot Status Section -->
            <section id="bot-status-section" class="section-content active">
                <div class="card">
                    <div class="card-header">
                        <h2>WhatsApp Bot Status</h2>
                        <button id="refresh-bot-status-btn" class="btn-secondary btn-small">Refresh</button>
                    </div>
                    <p class="text-lg">Current Status: <span id="bot-status" class="font-semibold text-yellow-400">Loading...</span></p>
                    <p class="text-gray-400 text-sm mt-1">Last Authenticated: <span id="last-auth-time" class="font-semibold text-white">N/A</span></p>
                    <div id="bot-status-actions" class="mt-4 flex flex-col sm:flex-row gap-3">
                        <button id="request-qr-btn" class="btn-primary">
                            <span id="request-qr-loader" class="loader hidden"></span>
                            <span id="request-qr-text">Request New QR</span>
                        </button>
                        <button id="load-session-btn" class="btn-primary">
                            <span id="load-session-loader" class="loader hidden"></span>
                            <span id="load-session-text">Load Saved Session</span>
                        </button>
                    </div>
                    <div id="qr-code-section" class="mt-4 hidden">
                        <p class="text-gray-300 mb-2">Scan this QR code with your WhatsApp app:</p>
                        <img id="qr-code-img" src="" alt="QR Code" class="qr-code-img mx-auto">
                        <p class="text-sm text-gray-400 mt-2">QR will expire in <span id="qr-countdown">60</span> seconds.</p>
                    </div>
                    <p id="bot-message" class="message mt-3 text-center"></p>
                </div>
            </section>

            <!-- Orders Section -->
            <section id="orders-section" class="section-content">
                <div class="card">
                    <div class="card-header">
                        <h2>Recent Orders</h2>
                        <button id="refresh-orders-btn" class="btn-secondary btn-small">Refresh</button>
                    </div>
                    <div id="orders-list">
                        <p class="text-center text-gray-400">Loading orders...</p>
                    </div>
                    <p id="orders-message" class="message mt-3"></p>
                </div>
            </section>

            <!-- Menu Management Section -->
            <section id="menu-section" class="section-content">
                <div class="card">
                    <div class="card-header">
                        <h2>Menu Items</h2>
                        <button id="add-menu-item-btn" class="btn-primary">Add New Item</button>
                    </div>
                    <div id="menu-items-list">
                        <p class="text-center text-gray-400">Loading menu items...</p>
                    </div>
                    <p id="menu-message" class="message mt-3"></p>
                </div>
            </section>

            <!-- Customer Management Section -->
            <section id="customers-section" class="section-content">
                <div class="card">
                    <div class="card-header">
                        <h2>Customer Data</h2>
                        <button id="refresh-customers-btn" class="btn-secondary btn-small">Refresh</button>
                    </div>
                    <div id="customers-list">
                        <p class="text-center text-gray-400">Loading customer data...</p>
                    </div>
                    <p id="customers-message" class="message mt-3"></p>
                </div>
            </section>

            <!-- Shop Settings Section -->
            <section id="settings-section" class="section-content">
                <div class="card">
                    <div class="card-header">
                        <h2>Shop Settings</h2>
                        <button id="save-settings-btn" class="btn-primary">Save Settings</button>
                    </div>
                    <form id="settings-form" class="mt-4">
                        <div class="form-group">
                            <label for="shop-name">Shop Name:</label>
                            <input type="text" id="shop-name" name="shopName" placeholder="e.g., Delicious Bites">
                        </div>
                        <div class="form-group">
                            <label for="shop-lat">Shop Location (Latitude):</label>
                            <input type="number" step="any" id="shop-lat" name="shopLocation.latitude" placeholder="e.g., 17.4">
                        </div>
                        <div class="form-group">
                            <label for="shop-lon">Shop Location (Longitude):</label>
                            <input type="number" step="any" id="shop-lon" name="shopLocation.longitude" placeholder="e.g., 78.5">
                        </div>

                        <div class="form-group">
                            <label class="block mb-2">Delivery Rates (KMs - Amount):</label>
                            <div id="delivery-rates-container">
                                <!-- Dynamic delivery rate inputs will go here -->
                                <p class="text-gray-400 text-sm">Add delivery ranges below.</p>
                            </div>
                            <button type="button" id="add-delivery-rate-btn" class="add-rate-btn mt-2">Add Rate</button>
                        </div>
                        <p id="settings-message" class="message mt-3"></p>
                    </form>
                </div>
            </section>
        </main>
    </div>

    <!-- Modals -->

    <!-- Edit/Add Menu Item Modal -->
    <div id="menu-item-modal" class="modal">
        <div class="modal-content">
            <span class="close-button">&times;</span>
            <h2 id="menu-item-modal-title" class="text-2xl font-bold mb-4">Add New Menu Item</h2>
            <form id="menu-item-form">
                <input type="hidden" id="menu-item-id">
                <div class="form-group">
                    <label for="item-name">Name:</label>
                    <input type="text" id="item-name" required>
                </div>
                <div class="form-group">
                    <label for="item-description">Description:</label>
                    <textarea id="item-description" rows="3"></textarea>
                </div>
                <div class="form-group">
                    <label for="item-price">Price:</label>
                    <input type="number" step="0.01" id="item-price" required>
                </div>
                <div class="form-group">
                    <label for="item-image-url">Image URL:</label>
                    <input type="url" id="item-image-url" placeholder="https://example.com/image.jpg">
                </div>
                <div class="form-group">
                    <label for="item-category">Category:</label>
                    <input type="text" id="item-category" placeholder="e.g., Main Course, Dessert">
                </div>
                <div class="form-group flex items-center">
                    <input type="checkbox" id="item-is-available">
                    <label for="item-is-available" class="mb-0">Is Available</label>
                </div>
                <div class="form-group flex items-center">
                    <input type="checkbox" id="item-is-trending">
                    <label for="item-is-trending" class="mb-0">Is Trending</label>
                </div>
                <button type="submit" class="btn-primary w-full mt-4">
                    <span id="menu-item-loader" class="loader hidden"></span>
                    <span id="menu-item-text">Save Item</span>
                </button>
                <p id="menu-item-message" class="message mt-3"></p>
            </form>
        </div>
    </div>

    <!-- Order Details Modal -->
    <div id="order-details-modal" class="modal">
        <div class="modal-content">
            <span class="close-button">&times;</span>
            <h2 class="text-2xl font-bold mb-4">Order Details <span id="order-detail-id-display"></span></h2>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 text-gray-300">
                <div><strong>Customer Name:</strong> <span id="order-detail-customer-name"></span></div>
                <div><strong>Phone:</strong> <span id="order-detail-customer-phone"></span></div>
                <div class="md:col-span-2"><strong>Address:</strong> <span id="order-detail-delivery-address"></span></div>
                <div><strong>Order Date:</strong> <span id="order-detail-date"></span></div>
                <div><strong>Payment Method:</strong> <span id="order-detail-payment-method"></span></div>
                <div><strong>Subtotal:</strong> ₹<span id="order-detail-subtotal"></span></div>
                <div><strong>Transport Tax:</strong> ₹<span id="order-detail-transport-tax"></span></div>
                <div><strong>Total Amount:</strong> ₹<span id="order-detail-total-amount" class="text-green-400 font-bold"></span></div>
            </div>
            <div class="mt-4">
                <h3 class="text-xl font-bold mb-2">Items:</h3>
                <ul id="order-detail-items" class="list-disc list-inside text-gray-300"></ul>
            </div>
            <div class="mt-4">
                <label for="order-status-select" class="block font-bold mb-2">Update Status:</label>
                <select id="order-status-select" class="form-group w-full p-2 rounded-md bg-gray-700 text-white">
                    <option value="Pending">Pending</option>
                    <option value="Confirmed">Confirmed</option>
                    <option value="Preparing">Preparing</option>
                    <option value="Out for Delivery">Out for Delivery</option>
                    <option value="Delivered">Delivered</option>
                    <option value="Cancelled">Cancelled</option>
                </select>
                <button id="update-order-status-btn" class="btn-primary w-full mt-3">
                    <span id="update-order-loader" class="loader hidden"></span>
                    <span id="update-order-text">Update Status</span>
                </button>
                <p id="order-update-message" class="message mt-3"></p>
            </div>
            <button id="delete-order-btn" class="btn-danger w-full mt-4">Delete Order</button>
        </div>
    </div>

    <script>
        const socket = io();

        // Bot Status Elements
        const botStatusSpan = document.getElementById('bot-status');
        const lastAuthTimeSpan = document.getElementById('last-auth-time');
        const refreshBotStatusBtn = document.getElementById('refresh-bot-status-btn');
        const requestQrBtn = document.getElementById('request-qr-btn');
        const loadSessionBtn = document.getElementById('load-session-btn');
        const requestQrLoader = document.getElementById('request-qr-loader');
        const requestQrText = document.getElementById('request-qr-text');
        const loadSessionLoader = document.getElementById('load-session-loader');
        const loadSessionText = document.getElementById('load-session-text');
        const botMessage = document.getElementById('bot-message');
        const qrCodeSection = document.getElementById('qr-code-section');
        const qrCodeImg = document.getElementById('qr-code-img');
        const qrCountdownSpan = document.getElementById('qr-countdown');

        // Orders Elements
        const ordersListDiv = document.getElementById('orders-list');
        const refreshOrdersBtn = document.getElementById('refresh-orders-btn');
        const ordersMessage = document.getElementById('orders-message');

        // Menu Elements
        const menuItemsListDiv = document.getElementById('menu-items-list');
        const addMenuItemBtn = document.getElementById('add-menu-item-btn');
        const menuMessage = document.getElementById('menu-message');

        // Customer Elements
        const customersListDiv = document.getElementById('customers-list');
        const refreshCustomersBtn = document.getElementById('refresh-customers-btn');
        const customersMessage = document.getElementById('customers-message');

        // Settings Elements
        const settingsForm = document.getElementById('settings-form');
        const shopNameInput = document.getElementById('shop-name');
        const shopLatInput = document.getElementById('shop-lat');
        const shopLonInput = document.getElementById('shop-lon');
        const deliveryRatesContainer = document.getElementById('delivery-rates-container');
        const addDeliveryRateBtn = document.getElementById('add-delivery-rate-btn');
        const saveSettingsBtn = document.getElementById('save-settings-btn');
        const settingsMessage = document.getElementById('settings-message');

        // Modals
        const menuItemModal = document.getElementById('menu-item-modal');
        const menuItemModalTitle = document.getElementById('menu-item-modal-title');
        const menuItemForm = document.getElementById('menu-item-form');
        const menuItemIdInput = document.getElementById('menu-item-id');
        const itemNameInput = document.getElementById('item-name');
        const itemDescriptionInput = document.getElementById('item-description');
        const itemPriceInput = document.getElementById('item-price');
        const itemImageUrlInput = document.getElementById('item-image-url');
        const itemCategoryInput = document.getElementById('item-category');
        const itemIsAvailableCheckbox = document.getElementById('item-is-available');
        const itemIsTrendingCheckbox = document.getElementById('item-is-trending');
        const menuItemLoader = document.getElementById('menu-item-loader');
        const menuItemText = document.getElementById('menu-item-text');
        const menuItemMessage = document.getElementById('menu-item-message');

        const orderDetailsModal = document.getElementById('order-details-modal');
        const orderDetailIdDisplay = document.getElementById('order-detail-id-display');
        const orderDetailCustomerName = document.getElementById('order-detail-customer-name');
        const orderDetailCustomerPhone = document.getElementById('order-detail-customer-phone');
        const orderDetailDeliveryAddress = document.getElementById('order-detail-delivery-address');
        const orderDetailDate = document.getElementById('order-detail-date');
        const orderDetailPaymentMethod = document.getElementById('order-detail-payment-method');
        const orderDetailSubtotal = document.getElementById('order-detail-subtotal');
        const orderDetailTransportTax = document.getElementById('order-detail-transport-tax');
        const orderDetailTotalAmount = document.getElementById('order-detail-total-amount');
        const orderDetailItemsList = document.getElementById('order-detail-items');
        const orderStatusSelect = document.getElementById('order-status-select');
        const updateOrderStatusBtn = document.getElementById('update-order-status-btn');
        const updateOrderLoader = document.getElementById('update-order-loader');
        const updateOrderText = document.getElementById('update-order-text');
        const orderUpdateMessage = document.getElementById('order-update-message');
        const deleteOrderBtn = document.getElementById('delete-order-btn');

        // Global variables
        let qrTimerInterval = null;
        const QR_EXPIRY_MS = 60000; // 60 seconds

        // --- Utility Functions ---
        function showLoader(loaderElement, textElement, messageElement, message = 'Loading...', type = 'info') {
            loaderElement.classList.remove('hidden');
            textElement.classList.add('hidden');
            messageElement.textContent = message;
            messageElement.className = `message mt-3 ${type}`;
        }

        function hideLoader(loaderElement, textElement, messageElement, success = true, message = '') {
            loaderElement.classList.add('hidden');
            textElement.classList.remove('hidden');
            messageElement.textContent = message;
            messageElement.className = `message mt-3 ${success ? 'success' : 'error'}`;
            if (!message) messageElement.classList.add('hidden');
            else messageElement.classList.remove('hidden');
        }

        function updateBotStatusDisplay(status) {
            botStatusSpan.textContent = status;
            botStatusSpan.classList.remove('text-green-400', 'text-yellow-400', 'text-red-400');
            switch (status) {
                case 'ready':
                    botStatusSpan.classList.add('text-green-400');
                    botMessage.textContent = 'WhatsApp bot is connected and ready!';
                    botMessage.className = 'message mt-3 success';
                    qrCodeSection.classList.add('hidden');
                    if (qrTimerInterval) clearInterval(qrTimerInterval);
                    break;
                case 'authenticated':
                    botStatusSpan.classList.add('text-yellow-400');
                    botMessage.textContent = 'WhatsApp bot authenticated. Waiting for ready state...';
                    botMessage.className = 'message mt-3 info';
                    qrCodeSection.classList.add('hidden');
                    if (qrTimerInterval) clearInterval(qrTimerInterval);
                    break;
                case 'qr_received':
                    botStatusSpan.classList.add('text-yellow-400');
                    botMessage.textContent = 'QR Code received. Scan it with your WhatsApp app.';
                    botMessage.className = 'message mt-3 info';
                    qrCodeSection.classList.remove('hidden');
                    startQrCountdown();
                    break;
                case 'auth_failure':
                    botStatusSpan.classList.add('text-red-400');
                    botMessage.textContent = 'Authentication failed. Please request a new QR code and re-scan.';
                    botMessage.className = 'message mt-3 error';
                    qrCodeSection.classList.add('hidden');
                    if (qrTimerInterval) clearInterval(qrTimerInterval);
                    break;
                case 'disconnected':
                    botStatusSpan.classList.add('text-red-400');
                    botMessage.textContent = 'WhatsApp bot disconnected. Attempting to reconnect or waiting for new QR.';
                    botMessage.className = 'message mt-3 error';
                    qrCodeSection.classList.add('hidden');
                    if (qrTimerInterval) clearInterval(qrTimerInterval);
                    break;
                case 'initializing':
                    botStatusSpan.classList.add('text-yellow-400');
                    botMessage.textContent = 'WhatsApp bot is initializing...';
                    botMessage.className = 'message mt-3 info';
                    qrCodeSection.classList.add('hidden');
                    if (qrTimerInterval) clearInterval(qrTimerInterval);
                    break;
                case 'qr_error':
                    botStatusSpan.classList.add('text-red-400');
                    botMessage.textContent = 'Error generating QR code. Check server logs.';
                    botMessage.className = 'message mt-3 error';
                    qrCodeSection.classList.add('hidden');
                    if (qrTimerInterval) clearInterval(qrTimerInterval);
                    break;
                default:
                    botStatusSpan.classList.add('text-gray-400');
                    botMessage.textContent = `Unknown status: ${status}`;
                    botMessage.className = 'message mt-3 info';
                    qrCodeSection.classList.add('hidden');
                    if (qrTimerInterval) clearInterval(qrTimerInterval);
            }
        }

        function startQrCountdown() {
            if (qrTimerInterval) clearInterval(qrTimerInterval);
            let timeLeft = QR_EXPIRY_MS / 1000;
            qrCountdownSpan.textContent = timeLeft;

            qrTimerInterval = setInterval(() => {
                timeLeft--;
                qrCountdownSpan.textContent = timeLeft;
                if (timeLeft <= 0) {
                    clearInterval(qrTimerInterval);
                    qrCodeSection.classList.add('hidden');
                    updateBotStatusDisplay('qr_expired');
                }
            }, 1000);
        }

        // --- Fetch Data Functions ---

        async function fetchBotStatus() {
            showLoader(requestQrLoader, requestQrText, botMessage, 'Fetching bot status...', 'info');
            try {
                const response = await fetch('/api/admin/bot-status');
                const data = await response.json();
                updateBotStatusDisplay(data.status);
                if (data.lastAuthenticatedAt) {
                    lastAuthTimeSpan.textContent = new Date(data.lastAuthenticatedAt).toLocaleString();
                } else {
                    lastAuthTimeSpan.textContent = 'N/A';
                }
                hideLoader(requestQrLoader, requestQrText, botMessage, true, 'Status updated.');
            } catch (error) {
                console.error('Error fetching bot status:', error);
                hideLoader(requestQrLoader, requestQrText, botMessage, false, `Error fetching status: ${error.message}`);
                botStatusSpan.textContent = 'Error';
                botStatusSpan.classList.add('text-red-400');
            }
        }

        async function fetchOrders() {
            ordersListDiv.innerHTML = '<p class="text-center text-gray-400">Loading orders...</p>';
            ordersMessage.classList.add('hidden');
            try {
                const response = await fetch('/api/admin/orders');
                const orders = await response.json();
                renderOrders(orders);
            } catch (error) {
                console.error('Error fetching orders:', error);
                ordersListDiv.innerHTML = '<p class="text-center text-red-400">Failed to load orders.</p>';
                ordersMessage.textContent = `Error: ${error.message}`;
                ordersMessage.className = 'message mt-3 error';
                ordersMessage.classList.remove('hidden');
            }
        }

        async function fetchMenuItems() {
            menuItemsListDiv.innerHTML = '<p class="text-center text-gray-400">Loading menu items...</p>';
            menuMessage.classList.add('hidden');
            try {
                const response = await fetch('/api/admin/menu');
                const items = await response.json();
                renderMenuItems(items);
            } catch (error) {
                console.error('Error fetching menu items:', error);
                menuItemsListDiv.innerHTML = '<p class="text-center text-red-400">Failed to load menu items.</p>';
                menuMessage.textContent = `Error: ${error.message}`;
                menuMessage.className = 'message mt-3 error';
                menuMessage.classList.remove('hidden');
            }
        }

        async function fetchCustomers() {
            customersListDiv.innerHTML = '<p class="text-center text-gray-400">Loading customer data...</p>';
            customersMessage.classList.add('hidden');
            try {
                const response = await fetch('/api/admin/customers');
                const customers = await response.json();
                renderCustomers(customers);
            } catch (error) {
                console.error('Error fetching customers:', error);
                customersListDiv.innerHTML = '<p class="text-center text-red-400">Failed to load customer data.</p>';
                customersMessage.textContent = `Error: ${error.message}`;
                customersMessage.className = 'message mt-3 error';
                customersMessage.classList.remove('hidden');
            }
        }

        async function fetchSettings() {
            try {
                const response = await fetch('/api/admin/settings');
                const settings = await response.json();
                shopNameInput.value = settings.shopName || '';
                shopLatInput.value = settings.shopLocation ? settings.shopLocation.latitude : '';
                shopLonInput.value = settings.shopLocation ? settings.shopLocation.longitude : '';
                renderDeliveryRates(settings.deliveryRates || []);
            } catch (error) {
                console.error('Error fetching settings:', error);
                settingsMessage.textContent = `Error loading settings: ${error.message}`;
                settingsMessage.className = 'message mt-3 error';
                settingsMessage.classList.remove('hidden');
            }
        }

        // --- Render Functions ---

        function renderOrders(orders) {
            if (orders.length === 0) {
                ordersListDiv.innerHTML = '<p class="text-center text-gray-400">No orders found.</p>';
                return;
            }
            let tableHtml = `
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>Order ID</th>
                            <th>Customer</th>
                            <th>Total</th>
                            <th>Status</th>
                            <th>Date</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
            `;
            orders.forEach(order => {
                const orderIdShort = order._id.substring(0, 6);
                const orderDate = new Date(order.orderDate).toLocaleString();
                let statusClass = 'text-white';
                switch(order.status) {
                    case 'Pending': statusClass = 'text-yellow-400'; break;
                    case 'Confirmed':
                    case 'Preparing': statusClass = 'text-blue-400'; break;
                    case 'Out for Delivery': statusClass = 'text-purple-400'; break;
                    case 'Delivered': statusClass = 'text-green-400'; break;
                    case 'Cancelled': statusClass = 'text-red-400'; break;
                }

                tableHtml += `
                    <tr>
                        <td>${orderIdShort}...</td>
                        <td>${order.customerName}</td>
                        <td>₹${order.totalAmount.toFixed(2)}</td>
                        <td class="${statusClass}">${order.status}</td>
                        <td>${orderDate}</td>
                        <td>
                            <button class="btn-secondary btn-small view-order-btn" data-id="${order._id}">View</button>
                        </td>
                    </tr>
                `;
            });
            tableHtml += `</tbody></table>`;
            ordersListDiv.innerHTML = tableHtml;

            // Add event listeners for view buttons
            document.querySelectorAll('.view-order-btn').forEach(button => {
                button.addEventListener('click', () => openOrderDetailsModal(button.dataset.id));
            });
        }

        function renderMenuItems(items) {
            if (items.length === 0) {
                menuItemsListDiv.innerHTML = '<p class="text-center text-gray-400">No menu items found. Add some!</p>';
                return;
            }
            let tableHtml = `
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>Name</th>
                            <th>Price</th>
                            <th>Available</th>
                            <th>Trending</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
            `;
            items.forEach(item => {
                tableHtml += `
                    <tr>
                        <td>${item.name}</td>
                        <td>₹${item.price.toFixed(2)}</td>
                        <td class="${item.isAvailable ? 'text-green-400' : 'text-red-400'}">${item.isAvailable ? 'Yes' : 'No'}</td>
                        <td class="${item.isTrending ? 'text-green-400' : 'text-red-400'}">${item.isTrending ? 'Yes' : 'No'}</td>
                        <td>
                            <button class="btn-secondary btn-small edit-menu-item-btn" data-id="${item._id}">Edit</button>
                            <button class="btn-danger btn-small delete-menu-item-btn" data-id="${item._id}">Delete</button>
                        </td>
                    </tr>
                `;
            });
            tableHtml += `</tbody></table>`;
            menuItemsListDiv.innerHTML = tableHtml;

            // Add event listeners for edit/delete buttons
            document.querySelectorAll('.edit-menu-item-btn').forEach(button => {
                button.addEventListener('click', () => openMenuItemModal(button.dataset.id));
            });
            document.querySelectorAll('.delete-menu-item-btn').forEach(button => {
                button.addEventListener('click', () => deleteMenuItem(button.dataset.id));
            });
        }

        function renderCustomers(customers) {
            if (customers.length === 0) {
                customersListDiv.innerHTML = '<p class="text-center text-gray-400">No customer data found.</p>';
                return;
            }
            let tableHtml = `
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>Phone</th>
                            <th>Name</th>
                            <th>Total Orders</th>
                            <th>Last Order</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
            `;
            customers.forEach(customer => {
                const lastOrderDate = customer.lastOrderDate ? new Date(customer.lastOrderDate).toLocaleString() : 'N/A';
                const customerPhone = customer.customerPhone;
                const customerLat = customer.lastKnownLocation ? customer.lastKnownLocation.latitude : null;
                const customerLon = customer.lastKnownLocation ? customer.lastKnownLocation.longitude : null;
                const trackButtonHtml = (customerLat && customerLon) ?
                    `<a href="https://www.google.com/maps/search/?api=1&query=${customerLat},${customerLon}" target="_blank" class="btn-secondary btn-small">Track Location</a>` :
                    `<button class="btn-secondary btn-small" disabled title="Location not available">Track Location</button>`;

                tableHtml += `
                    <tr>
                        <td>${customerPhone}</td>
                        <td>${customer.customerName || 'N/A'}</td>
                        <td>${customer.totalOrders}</td>
                        <td>${lastOrderDate}</td>
                        <td class="flex flex-wrap gap-2">
                            <a href="tel:${customerPhone}" class="btn-primary btn-small">Call</a>
                            ${trackButtonHtml}
                            <button class="btn-secondary btn-small view-latest-order-btn" data-phone="${customerPhone}">View Latest Order</button>
                            <button class="btn-danger btn-small delete-customer-btn" data-id="${customer._id}">Delete</button>
                        </td>
                    </tr>
                `;
            });
            tableHtml += `</tbody></table>`;
            customersListDiv.innerHTML = tableHtml;

            // Add event listeners for new buttons
            document.querySelectorAll('.view-latest-order-btn').forEach(button => {
                button.addEventListener('click', () => viewLatestCustomerOrder(button.dataset.phone));
            });
            document.querySelectorAll('.delete-customer-btn').forEach(button => {
                button.addEventListener('click', () => deleteCustomer(button.dataset.id));
            });
        }

        function renderDeliveryRates(rates) {
            deliveryRatesContainer.innerHTML = '';
            rates.sort((a, b) => a.kms - b.kms);

            rates.forEach((rate, index) => {
                const rateDiv = document.createElement('div');
                rateDiv.className = 'delivery-rate-item';
                rateDiv.innerHTML = `
                    <input type="number" step="any" class="kms-input" value="${rate.kms}" placeholder="KMs" data-index="${index}">
                    <input type="number" step="any" class="amount-input" value="${rate.amount}" placeholder="Amount" data-index="${index}">
                    <button type="button" class="remove-rate-btn btn-small">Remove</button>
                `;
                deliveryRatesContainer.appendChild(rateDiv);
            });

            document.querySelectorAll('.remove-rate-btn').forEach(button => {
                button.addEventListener('click', (e) => {
                    e.target.closest('.delivery-rate-item').remove();
                });
            });
        }


        // --- Modal Functions ---

        function openMenuItemModal(itemId = null) {
            menuItemForm.reset();
            menuItemIdInput.value = '';
            menuItemMessage.classList.add('hidden');
            menuItemText.textContent = 'Save Item';

            if (itemId) {
                menuItemModalTitle.textContent = 'Edit Menu Item';
                menuItemText.textContent = 'Update Item';
                fetch(`/api/admin/menu/${itemId}`)
                    .then(res => res.json())
                    .then(item => {
                        menuItemIdInput.value = item._id;
                        itemNameInput.value = item.name;
                        itemDescriptionInput.value = item.description || '';
                        itemPriceInput.value = item.price;
                        itemImageUrlInput.value = item.imageUrl || '';
                        itemCategoryInput.value = item.category || '';
                        itemIsAvailableCheckbox.checked = item.isAvailable;
                        itemIsTrendingCheckbox.checked = item.isTrending;
                    })
                    .catch(error => {
                        console.error('Error fetching menu item for edit:', error);
                        menuItemMessage.textContent = `Error loading item: ${error.message}`;
                        menuItemMessage.className = 'message mt-3 error';
                        menuItemMessage.classList.remove('hidden');
                    });
            } else {
                menuItemModalTitle.textContent = 'Add New Menu Item';
                itemIsAvailableCheckbox.checked = true;
                itemIsTrendingCheckbox.checked = false;
            }
            menuItemModal.style.display = 'flex';
        }

        async function openOrderDetailsModal(orderId) {
            orderUpdateMessage.classList.add('hidden');
            showLoader(updateOrderLoader, updateOrderText, orderUpdateMessage, 'Loading order details...', 'info');

            try {
                const response = await fetch(`/api/admin/orders/${orderId}`);
                const order = await response.json();

                orderDetailIdDisplay.textContent = order._id.substring(0, 8);
                orderDetailCustomerName.textContent = order.customerName;
                orderDetailCustomerPhone.textContent = order.customerPhone;
                orderDetailDeliveryAddress.textContent = order.deliveryAddress;
                orderDetailDate.textContent = new Date(order.orderDate).toLocaleString();
                orderDetailPaymentMethod.textContent = order.paymentMethod;
                orderDetailSubtotal.textContent = order.subtotal.toFixed(2);
                orderDetailTransportTax.textContent = order.transportTax.toFixed(2);
                orderDetailTotalAmount.textContent = order.totalAmount.toFixed(2);

                orderDetailItemsList.innerHTML = '';
                order.items.forEach(item => {
                    const li = document.createElement('li');
                    li.textContent = `${item.name} x ${item.quantity} (₹${item.price.toFixed(2)} each)`;
                    orderDetailItemsList.appendChild(li);
                });

                orderStatusSelect.value = order.status;
                updateOrderStatusBtn.dataset.id = order._id;
                deleteOrderBtn.dataset.id = order._id;

                hideLoader(updateOrderLoader, updateOrderText, orderUpdateMessage, true, '');
                orderDetailsModal.style.display = 'flex';
            } catch (error) {
                console.error('Error fetching order details:', error);
                hideLoader(updateOrderLoader, updateOrderText, orderUpdateMessage, false, `Error loading order: ${error.message}`);
            }
        }

        // --- Action Functions ---

        async function saveMenuItem() {
            const itemId = menuItemIdInput.value;
            const method = itemId ? 'PUT' : 'POST';
            const url = itemId ? `/api/admin/menu/${itemId}` : '/api/admin/menu';

            const itemData = {
                name: itemNameInput.value,
                description: itemDescriptionInput.value,
                price: parseFloat(itemPriceInput.value),
                imageUrl: itemImageUrlInput.value,
                category: itemCategoryInput.value,
                isAvailable: itemIsAvailableCheckbox.checked,
                isTrending: itemIsTrendingCheckbox.checked
            };

            showLoader(menuItemLoader, menuItemText, menuItemMessage, 'Saving item...');
            try {
                const response = await fetch(url, {
                    method: method,
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(itemData)
                });
                const result = await response.json();
                if (response.ok) {
                    hideLoader(menuItemLoader, menuItemText, menuItemMessage, true, `Item ${itemId ? 'updated' : 'added'} successfully!`);
                    fetchMenuItems();
                    setTimeout(() => menuItemModal.style.display = 'none', 1500);
                } else {
                    hideLoader(menuItemLoader, menuItemText, menuItemMessage, false, `Error: ${result.message || 'Failed to save item.'}`);
                }
            } catch (error) {
                console.error('Error saving menu item:', error);
                hideLoader(menuItemLoader, menuItemText, menuItemMessage, false, `Network error: ${error.message}`);
            }
        }

        async function deleteMenuItem(itemId) {
            if (!confirm('Are you sure you want to delete this menu item?')) return;
            menuMessage.classList.add('hidden');

            try {
                const response = await fetch(`/api/admin/menu/${itemId}`, { method: 'DELETE' });
                const result = await response.json();
                if (response.ok) {
                    menuMessage.textContent = result.message;
                    menuMessage.className = 'message mt-3 success';
                    menuMessage.classList.remove('hidden');
                    fetchMenuItems();
                } else {
                    menuMessage.textContent = `Error: ${result.message || 'Failed to delete item.'}`;
                    menuMessage.className = 'message mt-3 error';
                    menuMessage.classList.remove('hidden');
                }
            } catch (error) {
                console.error('Error deleting menu item:', error);
                menuMessage.textContent = `Network error: ${error.message}`;
                menuMessage.className = 'message mt-3 error';
                menuMessage.classList.remove('hidden');
            }
        }

        async function updateOrderStatus(orderId, newStatus) {
            showLoader(updateOrderLoader, updateOrderText, orderUpdateMessage, 'Updating status...', 'info');
            try {
                const response = await fetch(`/api/admin/orders/${orderId}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ status: newStatus })
                });
                const result = await response.json();
                if (response.ok) {
                    hideLoader(updateOrderLoader, updateOrderText, orderUpdateMessage, true, 'Order status updated!');
                    fetchOrders();
                    setTimeout(() => orderDetailsModal.style.display = 'none', 1500);
                } else {
                    hideLoader(updateOrderLoader, updateOrderText, orderUpdateMessage, false, `Error: ${result.message || 'Failed to update status.'}`);
                }
            } catch (error) {
                console.error('Error updating order status:', error);
                hideLoader(updateOrderLoader, updateOrderText, orderUpdateMessage, false, `Network error: ${error.message}`);
            }
        }

        async function deleteOrder(orderId) {
            if (!confirm('Are you sure you want to delete this order? This action cannot be undone.')) return;
            showLoader(updateOrderLoader, updateOrderText, orderUpdateMessage, 'Deleting order...', 'info');
            try {
                const response = await fetch(`/api/admin/orders/${orderId}`, { method: 'DELETE' });
                const result = await response.json();
                if (response.ok) {
                    hideLoader(updateOrderLoader, updateOrderText, orderUpdateMessage, true, result.message);
                    fetchOrders();
                    setTimeout(() => orderDetailsModal.style.display = 'none', 1500);
                } else {
                    hideLoader(updateOrderLoader, updateOrderText, orderUpdateMessage, false, `Error: ${result.message || 'Failed to delete order.'}`);
                }
            } catch (error) {
                console.error('Error deleting order:', error);
                hideLoader(updateOrderLoader, updateOrderText, orderUpdateMessage, false, `Network error: ${error.message}`);
            }
        }

        async function deleteCustomer(customerId) {
            if (!confirm('Are you sure you want to delete this customer? This action cannot be undone.')) return;
            customersMessage.classList.add('hidden');

            try {
                const response = await fetch(`/api/admin/customers/${customerId}`, { method: 'DELETE' });
                const result = await response.json();
                if (response.ok) {
                    customersMessage.textContent = result.message;
                    customersMessage.className = 'message mt-3 success';
                    customersMessage.classList.remove('hidden');
                    fetchCustomers();
                } else {
                    customersMessage.textContent = `Error: ${result.message || 'Failed to delete customer.'}`;
                    customersMessage.className = 'message mt-3 error';
                    customersMessage.classList.remove('hidden');
                }
            } catch (error) {
                console.error('Error deleting customer:', error);
                customersMessage.textContent = `Network error: ${error.message}`;
                customersMessage.className = 'message mt-3 error';
                customersMessage.classList.remove('hidden');
            }
        }

        async function viewLatestCustomerOrder(customerPhone) {
            customersMessage.classList.add('hidden');

            try {
                const response = await fetch(`/api/admin/customers/${customerPhone}/latest-order`);
                const order = await response.json();

                if (response.ok) {
                    openOrderDetailsModal(order._id);
                } else {
                    customersMessage.textContent = `No recent orders found for ${customerPhone}.`;
                    customersMessage.className = 'message mt-3 info';
                    customersMessage.classList.remove('hidden');
                }
            } catch (error) {
                console.error(`Error fetching latest order for ${customerPhone}:`, error);
                customersMessage.textContent = `Error fetching latest order: ${error.message}`;
                customersMessage.className = 'message mt-3 error';
                customersMessage.classList.remove('hidden');
            }
        }

        async function saveSettings() {
            const deliveryRates = [];
            document.querySelectorAll('#delivery-rates-container .kms-input').forEach(input => {
                const kms = parseFloat(input.value);
                const amount = parseFloat(input.nextElementSibling.value);
                if (!isNaN(kms) && !isNaN(amount)) {
                    deliveryRates.push({ kms, amount });
                }
            });

            deliveryRates.sort((a, b) => a.kms - b.kms);

            const settingsData = {
                shopName: shopNameInput.value,
                shopLocation: {
                    latitude: parseFloat(shopLatInput.value),
                    longitude: parseFloat(shopLonInput.value)
                },
                deliveryRates: deliveryRates
            };

            showLoader(saveSettingsBtn.querySelector('.loader'), saveSettingsBtn.querySelector('span:not(.loader)'), settingsMessage, 'Saving settings...');
            try {
                const response = await fetch('/api/admin/settings', {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(settingsData)
                });
                const result = await response.json();
                if (response.ok) {
                    hideLoader(saveSettingsBtn.querySelector('.loader'), saveSettingsBtn.querySelector('span:not(.loader)'), settingsMessage, true, result.message);
                    fetchSettings();
                } else {
                    hideLoader(saveSettingsBtn.querySelector('.loader'), saveSettingsBtn.querySelector('span:not(.loader)'), settingsMessage, false, `Error: ${result.message || 'Failed to save settings.'}`);
                }
            } catch (error) {
                console.error('Error saving settings:', error);
                hideLoader(saveSettingsBtn.querySelector('.loader'), saveSettingsBtn.querySelector('span:not(.loader)'), settingsMessage, false, `Network error: ${error.message}`);
            }
        }

        function addDeliveryRateInput() {
            const rateDiv = document.createElement('div');
            rateDiv.className = 'delivery-rate-item';
            rateDiv.innerHTML = `
                <input type="number" step="any" class="kms-input" placeholder="KMs">
                <input type="number" step="any" class="amount-input" placeholder="Amount">
                <button type="button" class="remove-rate-btn btn-small">Remove</button>
            `;
            deliveryRatesContainer.appendChild(rateDiv);
            rateDiv.querySelector('.remove-rate-btn').addEventListener('click', (e) => {
                e.target.closest('.delivery-rate-item').remove();
            });
        }


        // --- Navigation Logic ---
        const navLinks = document.querySelectorAll('.nav-link');
        const sections = document.querySelectorAll('.section-content');

        function showSection(sectionId) {
            sections.forEach(section => {
                section.classList.remove('active');
            });
            document.getElementById(sectionId).classList.add('active');

            navLinks.forEach(link => {
                link.classList.remove('active');
                if (link.dataset.section === sectionId) {
                    link.classList.add('active');
                }
            });

            switch (sectionId) {
                case 'bot-status-section':
                    fetchBotStatus();
                    break;
                case 'orders-section':
                    fetchOrders();
                    break;
                case 'menu-section':
                    fetchMenuItems();
                    break;
                case 'customers-section':
                    fetchCustomers();
                    break;
                case 'settings-section':
                    fetchSettings();
                    break;
            }
        }

        navLinks.forEach(link => {
            link.addEventListener('click', (e) => {
                e.preventDefault();
                const sectionId = e.target.dataset.section;
                showSection(sectionId);
            });
        });


        // --- Event Listeners ---

        document.getElementById('logout-btn').addEventListener('click', async () => {
            if (confirm('Are you sure you want to log out?')) {
                try {
                    await fetch('/admin/logout');
                    window.location.href = '/admin/login';
                } catch (error) {
                    alert('Failed to log out. Please try again.');
                    console.error('Logout error:', error);
                }
            }
        });

        refreshBotStatusBtn.addEventListener('click', fetchBotStatus);
        requestQrBtn.addEventListener('click', async () => {
            requestQrBtn.disabled = true;
            loadSessionBtn.disabled = true;
            showLoader(requestQrLoader, requestQrText, botMessage, 'Requesting new QR...', 'info');
            qrCodeSection.classList.add('hidden');
            if (qrTimerInterval) clearInterval(qrTimerInterval);

            try {
                const response = await fetch('/api/public/request-qr', { method: 'POST' });
                const result = await response.json();
                if (!response.ok) {
                    hideLoader(requestQrLoader, requestQrText, botMessage, false, `Error: ${result.message || 'Failed to request new QR.'}`);
                }
            } catch (error) {
                hideLoader(requestQrLoader, requestQrText, botMessage, false, `Network error requesting QR: ${error.message}`);
            } finally {
                requestQrBtn.disabled = false;
                loadSessionBtn.disabled = false;
            }
        });

        loadSessionBtn.addEventListener('click', async () => {
            loadSessionBtn.disabled = true;
            requestQrBtn.disabled = true;
            showLoader(loadSessionLoader, loadSessionText, botMessage, 'Attempting to load saved session...', 'info');
            qrCodeSection.classList.add('hidden');
            if (qrTimerInterval) clearInterval(qrTimerInterval);

            try {
                const response = await fetch('/api/admin/load-session', { method: 'POST' });
                const result = await response.json();
                if (!response.ok) {
                    hideLoader(loadSessionLoader, loadSessionText, botMessage, false, `Error: ${result.message || 'Failed to load session.'}`);
                }
            } catch (error) {
                hideLoader(loadSessionLoader, loadSessionText, botMessage, false, `Network error loading session: ${error.message}`);
            } finally {
                loadSessionBtn.disabled = false;
                requestQrBtn.disabled = false;
            }
        });

        refreshOrdersBtn.addEventListener('click', fetchOrders);
        addMenuItemBtn.addEventListener('click', () => openMenuItemModal());
        menuItemForm.addEventListener('submit', (e) => {
            e.preventDefault();
            saveMenuItem();
        });

        refreshCustomersBtn.addEventListener('click', fetchCustomers);
        saveSettingsBtn.addEventListener('click', saveSettings);
        addDeliveryRateBtn.addEventListener('click', addDeliveryRateInput);

        document.querySelectorAll('.modal .close-button').forEach(button => {
            button.addEventListener('click', (e) => {
                e.target.closest('.modal').style.display = 'none';
            });
        });
        window.addEventListener('click', (event) => {
            if (event.target === menuItemModal) {
                menuItemModal.style.display = 'none';
            }
            if (event.target === orderDetailsModal) {
                orderDetailsModal.style.display = 'none';
            }
        });

        updateOrderStatusBtn.addEventListener('click', () => {
            const orderId = updateOrderStatusBtn.dataset.id;
            const newStatus = orderStatusSelect.value;
            updateOrderStatus(orderId, newStatus);
        });
        deleteOrderBtn.addEventListener('click', () => {
            const orderId = deleteOrderBtn.dataset.id;
            deleteOrder(orderId);
        });

        socket.on('status', (status) => {
            updateBotStatusDisplay(status);
        });

        socket.on('qrCode', (qrDataURL) => {
            if (qrDataURL) {
                qrCodeImg.src = qrDataURL;
                qrCodeSection.classList.remove('hidden');
                startQrCountdown();
            } else {
                qrCodeImg.src = '';
                qrCodeSection.classList.add('hidden');
                if (qrTimerInterval) clearInterval(qrTimerInterval);
            }
        });

        socket.on('sessionInfo', (data) => {
            if (data.lastAuthenticatedAt) {
                lastAuthTimeSpan.textContent = new Date(data.lastAuthenticatedAt).toLocaleString();
            } else {
                lastAuthTimeSpan.textContent = 'N/A';
            }
        });

        document.addEventListener('DOMContentLoaded', () => {
            showSection('bot-status-section');
        });
    </script>
</body>
</html>

