<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard - Delicious Bites</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <script src="/socket.io/socket.io.js"></script>
    <style>
        body { font-family: 'Inter', sans-serif; }
        /* Apply black and white theme overrides */
        body {
            background-color: #000000 !important; /* Pure black background */
            color: #ffffff !important; /* Pure white text */
        }
        .bg-gray-100 {
            background-color: #000000 !important;
        }
        .bg-white, .bg-gray-800 {
            background-color: #1a1a1a !important; /* Very dark gray */
        }
        .text-gray-800 {
            color: #ffffff !important;
        }
        .text-gray-700, .text-gray-300 {
            color: #dddddd !important;
        }
        input, textarea, select {
            background-color: #222222 !important;
            border-color: #444444 !important;
            color: #ffffff !important;
        }
        input::placeholder, textarea::placeholder {
            color: #888888 !important;
        }
        button {
            background-color: #ffffff !important; /* White background */
            color: #000000 !important; /* Black text */
            box-shadow: 0 4px 6px -1px rgba(255, 255, 255, 0.2), 0 2px 4px -1px rgba(255, 255, 255, 0.1) !important;
        }
        button:hover {
            background-color: #e0e0e0 !important;
        }
        .text-red-500 {
            color: #ff6666 !important; /* Slightly brighter red for error messages */
        }
        .text-green-500 {
            color: #66ff66 !important; /* Slightly brighter green for success */
        }
        .text-yellow-500 {
            color: #ffff66 !important; /* Slightly brighter yellow for warnings */
        }
        .alert {
            padding: 1rem;
            border-radius: 0.5rem;
            margin-bottom: 1rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        .alert-red {
            background-color: #440000;
            color: #ff6666;
            border: 1px solid #ff6666;
        }
        .alert-yellow {
            background-color: #444400;
            color: #ffff66;
            border: 1px solid #ffff66;
        }
        .alert-green {
            background-color: #004400;
            color: #66ff66;
            border: 1px solid #66ff66;
        }
        .loader {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #4CAF50;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
            display: inline-block;
            vertical-align: middle;
            margin-right: 8px;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .modal {
            display: none; /* Hidden by default */
            position: fixed; /* Stay in place */
            z-index: 1000; /* Sit on top */
            left: 0;
            top: 0;
            width: 100%; /* Full width */
            height: 100%; /* Full height */
            overflow: auto; /* Enable scroll if needed */
            background-color: rgba(0,0,0,0.6); /* Black w/ opacity */
            justify-content: center;
            align-items: center;
        }
        .modal-content {
            background-color: #1a1a1a;
            margin: auto;
            padding: 2rem;
            border-radius: 0.75rem;
            box-shadow: 0 5px 15px rgba(255,255,255,0.1);
            width: 90%;
            max-width: 500px;
            position: relative;
            color: #ffffff;
        }
        .close-button {
            color: #aaa;
            position: absolute;
            top: 1rem;
            right: 1rem;
            font-size: 1.75rem;
            font-weight: bold;
            cursor: pointer;
        }
        .close-button:hover,
        .close-button:focus {
            color: #ffffff;
            text-decoration: none;
            cursor: pointer;
        }
    </style>
</head>
<body class="bg-gray-900 text-white min-h-screen">
    <div class="container mx-auto p-4">
        <header class="flex justify-between items-center py-4 border-b border-gray-700">
            <h1 class="text-4xl font-bold text-green-400">Admin Dashboard</h1>
            <nav>
                <a href="/admin/logout" class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-lg transition duration-300">Logout</a>
            </nav>
        </header>

        <main class="mt-8">
            <h2 class="text-3xl font-bold text-gray-200 mb-6">WhatsApp Bot Status</h2>
            <div id="bot-status-alert" class="alert hidden">
                <span id="alert-message"></span>
                <button id="request-qr-btn" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded-lg transition duration-300 ml-4 hidden">Request New QR</button>
            </div>
            <p class="text-gray-400 mb-6">Current Status: <span id="bot-status" class="font-semibold">Loading...</span></p>

            <!-- Tabs for navigation -->
            <div class="flex border-b border-gray-700 mb-6">
                <button class="tab-button px-4 py-2 text-lg font-medium focus:outline-none" data-tab="orders">Orders</button>
                <button class="tab-button px-4 py-2 text-lg font-medium focus:outline-none" data-tab="menu">Menu</button>
                <button class="tab-button px-4 py-2 text-lg font-medium focus:outline-none" data-tab="settings">Settings</button>
                <button class="tab-button px-4 py-2 text-lg font-medium focus:outline-none" data-tab="customers">Customers</button>
            </div>

            <!-- Orders Tab Content -->
            <div id="orders-tab" class="tab-content">
                <h2 class="text-3xl font-bold text-gray-200 mb-6">Recent Orders</h2>
                <div id="orders-list" class="bg-gray-800 rounded-lg shadow-lg p-4">
                    <p class="text-gray-400 text-center">Loading orders...</p>
                </div>
            </div>

            <!-- Menu Tab Content -->
            <div id="menu-tab" class="tab-content hidden">
                <h2 class="text-3xl font-bold text-gray-200 mb-6">Menu Management</h2>
                <button id="add-menu-item-btn" class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-lg mb-4 transition duration-300">Add New Menu Item</button>
                <div id="menu-items-list" class="bg-gray-800 rounded-lg shadow-lg p-4">
                    <p class="text-gray-400 text-center">Loading menu items...</p>
                </div>
            </div>

            <!-- Settings Tab Content -->
            <div id="settings-tab" class="tab-content hidden">
                <h2 class="text-3xl font-bold text-gray-200 mb-6">Shop Settings</h2>
                <form id="settings-form" class="bg-gray-800 rounded-lg shadow-lg p-6 space-y-4">
                    <div>
                        <label for="shop-name" class="block text-gray-300 text-sm font-bold mb-2">Shop Name:</label>
                        <input type="text" id="shop-name" name="shopName" class="shadow border rounded w-full py-2 px-3 text-gray-300 leading-tight focus:outline-none focus:shadow-outline" required>
                    </div>
                    <div>
                        <label class="block text-gray-300 text-sm font-bold mb-2">Shop Location (Latitude, Longitude):</label>
                        <input type="number" step="any" id="shop-latitude" name="shopLocation.latitude" class="shadow border rounded w-full py-2 px-3 text-gray-300 leading-tight focus:outline-none focus:shadow-outline mb-2" placeholder="Latitude" required>
                        <input type="number" step="any" id="shop-longitude" name="shopLocation.longitude" class="shadow border rounded w-full py-2 px-3 text-gray-300 leading-tight focus:outline-none focus:shadow-outline" placeholder="Longitude" required>
                    </div>
                    <div>
                        <h3 class="text-xl font-bold text-gray-200 mb-2">Delivery Rates (KMs, Amount)</h3>
                        <div id="delivery-rates-container" class="space-y-2">
                            <!-- Delivery rates will be dynamically added here -->
                        </div>
                        <button type="button" id="add-delivery-rate-btn" class="mt-4 bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg transition duration-300">Add Rate</button>
                    </div>
                    <button type="submit" class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-lg transition duration-300">Save Settings</button>
                    <p id="settings-message" class="mt-2 text-sm"></p>
                </form>
            </div>

            <!-- Customers Tab Content -->
            <div id="customers-tab" class="tab-content hidden">
                <h2 class="text-3xl font-bold text-gray-200 mb-6">Customer Locations</h2>
                <div id="customers-list" class="bg-gray-800 rounded-lg shadow-lg p-4">
                    <p class="text-gray-400 text-center">Loading customer data...</p>
                </div>
            </div>
        </main>
    </div>

    <!-- Modals (Order Details, Menu Item Form) -->

    <!-- Order Details Modal -->
    <div id="order-details-modal" class="modal">
        <div class="modal-content">
            <span class="close-button">&times;</span>
            <h2 class="text-2xl font-bold text-gray-200 mb-4">Order Details</h2>
            <div id="order-details-content" class="text-gray-300">
                <!-- Details will be loaded here -->
            </div>
            <div class="mt-4">
                <label for="order-status-select" class="block text-gray-300 text-sm font-bold mb-2">Update Status:</label>
                <select id="order-status-select" class="shadow border rounded w-full py-2 px-3 text-gray-300 leading-tight focus:outline-none focus:shadow-outline">
                    <option value="Pending">Pending</option>
                    <option value="Confirmed">Confirmed</option>
                    <option value="Preparing">Preparing</option>
                    <option value="Out for Delivery">Out for Delivery</option>
                    <option value="Delivered">Delivered</option>
                    <option value="Cancelled">Cancelled</option>
                </select>
                <button id="update-order-status-btn" class="mt-4 bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg transition duration-300">Update Status</button>
                <p id="order-update-message" class="mt-2 text-sm"></p>
            </div>
        </div>
    </div>

    <!-- Menu Item Form Modal -->
    <div id="menu-item-modal" class="modal">
        <div class="modal-content">
            <span class="close-button">&times;</span>
            <h2 id="menu-item-modal-title" class="text-2xl font-bold text-gray-200 mb-4">Add New Menu Item</h2>
            <form id="menu-item-form" class="space-y-4">
                <input type="hidden" id="menu-item-id">
                <div>
                    <label for="item-name" class="block text-gray-300 text-sm font-bold mb-2">Name:</label>
                    <input type="text" id="item-name" name="name" class="shadow border rounded w-full py-2 px-3 leading-tight focus:outline-none focus:shadow-outline" required>
                </div>
                <div>
                    <label for="item-description" class="block text-gray-300 text-sm font-bold mb-2">Description:</label>
                    <textarea id="item-description" name="description" class="shadow border rounded w-full py-2 px-3 leading-tight focus:outline-none focus:shadow-outline"></textarea>
                </div>
                <div>
                    <label for="item-price" class="block text-gray-300 text-sm font-bold mb-2">Price:</label>
                    <input type="number" step="0.01" id="item-price" name="price" class="shadow border rounded w-full py-2 px-3 leading-tight focus:outline-none focus:shadow-outline" required min="0">
                </div>
                <div>
                    <label for="item-image-url" class="block text-gray-300 text-sm font-bold mb-2">Image URL:</label>
                    <input type="url" id="item-image-url" name="imageUrl" class="shadow border rounded w-full py-2 px-3 leading-tight focus:outline-none focus:shadow-outline" placeholder="https://example.com/image.jpg">
                </div>
                <div>
                    <label for="item-category" class="block text-gray-300 text-sm font-bold mb-2">Category:</label>
                    <input type="text" id="item-category" name="category" class="shadow border rounded w-full py-2 px-3 leading-tight focus:outline-none focus:shadow-outline" value="Main Course">
                </div>
                <div class="flex items-center">
                    <input type="checkbox" id="item-is-available" name="isAvailable" class="mr-2 leading-tight">
                    <label for="item-is-available" class="text-gray-300 text-sm">Available</label>
                </div>
                <div class="flex items-center">
                    <input type="checkbox" id="item-is-trending" name="isTrending" class="mr-2 leading-tight">
                    <label for="item-is-trending" class="text-gray-300 text-sm">Trending</label>
                </div>
                <button type="submit" class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-lg transition duration-300">Save Item</button>
                <p id="menu-item-message" class="mt-2 text-sm"></p>
            </form>
        </div>
    </div>


    <script>
        const socket = io();
        const botStatusSpan = document.getElementById('bot-status');
        const botStatusAlert = document.getElementById('bot-status-alert');
        const alertMessage = document.getElementById('alert-message');
        const requestQrBtn = document.getElementById('request-qr-btn');

        const ordersTabBtn = document.querySelector('[data-tab="orders"]');
        const menuTabBtn = document.querySelector('[data-tab="menu"]');
        const settingsTabBtn = document.querySelector('[data-tab="settings"]');
        const customersTabBtn = document.querySelector('[data-tab="customers"]');

        const ordersTabContent = document.getElementById('orders-tab');
        const menuTabContent = document.getElementById('menu-tab');
        const settingsTabContent = document.getElementById('settings-tab');
        const customersTabContent = document.getElementById('customers-tab');

        const ordersList = document.getElementById('orders-list');
        const menuItemsList = document.getElementById('menu-items-list');
        const addMenuItemBtn = document.getElementById('add-menu-item-btn');
        const settingsForm = document.getElementById('settings-form');
        const deliveryRatesContainer = document.getElementById('delivery-rates-container');
        const addDeliveryRateBtn = document.getElementById('add-delivery-rate-btn');
        const settingsMessage = document.getElementById('settings-message');
        const customersList = document.getElementById('customers-list');

        const orderDetailsModal = document.getElementById('order-details-modal');
        const closeOrderDetailsModalBtn = orderDetailsModal.querySelector('.close-button');
        const orderDetailsContent = document.getElementById('order-details-content');
        const orderStatusSelect = document.getElementById('order-status-select');
        const updateOrderStatusBtn = document.getElementById('update-order-status-btn');
        const orderUpdateMessage = document.getElementById('order-update-message');
        let currentOrderId = null;

        const menuItemModal = document.getElementById('menu-item-modal');
        const closeMenuItemModalBtn = menuItemModal.querySelector('.close-button');
        const menuItemModalTitle = document.getElementById('menu-item-modal-title');
        const menuItemForm = document.getElementById('menu-item-form');
        const menuItemIdInput = document.getElementById('menu-item-id');
        const itemNameInput = document.getElementById('item-name');
        const itemDescriptionInput = document.getElementById('item-description');
        const itemPriceInput = document.getElementById('item-price');
        const itemImageUrlInput = document.getElementById('item-image-url');
        const itemCategoryInput = document.getElementById('item-category');
        const itemIsAvailableInput = document.getElementById('item-is-available');
        const itemIsTrendingInput = document.getElementById('item-is-trending');
        const menuItemMessage = document.getElementById('menu-item-message');

        let currentActiveTab = 'orders'; // Default active tab

        // --- Tab Switching Logic ---
        function switchTab(tabName) {
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.add('hidden');
            });
            document.querySelectorAll('.tab-button').forEach(button => {
                button.classList.remove('bg-gray-700', 'text-white');
                button.classList.add('text-gray-400', 'hover:text-gray-200');
            });

            document.getElementById(`${tabName}-tab`).classList.remove('hidden');
            document.querySelector(`[data-tab="${tabName}"]`).classList.add('bg-gray-700', 'text-white');
            document.querySelector(`[data-tab="${tabName}"]`).classList.remove('text-gray-400', 'hover:text-gray-200');
            currentActiveTab = tabName;

            // Fetch data for the active tab
            if (tabName === 'orders') fetchOrders();
            else if (tabName === 'menu') fetchMenuItems();
            else if (tabName === 'settings') fetchSettings();
            else if (tabName === 'customers') fetchCustomers();
        }

        ordersTabBtn.addEventListener('click', () => switchTab('orders'));
        menuTabBtn.addEventListener('click', () => switchTab('menu'));
        settingsTabBtn.addEventListener('click', () => switchTab('settings'));
        customersTabBtn.addEventListener('click', () => switchTab('customers'));

        // Initialize with the default tab
        switchTab(currentActiveTab);


        // --- WhatsApp Bot Status ---
        socket.on('status', (status) => {
            botStatusSpan.textContent = status;
            botStatusAlert.classList.remove('alert-red', 'alert-yellow', 'alert-green', 'hidden');
            requestQrBtn.classList.add('hidden'); // Hide by default

            let message = '';
            let alertClass = '';

            switch (status) {
                case 'ready':
                    message = 'WhatsApp bot is connected and ready!';
                    alertClass = 'alert-green';
                    break;
                case 'authenticated':
                    message = 'WhatsApp bot authenticated. Waiting for ready state...';
                    alertClass = 'alert-yellow';
                    break;
                case 'qr_received':
                    message = 'QR Code received. Scan it with your WhatsApp app.';
                    alertClass = 'alert-yellow';
                    requestQrBtn.classList.remove('hidden'); // Show QR button
                    break;
                case 'qr_expired':
                    message = 'QR Code expired. Please request a new one.';
                    alertClass = 'alert-red';
                    requestQrBtn.classList.remove('hidden'); // Show QR button
                    break;
                case 'auth_failure':
                    message = 'Authentication failed. Please request a new QR code and re-scan.';
                    alertClass = 'alert-red';
                    requestQrBtn.classList.remove('hidden'); // Show QR button
                    break;
                case 'disconnected':
                    message = 'WhatsApp bot disconnected. Attempting to reconnect or waiting for new QR.';
                    alertClass = 'alert-red';
                    requestQrBtn.classList.remove('hidden'); // Show QR button
                    break;
                case 'initializing':
                    message = 'WhatsApp bot is initializing...';
                    alertClass = 'alert-yellow';
                    break;
                case 'reconnecting':
                    message = 'WhatsApp bot is reconnecting...';
                    alertClass = 'alert-yellow';
                    break;
                case 'qr_error':
                    message = 'Error generating QR code. Check server logs.';
                    alertClass = 'alert-red';
                    requestQrBtn.classList.remove('hidden'); // Show QR button
                    break;
                default:
                    message = `Unknown status: ${status}`;
                    alertClass = 'alert-yellow';
            }

            alertMessage.textContent = message;
            botStatusAlert.classList.add(alertClass);
            botStatusAlert.classList.remove('hidden');
        });

        requestQrBtn.addEventListener('click', async () => {
            requestQrBtn.disabled = true;
            alertMessage.textContent = 'Requesting new QR...';
            botStatusAlert.classList.remove('alert-red', 'alert-yellow', 'alert-green');
            botStatusAlert.classList.add('alert-yellow');

            try {
                const response = await fetch('/api/public/request-qr', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' }
                });
                const result = await response.json();
                if (response.ok) {
                    alertMessage.textContent = result.message;
                    // Status update will come via socket.io
                } else {
                    alertMessage.textContent = `Error: ${result.message || 'Failed to request new QR.'}`;
                    botStatusAlert.classList.remove('alert-yellow');
                    botStatusAlert.classList.add('alert-red');
                }
            } catch (error) {
                alertMessage.textContent = `Network error requesting QR: ${error.message}`;
                botStatusAlert.classList.remove('alert-yellow');
                botStatusAlert.classList.add('alert-red');
            } finally {
                requestQrBtn.disabled = false;
            }
        });

        // --- Orders Tab Functions ---
        async function fetchOrders() {
            ordersList.innerHTML = '<p class="text-gray-400 text-center">Loading orders...</p>';
            try {
                const response = await fetch('/api/admin/orders');
                if (!response.ok) {
                    if (response.status === 401) {
                        window.location.href = '/admin/login'; // Redirect to login if unauthorized
                        return;
                    }
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                const orders = await response.json();
                displayOrders(orders);
            } catch (error) {
                console.error('Error fetching orders:', error);
                ordersList.innerHTML = `<p class="text-red-500 text-center">Failed to load orders: ${error.message}</p>`;
            }
        }

        function displayOrders(orders) {
            ordersList.innerHTML = '';
            if (orders.length === 0) {
                ordersList.innerHTML = '<p class="text-gray-400 text-center">No orders found.</p>';
                return;
            }

            const table = document.createElement('table');
            table.className = 'min-w-full bg-gray-700 rounded-lg overflow-hidden';
            table.innerHTML = `
                <thead>
                    <tr class="bg-gray-600 text-left">
                        <th class="py-2 px-4">Order ID</th>
                        <th class="py-2 px-4">Customer</th>
                        <th class="py-2 px-4">Phone</th>
                        <th class="py-2 px-4">Total</th>
                        <th class="py-2 px-4">Payment</th>
                        <th class="py-2 px-4">Status</th>
                        <th class="py-2 px-4">Date</th>
                        <th class="py-2 px-4">Actions</th>
                    </tr>
                </thead>
                <tbody id="orders-table-body"></tbody>
            `;
            ordersList.appendChild(table);
            const tbody = document.getElementById('orders-table-body');

            orders.forEach(order => {
                const row = tbody.insertRow();
                row.className = 'border-b border-gray-600 hover:bg-gray-700';
                row.innerHTML = `
                    <td class="py-2 px-4">${order._id.substring(0, 8)}...</td>
                    <td class="py-2 px-4">${order.customerName}</td>
                    <td class="py-2 px-4">${order.customerPhone}</td>
                    <td class="py-2 px-4">₹${order.totalAmount.toFixed(2)}</td>
                    <td class="py-2 px-4">${order.paymentMethod || 'N/A'}</td>
                    <td class="py-2 px-4">
                        <span class="px-2 py-1 rounded-full text-xs font-semibold
                            ${order.status === 'Pending' ? 'bg-yellow-500 text-yellow-900' : ''}
                            ${order.status === 'Confirmed' ? 'bg-blue-500 text-blue-900' : ''}
                            ${order.status === 'Preparing' ? 'bg-purple-500 text-purple-900' : ''}
                            ${order.status === 'Out for Delivery' ? 'bg-indigo-500 text-indigo-900' : ''}
                            ${order.status === 'Delivered' ? 'bg-green-500 text-green-900' : ''}
                            ${order.status === 'Cancelled' ? 'bg-red-500 text-red-900' : ''}
                        ">${order.status}</span>
                    </td>
                    <td class="py-2 px-4">${new Date(order.orderDate).toLocaleString()}</td>
                    <td class="py-2 px-4">
                        <button data-id="${order._id}" class="view-order-btn bg-blue-500 hover:bg-blue-600 text-white text-sm py-1 px-3 rounded-md">View</button>
                    </td>
                `;
            });

            ordersList.querySelectorAll('.view-order-btn').forEach(button => {
                button.addEventListener('click', (e) => openOrderDetailsModal(e.target.dataset.id));
            });
        }

        async function openOrderDetailsModal(orderId) {
            currentOrderId = orderId;
            orderDetailsContent.innerHTML = '<p class="text-gray-400">Loading order details...</p>';
            orderDetailsModal.style.display = 'flex';
            orderUpdateMessage.textContent = ''; // Clear previous messages

            try {
                const response = await fetch(`/api/admin/orders/${orderId}`);
                if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                const order = await response.json();

                orderDetailsContent.innerHTML = `
                    <p><strong>Order ID:</strong> ${order._id}</p>
                    <p><strong>Customer Name:</strong> ${order.customerName}</p>
                    <p><strong>Phone:</strong> ${order.customerPhone}</p>
                    <p><strong>Delivery Address:</strong> ${order.deliveryAddress}</p>
                    <p><strong>Customer Location:</strong> ${order.customerLocation ? `Lat: ${order.customerLocation.latitude}, Lon: ${order.customerLocation.longitude}` : 'N/A'}</p>
                    <p><strong>Payment Method:</strong> ${order.paymentMethod || 'COD'}</p>
                    <p><strong>Subtotal:</strong> ₹${order.subtotal.toFixed(2)}</p>
                    <p><strong>Transport Tax:</strong> ₹${order.transportTax.toFixed(2)}</p>
                    <p><strong>Total Amount:</strong> ₹${order.totalAmount.toFixed(2)}</p>
                    <p><strong>Order Date:</strong> ${new Date(order.orderDate).toLocaleString()}</p>
                    <h4 class="text-xl font-bold mt-4 mb-2">Items:</h4>
                    <ul class="list-disc pl-5">
                        ${order.items.map(item => `<li>${item.name} x ${item.quantity} (₹${item.price.toFixed(2)} each)</li>`).join('')}
                    </ul>
                `;
                orderStatusSelect.value = order.status; // Set current status in dropdown
            } catch (error) {
                console.error('Error fetching order details:', error);
                orderDetailsContent.innerHTML = `<p class="text-red-500">Failed to load order details: ${error.message}</p>`;
            }
        }

        closeOrderDetailsModalBtn.addEventListener('click', () => {
            orderDetailsModal.style.display = 'none';
            currentOrderId = null;
        });

        updateOrderStatusBtn.addEventListener('click', async () => {
            if (!currentOrderId) return;

            const newStatus = orderStatusSelect.value;
            updateOrderStatusBtn.disabled = true;
            orderUpdateMessage.textContent = 'Updating status...';
            orderUpdateMessage.className = 'mt-2 text-sm text-yellow-500';

            try {
                const response = await fetch(`/api/admin/orders/${currentOrderId}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ status: newStatus })
                });

                const result = await response.json();
                if (response.ok) {
                    orderUpdateMessage.textContent = `Status updated to ${result.status}!`;
                    orderUpdateMessage.className = 'mt-2 text-sm text-green-500';
                    fetchOrders(); // Refresh orders list
                } else {
                    orderUpdateMessage.textContent = `Error updating status: ${result.message || response.statusText}`;
                    orderUpdateMessage.className = 'mt-2 text-sm text-red-500';
                }
            } catch (error) {
                console.error('Error updating order status:', error);
                orderUpdateMessage.textContent = `Network error: ${error.message}`;
                orderUpdateMessage.className = 'mt-2 text-sm text-red-500';
            } finally {
                updateOrderStatusBtn.disabled = false;
            }
        });

        // --- Menu Tab Functions ---
        async function fetchMenuItems() {
            menuItemsList.innerHTML = '<p class="text-gray-400 text-center">Loading menu items...</p>';
            try {
                const response = await fetch('/api/admin/menu');
                if (!response.ok) {
                    if (response.status === 401) {
                        window.location.href = '/admin/login';
                        return;
                    }
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                const items = await response.json();
                displayMenuItems(items);
            } catch (error) {
                console.error('Error fetching menu items:', error);
                menuItemsList.innerHTML = `<p class="text-red-500 text-center">Failed to load menu items: ${error.message}</p>`;
            }
        }

        function displayMenuItems(items) {
            menuItemsList.innerHTML = '';
            if (items.length === 0) {
                menuItemsList.innerHTML = '<p class="text-gray-400 text-center">No menu items added yet.</p>';
                return;
            }

            const table = document.createElement('table');
            table.className = 'min-w-full bg-gray-700 rounded-lg overflow-hidden';
            table.innerHTML = `
                <thead>
                    <tr class="bg-gray-600 text-left">
                        <th class="py-2 px-4">Name</th>
                        <th class="py-2 px-4">Price</th>
                        <th class="py-2 px-4">Category</th>
                        <th class="py-2 px-4">Available</th>
                        <th class="py-2 px-4">Trending</th>
                        <th class="py-2 px-4">Actions</th>
                    </tr>
                </thead>
                <tbody id="menu-items-table-body"></tbody>
            `;
            menuItemsList.appendChild(table);
            const tbody = document.getElementById('menu-items-table-body');

            items.forEach(item => {
                const row = tbody.insertRow();
                row.className = 'border-b border-gray-600 hover:bg-gray-700';
                row.innerHTML = `
                    <td class="py-2 px-4">${item.name}</td>
                    <td class="py-2 px-4">₹${item.price.toFixed(2)}</td>
                    <td class="py-2 px-4">${item.category}</td>
                    <td class="py-2 px-4">${item.isAvailable ? 'Yes' : 'No'}</td>
                    <td class="py-2 px-4">${item.isTrending ? 'Yes' : 'No'}</td>
                    <td class="py-2 px-4">
                        <button data-id="${item._id}" class="edit-menu-item-btn bg-yellow-500 hover:bg-yellow-600 text-white text-sm py-1 px-3 rounded-md mr-2">Edit</button>
                        <button data-id="${item._id}" class="delete-menu-item-btn bg-red-500 hover:bg-red-600 text-white text-sm py-1 px-3 rounded-md">Delete</button>
                    </td>
                `;
            });

            menuItemsList.querySelectorAll('.edit-menu-item-btn').forEach(button => {
                button.addEventListener('click', (e) => openMenuItemModalForEdit(e.target.dataset.id));
            });
            menuItemsList.querySelectorAll('.delete-menu-item-btn').forEach(button => {
                button.addEventListener('click', (e) => deleteMenuItem(e.target.dataset.id));
            });
        }

        addMenuItemBtn.addEventListener('click', () => {
            menuItemModalTitle.textContent = 'Add New Menu Item';
            menuItemForm.reset(); // Clear form for new entry
            menuItemIdInput.value = ''; // Ensure ID is empty for new item
            menuItemModal.style.display = 'flex';
            menuItemMessage.textContent = '';
        });

        closeMenuItemModalBtn.addEventListener('click', () => {
            menuItemModal.style.display = 'none';
        });

        async function openMenuItemModalForEdit(itemId) {
            menuItemModalTitle.textContent = 'Edit Menu Item';
            menuItemForm.reset();
            menuItemMessage.textContent = 'Loading item details...';
            menuItemMessage.className = 'mt-2 text-sm text-yellow-500';
            menuItemModal.style.display = 'flex';

            try {
                const response = await fetch(`/api/admin/menu/${itemId}`);
                if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                const item = await response.json();

                menuItemIdInput.value = item._id;
                itemNameInput.value = item.name;
                itemDescriptionInput.value = item.description;
                itemPriceInput.value = item.price;
                itemImageUrlInput.value = item.imageUrl;
                itemCategoryInput.value = item.category;
                itemIsAvailableInput.checked = item.isAvailable;
                itemIsTrendingInput.checked = item.isTrending;

                menuItemMessage.textContent = '';
            } catch (error) {
                console.error('Error fetching menu item for edit:', error);
                menuItemMessage.textContent = `Failed to load item for edit: ${error.message}`;
                menuItemMessage.className = 'mt-2 text-sm text-red-500';
            }
        }

        menuItemForm.addEventListener('submit', async (e) => {
            e.preventDefault();

            const itemId = menuItemIdInput.value;
            const method = itemId ? 'PUT' : 'POST';
            const url = itemId ? `/api/admin/menu/${itemId}` : '/api/admin/menu';

            const formData = {
                name: itemNameInput.value,
                description: itemDescriptionInput.value,
                price: parseFloat(itemPriceInput.value),
                imageUrl: itemImageUrlInput.value,
                category: itemCategoryInput.value,
                isAvailable: itemIsAvailableInput.checked,
                isTrending: itemIsTrendingInput.checked
            };

            menuItemMessage.textContent = 'Saving item...';
            menuItemMessage.className = 'mt-2 text-sm text-yellow-500';
            menuItemForm.querySelector('button[type="submit"]').disabled = true;

            try {
                const response = await fetch(url, {
                    method: method,
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(formData)
                });

                const result = await response.json();
                if (response.ok) {
                    menuItemMessage.textContent = `Item saved successfully!`;
                    menuItemMessage.className = 'mt-2 text-sm text-green-500';
                    fetchMenuItems(); // Refresh list
                    setTimeout(() => menuItemModal.style.display = 'none', 1500);
                } else {
                    menuItemMessage.textContent = `Error saving item: ${result.message || response.statusText}`;
                    menuItemMessage.className = 'mt-2 text-sm text-red-500';
                }
            } catch (error) {
                console.error('Error saving menu item:', error);
                menuItemMessage.textContent = `Network error: ${error.message}`;
                menuItemMessage.className = 'mt-2 text-sm text-red-500';
            } finally {
                menuItemForm.querySelector('button[type="submit"]').disabled = false;
            }
        });

        async function deleteMenuItem(itemId) {
            if (!confirm('Are you sure you want to delete this menu item?')) { // Consider a custom modal instead of alert
                return;
            }

            try {
                const response = await fetch(`/api/admin/menu/${itemId}`, {
                    method: 'DELETE'
                });

                if (response.ok) {
                    alert('Menu item deleted successfully!'); // Consider a custom modal
                    fetchMenuItems(); // Refresh list
                } else {
                    const result = await response.json();
                    alert(`Error deleting item: ${result.message || response.statusText}`); // Consider a custom modal
                }
            } catch (error) {
                console.error('Error deleting menu item:', error);
                alert(`Network error deleting item: ${error.message}`); // Consider a custom modal
            }
        }

        // --- Settings Tab Functions ---
        async function fetchSettings() {
            settingsMessage.textContent = 'Loading settings...';
            settingsMessage.className = 'mt-2 text-sm text-yellow-500';
            try {
                const response = await fetch('/api/admin/settings');
                if (!response.ok) {
                    if (response.status === 401) {
                        window.location.href = '/admin/login';
                        return;
                    }
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                const settings = await response.json();
                document.getElementById('shop-name').value = settings.shopName || '';
                document.getElementById('shop-latitude').value = settings.shopLocation ? settings.shopLocation.latitude : 0;
                document.getElementById('shop-longitude').value = settings.shopLocation ? settings.shopLocation.longitude : 0;
                displayDeliveryRates(settings.deliveryRates || []);
                settingsMessage.textContent = '';
            } catch (error) {
                console.error('Error fetching settings:', error);
                settingsMessage.textContent = `Failed to load settings: ${error.message}`;
                settingsMessage.className = 'mt-2 text-sm text-red-500';
            }
        }

        function displayDeliveryRates(rates) {
            deliveryRatesContainer.innerHTML = '';
            rates.forEach((rate, index) => {
                const rateDiv = document.createElement('div');
                rateDiv.className = 'flex space-x-2 items-center';
                rateDiv.innerHTML = `
                    <input type="number" step="any" class="delivery-kms shadow border rounded py-2 px-3 w-1/2" placeholder="KMs" value="${rate.kms}" required>
                    <input type="number" step="0.01" class="delivery-amount shadow border rounded py-2 px-3 w-1/2" placeholder="Amount" value="${rate.amount}" required>
                    <button type="button" class="remove-delivery-rate-btn bg-red-500 hover:bg-red-600 text-white py-1 px-2 rounded-md text-sm">Remove</button>
                `;
                deliveryRatesContainer.appendChild(rateDiv);
            });
            addRemoveRateListeners();
        }

        function addRemoveRateListeners() {
            deliveryRatesContainer.querySelectorAll('.remove-delivery-rate-btn').forEach(button => {
                button.onclick = (e) => e.target.closest('.flex').remove();
            });
        }

        addDeliveryRateBtn.addEventListener('click', () => {
            const rateDiv = document.createElement('div');
            rateDiv.className = 'flex space-x-2 items-center';
            rateDiv.innerHTML = `
                <input type="number" step="any" class="delivery-kms shadow border rounded py-2 px-3 w-1/2" placeholder="KMs" required>
                <input type="number" step="0.01" class="delivery-amount shadow border rounded py-2 px-3 w-1/2" placeholder="Amount" required>
                <button type="button" class="remove-delivery-rate-btn bg-red-500 hover:bg-red-600 text-white py-1 px-2 rounded-md text-sm">Remove</button>
            `;
            deliveryRatesContainer.appendChild(rateDiv);
            addRemoveRateListeners();
        });

        settingsForm.addEventListener('submit', async (e) => {
            e.preventDefault();

            const shopName = document.getElementById('shop-name').value;
            const shopLatitude = parseFloat(document.getElementById('shop-latitude').value);
            const shopLongitude = parseFloat(document.getElementById('shop-longitude').value);

            const deliveryRates = [];
            deliveryRatesContainer.querySelectorAll('.flex').forEach(rateDiv => {
                const kms = parseFloat(rateDiv.querySelector('.delivery-kms').value);
                const amount = parseFloat(rateDiv.querySelector('.delivery-amount').value);
                if (!isNaN(kms) && !isNaN(amount)) {
                    deliveryRates.push({ kms, amount });
                }
            });

            const settingsData = {
                shopName,
                shopLocation: { latitude: shopLatitude, longitude: shopLongitude },
                deliveryRates
            };

            settingsMessage.textContent = 'Saving settings...';
            settingsMessage.className = 'mt-2 text-sm text-yellow-500';
            settingsForm.querySelector('button[type="submit"]').disabled = true;

            try {
                const response = await fetch('/api/admin/settings', {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(settingsData)
                });

                const result = await response.json();
                if (response.ok) {
                    settingsMessage.textContent = 'Settings saved successfully!';
                    settingsMessage.className = 'mt-2 text-sm text-green-500';
                } else {
                    settingsMessage.textContent = `Error saving settings: ${result.message || response.statusText}`;
                    settingsMessage.className = 'mt-2 text-sm text-red-500';
                }
            } catch (error) {
                console.error('Error saving settings:', error);
                settingsMessage.textContent = `Network error: ${error.message}`;
                settingsMessage.className = 'mt-2 text-sm text-red-500';
            } finally {
                settingsForm.querySelector('button[type="submit"]').disabled = false;
            }
        });

        // --- Customer Tab Functions ---
        async function fetchCustomers() {
            customersList.innerHTML = '<p class="text-gray-400 text-center">Loading customer data...</p>';
            try {
                const response = await fetch('/api/admin/customers');
                if (!response.ok) {
                    if (response.status === 401) {
                        window.location.href = '/admin/login';
                        return;
                    }
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                const customers = await response.json();
                displayCustomers(customers);
            } catch (error) {
                console.error('Error fetching customers:', error);
                customersList.innerHTML = `<p class="text-red-500 text-center">Failed to load customer data: ${error.message}</p>`;
            }
        }

        function displayCustomers(customers) {
            customersList.innerHTML = '';
            if (customers.length === 0) {
                customersList.innerHTML = '<p class="text-gray-400 text-center">No customer data found.</p>';
                return;
            }

            const table = document.createElement('table');
            table.className = 'min-w-full bg-gray-700 rounded-lg overflow-hidden';
            table.innerHTML = `
                <thead>
                    <tr class="bg-gray-600 text-left">
                        <th class="py-2 px-4">Customer Name</th>
                        <th class="py-2 px-4">Phone</th>
                        <th class="py-2 px-4">Last Known Location</th>
                        <th class="py-2 px-4">Distance from Shop (km)</th>
                    </tr>
                </thead>
                <tbody id="customers-table-body"></tbody>
            `;
            customersList.appendChild(table);
            const tbody = document.getElementById('customers-table-body');

            customers.forEach(customer => {
                const row = tbody.insertRow();
                row.className = 'border-b border-gray-600 hover:bg-gray-700';

                let locationText = 'N/A';
                let distanceFromShop = 'N/A';

                if (customer.lastKnownLocation && customer.lastKnownLocation.latitude && customer.lastKnownLocation.longitude) {
                    locationText = `Lat: ${customer.lastKnownLocation.latitude.toFixed(4)}, Lon: ${customer.lastKnownLocation.longitude.toFixed(4)}`;
                    if (customer.shopLocation && customer.shopLocation.latitude && customer.shopLocation.longitude) {
                        const dist = haversineDistance(
                            customer.shopLocation.latitude,
                            customer.shopLocation.longitude,
                            customer.lastKnownLocation.latitude,
                            customer.lastKnownLocation.longitude
                        );
                        distanceFromShop = dist.toFixed(2);
                    }
                }

                row.innerHTML = `
                    <td class="py-2 px-4">${customer.customerName || 'N/A'}</td>
                    <td class="py-2 px-4">${customer.customerPhone}</td>
                    <td class="py-2 px-4">${locationText}</td>
                    <td class="py-2 px-4">${distanceFromShop}</td>
                `;
            });
        }

        // Haversine distance function (duplicated from menu_panel for self-containment)
        function haversineDistance(lat1, lon1, lat2, lon2) {
            const R = 6371; // Radius of Earth in kilometers
            const dLat = (lat2 - lat1) * Math.PI / 180;
            const dLon = (lon2 - lon1) * Math.PI / 180;
            const a =
                Math.sin(dLat / 2) * Math.sin(dLat / 2) +
                Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
                Math.sin(dLon / 2) * Math.sin(dLon / 2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
            return R * c; // Distance in km
        }

        // Initial fetch for the default tab
        switchTab(currentActiveTab);

        // Periodically fetch bot status to keep the dashboard updated
        setInterval(() => {
            fetch('/api/admin/bot-status')
                .then(response => {
                    if (response.status === 401) {
                        // If session expired, redirect to login
                        window.location.href = '/admin/login';
                        return Promise.reject('Unauthorized');
                    }
                    return response.json();
                })
                .then(data => {
                    // Status update is handled by the socket.io listener now
                    // This fetch is primarily for initial load or if socket.io fails
                    // The socket.io 'status' event will trigger the display logic
                })
                .catch(error => {
                    console.error('Error fetching bot status:', error);
                    // Handle network errors or server issues
                    botStatusSpan.textContent = 'Error: Could not connect to server.';
                    alertMessage.textContent = 'Could not connect to bot server. Please check server logs.';
                    botStatusAlert.classList.remove('alert-yellow', 'alert-green');
                    botStatusAlert.classList.add('alert-red');
                    requestQrBtn.classList.remove('hidden');
                });
        }, 5000); // Poll every 5 seconds
    </script>
</body>
</html>

