<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Food Business Admin Dashboard</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Google Fonts - Inter -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <!-- Lucide Icons CDN (for icons) -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <!-- Socket.IO Client CDN -->
    <script src="https://cdn.socket.io/4.0.0/socket.io.min.js"></script>

    <style>
        body {
            font-family: 'Inter', sans-serif;
            transition: background-color 0.3s ease, color 0.3s ease;
        }

        /* Light Mode Defaults (New Theme) */
        body {
            background-color: #F0F4F8; /* Light Blue-Gray */
            color: #2C3E50; /* Dark Navy Blue */
        }
        .bg-card { background-color: #FFFFFF; } /* White for cards */
        .text-primary { color: #2C3E50; }
        .text-secondary { color: #7F8C8D; }
        .border-default { border-color: #DCE4EC; }
        .shadow-default { box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06); }

        /* Dark Mode Overrides (New Theme) */
        html.dark body {
            background-color: #1F2937; /* Dark Grey-Blue */
            color: #F3F4F6; /* Off-white */
        }
        html.dark .bg-card { background-color: #374151; } /* Medium Dark Grey-Blue for cards */
        html.dark .text-primary { color: #F3F4F6; }
        html.dark .text-secondary { color: #9CA3AF; }
        html.dark .border-default { border-color: #4B5563; }
        html.dark .shadow-default { box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.3), 0 2px 4px -1px rgba(0, 0, 0, 0.2); }

        /* General Styling for all modes */
        .bg-accent-primary { background-color: #FF7F50; } /* Coral */
        .hover\:bg-accent-primary-dark:hover { background-color: #E56A3B; } /* Darker Coral */
        .text-accent-primary { color: #FF7F50; }
        .text-accent-secondary { color: #2ECC71; } /* Emerald Green */
        .text-status-pending { color: #F39C12; } /* Orange */
        .bg-status-pending { background-color: #F39C12; }
        .text-status-confirmed { color: #3498DB; } /* Blue */
        .bg-status-confirmed { background-color: #3498DB; }
        .text-status-preparing { color: #9B59B6; } /* Purple */
        .bg-status-preparing { background-color: #9B59B6; }
        .text-status-out-for-delivery { color: #E67E22; } /* Dark Orange */
        .bg-status-out-for-delivery { background-color: #E67E22; }
        .text-status-delivered { color: #2ECC71; } /* Emerald Green */
        .bg-status-delivered { background-color: #2ECC71; }
        .text-status-cancelled { color: #E74C3C; } /* Red */
        .bg-status-cancelled { background-color: #E74C3C; }


        /* Input field styling */
        input:not([type="checkbox"]), select, textarea {
            @apply p-3 rounded-md border border-default focus:outline-none focus:ring-2 focus:ring-accent-primary transition-colors duration-200;
            @apply bg-white text-primary placeholder-secondary; /* Light mode defaults */
        }
        html.dark input:not([type="checkbox"]), html.dark select, html.dark textarea {
            @apply bg-gray-700 border-gray-600 text-gray-100 placeholder-gray-400; /* Dark mode overrides */
        }

        /* Custom checkbox styling for vibrant accent */
        .form-checkbox:checked {
            background-color: #FF7F50; /* Coral */
            border-color: #FF7F50;
        }
        .form-checkbox:focus {
            outline: none;
            box-shadow: 0 0 0 3px rgba(255, 127, 80, 0.5); /* Coral shadow */
        }

        /* Custom scrollbar */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #DCE4EC; border-radius: 10px; }
        ::-webkit-scrollbar-thumb { background: #FF7F50; border-radius: 10px; }
        ::-webkit-scrollbar-thumb:hover { background: #E56A3B; }
        html.dark ::-webkit-scrollbar-track { background: #4B5563; }
        html.dark ::-webkit-scrollbar-thumb { background: #FF7F50; }

        /* Ensure Lucide icons are styled correctly */
        [data-lucide] {
            stroke-width: 2;
        }
    </style>
</head>
<body class="min-h-screen flex flex-col lg:flex-row bg-body text-primary">

    <!-- Login Panel -->
    <div id="login-panel" class="fixed inset-0 bg-body flex items-center justify-center z-50 p-4">
        <div class="bg-card p-8 rounded-lg shadow-default w-full max-w-md text-primary">
            <h2 class="text-3xl font-bold text-center text-accent-primary mb-6">Admin Login</h2>
            <form id="login-form" class="space-y-4">
                <div>
                    <label for="login-username" class="block text-sm font-medium text-primary mb-1">Username</label>
                    <input type="text" id="login-username" name="username" required class="w-full">
                </div>
                <div>
                    <label for="login-password" class="block text-sm font-medium text-primary mb-1">Password</label>
                    <input type="password" id="login-password" name="password" required class="w-full">
                </div>
                <button type="submit" class="w-full bg-accent-primary text-white font-semibold py-3 rounded-md hover:bg-accent-primary-dark transition-colors shadow-default">
                    Login
                </button>
            </form>
            <p id="login-error-message" class="text-red-500 text-center mt-4 hidden"></p>
        </div>
    </div>

    <!-- Mobile Sidebar Toggle -->
    <button id="mobile-sidebar-toggle" class="lg:hidden fixed top-4 left-4 z-40 p-2 rounded-md bg-card text-primary hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors shadow-default">
        <i data-lucide="menu" class="w-6 h-6"></i>
    </button>

    <!-- Sidebar -->
    <aside id="sidebar" class="fixed inset-y-0 left-0 z-30 w-64 bg-card shadow-lg transform -translate-x-full lg:translate-x-0 lg:relative lg:flex-shrink-0 transition-transform duration-300 ease-in-out">
        <div class="p-6 text-2xl font-bold text-accent-primary border-b border-default">
            FoodBiz Admin
        </div>
        <nav class="mt-6">
            <ul>
                <li>
                    <button data-view="dashboard" class="nav-item flex items-center w-full px-6 py-3 text-lg font-medium rounded-r-full transition-colors duration-200 bg-accent-primary text-white shadow-default">
                        <i data-lucide="home" class="w-6 h-6 mr-4"></i>
                        Dashboard
                    </button>
                </li>
                <li>
                    <button data-view="qr-scan" class="nav-item flex items-center w-full px-6 py-3 text-lg font-medium rounded-r-full transition-colors duration-200 text-primary hover:bg-gray-100 dark:hover:bg-gray-700">
                        <i data-lucide="qr-code" class="w-6 h-6 mr-4"></i>
                        QR Scan
                    </button>
                </li>
                <li>
                    <button data-view="menu" class="nav-item flex items-center w-full px-6 py-3 text-lg font-medium rounded-r-full transition-colors duration-200 text-primary hover:bg-gray-100 dark:hover:bg-gray-700">
                        <i data-lucide="utensils" class="w-6 h-6 mr-4"></i>
                        Menu Management
                    </button>
                </li>
                <li>
                    <button data-view="orders" class="nav-item flex items-center w-full px-6 py-3 text-lg font-medium rounded-r-full transition-colors duration-200 text-primary hover:bg-gray-100 dark:hover:bg-gray-700">
                        <i data-lucide="clipboard-list" class="w-6 h-6 mr-4"></i>
                        Order Management
                    </button>
                </li>
            </ul>
        </nav>
        <div class="absolute bottom-6 w-full px-6">
            <button id="logout-button" class="w-full bg-red-500 text-white font-semibold py-3 rounded-md hover:bg-red-600 transition-colors shadow-default flex items-center justify-center">
                <i data-lucide="log-out" class="w-5 h-5 mr-2"></i> Logout
            </button>
            <button id="theme-toggle" class="w-full mt-4 bg-gray-200 dark:bg-gray-700 text-primary dark:text-gray-100 font-semibold py-3 rounded-md hover:bg-gray-300 dark:hover:bg-gray-600 transition-colors shadow-default flex items-center justify-center">
                <i id="sun-icon" data-lucide="sun" class="w-5 h-5 mr-2 hidden"></i>
                <i id="moon-icon" data-lucide="moon" class="w-5 h-5 mr-2"></i>
                Toggle Theme
            </button>
        </div>
    </aside>

    <!-- Main Content Area -->
    <main id="main-content" class="flex-1 p-6 lg:ml-64 overflow-auto">
        <div class="max-w-7xl mx-auto py-6 sm:px-6 lg:px-8">
            <!-- Dynamic content will be loaded here -->
            <div id="dashboard-panel" class="panel bg-card p-6 rounded-lg shadow-default">
                <h1 class="text-3xl font-bold text-accent-primary mb-6">Dashboard Overview</h1>
                <p class="text-secondary mb-8">
                    Welcome to your Food Business Admin Dashboard! Use the navigation on the left to manage your WhatsApp bots, menu, and orders.
                </p>
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                    <div class="p-6 bg-gray-100 dark:bg-gray-700 rounded-lg shadow-default">
                        <h2 class="text-xl font-semibold text-accent-primary mb-2">Quick Access</h2>
                        <ul class="space-y-2">
                            <li>
                                <button data-view="qr-scan" class="nav-item text-blue-500 hover:text-blue-600 flex items-center">
                                    <i data-lucide="qr-code" class="w-5 h-5 mr-2"></i> Manage WhatsApp Bots
                                </button>
                            </li>
                            <li>
                                <button data-view="menu" class="nav-item text-blue-500 hover:text-blue-600 flex items-center">
                                    <i data-lucide="utensils" class="w-5 h-5 mr-2"></i> Manage Menu
                                </button>
                            </li>
                            <li>
                                <button data-view="orders" class="nav-item text-blue-500 hover:text-blue-600 flex items-center">
                                    <i data-lucide="clipboard-list" class="w-5 h-5 mr-2"></i> View Orders
                                </button>
                            </li>
                        </ul>
                    </div>
                    <div class="p-6 bg-gray-100 dark:bg-gray-700 rounded-lg shadow-default">
                        <h2 class="text-xl font-semibold text-accent-primary mb-2">Recent Activity</h2>
                        <p class="text-secondary text-sm">
                            * New Order #12345 (Pending) - 5 mins ago<br/>
                            * Bot 1 Connected - 1 hour ago<br/>
                            * Menu Item "Spicy Noodles" updated - Yesterday
                        </p>
                        <p class="text-gray-500 text-xs mt-4">
                            (This section would dynamically show recent activities from your backend logs/data.)
                        </p>
                    </div>
                    <div class="p-6 bg-gray-100 dark:bg-gray-700 rounded-lg shadow-default">
                        <h2 class="text-xl font-semibold text-accent-primary mb-2">Key Metrics</h2>
                        <p class="text-secondary text-sm">
                            * Today's Orders: <span class="font-bold text-accent-primary">5</span><br/>
                            * Total Revenue (Today): <span class="font-bold text-accent-secondary">Rs. 1,250.00</span><br/>
                            * Active Bots: <span class="font-bold text-blue-500">2/2</span>
                        </p>
                        <p class="text-gray-500 text-xs mt-4">
                            (This section would dynamically show real-time or daily statistics.)
                        </p>
                    </div>
                </div>
            </div>

            <div id="qr-scan-panel" class="panel hidden bg-card p-6 rounded-lg shadow-default">
                <h1 class="text-3xl font-bold text-accent-primary mb-8">WhatsApp QR Scan</h1>
                <p class="text-secondary mb-6">Scan the QR codes below with your WhatsApp app to connect your bots. The QR codes are also displayed in your server terminal.</p>
                <div id="whatsapp-qr-content" class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <!-- WhatsApp bot QR and status will be rendered here -->
                    <div class="bg-gray-100 dark:bg-gray-700 p-6 rounded-lg shadow-default flex flex-col items-center">
                        <h2 class="text-xl font-semibold mb-4 text-accent-primary">WhatsApp Bot 1</h2>
                        <div class="mb-4 text-lg flex items-center text-primary">
                            Status: <span id="bot1-status-text" class="ml-2 font-medium text-status-pending">Loading...</span>
                            <i id="bot1-status-icon" data-lucide="alert-circle" class="w-5 h-5 ml-2 text-status-pending"></i>
                        </div>
                        <div id="bot1-qr-container" class="w-48 h-48 flex items-center justify-center bg-gray-200 dark:bg-gray-600 rounded-md text-secondary text-sm">
                            Waiting for QR Code...
                        </div>
                        <p class="mt-4 text-sm text-secondary text-center">
                            Scan the QR code with your WhatsApp app to connect Bot 1.
                        </p>
                    </div>
                    <div class="bg-gray-100 dark:bg-gray-700 p-6 rounded-lg shadow-default flex flex-col items-center">
                        <h2 class="text-xl font-semibold mb-4 text-accent-primary">WhatsApp Bot 2</h2>
                        <div class="mb-4 text-lg flex items-center text-primary">
                            Status: <span id="bot2-status-text" class="ml-2 font-medium text-status-pending">Loading...</span>
                            <i id="bot2-status-icon" data-lucide="alert-circle" class="w-5 h-5 ml-2 text-status-pending"></i>
                        </div>
                        <div id="bot2-qr-container" class="w-48 h-48 flex items-center justify-center bg-gray-200 dark:bg-gray-600 rounded-md text-secondary text-sm">
                            Waiting for QR Code...
                        </div>
                        <p class="mt-4 text-sm text-secondary text-center">
                            Scan the QR code with your WhatsApp app to connect Bot 2.
                        </p>
                    </div>
                </div>
            </div>

            <div id="menu-panel" class="panel hidden bg-card p-6 rounded-lg shadow-default">
                <h1 class="text-3xl font-bold text-accent-primary mb-8">Menu Management</h1>
                <div class="flex flex-col md:flex-row justify-between items-center mb-4">
                    <input type="text" id="menu-search-input" placeholder="Search menu items..." class="w-full md:w-1/3">
                    <div class="flex flex-col md:flex-row gap-4 w-full md:w-2/3 md:justify-end">
                        <select id="menu-category-filter">
                            <option value="All">All Categories</option>
                        </select>
                        <select id="menu-sort-order">
                            <option value="name-asc">Name (A-Z)</option>
                            <option value="name-desc">Name (Z-A)</option>
                            <option value="price-asc">Price (Low to High)</option>
                            <option value="price-desc">Price (High to Low)</option>
                        </select>
                        <button id="add-menu-item-btn" class="bg-accent-primary hover:bg-accent-primary-dark text-white font-semibold py-3 px-5 rounded-md flex items-center justify-center transition-colors shadow-default">
                            <i data-lucide="plus" class="w-5 h-5 mr-2"></i>
                            Add New Item
                        </button>
                    </div>
                </div>
                <div id="menu-items-table-container" class="overflow-x-auto rounded-lg border border-default">
                    <table class="min-w-full divide-y divide-default">
                        <thead class="bg-gray-100 dark:bg-gray-700">
                            <tr>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-secondary uppercase tracking-wider">Image</th>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-secondary uppercase tracking-wider">Name</th>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-secondary uppercase tracking-wider">Category</th>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-secondary uppercase tracking-wider">Price</th>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-secondary uppercase tracking-wider">Available</th>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-secondary uppercase tracking-wider">New</th>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-secondary uppercase tracking-wider">Trending</th>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-secondary uppercase tracking-wider">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="menu-items-table-body" class="bg-card divide-y divide-default">
                            <!-- Menu items will be rendered here -->
                            <tr><td colspan="8" class="text-center text-secondary py-8">Loading menu items...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <div id="orders-panel" class="panel hidden bg-card p-6 rounded-lg shadow-default">
                <h1 class="text-3xl font-bold text-accent-primary mb-8">Order Management</h1>
                <div class="flex flex-col md:flex-row justify-between items-center mb-4 gap-4">
                    <input type="text" id="order-search-input" placeholder="Search orders by customer or ID..." class="w-full md:w-1/2">
                    <div class="flex flex-col md:flex-row gap-4 w-full md:w-1/2 md:justify-end">
                        <select id="order-status-filter">
                            <option value="All">All</option>
                            <option value="Pending">Pending</option>
                            <option value="Confirmed">Confirmed</option>
                            <option value="Preparing">Preparing</option>
                            <option value="Out for Delivery">Out for Delivery</option>
                            <option value="Delivered">Delivered</option>
                            <option value="Cancelled">Cancelled</option>
                        </select>
                        <button id="refresh-orders-btn" class="bg-gray-200 dark:bg-gray-700 text-primary dark:text-gray-100 font-semibold py-3 px-5 rounded-md flex items-center justify-center hover:bg-gray-300 dark:hover:bg-gray-600 transition-colors shadow-default">
                            <i data-lucide="refresh-cw" class="w-5 h-5 mr-2"></i>
                            Refresh Orders
                        </button>
                    </div>
                </div>
                <div id="orders-table-container" class="overflow-x-auto rounded-lg border border-default">
                    <table class="min-w-full divide-y divide-default">
                        <thead class="bg-gray-100 dark:bg-gray-700">
                            <tr>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-secondary uppercase tracking-wider">Order ID</th>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-secondary uppercase tracking-wider">Customer</th>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-secondary uppercase tracking-wider">Items</th>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-secondary uppercase tracking-wider">Total</th>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-secondary uppercase tracking-wider">Status</th>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-secondary uppercase tracking-wider">Date</th>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-secondary uppercase tracking-wider">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="orders-table-body" class="bg-card divide-y divide-default">
                            <!-- Orders will be rendered here -->
                            <tr><td colspan="7" class="text-center text-secondary py-8">Loading orders...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </main>

    <!-- Menu Item Add/Edit Modal -->
    <div id="menu-item-modal" class="fixed inset-0 bg-black bg-opacity-75 hidden items-center justify-center z-50 p-4">
        <div class="bg-card p-8 rounded-lg shadow-xl w-full max-w-md relative text-primary">
            <h2 id="menu-modal-title" class="text-2xl font-bold text-accent-primary mb-6">Add New Menu Item</h2>
            <button id="close-menu-item-modal" class="absolute top-4 right-4 text-secondary hover:text-primary transition-colors">
                <i data-lucide="x-circle" class="w-6 h-6"></i>
            </button>

            <form id="menu-item-form" class="space-y-4">
                <input type="hidden" id="menu-item-id">
                <div>
                    <label for="menu-name" class="block text-sm font-medium text-primary mb-1">Name</label>
                    <input type="text" id="menu-name" name="name" class="w-full" required>
                </div>
                <div>
                    <label for="menu-description" class="block text-sm font-medium text-primary mb-1">Description</label>
                    <textarea id="menu-description" name="description" rows="3" class="w-full"></textarea>
                </div>
                <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                    <div>
                        <label for="menu-price" class="block text-sm font-medium text-primary mb-1">Price (Rs.)</label>
                        <input type="number" id="menu-price" name="price" step="0.01" class="w-full" required>
                    </div>
                    <div>
                        <label for="menu-category" class="block text-sm font-medium text-primary mb-1">Category</label>
                        <input type="text" id="menu-category" name="category" class="w-full" required>
                    </div>
                </div>
                <div>
                    <label for="menu-image-url" class="block text-sm font-medium text-primary mb-1">Image URL</label>
                    <input type="url" id="menu-image-url" name="imageUrl" class="w-full">
                    <img id="menu-image-preview" src="" alt="Preview" class="mt-2 w-24 h-24 object-cover rounded-md hidden" onerror="this.onerror=null;this.src='https://placehold.co/96x96/E0E0E0/333333?text=No+Preview';">
                </div>

                <div class="flex items-center space-x-4">
                    <label class="flex items-center text-primary">
                        <input type="checkbox" id="menu-is-available" name="isAvailable" class="form-checkbox h-5 w-5 rounded">
                        <span class="ml-2 text-sm">Available</span>
                    </label>
                    <label class="flex items-center text-primary">
                        <input type="checkbox" id="menu-is-new" name="isNew" class="form-checkbox h-5 w-5 rounded">
                        <span class="ml-2 text-sm">New Item</span>
                    </label>
                    <label class="flex items-center text-primary">
                        <input type="checkbox" id="menu-is-trending" name="isTrending" class="form-checkbox h-5 w-5 rounded">
                        <span class="ml-2 text-sm">Trending</span>
                    </label>
                </div>

                <div class="flex justify-end space-x-3 mt-6">
                    <button type="button" id="cancel-menu-item-btn" class="px-5 py-2 rounded-md text-secondary border border-default hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors">
                        Cancel
                    </button>
                    <button type="submit" id="save-menu-item-btn" class="bg-accent-primary hover:bg-accent-primary-dark text-white font-semibold px-5 py-2 rounded-md transition-colors shadow-default">
                        Add Item
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Order Details Modal -->
    <div id="order-details-modal" class="fixed inset-0 bg-black bg-opacity-75 hidden items-center justify-center z-50 p-4">
        <div class="bg-card p-8 rounded-lg shadow-xl w-full max-w-2xl relative text-primary">
            <h2 id="order-modal-title" class="text-2xl font-bold text-accent-primary mb-6">Order Details - ID: <span id="order-details-id"></span></h2>
            <button id="close-order-details-modal" class="absolute top-4 right-4 text-secondary hover:text-primary transition-colors">
                <i data-lucide="x-circle" class="w-6 h-6"></i>
            </button>

            <div class="space-y-6">
                <!-- Customer Info -->
                <div class="bg-gray-100 dark:bg-gray-700 p-5 rounded-lg">
                    <h3 class="text-lg font-semibold text-accent-primary mb-3">Customer Information</h3>
                    <p class="text-primary">
                        <span class="font-medium">Name:</span> <span id="order-customer-name"></span>
                    </p>
                    <p class="text-primary">
                        <span class="font-medium">Phone:</span>
                        <a id="order-customer-phone" href="#" class="text-blue-500 hover:underline"></a>
                    </p>
                </div>

                <!-- Order Summary -->
                <div class="bg-gray-100 dark:bg-gray-700 p-5 rounded-lg">
                    <h3 class="text-lg font-semibold text-accent-primary mb-3">Order Summary</h3>
                    <ul id="order-details-items" class="divide-y divide-default">
                        <!-- Order items will be populated here -->
                    </ul>
                    <div class="mt-4 pt-4 border-t border-default text-right">
                        <p class="text-xl font-bold text-primary">
                            Total Amount: Rs. <span id="order-details-total"></span>
                        </p>
                    </div>
                </div>

                <!-- Status & Actions -->
                <div class="bg-gray-100 dark:bg-gray-700 p-5 rounded-lg flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4">
                    <div>
                        <h3 class="text-lg font-semibold text-accent-primary mb-2">Order Status</h3>
                        <span id="order-details-status-badge" class="px-4 py-2 inline-flex text-sm leading-5 font-semibold rounded-full"></span>
                        <p class="text-secondary text-sm mt-1">
                            Ordered on: <span id="order-details-date"></span>
                        </p>
                    </div>
                    <div class="flex flex-col sm:flex-row items-center gap-3">
                        <label for="order-status-select-modal" class="sr-only">Change Status</label>
                        <select id="order-status-select-modal" class="p-3 rounded-md bg-gray-200 dark:bg-gray-600 border border-default text-primary dark:text-gray-100 focus:outline-none focus:ring-2 focus:ring-accent-primary">
                            <option value="Pending">Pending</option>
                            <option value="Confirmed">Confirmed</option>
                            <option value="Preparing">Preparing</option>
                            <option value="Out for Delivery">Out for Delivery</option>
                            <option value="Delivered">Delivered</option>
                            <option value="Cancelled">Cancelled</option>
                        </select>
                    </div>
                </div>
            </div>

            <div class="flex justify-end mt-6">
                <button type="button" id="close-order-details-btn" class="px-6 py-3 rounded-md bg-gray-200 dark:bg-gray-700 text-primary dark:text-gray-100 hover:bg-gray-300 dark:hover:bg-gray-600 font-semibold transition-colors shadow-default">
                    Close
                </button>
            </div>
        </div>
    </div>

    <!-- Toast Container -->
    <div id="toast-container" class="fixed bottom-4 right-4 z-50 space-y-2"></div>

    <script>
        const API_BASE_URL = ''; // Use empty string for relative paths if served from same origin

        // --- DOM Elements ---
        const loginPanel = document.getElementById('login-panel');
        const loginForm = document.getElementById('login-form');
        const loginErrorMessage = document.getElementById('login-error-message');
        const mobileSidebarToggle = document.getElementById('mobile-sidebar-toggle');
        const sidebar = document.getElementById('sidebar');
        const navItems = document.querySelectorAll('.nav-item');
        const panels = document.querySelectorAll('.panel');
        const mainContent = document.getElementById('main-content');
        const logoutButton = document.getElementById('logout-button');
        const themeToggle = document.getElementById('theme-toggle');
        const sunIcon = document.getElementById('sun-icon');
        const moonIcon = document.getElementById('moon-icon');
        const toastContainer = document.getElementById('toast-container');

        // WhatsApp QR Scan Panel Elements
        const qrScanPanel = document.getElementById('qr-scan-panel');
        const bot1StatusText = document.getElementById('bot1-status-text');
        const bot1StatusIcon = document.getElementById('bot1-status-icon');
        const bot1QrContainer = document.getElementById('bot1-qr-container');
        const bot2StatusText = document.getElementById('bot2-status-text');
        const bot2StatusIcon = document.getElementById('bot2-status-icon');
        const bot2QrContainer = document.getElementById('bot2-qr-container');

        // Menu Panel Elements
        const menuPanel = document.getElementById('menu-panel');
        const menuSearchInput = document.getElementById('menu-search-input');
        const menuCategoryFilter = document.getElementById('menu-category-filter');
        const menuSortOrder = document.getElementById('menu-sort-order');
        const addMenuItemBtn = document.getElementById('add-menu-item-btn');
        const menuItemsTableBody = document.getElementById('menu-items-table-body');
        const menuItemModal = document.getElementById('menu-item-modal');
        const closeMenuItemModal = document.getElementById('close-menu-item-modal');
        const cancelMenuItemBtn = document.getElementById('cancel-menu-item-btn');
        const menuItemForm = document.getElementById('menu-item-form');
        const menuModalTitle = document.getElementById('menu-modal-title');
        const menuItemIdInput = document.getElementById('menu-item-id');
        const menuNameInput = document.getElementById('menu-name');
        const menuDescriptionInput = document.getElementById('menu-description');
        const menuPriceInput = document.getElementById('menu-price');
        const menuImageUrlInput = document.getElementById('menu-image-url');
        const menuImagePreview = document.getElementById('menu-image-preview');
        const menuCategoryInput = document.getElementById('menu-category');
        const menuIsAvailableInput = document.getElementById('menu-is-available');
        const menuIsNewInput = document.getElementById('menu-is-new');
        const menuIsTrendingInput = document.getElementById('menu-is-trending');
        const saveMenuItemBtn = document.getElementById('save-menu-item-btn');

        // Orders Panel Elements
        const ordersPanel = document.getElementById('orders-panel');
        const orderSearchInput = document.getElementById('order-search-input');
        const orderStatusFilter = document.getElementById('order-status-filter');
        const refreshOrdersBtn = document.getElementById('refresh-orders-btn');
        const ordersTableBody = document.getElementById('orders-table-body');
        const orderDetailsModal = document.getElementById('order-details-modal');
        const closeOrderDetailsModal = document.getElementById('close-order-details-modal');
        const closeOrderDetailsBtn = document.getElementById('close-order-details-btn');
        const orderDetailsId = document.getElementById('order-details-id');
        const orderCustomerName = document.getElementById('order-customer-name');
        const orderCustomerPhone = document.getElementById('order-customer-phone');
        const orderDetailsItems = document.getElementById('order-details-items');
        const orderDetailsTotal = document.getElementById('order-details-total');
        const orderDetailsStatusBadge = document.getElementById('order-details-status-badge');
        const orderDetailsDate = document.getElementById('order-details-date');
        const orderStatusSelectModal = document.getElementById('order-status-select-modal');

        let allMenuItemsData = [];
        let allOrdersData = [];
        let currentEditingMenuItem = null;
        let currentViewingOrder = null;
        let whatsappClient1Status = { image: null, status: 'Initializing...', isReady: false };
        let whatsappClient2Status = { image: null, status: 'Initializing...', isReady: false };


        // --- Utility Functions ---

        // Toast Notification
        function showToast(message, type = 'info') {
            const toast = document.createElement('div');
            let bgColor = 'bg-gray-800';
            let iconHtml = '';

            if (type === 'success') {
                bgColor = 'bg-accent-secondary'; /* Emerald Green */
                iconHtml = '<i data-lucide="check-circle" class="w-5 h-5 mr-2"></i>';
            } else if (type === 'error') {
                bgColor = 'bg-red-500';
                iconHtml = '<i data-lucide="alert-circle" class="w-5 h-5 mr-2"></i>';
            } else { // info
                bgColor = 'bg-blue-500';
                iconHtml = '<i data-lucide="info" class="w-5 h-5 mr-2"></i>';
            }

            toast.className = `p-4 rounded-lg shadow-lg flex items-center text-white z-50 transition-all duration-300 ease-in-out transform translate-y-full opacity-0 ${bgColor}`;
            toast.innerHTML = `${iconHtml}<span>${message}</span>`;
            toastContainer.appendChild(toast);

            // Render lucide icons within the toast
            lucide.createIcons();

            // Animate in
            setTimeout(() => {
                toast.classList.remove('translate-y-full', 'opacity-0');
                toast.classList.add('translate-y-0', 'opacity-100');
            }, 100);

            // Animate out and remove
            setTimeout(() => {
                toast.classList.remove('translate-y-0', 'opacity-100');
                toast.classList.add('translate-y-full', 'opacity-0');
                toast.addEventListener('transitionend', () => toast.remove());
            }, 3000);
        }

        // Loading Spinner HTML
        const loadingSpinnerHtml = `
            <div class="flex justify-center items-center py-8">
                <i data-lucide="loader-2" class="animate-spin text-accent-primary w-8 h-8"></i>
            </div>
        `;

        // Get Status Color for Orders
        function getStatusColor(status) {
            switch (status) {
                case 'Pending': return 'bg-status-pending text-white';
                case 'Confirmed': return 'bg-status-confirmed text-white';
                case 'Preparing': return 'bg-status-preparing text-white';
                case 'Out for Delivery': return 'bg-status-out-for-delivery text-white';
                case 'Delivered': return 'bg-status-delivered text-white';
                case 'Cancelled': return 'bg-status-cancelled text-white';
                default: return 'bg-gray-500 text-white';
            }
        }

        // --- Dark Mode Logic ---
        function applyTheme(theme) {
            if (theme === 'dark') {
                document.documentElement.classList.add('dark');
                sunIcon.classList.remove('hidden');
                moonIcon.classList.add('hidden');
            } else {
                document.documentElement.classList.remove('dark');
                sunIcon.classList.add('hidden');
                moonIcon.classList.remove('hidden');
            }
            // After applying theme, re-create Lucide icons to ensure they pick up new colors
            lucide.createIcons();
        }

        // Check for saved theme preference on load
        const savedTheme = localStorage.getItem('dashboard-theme');
        if (savedTheme) {
            applyTheme(savedTheme);
        } else if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
            applyTheme('dark'); // Default to system preference
        } else {
            applyTheme('light'); // Default to light
        }

        // --- Authentication Logic ---
        function checkAuth() {
            const token = localStorage.getItem('jwtToken');
            if (token) {
                loginPanel.classList.add('hidden');
                loginPanel.classList.remove('flex');
                mainContent.classList.remove('hidden'); // Show main content
                sidebar.classList.remove('hidden'); // Show sidebar
                // Initialize data for panels
                fetchInitialWhatsAppStatus();
                fetchMenuItems();
                fetchOrders();
            } else {
                loginPanel.classList.remove('hidden');
                loginPanel.classList.add('flex');
                mainContent.classList.add('hidden'); // Hide main content
                sidebar.classList.add('hidden'); // Hide sidebar
            }
        }

        async function handleLogin(e) {
            e.preventDefault();
            const username = e.target.elements['login-username'].value;
            const password = e.target.elements['login-password'].value;
            loginErrorMessage.classList.add('hidden');

            try {
                const response = await fetch(`${API_BASE_URL}/api/auth/login`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ username, password })
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.message || 'Login failed.');
                }

                const data = await response.json();
                localStorage.setItem('jwtToken', data.token);
                showToast('Logged in successfully!', 'success');
                checkAuth(); // Re-check auth to show dashboard
            } catch (error) {
                loginErrorMessage.textContent = error.message;
                loginErrorMessage.classList.remove('hidden');
                showToast(`Login failed: ${error.message}`, 'error');
            }
        }

        function handleLogout() {
            localStorage.removeItem('jwtToken');
            showToast('Logged out successfully!', 'info');
            checkAuth(); // Re-check auth to show login panel
        }

        // --- API Helper with Auth Token ---
        async function authenticatedFetch(url, options = {}) {
            const token = localStorage.getItem('jwtToken');
            const headers = {
                ...options.headers,
                'Authorization': `Bearer ${token}`
            };
            return fetch(url, { ...options, headers });
        }


        // --- Navigation Logic ---
        function showPanel(panelId) {
            panels.forEach(panel => {
                panel.classList.add('hidden');
            });
            document.getElementById(panelId).classList.remove('hidden');

            // Update active state in sidebar
            navItems.forEach(item => {
                item.classList.remove('bg-accent-primary', 'text-white', 'shadow-default');
                item.classList.add('text-primary', 'hover:bg-gray-100', 'dark:hover:bg-gray-700');
            });
            const activeNavItem = document.querySelector(`.nav-item[data-view="${panelId.replace('-panel', '')}"]`);
            if (activeNavItem) {
                activeNavItem.classList.add('bg-accent-primary', 'text-white', 'shadow-default');
                activeNavItem.classList.remove('text-primary', 'hover:bg-gray-100', 'dark:hover:bg-gray-700');
            }

            // Close sidebar on mobile after selection
            if (window.innerWidth < 1024) { // Tailwind's 'lg' breakpoint is 1024px
                sidebar.classList.add('-translate-x-full');
                sidebar.classList.remove('translate-x-0');
            }
            lucide.createIcons(); // Re-render icons on panel switch
        }

        // --- WhatsApp QR Scan Panel Functions ---
        function updateWhatsAppPanel() {
            // Bot 1
            bot1StatusText.textContent = whatsappClient1Status.status;
            bot1StatusText.className = `ml-2 font-medium ${whatsappClient1Status.isReady ? 'text-accent-secondary' : 'text-status-pending'}`;
            bot1StatusIcon.setAttribute('data-lucide', whatsappClient1Status.isReady ? 'check-circle' : 'alert-circle');
            bot1StatusIcon.className = `w-5 h-5 ml-2 ${whatsappClient1Status.isReady ? 'text-accent-secondary' : 'text-status-pending'}`;

            if (whatsappClient1Status.image && !whatsappClient1Status.isReady) {
                bot1QrContainer.innerHTML = `<div class="bg-white dark:bg-gray-900 p-4 rounded-md"><img src="${whatsappClient1Status.image}" alt="QR Code 1" class="w-48 h-48 object-contain"></div>`;
            } else {
                bot1QrContainer.innerHTML = `<div class="w-48 h-48 flex items-center justify-center bg-gray-200 dark:bg-gray-600 rounded-md text-secondary text-sm">
                    ${whatsappClient1Status.isReady ? 'Bot 1 Connected' : 'Waiting for QR Code...'}
                </div>`;
            }

            // Bot 2
            bot2StatusText.textContent = whatsappClient2Status.status;
            bot2StatusText.className = `ml-2 font-medium ${whatsappClient2Status.isReady ? 'text-accent-secondary' : 'text-status-pending'}`;
            bot2StatusIcon.setAttribute('data-lucide', whatsappClient2Status.isReady ? 'check-circle' : 'alert-circle');
            bot2StatusIcon.className = `w-5 h-5 ml-2 ${whatsappClient2Status.isReady ? 'text-accent-secondary' : 'text-status-pending'}`;

            if (whatsappClient2Status.image && !whatsappClient2Status.isReady) {
                bot2QrContainer.innerHTML = `<div class="bg-white dark:bg-gray-900 p-4 rounded-md"><img src="${whatsappClient2Status.image}" alt="QR Code 2" class="w-48 h-48 object-contain"></div>`;
            } else {
                bot2QrContainer.innerHTML = `<div class="w-48 h-48 flex items-center justify-center bg-gray-200 dark:bg-gray-600 rounded-md text-secondary text-sm">
                    ${whatsappClient2Status.isReady ? 'Bot 2 Connected' : 'Waiting for QR Code...'}
                </div>`;
            }
            lucide.createIcons(); // Re-render Lucide icons after updating innerHTML
        }

        async function fetchInitialWhatsAppStatus() {
            try {
                const [res1, res2] = await Promise.all([
                    fetch(`${API_BASE_URL}/api/whatsapp/qr1`),
                    fetch(`${API_BASE_URL}/api/whatsapp/qr2`)
                ]);
                whatsappClient1Status = await res1.json();
                whatsappClient2Status = await res2.json();
                updateWhatsAppPanel();
            } catch (error) {
                console.error('Error fetching initial WhatsApp status:', error);
                showToast('Failed to fetch initial WhatsApp status.', 'error');
            }
        }

        // --- Menu Panel Functions ---
        async function fetchMenuItems() {
            menuItemsTableBody.innerHTML = `<tr><td colspan="8" class="text-center text-secondary py-8">${loadingSpinnerHtml}</td></tr>`;
            lucide.createIcons(); // Render spinner icon
            try {
                const response = await authenticatedFetch(`${API_BASE_URL}/api/menu`); // Use authenticatedFetch
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                allMenuItemsData = await response.json();
                populateMenuCategoriesFilter();
                displayFilteredMenuItems();
            } catch (error) {
                console.error('Error fetching menu items:', error);
                menuItemsTableBody.innerHTML = `<tr><td colspan="8" class="text-center text-red-500 py-8">Failed to load menu items.</td></tr>`;
                showToast('Failed to load menu items.', 'error');
            }
        }

        function populateMenuCategoriesFilter() {
            const categories = new Set(allMenuItemsData.map(item => item.category));
            menuCategoryFilter.innerHTML = '<option value="All">All Categories</option>';
            categories.forEach(category => {
                const option = document.createElement('option');
                option.value = category;
                option.textContent = category;
                menuCategoryFilter.appendChild(option);
            });
        }

        function displayFilteredMenuItems() {
            menuItemsTableBody.innerHTML = '';
            const searchTerm = menuSearchInput.value.toLowerCase();
            const selectedCategory = menuCategoryFilter.value;
            const sortOrder = menuSortOrder.value;

            let filteredAndSortedItems = allMenuItemsData.filter(item => {
                const matchesSearch = item.name.toLowerCase().includes(searchTerm) ||
                                      item.description.toLowerCase().includes(searchTerm);
                const matchesCategory = selectedCategory === 'All' || item.category === selectedCategory;
                return matchesSearch && matchesCategory;
            });

            filteredAndSortedItems.sort((a, b) => {
                if (sortOrder === 'name-asc') return a.name.localeCompare(b.name);
                if (sortOrder === 'name-desc') return b.name.localeCompare(a.name);
                if (sortOrder === 'price-asc') return a.price - b.price;
                if (sortOrder === 'price-desc') return b.price - a.price;
                return 0;
            });

            if (filteredAndSortedItems.length === 0) {
                menuItemsTableBody.innerHTML = `<tr><td colspan="8" class="text-center text-secondary py-8">No menu items found. Try adjusting your filters or add a new item!</td></tr>`;
                return;
            }

            filteredAndSortedItems.forEach(item => {
                const row = document.createElement('tr');
                row.className = 'hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors';
                row.innerHTML = `
                    <td class="px-6 py-4 whitespace-nowrap">
                        <img src="${item.imageUrl}" alt="${item.name}" class="w-16 h-16 rounded-md object-cover" onerror="this.onerror=null;this.src='https://placehold.co/64x64/E0E0E0/333333?text=No+Image';">
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-primary font-medium">${item.name}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-secondary">${item.category}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-primary">Rs. ${item.price.toFixed(2)}</td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <i data-lucide="${item.isAvailable ? 'check-circle' : 'x-circle'}" class="w-5 h-5 ${item.isAvailable ? 'text-accent-secondary' : 'text-red-500'}"></i>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <i data-lucide="${item.isNew ? 'check-circle' : 'x-circle'}" class="w-5 h-5 ${item.isNew ? 'text-blue-500' : 'text-secondary'}"></i>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <i data-lucide="${item.isTrending ? 'check-circle' : 'x-circle'}" class="w-5 h-5 ${item.isTrending ? 'text-purple-500' : 'text-secondary'}"></i>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
                        <button data-id="${item._id}" class="edit-menu-item-btn text-blue-500 hover:text-blue-600 mr-3 p-2 rounded-md hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors" title="Edit Item">
                            <i data-lucide="edit" class="w-5 h-5"></i>
                        </button>
                        <button data-id="${item._id}" class="delete-menu-item-btn text-red-500 hover:text-red-600 p-2 rounded-md hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors" title="Delete Item">
                            <i data-lucide="trash-2" class="w-5 h-5"></i>
                        </button>
                    </td>
                `;
                menuItemsTableBody.appendChild(row);
            });
            lucide.createIcons(); // Re-render Lucide icons after updating innerHTML

            // Attach event listeners to new "Edit" and "Delete" buttons
            document.querySelectorAll('.edit-menu-item-btn').forEach(btn => {
                btn.onclick = (e) => openEditMenuItemModal(e.currentTarget.dataset.id);
            });
            document.querySelectorAll('.delete-menu-item-btn').forEach(btn => {
                btn.onclick = (e) => deleteMenuItem(e.currentTarget.dataset.id);
            });
        }

        function openAddMenuItemModal() {
            currentEditingMenuItem = null;
            menuModalTitle.textContent = 'Add New Menu Item';
            saveMenuItemBtn.textContent = 'Add Item';
            menuItemIdInput.value = '';
            menuItemForm.reset(); // Clear form fields
            menuImagePreview.classList.add('hidden'); // Hide preview
            menuItemModal.classList.remove('hidden');
            menuItemModal.classList.add('flex');
        }

        function openEditMenuItemModal(id) {
            const item = allMenuItemsData.find(i => i._id === id);
            if (!item) {
                showToast('Menu item not found for editing.', 'error');
                return;
            }
            currentEditingMenuItem = item;
            menuModalTitle.textContent = 'Edit Menu Item';
            saveMenuItemBtn.textContent = 'Update Item';

            menuItemIdInput.value = item._id;
            menuNameInput.value = item.name;
            menuDescriptionInput.value = item.description || '';
            menuPriceInput.value = item.price;
            menuImageUrlInput.value = item.imageUrl || '';
            menuCategoryInput.value = item.category;
            menuIsAvailableInput.checked = item.isAvailable;
            menuIsNewInput.checked = item.isNew;
            menuIsTrendingInput.checked = item.isTrending;

            if (item.imageUrl) {
                menuImagePreview.src = item.imageUrl;
                menuImagePreview.classList.remove('hidden');
            } else {
                menuImagePreview.classList.add('hidden');
            }

            menuItemModal.classList.remove('hidden');
            menuItemModal.classList.add('flex');
        }

        async function saveMenuItem(e) {
            e.preventDefault();
            const id = menuItemIdInput.value;
            const itemData = {
                name: menuNameInput.value,
                description: menuDescriptionInput.value,
                price: parseFloat(menuPriceInput.value),
                imageUrl: menuImageUrlInput.value,
                category: menuCategoryInput.value,
                isAvailable: menuIsAvailableInput.checked,
                isNew: menuIsNewInput.checked,
                isTrending: menuIsTrendingInput.checked,
            };

            if (!itemData.name || !itemData.price || !itemData.category) {
                showToast('Name, Price, and Category are required.', 'error');
                return;
            }
            if (isNaN(itemData.price) || itemData.price <= 0) {
                showToast('Price must be a positive number.', 'error');
                return;
            }

            try {
                let response;
                if (id) {
                    response = await authenticatedFetch(`${API_BASE_URL}/api/menu/${id}`, {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(itemData),
                    });
                } else {
                    response = await authenticatedFetch(`${API_BASE_URL}/api/menu`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(itemData),
                    });
                }

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.message || 'Failed to save menu item.');
                }

                showToast(`Menu item ${id ? 'updated' : 'added'} successfully!`, 'success');
                closeMenuItemModal.click(); // Close modal
                fetchMenuItems(); // Refresh list
            } catch (error) {
                console.error('Error saving menu item:', error);
                showToast(error.message, 'error');
            }
        }

        async function deleteMenuItem(id) {
            if (!confirm('Are you sure you want to delete this menu item?')) {
                return;
            }
            try {
                const response = await authenticatedFetch(`${API_BASE_URL}/api/menu/${id}`, {
                    method: 'DELETE',
                });
                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.message || 'Failed to delete menu item.');
                }
                showToast('Menu item deleted successfully!', 'success');
                fetchMenuItems(); // Refresh list
            } catch (error) {
                console.error('Error deleting menu item:', error);
                showToast(error.message, 'error');
            }
        }

        // --- Orders Panel Functions ---
        async function fetchOrders() {
            ordersTableBody.innerHTML = `<tr><td colspan="7" class="text-center text-secondary py-8">${loadingSpinnerHtml}</td></tr>`;
            lucide.createIcons(); // Render spinner icon
            try {
                const response = await authenticatedFetch(`${API_BASE_URL}/api/orders`); // Use authenticatedFetch
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                allOrdersData = await response.json();
                // Sort orders by date descending by default
                allOrdersData.sort((a, b) => new Date(b.orderDate) - new Date(a.orderDate));
                displayFilteredOrders();
            } catch (error) {
                console.error('Error fetching orders:', error);
                ordersTableBody.innerHTML = `<tr><td colspan="7" class="text-center text-red-500 py-8">Failed to load orders.</td></tr>`;
                showToast('Failed to load orders.', 'error');
            }
        }

        function displayFilteredOrders() {
            ordersTableBody.innerHTML = '';
            const searchTerm = orderSearchInput.value.toLowerCase();
            const selectedStatus = orderStatusFilter.value;

            const filteredOrders = allOrdersData.filter(order => {
                const matchesSearch = order.customerName.toLowerCase().includes(searchTerm) ||
                                      order.customerId.toLowerCase().includes(searchTerm) ||
                                      order._id.toString().toLowerCase().includes(searchTerm);
                const matchesStatus = selectedStatus === 'All' || order.status === selectedStatus;
                return matchesSearch && matchesStatus;
            });

            if (filteredOrders.length === 0) {
                ordersTableBody.innerHTML = `<tr><td colspan="7" class="text-center text-secondary py-8">No orders found matching your criteria.</td></tr>`;
                return;
            }

            filteredOrders.forEach(order => {
                const row = document.createElement('tr');
                row.className = 'hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors';
                const itemsSummary = order.items.slice(0, 2).map(item => `${item.name} (x${item.quantity})`).join(', ') +
                                     (order.items.length > 2 ? `, ...and ${order.items.length - 2} more` : '');
                const statusColorClass = getStatusColor(order.status);

                row.innerHTML = `
                    <td class="px-6 py-4 whitespace-nowrap text-primary">${order._id.substring(0, 8)}...</td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <div class="text-primary font-medium">${order.customerName}</div>
                        <div class="text-secondary text-sm">${order.customerId.split('@')[0]}</div>
                    </td>
                    <td class="px-6 py-4">
                        <ul class="list-disc list-inside text-secondary text-sm">
                            ${order.items.slice(0, 2).map(item => `<li>${item.name} (x${item.quantity})</li>`).join('')}
                            ${order.items.length > 2 ? `<li class="text-secondary">...and ${order.items.length - 2} more</li>` : ''}
                        </ul>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-primary font-medium">Rs. ${order.totalAmount.toFixed(2)}</td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <span class="px-3 py-1 inline-flex text-xs leading-5 font-semibold rounded-full ${statusColorClass}">
                            ${order.status}
                        </span>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-secondary text-sm">
                        ${new Date(order.orderDate).toLocaleDateString()}
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                        <button data-id="${order._id}" class="view-order-details-btn text-blue-500 hover:text-blue-600 mr-3 p-2 rounded-md hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors" title="View Details">
                            <i data-lucide="clipboard-list" class="w-5 h-5"></i>
                        </button>
                        <div class="relative inline-block text-left z-10">
                            <button type="button" data-id="${order._id}" class="status-dropdown-toggle inline-flex justify-center w-full rounded-md border border-default shadow-sm px-4 py-2 bg-gray-100 dark:bg-gray-700 text-primary dark:text-gray-100 text-sm font-medium hover:bg-gray-200 dark:hover:bg-gray-600 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-offset-body focus:ring-accent-primary">
                                Update Status <i data-lucide="chevron-down" class="-mr-1 ml-2 h-5 w-5"></i>
                            </button>
                            <div class="status-dropdown-menu origin-top-right absolute right-0 mt-2 w-48 rounded-md shadow-lg bg-card ring-1 ring-black ring-opacity-5 focus:outline-none hidden">
                                <div class="py-1">
                                    ${['Pending', 'Confirmed', 'Preparing', 'Out for Delivery', 'Delivered', 'Cancelled'].map(status => `
                                        <button data-status="${status}" data-order-id="${order._id}" class="update-order-status-btn block w-full text-left px-4 py-2 text-sm ${status === order.status ? 'bg-accent-primary text-white' : 'text-primary hover:bg-gray-100 dark:hover:bg-gray-700'}">
                                            ${status}
                                        </button>
                                    `).join('')}
                                </div>
                            </div>
                        </div>
                    </td>
                `;
                ordersTableBody.appendChild(row);
            });
            lucide.createIcons(); // Re-render Lucide icons after updating innerHTML

            // Attach event listeners for order details and status dropdowns
            document.querySelectorAll('.view-order-details-btn').forEach(btn => {
                btn.onclick = (e) => openOrderDetailsModal(e.currentTarget.dataset.id);
            });

            document.querySelectorAll('.status-dropdown-toggle').forEach(btn => {
                btn.onclick = (e) => {
                    // Close other open dropdowns
                    document.querySelectorAll('.status-dropdown-menu').forEach(menu => {
                        if (menu !== e.currentTarget.nextElementSibling) {
                            menu.classList.add('hidden');
                            // Find the icon within the toggler button and change it back
                            const icon = menu.previousElementSibling.querySelector('[data-lucide]');
                            if (icon) icon.setAttribute('data-lucide', 'chevron-down');
                        }
                    });

                    const menu = e.currentTarget.nextElementSibling;
                    const icon = e.currentTarget.querySelector('[data-lucide]');
                    menu.classList.toggle('hidden');
                    if (menu.classList.contains('hidden')) {
                        icon.setAttribute('data-lucide', 'chevron-down');
                    } else {
                        icon.setAttribute('data-lucide', 'chevron-up');
                    }
                    lucide.createIcons();
                };
            });

            document.querySelectorAll('.update-order-status-btn').forEach(btn => {
                btn.onclick = (e) => {
                    const orderId = e.currentTarget.dataset.orderId;
                    const newStatus = e.currentTarget.dataset.status;
                    updateOrderStatus(orderId, newStatus);
                    // Close dropdown after selection
                    e.currentTarget.closest('.status-dropdown-menu').classList.add('hidden');
                    const toggleBtn = e.currentTarget.closest('.status-dropdown-menu').previousElementSibling;
                    const icon = toggleBtn.querySelector('[data-lucide]');
                    if (icon) icon.setAttribute('data-lucide', 'chevron-down');
                    lucide.createIcons();
                };
            });

            // Close dropdowns when clicking outside
            document.addEventListener('click', (e) => {
                if (!e.target.closest('.status-dropdown-toggle') && !e.target.closest('.status-dropdown-menu')) {
                    document.querySelectorAll('.status-dropdown-menu').forEach(menu => {
                        menu.classList.add('hidden');
                        const icon = menu.previousElementSibling.querySelector('[data-lucide]');
                        if (icon) icon.setAttribute('data-lucide', 'chevron-down');
                    });
                    lucide.createIcons();
                }
            });
        }

        function openOrderDetailsModal(id) {
            const order = allOrdersData.find(o => o._id === id);
            if (!order) {
                showToast('Order not found for details.', 'error');
                return;
            }
            currentViewingOrder = order;

            orderDetailsId.textContent = order._id.substring(0, 10) + '...';
            orderCustomerName.textContent = order.customerName;
            orderCustomerPhone.textContent = order.customerId.split('@')[0];
            orderCustomerPhone.href = `tel:${order.customerId.split('@')[0]}`;

            orderDetailsItems.innerHTML = '';
            order.items.forEach(item => {
                const li = document.createElement('li');
                li.className = 'py-2 flex justify-between items-center text-primary';
                li.innerHTML = `
                    <span>${item.name} (x${item.quantity})</span>
                    <span>Rs. ${(item.price * item.quantity).toFixed(2)}</span>
                `;
                orderDetailsItems.appendChild(li);
            });

            orderDetailsTotal.textContent = order.totalAmount.toFixed(2);
            orderDetailsStatusBadge.className = `px-4 py-2 inline-flex text-sm leading-5 font-semibold rounded-full ${getStatusColor(order.status)}`;
            orderDetailsStatusBadge.textContent = order.status;
            orderDetailsDate.textContent = new Date(order.orderDate).toLocaleString();
            orderStatusSelectModal.value = order.status; // Set dropdown value

            orderDetailsModal.classList.remove('hidden');
            orderDetailsModal.classList.add('flex');
            lucide.createIcons(); // Re-render icons in modal
        }

        async function updateOrderStatus(orderId, newStatus) {
            try {
                const response = await authenticatedFetch(`${API_BASE_URL}/api/orders/${orderId}/status`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ status: newStatus }),
                });
                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.message || 'Failed to update order status.');
                }
                showToast('Order status updated successfully!', 'success');
                fetchOrders(); // Refresh list
                // If the modal is open for this order, update its status
                if (currentViewingOrder && currentViewingOrder._id === orderId) {
                    currentViewingOrder.status = newStatus;
                    orderDetailsStatusBadge.className = `px-4 py-2 inline-flex text-sm leading-5 font-semibold rounded-full ${getStatusColor(newStatus)}`;
                    orderDetailsStatusBadge.textContent = newStatus;
                    orderStatusSelectModal.value = newStatus;
                }
            } catch (error) {
                console.error('Error updating order status:', error);
                showToast(error.message, 'error');
            }
        }

        // --- Event Listeners ---
        document.addEventListener('DOMContentLoaded', () => {
            checkAuth(); // Check authentication status on load

            // Render all Lucide icons on page load
            lucide.createIcons();
        });

        // Login Form
        loginForm.addEventListener('submit', handleLogin);
        logoutButton.addEventListener('click', handleLogout);

        // Sidebar navigation
        navItems.forEach(item => {
            item.addEventListener('click', (e) => {
                const view = e.currentTarget.dataset.view;
                showPanel(`${view}-panel`);
            });
        });

        // Mobile sidebar toggle
        mobileSidebarToggle.addEventListener('click', () => {
            sidebar.classList.toggle('-translate-x-full');
            sidebar.classList.toggle('translate-x-0');
        });

        // Close sidebar when clicking outside on mobile
        mainContent.addEventListener('click', (e) => {
            if (window.innerWidth < 1024 && sidebar.classList.contains('translate-x-0') && !sidebar.contains(e.target) && !mobileSidebarToggle.contains(e.target)) {
                sidebar.classList.add('-translate-x-full');
                sidebar.classList.remove('translate-x-0');
            }
        });

        // Theme Toggle
        themeToggle.addEventListener('click', () => {
            if (document.documentElement.classList.contains('dark')) {
                applyTheme('light');
                localStorage.setItem('dashboard-theme', 'light');
            } else {
                applyTheme('dark');
                localStorage.setItem('dashboard-theme', 'dark');
            }
        });


        // Menu Panel Event Listeners
        menuSearchInput.addEventListener('input', displayFilteredMenuItems);
        menuCategoryFilter.addEventListener('change', displayFilteredMenuItems);
        menuSortOrder.addEventListener('change', displayFilteredMenuItems);
        addMenuItemBtn.addEventListener('click', openAddMenuItemModal);
        closeMenuItemModal.addEventListener('click', () => {
            menuItemModal.classList.add('hidden');
            menuItemModal.classList.remove('flex');
        });
        cancelMenuItemBtn.addEventListener('click', () => {
            menuItemModal.classList.add('hidden');
            menuItemModal.classList.remove('flex');
        });
        menuItemForm.addEventListener('submit', saveMenuItem);
        menuImageUrlInput.addEventListener('input', (e) => {
            if (e.target.value) {
                menuImagePreview.src = e.target.value;
                menuImagePreview.classList.remove('hidden');
            } else {
                menuImagePreview.classList.add('hidden');
            }
        });
        // Close menu item modal when clicking outside
        menuItemModal.addEventListener('click', (e) => {
            if (e.target === menuItemModal) {
                closeMenuItemModal.click();
            }
        });


        // Orders Panel Event Listeners
        orderSearchInput.addEventListener('input', displayFilteredOrders);
        orderStatusFilter.addEventListener('change', displayFilteredOrders);
        refreshOrdersBtn.addEventListener('click', fetchOrders);
        closeOrderDetailsModal.addEventListener('click', () => {
            orderDetailsModal.classList.add('hidden');
            orderDetailsModal.classList.remove('flex');
        });
        closeOrderDetailsBtn.addEventListener('click', () => {
            orderDetailsModal.classList.add('hidden');
            orderDetailsModal.classList.remove('flex');
        });
        orderStatusSelectModal.addEventListener('change', (e) => {
            if (currentViewingOrder) {
                updateOrderStatus(currentViewingOrder._id, e.target.value);
            }
        });
        // Close order details modal when clicking outside
        orderDetailsModal.addEventListener('click', (e) => {
            if (e.target === orderDetailsModal) {
                closeOrderDetailsModal.click();
            }
        });

        // Socket.IO for QR updates
        const socket = io(API_BASE_URL);
        socket.on('qr1', (data) => {
            whatsappClient1Status = data;
            updateWhatsAppPanel();
            if (data.isReady) {
                showToast('WhatsApp Bot 1 is ready!', 'success');
            } else if (data.status.includes('Auth Failure') || data.status.includes('Disconnected')) {
                showToast(`WhatsApp Bot 1: ${data.status}`, 'error');
            }
        });

        socket.on('qr2', (data) => {
            whatsappClient2Status = data;
            updateWhatsAppPanel();
            if (data.isReady) {
                showToast('WhatsApp Bot 2 is ready!', 'success');
            } else if (data.status.includes('Auth Failure') || data.status.includes('Disconnected')) {
                showToast(`WhatsApp Bot 2: ${data.status}`, 'error');
            }
        });

    </script>
</body>
</html>

