<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard - Delicious Bites</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <!-- Leaflet CSS for map -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #000000; /* Pure black */
            color: #ffffff; /* Pure white */
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }
        .header {
            background-color: #1a1a1a; /* Dark gray */
            padding: 1rem 2rem;
            box-shadow: 0 2px 4px rgba(255,255,255,0.05);
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom-left-radius: 1rem;
            border-bottom-right-radius: 1rem;
        }
        .header h1 {
            font-size: 1.8rem;
            font-weight: 700;
            color: #ffffff;
        }
        .logout-btn {
            background-color: #cc0000; /* Red */
            color: #ffffff;
            padding: 0.5rem 1rem;
            border-radius: 0.5rem;
            font-weight: 600;
            transition: background-color 0.2s;
        }
        .logout-btn:hover {
            background-color: #ff3333;
        }
        .container {
            flex-grow: 1;
            padding: 2rem;
            max-width: 1400px;
            margin: 0 auto;
            width: 100%;
        }
        .card {
            background-color: #1a1a1a; /* Dark gray */
            border-radius: 1.5rem;
            padding: 2rem;
            box-shadow: 0 4px 8px rgba(0,0,0,0.3);
            margin-bottom: 2rem;
        }
        .card-header {
            font-size: 1.5rem;
            font-weight: 600;
            color: #ffffff;
            margin-bottom: 1.5rem;
            border-bottom: 1px solid #333333;
            padding-bottom: 1rem;
        }
        .table-container {
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
            scrollbar-width: thin;
            scrollbar-color: #555555 #2a2a2a;
        }
        .table-container::-webkit-scrollbar {
            height: 8px;
        }
        .table-container::-webkit-scrollbar-track {
            background: #2a2a2a;
            border-radius: 10px;
        }
        .table-container::-webkit-scrollbar-thumb {
            background-color: #555555;
            border-radius: 10px;
            border: 2px solid #2a2a2a;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            min-width: 800px; /* Ensure table doesn't get too small on mobile */
        }
        th, td {
            padding: 1rem;
            text-align: left;
            border-bottom: 1px solid #333333;
            white-space: nowrap; /* Prevent text wrapping in table cells */
        }
        th {
            background-color: #2a2a2a; /* Darker gray for table header */
            font-weight: 600;
            color: #cccccc;
        }
        tr:hover {
            background-color: #2a2a2a;
            cursor: pointer;
        }
        .btn-primary, .btn-secondary {
            padding: 0.6rem 1.2rem;
            border-radius: 0.5rem;
            font-weight: 600;
            transition: background-color 0.2s;
        }
        .btn-primary {
            background-color: #ffffff; /* White */
            color: #000000; /* Black */
        }
        .btn-primary:hover {
            background-color: #dddddd;
        }
        .btn-secondary {
            background-color: #333333; /* Dark gray */
            color: #ffffff;
        }
        .btn-secondary:hover {
            background-color: #555555;
        }
        .btn-danger {
            background-color: #cc0000;
            color: #ffffff;
            padding: 0.6rem 1.2rem;
            border-radius: 0.5rem;
            font-weight: 600;
            transition: background-color 0.2s;
        }
        .btn-danger:hover {
            background-color: #ff3333;
        }
        .form-group {
            margin-bottom: 1rem;
        }
        .form-group label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 600;
            color: #cccccc;
        }
        .form-group input[type="text"],
        .form-group input[type="password"],
        .form-group input[type="email"],
        .form-group input[type="tel"],
        .form-group textarea,
        .form-group select,
        .form-group input[type="number"] {
            background-color: #333333;
            border: 1px solid #555555;
            color: #ffffff;
            padding: 0.75rem 1rem;
            border-radius: 0.75rem;
            width: 100%;
        }
        .form-group input::placeholder {
            color: #888888;
        }
        .message {
            margin-top: 1rem;
            font-weight: 600;
            text-align: center;
        }
        .message.error {
            color: #ff6666;
        }
        .message.success {
            color: #66ff66;
        }
        .message.info {
            color: #ffff66;
        }
        .loader {
            border: 4px solid #333333;
            border-top: 4px solid #ffffff; /* White loader top */
            border-radius: 50%;
            width: 20px;
            height: 20px;
            animation: spin 1s linear infinite;
            display: inline-block;
            vertical-align: middle;
            margin-right: 8px;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Modal Styles */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.8);
            justify-content: center;
            align-items: center;
            padding: 1rem;
        }
        .modal-content {
            background-color: #1a1a1a; /* Dark gray */
            margin: auto;
            padding: 2rem;
            border-radius: 1.5rem;
            box-shadow: 0 5px 15px rgba(0,0,0,0.5);
            width: 90%;
            max-width: 700px; /* Increased max-width for modals */
            position: relative;
            color: #ffffff;
            max-height: 90vh;
            overflow-y: auto;
        }
        .close-button {
            color: #ffffff;
            position: absolute;
            top: 1rem;
            right: 1rem;
            font-size: 2rem;
            font-weight: bold;
            cursor: pointer;
            background-color: rgba(255,255,255,0.1);
            border-radius: 50%;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background-color 0.2s;
        }
        .close-button:hover, .close-button:focus {
            background-color: rgba(255,255,255,0.2);
        }

        /* Tab navigation */
        .tab-nav {
            display: flex;
            margin-bottom: 2rem;
            border-bottom: 1px solid #333333;
        }
        .tab-nav-item {
            padding: 0.75rem 1.5rem;
            cursor: pointer;
            font-weight: 600;
            color: #cccccc;
            border-bottom: 3px solid transparent;
            transition: all 0.2s ease-in-out;
        }
        .tab-nav-item.active {
            color: #ffffff;
            border-bottom-color: #ffffff;
        }
        .tab-nav-item:hover:not(.active) {
            color: #dddddd;
        }
        .tab-content {
            display: none;
        }
        .tab-content.active {
            display: block;
        }

        /* WhatsApp QR Code */
        #qrCodeDisplay {
            display: flex;
            justify-content: center;
            align-items: center;
            margin-top: 1rem;
            padding: 1rem;
            background-color: #2a2a2a;
            border-radius: 1rem;
            min-height: 200px;
        }
        #qrCodeDisplay img {
            max-width: 180px;
            height: auto;
            border-radius: 0.5rem;
        }

        /* Map specific styles for modal */
        #modal-customer-map {
            height: 250px; /* Fixed height for the map */
            width: 100%;
            background-color: #333333;
            border-radius: 0.75rem;
            margin-bottom: 1rem;
        }
        /* Hide Leaflet zoom controls and attribution */
        .leaflet-control-zoom {
            display: none !important;
        }
        .leaflet-control-attribution {
            display: none !important;
        }
        #modal-customer-map-address {
            background-color: #2a2a2a;
            padding: 0.75rem;
            border-radius: 0.5rem;
            color: #ffffff;
            font-size: 0.95rem;
            margin-bottom: 1rem;
            min-height: 3rem;
            display: flex;
            align-items: center;
            justify-content: center;
            text-align: center;
        }
        .call-button {
            background-color: #25D366; /* WhatsApp green */
            color: #ffffff;
            padding: 0.6rem 1rem;
            border-radius: 0.5rem;
            font-weight: 600;
            transition: background-color 0.2s;
            display: inline-flex; /* Use flex to align icon and text */
            align-items: center;
            gap: 0.5rem; /* Space between icon and text */
        }
        .call-button:hover {
            background-color: #1DA851;
        }
        .track-button {
            background-color: #007bff; /* Blue for track */
            color: #ffffff;
            padding: 0.6rem 1rem;
            border-radius: 0.5rem;
            font-weight: 600;
            transition: background-color 0.2s;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
        }
        .track-button:hover {
            background-color: #0056b3;
        }

        /* WhatsApp Log Console */
        #whatsapp-log-console {
            background-color: #2a2a2a;
            border-radius: 0.75rem;
            padding: 1rem;
            height: 200px; /* Fixed height for the console */
            overflow-y: auto;
            font-family: 'Consolas', 'Monaco', monospace;
            font-size: 0.85rem;
            color: #cccccc;
            margin-top: 1.5rem;
        }
        #whatsapp-log-console p {
            margin-bottom: 0.25rem;
            line-height: 1.2;
        }
        #whatsapp-log-console p:last-child {
            margin-bottom: 0;
        }


        /* Responsive adjustments */
        @media (max-width: 768px) {
            .header {
                padding: 1rem;
            }
            .header h1 {
                font-size: 1.5rem;
            }
            .container {
                padding: 1rem;
            }
            .card {
                padding: 1.5rem;
            }
            .card-header {
                font-size: 1.3rem;
                margin-bottom: 1rem;
            }
            .tab-nav-item {
                padding: 0.6rem 1rem;
                font-size: 0.9rem;
            }
            th, td {
                padding: 0.75rem;
                font-size: 0.9rem;
            }
            .modal-content {
                padding: 1.5rem;
                border-radius: 1rem;
            }
            .close-button {
                font-size: 1.5rem;
                width: 30px;
                height: 30px;
            }
            #modal-customer-map {
                height: 200px; /* Adjust map height for smaller screens */
            }
        }
    </style>
</head>
<body>
    <!-- MODIFICATION START: Immediate client-side authentication check -->
    <script>
        const token = localStorage.getItem('adminToken');
        if (!token) {
            window.location.href = '/admin/login';
        }
    </script>
    <!-- MODIFICATION END -->

    <header class="header">
        <h1>Delicious Bites Admin</h1>
        <button id="logout-btn" class="logout-btn">Logout</button>
    </header>

    <main class="container">
        <div class="tab-nav">
            <div class="tab-nav-item active" data-tab="orders">Orders</div>
            <div class="tab-nav-item" data-tab="menu">Menu</div>
            <div class="tab-nav-item" data-tab="customers">Customers</div>
            <div class="tab-nav-item" data-tab="settings">Settings</div>
        </div>

        <!-- Orders Tab Content -->
        <section id="orders-tab" class="tab-content active">
            <div class="card">
                <h2 class="card-header">Manage Orders</h2>
                <div class="mb-4">
                    <input type="text" id="order-search-input" placeholder="Search by Order ID, PIN, or Customer Phone" class="form-group w-full">
                </div>
                <div class="table-container">
                    <table id="orders-table">
                        <thead>
                            <tr>
                                <th>Custom Order ID</th>
                                <th>PIN</th>
                                <th>Customer Phone</th>
                                <th>Total Amount</th>
                                <th>Payment Method</th>
                                <th>Status</th>
                                <th>Order Date</th>
                            </tr>
                        </thead>
                        <tbody>
                            <!-- Orders will be loaded here -->
                        </tbody>
                    </table>
                </div>
                <p id="orders-message" class="message mt-4 hidden"></p>
                <div id="orders-loader" class="loader mx-auto mt-4 hidden"></div>
            </div>
        </section>

        <!-- Menu Tab Content -->
        <section id="menu-tab" class="tab-content">
            <div class="card">
                <h2 class="card-header">Manage Menu Items</h2>
                <button id="add-menu-item-btn" class="btn-primary mb-4">Add New Item</button>
                <div class="table-container">
                    <table id="menu-items-table">
                        <thead>
                            <tr>
                                <th>Name</th>
                                <th>Price</th>
                                <th>Category</th>
                                <th>Available</th>
                                <th>Trending</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            <!-- Menu items will be loaded here -->
                        </tbody>
                    </table>
                </div>
                <p id="menu-message" class="message mt-4 hidden"></p>
                <div id="menu-loader" class="loader mx-auto mt-4 hidden"></div>
            </div>
        </section>

        <!-- Customers Tab Content -->
        <section id="customers-tab" class="tab-content">
            <div class="card">
                <h2 class="card-header">Manage Customers</h2>
                <div class="table-container">
                    <table id="customers-table">
                        <thead>
                            <tr>
                                <th>Phone</th>
                                <th>Name</th>
                                <th>Total Orders</th>
                                <th>Last Order</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            <!-- Customers will be loaded here -->
                        </tbody>
                    </table>
                </div>
                <p id="customers-message" class="message mt-4 hidden"></p>
                <div id="customers-loader" class="loader mx-auto mt-4 hidden"></div>
            </div>
        </section>

        <!-- Settings Tab Content -->
        <section id="settings-tab" class="tab-content">
            <div class="card mb-6">
                <h2 class="card-header">WhatsApp Bot Status</h2>
                <div class="flex flex-col sm:flex-row items-center justify-between mb-4">
                    <p class="text-lg font-bold">Status: <span id="whatsapp-status" class="font-normal text-yellow-400">Loading...</span></p>
                    <p class="text-sm text-gray-400">Last Authenticated: <span id="last-auth-date">N/A</span></p>
                </div>
                <div id="qrCodeDisplay" class="mb-4">
                    <p class="text-gray-400">QR code will appear here if needed.</p>
                </div>
                <button id="reconnect-whatsapp-btn" class="btn-primary w-full sm:w-auto">Reconnect WhatsApp</button>
                <p id="whatsapp-message" class="message mt-3 hidden"></p>

                <!-- New WhatsApp Log Console -->
                <h3 class="text-lg font-bold mt-6 mb-3">WhatsApp Bot Logs</h3>
                <div id="whatsapp-log-console">
                    <p>Waiting for logs...</p>
                </div>
            </div>

            <div class="card">
                <h2 class="card-header">Two-Factor Authentication (2FA)</h2>
                <div class="mb-4">
                    <p class="text-lg font-bold">2FA Status: <span id="2fa-status" class="font-normal text-yellow-400">Loading...</span></p>
                </div>
                <div class="flex flex-col sm:flex-row gap-4">
                    <button id="enable-2fa-btn" class="btn-primary w-full sm:w-auto hidden">Enable 2FA</button>
                    <button id="disable-2fa-btn" class="btn-danger w-full sm:w-auto hidden">Disable 2FA</button>
                </div>
                <p id="2fa-message" class="message mt-3 hidden"></p>
            </div>

            <div class="card mt-6">
                <h2 class="card-header">Shop Settings</h2>
                <form id="settings-form">
                    <div class="form-group">
                        <label for="shop-name">Shop Name:</label>
                        <input type="text" id="shop-name" placeholder="Delicious Bites" required>
                    </div>
                    <div class="form-group">
                        <label>Shop Location (Latitude, Longitude):</label>
                        <div class="flex gap-2">
                            <input type="number" step="any" id="shop-latitude" placeholder="Latitude" required>
                            <input type="number" step="any" id="shop-longitude" placeholder="Longitude" required>
                        </div>
                    </div>
                    <div class="form-group">
                        <label>Delivery Rates (KMs, Amount):</label>
                        <div id="delivery-rates-container">
                            <!-- Delivery rate inputs will be added here -->
                        </div>
                        <button type="button" id="add-delivery-rate-btn" class="btn-secondary mt-2">Add Delivery Rate</button>
                    </div>
                    <button type="submit" id="save-settings-btn" class="btn-primary w-full sm:w-auto mt-4">Save Settings</button>
                    <p id="settings-message" class="message mt-3 hidden"></p>
                </form>
            </div>
        </section>
    </main>

    <!-- Order Details Modal -->
    <div id="order-details-modal" class="modal">
        <div class="modal-content">
            <span class="close-button">&times;</span>
            <h2 class="text-2xl font-bold mb-4">Order Details</h2>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4 text-sm">
                <div>
                    <p><span class="font-semibold">Custom Order ID:</span> <span id="modal-order-custom-id"></span></p>
                    <p><span class="font-semibold">PIN:</span> <span id="modal-order-pin"></span></p>
                    <p><span class="font-semibold">Customer Name:</span> <span id="modal-customer-name"></span></p>
                    <p><span class="font-semibold">Customer Phone:</span> <span id="modal-customer-phone"></span>
                        <!-- Call Button Added Here -->
                        <a id="call-customer-btn" href="#" class="call-button ml-2">
                            <i class="fas fa-phone"></i> Call
                        </a>
                    </p>
                    <p><span class="font-semibold">Delivery Address:</span> <span id="modal-delivery-address"></span></p>
                    <p><span class="font-semibold">Order Date:</span> <span id="modal-order-date"></span></p>
                </div>
                <div>
                    <p><span class="font-semibold">Subtotal:</span> ₹<span id="modal-subtotal"></span></p>
                    <p><span class="font-semibold">Delivery Tax:</span> ₹<span id="modal-transport-tax"></span></p>
                    <p><span class="font-semibold">Total Amount:</span> ₹<span id="modal-total-amount" class="text-lg font-bold"></span></p>
                    <p><span class="font-semibold">Payment Method:</span> <span id="modal-payment-method"></span></p>
                    <p><span class="font-semibold">Razorpay Order ID:</span> <span id="modal-razorpay-order-id">N/A</span></p>
                    <p><span class="font-semibold">Razorpay Payment ID:</span> <span id="modal-razorpay-payment-id">N/A</span></p>
                </div>
            </div>
            <h3 class="font-semibold text-lg mb-2">Items:</h3>
            <ul id="modal-order-items" class="list-disc list-inside text-gray-400 mb-4">
                <!-- Order items will be listed here -->
            </ul>

            <!-- Customer Location Map Added Here -->
            <h3 class="font-semibold text-lg mb-2">Customer Location:</h3>
            <div id="modal-customer-map"></div>
            <div id="modal-customer-map-address" class="text-center">Loading customer address...</div>
            <p class="text-gray-400 text-sm mt-1 mb-4">This is the last known location provided by the customer.</p>

            <div class="flex justify-end gap-2 mb-4">
                <a id="track-delivery-btn" href="#" target="_blank" class="track-button hidden">
                    <i class="fas fa-map-marker-alt"></i> Track Delivery
                </a>
            </div>

            <div class="form-group">
                <label for="modal-order-status">Update Status:</label>
                <select id="modal-order-status" class="w-full p-2 rounded-md bg-gray-700 text-white">
                    <option value="Pending">Pending</option>
                    <option value="Confirmed">Confirmed</option>
                    <option value="Preparing">Preparing</option>
                    <option value="Out for Delivery">Out for Delivery</option>
                    <option value="Delivered">Delivered</option>
                    <option value="Cancelled">Cancelled</option>
                </select>
            </div>
            <button id="save-order-status-btn" class="btn-primary w-full">
                <span id="save-order-status-loader" class="loader hidden"></span>
                <span id="save-order-status-text">Save Status</span>
            </button>
            <p id="modal-order-message" class="message mt-3 hidden"></p>
        </div>
    </div>

    <!-- Add/Edit Menu Item Modal -->
    <div id="menu-item-modal" class="modal">
        <div class="modal-content">
            <span class="close-button">&times;</span>
            <h2 id="menu-item-modal-title" class="text-2xl font-bold mb-4">Add New Menu Item</h2>
            <form id="menu-item-form">
                <input type="hidden" id="menu-item-id">
                <div class="form-group">
                    <label for="item-name">Name:</label>
                    <input type="text" id="item-name" required>
                </div>
                <div class="form-group">
                    <label for="item-description">Description:</label>
                    <textarea id="item-description" rows="3"></textarea>
                </div>
                <div class="form-group">
                    <label for="item-price">Price:</label>
                    <input type="number" step="0.01" id="item-price" required>
                </div>
                <div class="form-group">
                    <label for="item-image-url">Image URL:</label>
                    <input type="text" id="item-image-url">
                </div>
                <div class="form-group">
                    <label for="item-category">Category:</label>
                    <input type="text" id="item-category">
                </div>
                <div class="form-group flex items-center gap-2">
                    <input type="checkbox" id="item-available" class="h-4 w-4 text-white bg-gray-700 border-gray-600 rounded focus:ring-blue-500">
                    <label for="item-available">Available</label>
                </div>
                <div class="form-group flex items-center gap-2">
                    <input type="checkbox" id="item-trending" class="h-4 w-4 text-white bg-gray-700 border-gray-600 rounded focus:ring-blue-500">
                    <label for="item-trending">Trending</label>
                </div>
                <button type="submit" id="save-menu-item-btn" class="btn-primary w-full mt-4">
                    <span id="save-menu-item-loader" class="loader hidden"></span>
                    <span id="save-menu-item-text">Save Item</span>
                </button>
                <p id="menu-item-message" class="message mt-3 hidden"></p>
            </form>
        </div>
    </div>

    <!-- Two-Factor Authentication Setup Modal -->
    <div id="two-factor-modal" class="modal">
        <div class="modal-content text-center">
            <span class="close-button">&times;</span>
            <h2 class="text-2xl font-bold mb-4">Enable Two-Factor Authentication</h2>
            <p class="mb-4 text-gray-300">Scan the QR code with your authenticator app (e.g., Google Authenticator) or manually enter the secret key.</p>
            <div id="qr-code-2fa" class="flex justify-center mb-4">
                <!-- QR code will be generated here -->
            </div>
            <p class="font-mono text-sm text-gray-400 break-all mb-4">Secret Key: <span id="2fa-secret-key"></span></p>
            <div class="form-group">
                <label for="totp-code-input">Enter 6-digit code:</label>
                <input type="text" id="totp-code-input" maxlength="6" class="text-center" placeholder="XXXXXX">
            </div>
            <button id="verify-2fa-btn" class="btn-primary w-full mt-4">
                <span id="verify-2fa-loader" class="loader hidden"></span>
                <span id="verify-2fa-text">Verify & Enable 2FA</span>
            </button>
            <p id="2fa-setup-message" class="message mt-3 hidden"></p>
        </div>
    </div>


    <script src="/socket.io/socket.io.js"></script>
    <!-- Leaflet JS for map -->
    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
    <script>
        // The token check is now at the very top of the <script> block for immediate redirection.
        // const token = localStorage.getItem('adminToken'); // This is now declared globally in the immediate check
        const socket = io();
        // Re-declare token here for scope within DOMContentLoaded and other functions
        const token = localStorage.getItem('adminToken');


        // --- DOM Elements ---
        const logoutBtn = document.getElementById('logout-btn');

        // Tabs
        const tabNavItems = document.querySelectorAll('.tab-nav-item');
        const tabContents = document.querySelectorAll('.tab-content');

        // Orders Tab
        const ordersTableBody = document.querySelector('#orders-table tbody');
        const ordersMessage = document.getElementById('orders-message');
        const ordersLoader = document.getElementById('orders-loader');
        const orderSearchInput = document.getElementById('order-search-input');

        // Order Details Modal
        const orderDetailsModal = document.getElementById('order-details-modal');
        const modalOrderCustomId = document.getElementById('modal-order-custom-id');
        const modalOrderPin = document.getElementById('modal-order-pin');
        const modalCustomerName = document.getElementById('modal-customer-name');
        const modalCustomerPhone = document.getElementById('modal-customer-phone');
        const callCustomerBtn = document.getElementById('call-customer-btn'); // New Call Button
        const modalDeliveryAddress = document.getElementById('modal-delivery-address');
        const modalOrderDate = document.getElementById('modal-order-date');
        const modalSubtotal = document.getElementById('modal-subtotal');
        const modalTransportTax = document.getElementById('modal-transport-tax');
        const modalTotalAmount = document.getElementById('modal-total-amount');
        const modalPaymentMethod = document.getElementById('modal-payment-method');
        const modalRazorpayOrderId = document.getElementById('modal-razorpay-order-id');
        const modalRazorpayPaymentId = document.getElementById('modal-razorpay-payment-id');
        const modalOrderItemsList = document.getElementById('modal-order-items');
        const modalOrderStatusSelect = document.getElementById('modal-order-status');
        const saveOrderStatusBtn = document.getElementById('save-order-status-btn');
        const saveOrderStatusLoader = document.getElementById('save-order-status-loader');
        const saveOrderStatusText = document.getElementById('save-order-status-text');
        const modalOrderMessage = document.getElementById('modal-order-message');

        // Map elements for Order Details Modal
        const modalCustomerMap = document.getElementById('modal-customer-map');
        const modalCustomerMapAddress = document.getElementById('modal-customer-map-address');
        let orderDetailsMap = null;
        let orderDetailsMarker = null;

        // New Track Button
        const trackDeliveryBtn = document.getElementById('track-delivery-btn');
        let shopLocation = null; // To store shop's location fetched from settings

        // Menu Tab
        const addMenuItemBtn = document.getElementById('add-menu-item-btn');
        const menuItemsTableBody = document.querySelector('#menu-items-table tbody');
        const menuMessage = document.getElementById('menu-message');
        const menuLoader = document.getElementById('menu-loader');

        // Menu Item Modal
        const menuItemModal = document.getElementById('menu-item-modal');
        const menuItemModalTitle = document.getElementById('menu-item-modal-title');
        const menuItemForm = document.getElementById('menu-item-form');
        const menuItemIdInput = document.getElementById('menu-item-id');
        const itemNameInput = document.getElementById('item-name');
        const itemDescriptionInput = document.getElementById('item-description');
        const itemPriceInput = document.getElementById('item-price');
        const itemImageUrlInput = document.getElementById('item-image-url');
        const itemCategoryInput = document.getElementById('item-category');
        const itemAvailableCheckbox = document.getElementById('item-available');
        const itemTrendingCheckbox = document.getElementById('item-trending');
        const saveMenuItemBtn = document.getElementById('save-menu-item-btn');
        const saveMenuItemLoader = document.getElementById('save-menu-item-loader');
        const saveMenuItemText = document.getElementById('save-menu-item-text');
        const menuItemMessage = document.getElementById('menu-item-message');

        // Customers Tab
        const customersTableBody = document.querySelector('#customers-table tbody');
        const customersMessage = document.getElementById('customers-message');
        const customersLoader = document.getElementById('customers-loader');

        // Settings Tab
        const whatsappStatusSpan = document.getElementById('whatsapp-status');
        const lastAuthDateSpan = document.getElementById('last-auth-date');
        const qrCodeDisplay = document.getElementById('qrCodeDisplay');
        const reconnectWhatsappBtn = document.getElementById('reconnect-whatsapp-btn');
        const whatsappMessage = document.getElementById('whatsapp-message');
        const whatsappLogConsole = document.getElementById('whatsapp-log-console'); // New log console element

        const twoFactorStatusSpan = document.getElementById('2fa-status');
        const enable2FABtn = document.getElementById('enable-2fa-btn');
        const disable2FABtn = document.getElementById('disable-2fa-btn');
        const twoFAMessage = document.getElementById('2fa-message');

        const twoFactorModal = document.getElementById('two-factor-modal');
        const qrCode2FA = document.getElementById('qr-code-2fa');
        const twoFASecretKey = document.getElementById('2fa-secret-key');
        const totpCodeInput = document.getElementById('totp-code-input');
        const verify2FABtn = document.getElementById('verify-2fa-btn');
        const verify2FALoader = document.getElementById('verify-2fa-loader');
        const verify2FAText = document.getElementById('verify-2fa-text');
        const twoFASetupMessage = document.getElementById('2fa-setup-message');

        const settingsForm = document.getElementById('settings-form');
        const shopNameInput = document.getElementById('shop-name');
        const shopLatitudeInput = document.getElementById('shop-latitude');
        const shopLongitudeInput = document.getElementById('shop-longitude');
        const deliveryRatesContainer = document.getElementById('delivery-rates-container');
        const addDeliveryRateBtn = document.getElementById('add-delivery-rate-btn');
        const saveSettingsBtn = document.getElementById('save-settings-btn');
        const settingsMessage = document.getElementById('settings-message');

        let currentOrderId = null; // To store the ID of the order being viewed/edited in the modal
        let current2FASecret = null; // To temporarily store the generated 2FA secret

        // --- Utility Functions ---
        function showLoader(loaderElement, messageElement, message = 'Loading...', type = 'info') {
            loaderElement.classList.remove('hidden');
            messageElement.textContent = message;
            messageElement.className = `message mt-3 ${type}`;
            messageElement.classList.remove('hidden');
        }

        function hideLoader(loaderElement, messageElement, success = true, message = '') {
            loaderElement.classList.add('hidden');
            messageElement.textContent = message;
            messageElement.className = `message mt-3 ${success ? 'success' : 'error'}`;
            if (!message) messageElement.classList.add('hidden');
            else messageElement.classList.remove('hidden');
        }

        function showModal(modalElement) {
            modalElement.style.display = 'flex';
        }

        function hideModal(modalElement) {
            modalElement.style.display = 'none';
        }

        // --- API Calls ---
        async function fetchData(url, loader, messageElement, successCallback, errorCallback) {
            showLoader(loader, messageElement);
            try {
                const response = await fetch(url, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                if (!response.ok) {
                    if (response.status === 401 || response.status === 403) {
                        localStorage.removeItem('adminToken');
                        // Redirect to login if unauthorized for API calls
                        window.location.href = '/admin/login';
                        return;
                    }
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                const data = await response.json();
                hideLoader(loader, messageElement, true, ''); // Hide message on success
                successCallback(data);
            } catch (error) {
                console.error(`Error fetching from ${url}:`, error);
                hideLoader(loader, messageElement, false, `Failed to load data: ${error.message}`);
                if (errorCallback) errorCallback(error);
            }
        }

        async function sendData(url, method, body, loader, textElement, messageElement, successCallback, errorCallback) {
            showLoader(loader, messageElement, 'Processing...', 'info');
            textElement.classList.add('hidden'); // Hide text when loader is active
            try {
                const response = await fetch(url, {
                    method: method,
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify(body)
                });
                const data = await response.json();
                if (!response.ok) {
                    if (response.status === 401 || response.status === 403) {
                        localStorage.removeItem('adminToken');
                        window.location.href = '/admin/login';
                        return;
                    }
                    throw new Error(data.message || `HTTP error! status: ${response.status}`);
                }
                hideLoader(loader, messageElement, true, data.message || 'Success!');
                textElement.classList.remove('hidden'); // Show text back
                successCallback(data);
            } catch (error) {
                console.error(`Error sending data to ${url}:`, error);
                hideLoader(loader, messageElement, false, `Error: ${error.message}`);
                textElement.classList.remove('hidden'); // Show text back
                if (errorCallback) errorCallback(error);
            }
        }

        async function deleteData(url, loader, messageElement, successCallback, errorCallback) {
            showLoader(loader, messageElement, 'Deleting...', 'info');
            try {
                const response = await fetch(url, {
                    method: 'DELETE',
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const data = await response.json();
                if (!response.ok) {
                    if (response.status === 401 || response.status === 403) {
                        localStorage.removeItem('adminToken');
                        window.location.href = '/admin/login';
                        return;
                    }
                    throw new Error(data.message || `HTTP error! status: ${response.status}`);
                }
                hideLoader(loader, messageElement, true, data.message || 'Deleted successfully!');
                successCallback(data);
            } catch (error) {
                console.error(`Error deleting from ${url}:`, error);
                hideLoader(loader, messageElement, false, `Error: ${error.message}`);
                if (errorCallback) errorCallback(error);
            }
        }

        // --- Tab Navigation ---
        tabNavItems.forEach(item => {
            item.addEventListener('click', () => {
                const targetTab = item.dataset.tab;

                tabNavItems.forEach(nav => nav.classList.remove('active'));
                item.classList.add('active');

                tabContents.forEach(content => content.classList.remove('active'));
                document.getElementById(`${targetTab}-tab`).classList.add('active');

                // Load data for the active tab
                if (targetTab === 'orders') fetchOrders();
                else if (targetTab === 'menu') fetchMenuItems();
                else if (targetTab === 'customers') fetchCustomers();
                else if (targetTab === 'settings') fetchSettings();
            });
        });

        // --- Orders Management ---
        async function fetchOrders() {
            fetchData('/api/admin/orders', ordersLoader, ordersMessage, (data) => {
                renderOrders(data);
            });
        }

        function renderOrders(orders) {
            ordersTableBody.innerHTML = '';
            if (orders.length === 0) {
                ordersTableBody.innerHTML = '<tr><td colspan="7" class="text-center text-gray-400">No orders found.</td></tr>';
                return;
            }
            orders.forEach(order => {
                const row = document.createElement('tr');
                row.dataset.orderId = order._id;
                row.innerHTML = `
                    <td>${order.customOrderId || 'N/A'}</td>
                    <td>${order.pinId || 'N/A'}</td>
                    <td>${order.customerPhone}</td>
                    <td>₹${order.totalAmount.toFixed(2)}</td>
                    <td>${order.paymentMethod}</td>
                    <td><span class="font-semibold text-yellow-400">${order.status}</span></td>
                    <td>${new Date(order.orderDate).toLocaleString()}</td>
                `;
                row.addEventListener('click', () => openOrderDetailsModal(order));
                ordersTableBody.appendChild(row);
            });
        }

        function openOrderDetailsModal(order) {
            currentOrderId = order._id;
            modalOrderCustomId.textContent = order.customOrderId || 'N/A';
            modalOrderPin.textContent = order.pinId || 'N/A';
            modalCustomerName.textContent = order.customerName;
            modalCustomerPhone.textContent = order.customerPhone;
            // Set call button href
            callCustomerBtn.href = `tel:${order.customerPhone}`;
            modalDeliveryAddress.textContent = order.deliveryAddress;
            modalOrderDate.textContent = new Date(order.orderDate).toLocaleString();
            modalSubtotal.textContent = order.subtotal.toFixed(2);
            modalTransportTax.textContent = order.transportTax.toFixed(2);
            modalTotalAmount.textContent = order.totalAmount.toFixed(2);
            modalPaymentMethod.textContent = order.paymentMethod;
            modalRazorpayOrderId.textContent = order.razorpayOrderId || 'N/A';
            modalRazorpayPaymentId.textContent = order.razorpayPaymentId || 'N/A';

            modalOrderItemsList.innerHTML = '';
            order.items.forEach(item => {
                const li = document.createElement('li');
                li.textContent = `${item.name} x ${item.quantity} (₹${item.price.toFixed(2)} each)`;
                modalOrderItemsList.appendChild(li);
            });

            // Initialize and display map
            if (order.customerLocation && order.customerLocation.latitude && order.customerLocation.longitude) {
                initModalMap(order.customerLocation.latitude, order.customerLocation.longitude);
                modalCustomerMapAddress.textContent = order.customerLocation.address || 'Location provided by customer.';
                
                // Set Track Delivery button href
                if (shopLocation && shopLocation.latitude && shopLocation.longitude) {
                    const originLat = shopLocation.latitude;
                    const originLon = shopLocation.longitude;
                    const destLat = order.customerLocation.latitude;
                    const destLon = order.customerLocation.longitude;
                    const googleMapsUrl = `https://www.google.com/maps/dir/?api=1&origin=${originLat},${originLon}&destination=${destLat},${destLon}`;
                    trackDeliveryBtn.href = googleMapsUrl;
                    trackDeliveryBtn.classList.remove('hidden');
                } else {
                    trackDeliveryBtn.classList.add('hidden');
                    console.warn('Shop location not available for tracking link.');
                }

            } else {
                modalCustomerMapAddress.textContent = 'Customer location not available.';
                // If map was previously initialized, destroy it or hide it
                if (orderDetailsMap) {
                    orderDetailsMap.remove();
                    orderDetailsMap = null;
                    orderDetailsMarker = null;
                }
                modalCustomerMap.innerHTML = '<p class="text-gray-400 text-center py-4">Map not available for this order.</p>';
                trackDeliveryBtn.classList.add('hidden'); // Hide track button if no customer location
            }


            modalOrderStatusSelect.value = order.status;
            modalOrderMessage.classList.add('hidden'); // Clear previous messages
            showModal(orderDetailsModal);
        }

        // --- Map Functions for Order Details Modal ---
        function initModalMap(latitude, longitude) {
            // Ensure the map container is empty before initializing
            modalCustomerMap.innerHTML = '';

            if (orderDetailsMap === null) {
                orderDetailsMap = L.map('modal-customer-map', { zoomControl: false }).setView([latitude, longitude], 13);
                L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
                    attribution: 'Tiles &copy; Esri &mdash; Source: Esri, i-cubed, USDA, USGS, AEX, GeoEye, Getmapping, Aerogrid, IGN, IGP, UPR-EGP, and the GIS User Community'
                }).addTo(orderDetailsMap);
                orderDetailsMarker = L.marker([latitude, longitude]).addTo(orderDetailsMap);
            } else {
                orderDetailsMap.setView([latitude, longitude], 13);
                orderDetailsMarker.setLatLng([latitude, longitude]);
                // Invalidate size to ensure map renders correctly after modal display change
                orderDetailsMap.invalidateSize();
            }
        }

        saveOrderStatusBtn.addEventListener('click', () => {
            const newStatus = modalOrderStatusSelect.value;
            if (currentOrderId && newStatus) {
                sendData(`/api/admin/orders/${currentOrderId}`, 'PUT', { status: newStatus }, saveOrderStatusLoader, saveOrderStatusText, modalOrderMessage, (data) => {
                    fetchOrders(); // Refresh orders list
                    hideModal(orderDetailsModal);
                });
            }
        });

        orderSearchInput.addEventListener('input', async () => {
            const searchTerm = orderSearchInput.value.trim().toLowerCase();
            if (searchTerm === '') {
                fetchOrders(); // Reload all orders if search is cleared
                return;
            }

            showLoader(ordersLoader, ordersMessage, 'Searching orders...', 'info');
            try {
                const response = await fetch('/api/admin/orders', {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const allOrders = await response.json();

                const filteredOrders = allOrders.filter(order =>
                    (order.customOrderId && order.customOrderId.toLowerCase().includes(searchTerm)) ||
                    (order.pinId && order.pinId.includes(searchTerm)) || // PIN is numeric, direct include
                    (order.customerPhone && order.customerPhone.toLowerCase().includes(searchTerm))
                );
                renderOrders(filteredOrders);
                hideLoader(ordersLoader, ordersMessage, true, '');
                if (filteredOrders.length === 0) {
                    ordersMessage.textContent = 'No matching orders found.';
                    ordersMessage.classList.remove('hidden');
                    ordersMessage.className = 'message mt-3 info';
                }
            } catch (error) {
                hideLoader(ordersLoader, ordersMessage, false, `Search failed: ${error.message}`);
                console.error('Order search error:', error);
            }
        });


        // --- Menu Management ---
        async function fetchMenuItems() {
            fetchData('/api/admin/menu', menuLoader, menuMessage, (data) => {
                renderMenuItems(data);
            });
        }

        function renderMenuItems(items) {
            menuItemsTableBody.innerHTML = '';
            if (items.length === 0) {
                menuItemsTableBody.innerHTML = '<tr><td colspan="6" class="text-center text-gray-400">No menu items found.</td></tr>';
                return;
            }
            items.forEach(item => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${item.name}</td>
                    <td>₹${item.price.toFixed(2)}</td>
                    <td>${item.category || 'N/A'}</td>
                    <td>${item.isAvailable ? '<i class="fas fa-check-circle text-green-500"></i>' : '<i class="fas fa-times-circle text-red-500"></i>'}</td>
                    <td>${item.isTrending ? '<i class="fas fa-check-circle text-green-500"></i>' : '<i class="fas fa-times-circle text-red-500"></i>'}</td>
                    <td class="flex gap-2">
                        <button class="btn-secondary text-sm" onclick="editMenuItem('${item._id}')">Edit</button>
                        <button class="btn-danger text-sm" onclick="deleteMenuItem('${item._id}')">Delete</button>
                    </td>
                `;
                menuItemsTableBody.appendChild(row);
            });
        }

        addMenuItemBtn.addEventListener('click', () => {
            menuItemModalTitle.textContent = 'Add New Menu Item';
            menuItemForm.reset();
            menuItemIdInput.value = '';
            itemAvailableCheckbox.checked = true; // Default to available
            itemTrendingCheckbox.checked = false;
            menuItemMessage.classList.add('hidden');
            showModal(menuItemModal);
        });

        async function editMenuItem(id) {
            menuItemModalTitle.textContent = 'Edit Menu Item';
            menuItemMessage.classList.add('hidden');
            showLoader(saveMenuItemLoader, menuItemMessage, 'Loading item details...', 'info');
            saveMenuItemText.classList.add('hidden');

            try {
                const response = await fetch(`/api/admin/menu/${id}`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                if (!response.ok) throw new Error('Failed to fetch item details.');
                const item = await response.json();

                menuItemIdInput.value = item._id;
                itemNameInput.value = item.name;
                itemDescriptionInput.value = item.description || '';
                itemPriceInput.value = item.price;
                itemImageUrlInput.value = item.imageUrl || '';
                itemCategoryInput.value = item.category || '';
                itemAvailableCheckbox.checked = item.isAvailable;
                itemTrendingCheckbox.checked = item.isTrending;

                hideLoader(saveMenuItemLoader, menuItemMessage, true, '');
                saveMenuItemText.classList.remove('hidden');
                showModal(menuItemModal);
            } catch (error) {
                hideLoader(saveMenuItemLoader, menuItemMessage, false, `Error loading item: ${error.message}`);
                saveMenuItemText.classList.remove('hidden');
                console.error('Error editing menu item:', error);
            }
        }

        menuItemForm.addEventListener('submit', (e) => {
            e.preventDefault();
            const id = menuItemIdInput.value;
            const method = id ? 'PUT' : 'POST';
            const url = id ? `/api/admin/menu/${id}` : '/api/admin/menu';

            const itemData = {
                name: itemNameInput.value,
                description: itemDescriptionInput.value,
                price: parseFloat(itemPriceInput.value),
                imageUrl: itemImageUrlInput.value,
                category: itemCategoryInput.value,
                isAvailable: itemAvailableCheckbox.checked,
                isTrending: itemTrendingCheckbox.checked
            };

            sendData(url, method, itemData, saveMenuItemLoader, saveMenuItemText, menuItemMessage, (data) => {
                fetchMenuItems();
                hideModal(menuItemModal);
            });
        });

        async function deleteMenuItem(id) {
            if (confirm('Are you sure you want to delete this menu item?')) {
                deleteData(`/api/admin/menu/${id}`, menuLoader, menuMessage, () => {
                    fetchMenuItems();
                });
            }
        }

        // --- Customers Management ---
        async function fetchCustomers() {
            fetchData('/api/admin/customers', customersLoader, customersMessage, (data) => {
                renderCustomers(data);
            });
        }

        function renderCustomers(customers) {
            customersTableBody.innerHTML = '';
            if (customers.length === 0) {
                customersTableBody.innerHTML = '<tr><td colspan="5" class="text-center text-gray-400">No customers found.</td></tr>';
                return;
            }
            customers.forEach(customer => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${customer.customerPhone}</td>
                    <td>${customer.customerName || 'N/A'}</td>
                    <td>${customer.totalOrders}</td>
                    <td>${customer.lastOrderDate ? new Date(customer.lastOrderDate).toLocaleDateString() : 'N/A'}</td>
                    <td class="flex gap-2">
                        <button class="btn-secondary text-sm" onclick="viewCustomerOrders('${customer.customerPhone}')">View Orders</button>
                        <button class="btn-danger text-sm" onclick="deleteCustomer('${customer._id}')">Delete</button>
                    </td>
                `;
                customersTableBody.appendChild(row);
            });
        }

        async function viewCustomerOrders(phone) {
            alert('Viewing customer orders is not yet fully implemented. Check console for latest order data.');
            try {
                const response = await fetch(`/api/admin/customers/${phone}/latest-order`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                if (!response.ok) throw new Error('Failed to fetch latest order.');
                const order = await response.json();
                console.log('Latest Order for ' + phone + ':', order);
                // You can expand this to open a modal with all orders for this customer
            } catch (error) {
                console.error('Error fetching customer orders:', error);
                alert('Failed to fetch latest order for this customer.');
            }
        }

        async function deleteCustomer(id) {
            if (confirm('Are you sure you want to delete this customer? This will not delete their orders.')) {
                deleteData(`/api/admin/customers/${id}`, customersLoader, customersMessage, () => {
                    fetchCustomers();
                });
            }
        }

        // --- Settings Management ---
        async function fetchSettings() {
            fetchData('/api/admin/settings', settingsMessage, settingsMessage, (data) => {
                shopNameInput.value = data.shopName || '';
                shopLatitudeInput.value = data.shopLocation ? data.shopLocation.latitude : '';
                shopLongitudeInput.value = data.shopLocation ? data.shopLocation.longitude : '';
                shopLocation = data.shopLocation; // Store shop location globally
                renderDeliveryRates(data.deliveryRates || []);
                updateWhatsappStatus(data.whatsappStatus, data.lastAuthenticatedAt);
                fetch2FAStatus(); // Fetch 2FA status after general settings
            });
        }

        function renderDeliveryRates(rates) {
            deliveryRatesContainer.innerHTML = '';
            if (rates.length === 0) {
                deliveryRatesContainer.innerHTML = '<p class="text-gray-400 text-sm">No delivery rates configured.</p>';
            }
            rates.forEach((rate, index) => {
                const div = document.createElement('div');
                div.className = 'flex gap-2 mb-2 items-center';
                div.innerHTML = `
                    <input type="number" step="any" class="delivery-kms" value="${rate.kms}" placeholder="KMs" required>
                    <input type="number" step="0.01" class="delivery-amount" value="${rate.amount}" placeholder="Amount" required>
                    <button type="button" class="btn-danger remove-delivery-rate-btn text-sm">Remove</button>
                `;
                div.querySelector('.remove-delivery-rate-btn').addEventListener('click', () => {
                    div.remove();
                });
                deliveryRatesContainer.appendChild(div);
            });
        }

        addDeliveryRateBtn.addEventListener('click', () => {
            const div = document.createElement('div');
            div.className = 'flex gap-2 mb-2 items-center';
            div.innerHTML = `
                <input type="number" step="any" class="delivery-kms" placeholder="KMs" required>
                <input type="number" step="0.01" class="delivery-amount" placeholder="Amount" required>
                <button type="button" class="btn-danger remove-delivery-rate-btn text-sm">Remove</button>
            `;
            div.querySelector('.remove-delivery-rate-btn').addEventListener('click', () => {
                div.remove();
            });
            deliveryRatesContainer.appendChild(div);
        });

        settingsForm.addEventListener('submit', (e) => {
            e.preventDefault();
            const deliveryRates = [];
            document.querySelectorAll('.delivery-rates-container > div').forEach(row => {
                const kms = parseFloat(row.querySelector('.delivery-kms').value);
                const amount = parseFloat(row.querySelector('.delivery-amount').value);
                if (!isNaN(kms) && !isNaN(amount)) {
                    deliveryRates.push({ kms, amount });
                }
            });

            const settingsData = {
                shopName: shopNameInput.value,
                shopLocation: {
                    latitude: parseFloat(shopLatitudeInput.value),
                    longitude: parseFloat(shopLongitudeInput.value)
                },
                deliveryRates: deliveryRates
            };

            sendData('/api/admin/settings', 'PUT', settingsData, saveSettingsBtn, saveSettingsBtn, settingsMessage, (data) => {
                // Settings saved, no need to refresh the whole page, just update status
                shopLocation = data.settings.shopLocation; // Update global shopLocation
            });
        });

        // --- WhatsApp Bot Status & Reconnect ---
        function updateWhatsappStatus(status, lastAuthDate) {
            whatsappStatusSpan.textContent = status.replace(/_/g, ' ').toUpperCase();
            whatsappStatusSpan.className = 'font-normal'; // Reset classes

            if (status === 'ready') {
                whatsappStatusSpan.classList.add('text-green-500');
                reconnectWhatsappBtn.textContent = 'Reconnect WhatsApp';
                reconnectWhatsappBtn.classList.remove('btn-secondary');
                reconnectWhatsappBtn.classList.add('btn-primary');
                qrCodeDisplay.innerHTML = '<p class="text-gray-400">WhatsApp client is connected.</p>';
            } else if (status === 'qr_received') {
                whatsappStatusSpan.classList.add('text-yellow-400');
                reconnectWhatsappBtn.textContent = 'Re-scan QR';
                reconnectWhatsappBtn.classList.remove('btn-primary');
                reconnectWhatsappBtn.classList.add('btn-secondary');
                qrCodeDisplay.innerHTML = '<p class="text-gray-400">Please scan the QR code above.</p>'; // QR will be updated by socket
            } else if (status === 'disconnected' || status === 'auth_failure' || status === 'qr_error') {
                whatsappStatusSpan.classList.add('text-red-500');
                reconnectWhatsappBtn.textContent = 'Reconnect WhatsApp';
                reconnectWhatsappBtn.classList.remove('btn-secondary');
                reconnectWhatsappBtn.classList.add('btn-primary');
                qrCodeDisplay.innerHTML = '<p class="text-gray-400">WhatsApp client disconnected or failed to authenticate.</p>';
            } else if (status === 'initializing' || status === 'authenticated') {
                whatsappStatusSpan.classList.add('text-blue-400');
                reconnectWhatsappBtn.textContent = 'Initializing...';
                reconnectWhatsappBtn.disabled = true; // Disable during initialization
                qrCodeDisplay.innerHTML = '<p class="text-gray-400">Initializing WhatsApp client...</p>';
            }
            lastAuthDateSpan.textContent = lastAuthDate ? new Date(lastAuthDate).toLocaleString() : 'N/A';
        }

        reconnectWhatsappBtn.addEventListener('click', () => {
            sendData('/api/admin/load-session', 'POST', {}, reconnectWhatsappBtn, reconnectWhatsappBtn, whatsappMessage, (data) => {
                // Status will be updated by socket.io
            }, (error) => {
                reconnectWhatsappBtn.disabled = false; // Re-enable button on error
            });
        });

        socket.on('status', (status) => {
            console.log('Socket: WhatsApp Status received:', status);
            whatsappMessage.classList.add('hidden'); // Clear any previous messages
            updateWhatsappStatus(status, lastAuthDateSpan.textContent); // Update status text, keep old date for now
        });

        socket.on('sessionInfo', (info) => {
            console.log('Socket: Session Info received:', info);
            if (info.lastAuthenticatedAt) {
                lastAuthDateSpan.textContent = new Date(info.lastAuthenticatedAt).toLocaleString();
            }
        });

        socket.on('qrCode', (qrData) => {
            console.log('Socket: QR Code received.');
            if (qrData) {
                qrCodeDisplay.innerHTML = `<img src="${qrData}" alt="QR Code">`;
                whatsappMessage.textContent = 'Scan this QR code with your WhatsApp app.';
                whatsappMessage.className = 'message mt-3 info';
                whatsappMessage.classList.remove('hidden');
            } else {
                qrCodeDisplay.innerHTML = '<p class="text-gray-400">QR code will appear here if needed.</p>';
            }
            // Re-enable reconnect button if QR is received (it means initialization is trying again)
            reconnectWhatsappBtn.disabled = false;
        });

        // MODIFICATION START: WhatsApp Log Console Listener
        socket.on('whatsapp_log', (logMessage) => {
            const logEntry = document.createElement('p');
            logEntry.textContent = `[${new Date().toLocaleTimeString()}] ${logMessage}`;
            whatsappLogConsole.appendChild(logEntry);
            whatsappLogConsole.scrollTop = whatsappLogConsole.scrollHeight; // Auto-scroll to bottom
            // Remove "Waiting for logs..." message if it's present
            if (whatsappLogConsole.querySelector('p').textContent === 'Waiting for logs...') {
                whatsappLogConsole.innerHTML = '';
                whatsappLogConsole.appendChild(logEntry);
            }
        });
        // MODIFICATION END


        // --- 2FA Management ---
        async function fetch2FAStatus() {
            fetchData('/api/admin/2fa/status', twoFAMessage, twoFAMessage, (data) => {
                if (data.twoFactorEnabled) {
                    twoFactorStatusSpan.textContent = 'Enabled';
                    twoFactorStatusSpan.classList.remove('text-yellow-400');
                    twoFactorStatusSpan.classList.add('text-green-500');
                    enable2FABtn.classList.add('hidden');
                    disable2FABtn.classList.remove('hidden');
                } else {
                    twoFactorStatusSpan.textContent = 'Disabled';
                    twoFactorStatusSpan.classList.remove('text-green-500');
                    twoFactorStatusSpan.classList.add('text-yellow-400');
                    enable2FABtn.classList.remove('hidden');
                    disable2FABtn.classList.add('hidden');
                }
            });
        }

        enable2FABtn.addEventListener('click', async () => {
            showLoader(verify2FALoader, twoFASetupMessage, 'Generating QR code...', 'info');
            verify2FAText.classList.add('hidden');
            try {
                const response = await fetch('/api/admin/2fa/generate', {
                    method: 'POST',
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                if (!response.ok) throw new Error('Failed to generate 2FA QR.');
                const data = await response.json();
                qrCode2FA.innerHTML = `<img src="${data.qrCodeUrl}" alt="2FA QR Code" class="mx-auto">`;
                twoFASecretKey.textContent = data.secret;
                current2FASecret = data.secret; // Store the secret temporarily
                hideLoader(verify2FALoader, twoFASetupMessage, true, 'Scan QR and enter code.');
                verify2FAText.classList.remove('hidden');
                showModal(twoFactorModal);
            } catch (error) {
                hideLoader(verify2FALoader, twoFASetupMessage, false, `Error: ${error.message}`);
                verify2FAText.classList.remove('hidden');
                console.error('Error generating 2FA:', error);
            }
        });

        verify2FABtn.addEventListener('click', () => {
            const totpCode = totpCodeInput.value.trim();
            if (!totpCode || totpCode.length !== 6 || !current2FASecret) {
                twoFASetupMessage.textContent = 'Please enter a valid 6-digit code and ensure QR was generated.';
                twoFASetupMessage.className = 'message mt-3 error';
                twoFASetupMessage.classList.remove('hidden');
                return;
            }

            sendData('/api/admin/2fa/verify', 'POST', { totpCode: totpCode, secret: current2FASecret }, verify2FABtn, verify2FABtn, twoFASetupMessage, (data) => {
                hideModal(twoFactorModal);
                twoFAMessage.textContent = data.message;
                twoFAMessage.className = 'message mt-3 success';
                twoFAMessage.classList.remove('hidden');
                fetch2FAStatus(); // Update 2FA status on dashboard
                current2FASecret = null; // Clear secret after successful setup
            }, (error) => {
                // Error message already handled by sendData
            });
        });

        disable2FABtn.addEventListener('click', () => {
            if (confirm('Are you sure you want to disable Two-Factor Authentication?')) {
                sendData('/api/admin/2fa/disable', 'POST', {}, disable2FABtn, disable2FABtn, twoFAMessage, (data) => {
                    twoFAMessage.textContent = data.message;
                    twoFAMessage.className = 'message mt-3 success';
                    twoFAMessage.classList.remove('hidden');
                    fetch2FAStatus(); // Update 2FA status on dashboard
                }, (error) => {
                    // Error message already handled by sendData
                });
            }
        });


        // --- Logout ---
        logoutBtn.addEventListener('click', async () => {
            localStorage.removeItem('adminToken');
            window.location.href = '/admin/login';
        });

        // --- Close Modals ---
        document.querySelectorAll('.modal .close-button').forEach(button => {
            button.addEventListener('click', (e) => {
                hideModal(e.target.closest('.modal'));
                // Clear messages when closing modals
                if (e.target.closest('#order-details-modal')) {
                    modalOrderMessage.classList.add('hidden');
                    // Invalidate map size when modal closes to prevent rendering issues on next open
                    if (orderDetailsMap) {
                        orderDetailsMap.remove(); // Remove map instance completely
                        orderDetailsMap = null;
                        orderDetailsMarker = null;
                        modalCustomerMap.innerHTML = ''; // Clear map div content
                    }
                }
                if (e.target.closest('#menu-item-modal')) menuItemMessage.classList.add('hidden');
                if (e.target.closest('#two-factor-modal')) twoFASetupMessage.classList.add('hidden');
            });
        });

        window.addEventListener('click', (event) => {
            if (event.target === orderDetailsModal) {
                hideModal(orderDetailsModal);
                if (orderDetailsMap) {
                    orderDetailsMap.remove(); // Remove map instance completely
                    orderDetailsMap = null;
                    orderDetailsMarker = null;
                    modalCustomerMap.innerHTML = ''; // Clear map div content
                }
            }
            if (event.target === menuItemModal) hideModal(menuItemModal);
            if (event.target === twoFactorModal) hideModal(twoFactorModal);
        });


        // --- Initial Load (Client-side authentication check) ---
        document.addEventListener('DOMContentLoaded', async () => {
            // The initial token check and redirect is now at the very top of the script block.
            // This ensures it runs before DOMContentLoaded if the token is missing.

            // If we reach here, a token was found by the initial check.
            try {
                // Token exists, attempt to verify it with a lightweight API call
                const response = await fetch('/api/admin/bot-status', {
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                if (response.ok) {
                    // Token is valid, proceed with loading dashboard content
                    document.querySelector('.tab-nav-item').click(); // Activate the first tab by default
                } else {
                    // Token is invalid or expired (e.g., 401, 403 response)
                    console.warn('Admin token invalid or expired. Redirecting to login.');
                    localStorage.removeItem('adminToken'); // Clear invalid token
                    window.location.href = '/admin/login'; // Redirect to login
                }
            } catch (error) {
                // Network error or other fetch issue during token validation
                console.error('Error validating admin token:', error);
                localStorage.removeItem('adminToken'); // Clear token on network error
                window.location.href = '/admin/login'; // Redirect to login
            }
        });
    </script>
</body>
</html>

