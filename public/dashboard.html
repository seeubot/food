<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Inter Font -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <!-- Socket.io Client CDN -->
    <script src="https://cdn.jsdelivr.net/npm/socket.io-client@4.0.0/dist/socket.io.min.js"></script>
    <!-- qrcode.js for any potential client-side QR needs, though backend sends data URL -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcode.js/1.0.0/qrcode.min.js"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            background-color: #f9fafb; /* Light gray background */
        }
        /* Custom animation for notifications */
        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        .animate-fade-in-up {
            animation: fadeInUp 0.5s ease-out forwards;
        }
        /* Hide sections by default, JavaScript will show them */
        .page-section {
            display: none;
        }
        /* Style for active sidebar link */
        .sidebar-link.active {
            background-color: #4f46e5; /* Indigo-600 */
            color: white;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        }
    </style>
</head>
<body class="min-h-screen flex flex-col font-inter">

    <!-- Notification Toast -->
    <div id="notification-toast" class="fixed bottom-4 right-4 p-4 rounded-lg shadow-lg text-white z-50 flex items-center justify-between hidden animate-fade-in-up">
        <span id="notification-message"></span>
        <button id="notification-close" class="ml-4 text-white font-bold">&times;</button>
    </div>

    <!-- Login Page -->
    <div id="login-page" class="page-section min-h-screen flex items-center justify-center bg-gray-100 p-4">
        <div class="bg-white p-8 rounded-xl shadow-2xl w-full max-w-md">
            <h2 class="text-3xl font-extrabold text-center text-gray-900 mb-8">Admin Login</h2>
            <form id="login-form" class="space-y-6">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1" for="login-username">Username</label>
                    <input
                        id="login-username"
                        type="text"
                        value="dashboard_admin"
                        class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500 transition duration-150 ease-in-out"
                        placeholder="Enter your username"
                        required
                    />
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1" for="login-password">Password</label>
                    <input
                        id="login-password"
                        type="password"
                        value="password123"
                        class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500 transition duration-150 ease-in-out"
                        placeholder="Enter your password"
                        required
                    />
                </div>
                <div id="totp-input-container" class="hidden">
                    <label class="block text-sm font-medium text-gray-700 mb-1" for="login-totp-code">2FA Code</label>
                    <input
                        id="login-totp-code"
                        type="text"
                        class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500 transition duration-150 ease-in-out"
                        placeholder="Enter 2FA code"
                    />
                </div>
                <button
                    type="submit"
                    id="login-button"
                    class="w-full flex justify-center py-3 px-4 border border-transparent rounded-lg shadow-sm text-lg font-semibold text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 transition duration-150 ease-in-out disabled:opacity-50 disabled:cursor-not-allowed"
                >
                    Login
                </button>
            </form>
        </div>
    </div>

    <!-- Dashboard Layout -->
    <div id="dashboard-layout" class="page-section flex min-h-screen bg-gray-50 font-inter">
        <!-- Mobile Sidebar Toggle -->
        <button
            id="sidebar-toggle"
            class="lg:hidden fixed top-4 left-4 z-40 p-2 rounded-md bg-indigo-600 text-white shadow-lg"
        >
            <!-- Hamburger Icon -->
            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path>
            </svg>
        </button>

        <!-- Sidebar -->
        <aside id="sidebar" class="fixed inset-y-0 left-0 z-30 w-64 bg-gray-800 text-white shadow-xl transform -translate-x-full lg:relative lg:translate-x-0 transition-transform duration-300 ease-in-out flex flex-col">
            <div class="p-6 text-2xl font-bold text-center border-b border-gray-700">
                Admin Panel
            </div>
            <nav class="flex-grow mt-6">
                <ul>
                    <li><a href="#/dashboard" class="sidebar-link flex items-center px-6 py-3 text-lg font-medium rounded-r-full transition-all duration-200 ease-in-out text-gray-300 hover:bg-gray-700 hover:text-white">Dashboard</a></li>
                    <li><a href="#/dashboard/whatsapp" class="sidebar-link flex items-center px-6 py-3 text-lg font-medium rounded-r-full transition-all duration-200 ease-in-out text-gray-300 hover:bg-gray-700 hover:text-white">WhatsApp Bot</a></li>
                    <li><a href="#/dashboard/menu" class="sidebar-link flex items-center px-6 py-3 text-lg font-medium rounded-r-full transition-all duration-200 ease-in-out text-gray-300 hover:bg-gray-700 hover:text-white">Menu Management</a></li>
                    <li><a href="#/dashboard/orders" class="sidebar-link flex items-center px-6 py-3 text-lg font-medium rounded-r-full transition-all duration-200 ease-in-out text-gray-300 hover:bg-gray-700 hover:text-white">Order Management</a></li>
                    <li><a href="#/dashboard/customers" class="sidebar-link flex items-center px-6 py-3 text-lg font-medium rounded-r-full transition-all duration-200 ease-in-out text-gray-300 hover:bg-gray-700 hover:text-white">Customer Management</a></li>
                    <li><a href="#/dashboard/settings" class="sidebar-link flex items-center px-6 py-3 text-lg font-medium rounded-r-full transition-all duration-200 ease-in-out text-gray-300 hover:bg-gray-700 hover:text-white">Settings</a></li>
                    <li><a href="#/dashboard/2fa" class="sidebar-link flex items-center px-6 py-3 text-lg font-medium rounded-r-full transition-all duration-200 ease-in-out text-gray-300 hover:bg-gray-700 hover:text-white">2FA Settings</a></li>
                </ul>
            </nav>
            <div class="p-6 border-t border-gray-700">
                <button
                    id="logout-button"
                    class="w-full flex items-center justify-center py-3 px-4 border border-transparent rounded-lg shadow-sm text-lg font-semibold text-white bg-red-600 hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-red-500 transition duration-150 ease-in-out"
                >
                    Logout
                </button>
            </div>
        </aside>

        <!-- Main Content Area -->
        <main id="main-content" class="flex-1 p-4 sm:p-6 lg:p-8 overflow-auto">
            <!-- Content will be dynamically loaded here by JavaScript -->
        </main>
    </div>

    <!-- WhatsApp Bot Status Section -->
    <template id="whatsapp-status-template">
        <div class="p-6 bg-white rounded-xl shadow-lg">
            <h2 class="text-3xl font-bold text-gray-800 mb-6">WhatsApp Bot Status</h2>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8">
                <div class="flex flex-col items-center justify-center p-6 bg-gray-50 rounded-lg shadow-inner">
                    <div id="whatsapp-status-badge" class="w-24 h-24 rounded-full flex items-center justify-center text-white text-xl font-semibold mb-4">
                        Status
                    </div>
                    <p class="text-lg font-medium text-gray-700">Current Status: <span id="whatsapp-status-text" class="font-semibold"></span></p>
                    <p id="last-authenticated-at" class="text-sm text-gray-500 mt-1"></p>
                    <button
                        id="reinitialize-session-button"
                        class="mt-6 px-6 py-3 bg-indigo-600 text-white font-semibold rounded-lg shadow-md hover:bg-indigo-700 transition duration-200 ease-in-out disabled:opacity-50 disabled:cursor-not-allowed"
                    >
                        Re-initialize Session
                    </button>
                </div>

                <div class="flex flex-col items-center justify-center p-6 bg-gray-50 rounded-lg shadow-inner">
                    <img id="qr-code-image" src="" alt="QR Code" class="w-48 h-48 object-contain rounded-lg shadow-md mb-4 hidden" />
                    <div id="no-qr-message" class="w-48 h-48 flex items-center justify-center bg-gray-200 text-gray-500 rounded-lg shadow-md">
                        No QR Code Available
                    </div>
                    <p id="qr-scan-message" class="text-gray-700 text-center font-medium hidden">Scan this QR code with your WhatsApp app.</p>
                    <p id="qr-expiry-message" class="text-sm text-gray-500 text-center mt-1 hidden">QR will expire in 5 minutes if not scanned.</p>
                </div>
            </div>

            <div class="mt-8">
                <h3 class="text-2xl font-bold text-gray-800 mb-4">WhatsApp Logs</h3>
                <div id="whatsapp-logs" class="bg-gray-800 text-green-300 p-4 rounded-lg h-64 overflow-y-auto font-mono text-sm shadow-inner">
                    <p class="text-gray-500">No logs yet.</p>
                </div>
            </div>
        </div>
    </template>

    <!-- Menu Management Section -->
    <template id="menu-management-template">
        <div class="p-6 bg-white rounded-xl shadow-lg">
            <h2 class="text-3xl font-bold text-gray-800 mb-6">Menu Management</h2>

            <button
                id="add-menu-item-button"
                class="mb-6 px-6 py-3 bg-indigo-600 text-white font-semibold rounded-lg shadow-md hover:bg-indigo-700 transition duration-200 ease-in-out"
            >
                Add New Item
            </button>

            <div id="menu-loading-message" class="text-center py-8 text-gray-600 hidden">Loading menu items...</div>

            <div class="overflow-x-auto rounded-lg shadow-md">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Image</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Name</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Category</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Price</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Available</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Trending</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
                        </tr>
                    </thead>
                    <tbody id="menu-items-table-body" class="bg-white divide-y divide-gray-200">
                        <!-- Menu items will be populated here -->
                    </tbody>
                </table>
            </div>

            <!-- Add/Edit Item Modal -->
            <div id="menu-item-modal" class="fixed inset-0 bg-gray-600 bg-opacity-75 flex items-center justify-center z-50 p-4 hidden">
                <div class="bg-white rounded-xl shadow-2xl w-full max-w-lg p-6">
                    <h3 id="menu-item-modal-title" class="text-2xl font-bold text-gray-800 mb-6">Add New Menu Item</h3>
                    <form id="menu-item-form" class="space-y-4">
                        <input type="hidden" id="menu-item-id" />
                        <div>
                            <label class="block text-sm font-medium text-gray-700" for="menu-item-name">Name</label>
                            <input type="text" id="menu-item-name" name="name" required class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2" />
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700" for="menu-item-description">Description</label>
                            <textarea id="menu-item-description" name="description" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2"></textarea>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700" for="menu-item-price">Price</label>
                            <input type="number" id="menu-item-price" name="price" required class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2" step="0.01" />
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700" for="menu-item-image-url">Image URL</label>
                            <input type="text" id="menu-item-image-url" name="imageUrl" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2" placeholder="https://example.com/image.jpg" />
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700" for="menu-item-category">Category</label>
                            <input type="text" id="menu-item-category" name="category" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2" />
                        </div>
                        <div class="flex items-center space-x-4">
                            <div class="flex items-center">
                                <input type="checkbox" id="menu-item-is-available" name="isAvailable" class="h-4 w-4 text-indigo-600 border-gray-300 rounded" />
                                <label for="menu-item-is-available" class="ml-2 block text-sm text-gray-900">Is Available</label>
                            </div>
                            <div class="flex items-center">
                                <input type="checkbox" id="menu-item-is-trending" name="isTrending" class="h-4 w-4 text-indigo-600 border-gray-300 rounded" />
                                <label for="menu-item-is-trending" class="ml-2 block text-sm text-gray-900">Is Trending</label>
                            </div>
                        </div>
                        <div class="flex justify-end space-x-4 mt-6">
                            <button type="button" id="cancel-menu-item-button" class="px-5 py-2 border border-gray-300 rounded-lg text-gray-700 hover:bg-gray-100 transition duration-150 ease-in-out">
                                Cancel
                            </button>
                            <button type="submit" id="submit-menu-item-button" class="px-5 py-2 bg-indigo-600 text-white font-semibold rounded-lg shadow-md hover:bg-indigo-700 transition duration-150 ease-in-out">
                                Add Item
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </template>

    <!-- Order Management Section -->
    <template id="order-management-template">
        <div class="p-6 bg-white rounded-xl shadow-lg">
            <h2 class="text-3xl font-bold text-gray-800 mb-6">Order Management</h2>

            <div class="mb-6 flex flex-wrap items-center gap-4">
                <label for="order-status-filter" class="text-gray-700 font-medium">Filter by Status:</label>
                <select
                    id="order-status-filter"
                    class="px-4 py-2 border border-gray-300 rounded-lg shadow-sm focus:ring-indigo-500 focus:border-indigo-500 transition duration-150 ease-in-out"
                >
                    <option value="All">All</option>
                    <option value="Pending">Pending</option>
                    <option value="Confirmed">Confirmed</option>
                    <option value="Preparing">Preparing</option>
                    <option value="Out for Delivery">Out for Delivery</option>
                    <option value="Delivered">Delivered</option>
                    <option value="Cancelled">Cancelled</option>
                </select>
            </div>

            <div id="order-loading-message" class="text-center py-8 text-gray-600 hidden">Loading orders...</div>

            <div class="overflow-x-auto rounded-lg shadow-md">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Order ID</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Customer</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Phone</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Items</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Total</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Date</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Address</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
                        </tr>
                    </thead>
                    <tbody id="order-items-table-body" class="bg-white divide-y divide-gray-200">
                        <!-- Orders will be populated here -->
                    </tbody>
                </table>
            </div>
        </div>
    </template>

    <!-- Customer Management Section -->
    <template id="customer-management-template">
        <div class="p-6 bg-white rounded-xl shadow-lg">
            <h2 class="text-3xl font-bold text-gray-800 mb-6">Customer Management</h2>

            <div id="customer-loading-message" class="text-center py-8 text-gray-600 hidden">Loading customers...</div>

            <div class="overflow-x-auto rounded-lg shadow-md">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Name</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Phone</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Total Orders</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Last Order Date</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Last Location</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
                        </tr>
                    </thead>
                    <tbody id="customer-items-table-body" class="bg-white divide-y divide-gray-200">
                        <!-- Customers will be populated here -->
                    </tbody>
                </table>
            </div>
        </div>
    </template>

    <!-- Settings Management Section -->
    <template id="settings-management-template">
        <div class="p-6 bg-white rounded-xl shadow-lg">
            <h2 class="text-3xl font-bold text-gray-800 mb-6">Shop Settings</h2>

            <div id="settings-loading-message" class="text-center py-8 text-gray-600 hidden">Loading settings...</div>

            <form id="settings-form" class="space-y-6">
                <!-- General Settings -->
                <div class="p-4 border border-gray-200 rounded-lg bg-gray-50">
                    <h3 class="text-xl font-semibold text-gray-800 mb-4">General Information</h3>
                    <div>
                        <label class="block text-sm font-medium text-gray-700" for="shop-name">Shop Name</label>
                        <input type="text" id="shop-name" name="shopName" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2" />
                    </div>
                    <div class="mt-4 grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700" for="shop-latitude">Shop Latitude</label>
                            <input type="number" id="shop-latitude" name="shopLocation.latitude" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2" step="any" />
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700" for="shop-longitude">Shop Longitude</label>
                            <input type="number" id="shop-longitude" name="shopLocation.longitude" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2" step="any" />
                        </div>
                    </div>
                </div>

                <!-- Delivery Rates -->
                <div class="p-4 border border-gray-200 rounded-lg bg-gray-50">
                    <h3 class="text-xl font-semibold text-gray-800 mb-4">Delivery Rates (per km)</h3>
                    <div id="delivery-rates-container">
                        <!-- Delivery rates will be dynamically added here -->
                    </div>
                    <button type="button" id="add-delivery-rate-button" class="mt-4 px-4 py-2 bg-blue-600 text-white font-semibold rounded-lg shadow-md hover:bg-blue-700 transition duration-150 ease-in-out">
                        Add Delivery Rate
                    </button>
                </div>

                <!-- Discount Settings -->
                <div class="p-4 border border-gray-200 rounded-lg bg-gray-50">
                    <h3 class="text-xl font-semibold text-gray-800 mb-4">Discount Settings</h3>
                    <div class="flex items-center mb-4">
                        <input
                            type="checkbox"
                            id="is-discount-enabled"
                            name="isDiscountEnabled"
                            class="h-4 w-4 text-indigo-600 border-gray-300 rounded"
                        />
                        <label for="is-discount-enabled" class="ml-2 block text-sm text-gray-900">Enable Discount</label>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700" for="min-subtotal-for-discount">Min Subtotal for Discount (â‚¹)</label>
                        <input
                            type="number"
                            id="min-subtotal-for-discount"
                            name="minSubtotalForDiscount"
                            class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2"
                            step="0.01"
                        />
                    </div>
                    <div class="mt-4">
                        <label class="block text-sm font-medium text-gray-700" for="discount-percentage">Discount Percentage (0.00 - 1.00)</label>
                        <input
                            type="number"
                            id="discount-percentage"
                            name="discountPercentage"
                            class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2"
                            step="0.01"
                            min="0"
                            max="1"
                        />
                    </div>
                </div>

                <button type="submit" id="save-settings-button" class="px-6 py-3 bg-indigo-600 text-white font-semibold rounded-lg shadow-md hover:bg-indigo-700 transition duration-200 ease-in-out">
                    Save Settings
                </button>
            </form>
        </div>
    </template>

    <!-- 2FA Management Section -->
    <template id="2fa-management-template">
        <div class="p-6 bg-white rounded-xl shadow-lg">
            <h2 class="text-3xl font-bold text-gray-800 mb-6">Two-Factor Authentication (2FA)</h2>

            <div class="flex items-center mb-6">
                <span id="2fa-status-badge" class="px-4 py-2 rounded-full text-lg font-semibold">
                    Status: Disabled
                </span>
            </div>

            <div class="space-y-4">
                <button
                    id="enable-2fa-button"
                    class="px-6 py-3 bg-indigo-600 text-white font-semibold rounded-lg shadow-md hover:bg-indigo-700 transition duration-200 ease-in-out disabled:opacity-50 disabled:cursor-not-allowed"
                >
                    Enable 2FA
                </button>
                <button
                    id="disable-2fa-button"
                    class="px-6 py-3 bg-red-600 text-white font-semibold rounded-lg shadow-md hover:bg-red-700 transition duration-200 ease-in-out disabled:opacity-50 disabled:cursor-not-allowed hidden"
                >
                    Disable 2FA
                </button>
            </div>

            <!-- 2FA Enable Modal -->
            <div id="2fa-enable-modal" class="fixed inset-0 bg-gray-600 bg-opacity-75 flex items-center justify-center z-50 p-4 hidden">
                <div class="bg-white rounded-xl shadow-2xl w-full max-w-md p-6 text-center">
                    <h3 class="text-2xl font-bold text-gray-800 mb-6">Enable Two-Factor Authentication</h3>
                    <div id="2fa-qr-container" class="mb-6 flex justify-center">
                        <img id="2fa-qr-image" src="" alt="2FA QR Code" class="w-48 h-48 border border-gray-200 rounded-lg shadow-sm hidden" />
                    </div>
                    <p class="text-gray-700 mb-4">Scan this QR code with your authenticator app (e.g., Google Authenticator, Authy).</p>
                    <div class="mb-6">
                        <label class="block text-sm font-medium text-gray-700 mb-1" for="2fa-totp-code-verify">Enter 6-digit code from app</label>
                        <input
                            id="2fa-totp-code-verify"
                            type="text"
                            class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500 transition duration-150 ease-in-out text-center text-xl tracking-widest"
                            placeholder="******"
                            maxlength="6"
                            required
                        />
                    </div>
                    <div class="flex justify-end space-x-4">
                        <button type="button" id="cancel-2fa-button" class="px-5 py-2 border border-gray-300 rounded-lg text-gray-700 hover:bg-gray-100 transition duration-150 ease-in-out">
                            Cancel
                        </button>
                        <button
                            id="verify-2fa-button"
                            class="px-5 py-2 bg-indigo-600 text-white font-semibold rounded-lg shadow-md hover:bg-indigo-700 transition duration-150 ease-in-out disabled:opacity-50 disabled:cursor-not-allowed"
                        >
                            Verify & Enable
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </template>

    <!-- Dashboard Home Section -->
    <template id="dashboard-home-template">
        <div class="p-6 bg-white rounded-xl shadow-lg">
            <h2 class="text-3xl font-bold text-gray-800 mb-6">Welcome to Your Dashboard!</h2>
            <p class="text-gray-700">Use the sidebar to navigate through different management sections.</p>
            <div class="mt-8 grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                <div class="bg-blue-50 p-6 rounded-lg shadow-md hover:shadow-xl transition-shadow duration-200">
                    <h3 class="text-xl font-semibold text-blue-800 mb-2">WhatsApp Bot</h3>
                    <p class="text-gray-600">Monitor bot status, QR code, and logs.</p>
                    <a href="#/dashboard/whatsapp" class="mt-4 text-blue-600 hover:underline font-medium block">Go to Status &rarr;</a>
                </div>
                <div class="bg-green-50 p-6 rounded-lg shadow-md hover:shadow-xl transition-shadow duration-200">
                    <h3 class="text-xl font-semibold text-green-800 mb-2">Menu Items</h3>
                    <p class="text-gray-600">Add, edit, or remove food items.</p>
                    <a href="#/dashboard/menu" class="mt-4 text-green-600 hover:underline font-medium block">Manage Menu &rarr;</a>
                </div>
                <div class="bg-purple-50 p-6 rounded-lg shadow-md hover:shadow-xl transition-shadow duration-200">
                    <h3 class="text-xl font-semibold text-purple-800 mb-2">Customer Orders</h3>
                    <p class="text-gray-600">View and update customer orders.</p>
                    <a href="#/dashboard/orders" class="mt-4 text-purple-600 hover:underline font-medium block">View Orders &rarr;</a>
                </div>
                <div class="bg-yellow-50 p-6 rounded-lg shadow-md hover:shadow-xl transition-shadow duration-200">
                    <h3 class="text-xl font-semibold text-yellow-800 mb-2">Customer List</h3>
                    <p class="text-gray-600">View and manage customer details.</p>
                    <a href="#/dashboard/customers" class="mt-4 text-yellow-600 hover:underline font-medium block">View Customers &rarr;</a>
                </div>
                 <div class="bg-red-50 p-6 rounded-lg shadow-md hover:shadow-xl transition-shadow duration-200">
                    <h3 class="text-xl font-semibold text-red-800 mb-2">Shop Settings</h3>
                    <p class="text-gray-600">Configure shop details, delivery rates, and discounts.</p>
                    <a href="#/dashboard/settings" class="mt-4 text-red-600 hover:underline font-medium block">Manage Settings &rarr;</a>
                </div>
                 <div class="bg-pink-50 p-6 rounded-lg shadow-md hover:shadow-xl transition-shadow duration-200">
                    <h3 class="text-xl font-semibold text-pink-800 mb-2">2FA Settings</h3>
                    <p class="text-gray-600">Enable or disable Two-Factor Authentication.</p>
                    <a href="#/dashboard/2fa" class="mt-4 text-pink-600 hover:underline font-medium block">Manage 2FA &rarr;</a>
                </div>
            </div>
        </div>
    </template>

    <script>
        const API_BASE_URL = 'http://localhost:3000/api/admin';
        const LOGIN_URL = 'http://localhost:3000/admin/login';

        // --- Global State Variables ---
        let isAuthenticated = false;
        let currentPath = window.location.hash.substring(1) || '/dashboard'; // Use hash for routing
        let notificationTimeout;
        let whatsappSocket;
        let whatsappStatusData = {
            status: 'disconnected',
            qrCodeUrl: null,
            lastAuthenticatedAt: null,
            logs: []
        };
        let twoFactorTempSecret = ''; // Temporarily store 2FA secret for verification

        // --- DOM Elements ---
        const loginPage = document.getElementById('login-page');
        const dashboardLayout = document.getElementById('dashboard-layout');
        const mainContent = document.getElementById('main-content');
        const loginForm = document.getElementById('login-form');
        const loginUsernameInput = document.getElementById('login-username');
        const loginPasswordInput = document.getElementById('login-password');
        const totpInputContainer = document.getElementById('totp-input-container');
        const loginTotpCodeInput = document.getElementById('login-totp-code');
        const loginButton = document.getElementById('login-button');
        const logoutButton = document.getElementById('logout-button');
        const sidebarToggle = document.getElementById('sidebar-toggle');
        const sidebar = document.getElementById('sidebar');
        const notificationToast = document.getElementById('notification-toast');
        const notificationMessage = document.getElementById('notification-message');
        const notificationCloseButton = document.getElementById('notification-close');

        // --- Utility Functions ---

        /**
         * Displays a toast notification.
         * @param {string} message - The message to display.
         * @param {'success'|'error'|'info'} type - The type of notification.
         */
        function showNotification(message, type) {
            clearTimeout(notificationTimeout);
            notificationMessage.textContent = message;
            notificationToast.className = `fixed bottom-4 right-4 p-4 rounded-lg shadow-lg text-white z-50 flex items-center justify-between animate-fade-in-up`;
            if (type === 'success') {
                notificationToast.classList.add('bg-green-500');
            } else if (type === 'error') {
                notificationToast.classList.add('bg-red-500');
            } else if (type === 'info') {
                notificationToast.classList.add('bg-blue-500');
            }
            notificationToast.classList.remove('hidden');

            notificationTimeout = setTimeout(() => {
                notificationToast.classList.add('hidden');
            }, 5000);
        }

        notificationCloseButton.addEventListener('click', () => {
            notificationToast.classList.add('hidden');
            clearTimeout(notificationTimeout);
        });

        /**
         * Fetches data from the API with authentication token.
         * Handles token expiration and redirects to login.
         * @param {string} url - The API endpoint URL.
         * @param {object} options - Fetch options (method, headers, body, etc.).
         * @returns {Promise<Response>} The fetch response.
         */
        async function fetchWithAuth(url, options = {}) {
            const token = localStorage.getItem('adminToken');
            const headers = {
                'Content-Type': 'application/json',
                ...options.headers,
            };
            if (token) {
                headers['Authorization'] = `Bearer ${token}`;
            }

            const response = await fetch(url, { ...options, headers });

            if (response.status === 401 || response.status === 403) {
                // If unauthorized or forbidden, clear token and redirect to login
                localStorage.removeItem('adminToken');
                isAuthenticated = false;
                navigateTo('/admin/login'); // Redirect to login page
                showNotification('Session expired or unauthorized. Please log in again.', 'error');
                throw new Error('Authentication failed. Please log in again.');
            }

            return response;
        }

        /**
         * Shows a specific section and hides others.
         * @param {HTMLElement} sectionToShow - The DOM element to show.
         */
        function showSection(sectionToShow) {
            document.querySelectorAll('.page-section').forEach(section => {
                section.style.display = 'none';
            });
            sectionToShow.style.display = 'flex'; // Use flex for login, dashboard-layout
            if (sectionToShow.id === 'dashboard-layout') {
                 sectionToShow.style.display = 'flex'; // Ensure dashboard layout is flex
            } else {
                 sectionToShow.style.display = 'flex';
            }
        }

        /**
         * Navigates to a new path and updates the UI.
         * @param {string} path - The new path (e.g., '/dashboard/menu').
         */
        function navigateTo(path) {
            window.location.hash = path;
            currentPath = path;
            renderPage();
            updateSidebarActiveLink();
        }

        /**
         * Updates the active state of sidebar links.
         */
        function updateSidebarActiveLink() {
            document.querySelectorAll('.sidebar-link').forEach(link => {
                if (link.getAttribute('href') === `#${currentPath}`) {
                    link.classList.add('active');
                } else {
                    link.classList.remove('active');
                }
            });
        }

        /**
         * Renders the appropriate page based on the current path.
         */
        async function renderPage() {
            if (!isAuthenticated && currentPath !== '/admin/login') {
                navigateTo('/admin/login');
                return;
            }

            if (currentPath === '/admin/login') {
                showSection(loginPage);
                return;
            }

            showSection(dashboardLayout);
            mainContent.innerHTML = ''; // Clear previous content

            let templateId;
            switch (currentPath) {
                case '/dashboard':
                    templateId = 'dashboard-home-template';
                    break;
                case '/dashboard/whatsapp':
                    templateId = 'whatsapp-status-template';
                    break;
                case '/dashboard/menu':
                    templateId = 'menu-management-template';
                    break;
                case '/dashboard/orders':
                    templateId = 'order-management-template';
                    break;
                case '/dashboard/customers':
                    templateId = 'customer-management-template';
                    break;
                case '/dashboard/settings':
                    templateId = 'settings-management-template';
                    break;
                case '/dashboard/2fa':
                    templateId = '2fa-management-template';
                    break;
                default:
                    // Fallback for unknown dashboard paths
                    templateId = 'dashboard-home-template';
                    navigateTo('/dashboard'); // Redirect to dashboard home
                    break;
            }

            const template = document.getElementById(templateId);
            if (template) {
                const clone = document.importNode(template.content, true);
                mainContent.appendChild(clone);
                // After appending, initialize specific page logic
                switch (currentPath) {
                    case '/dashboard/whatsapp':
                        initWhatsAppStatusPage();
                        break;
                    case '/dashboard/menu':
                        initMenuManagementPage();
                        break;
                    case '/dashboard/orders':
                        initOrderManagementPage();
                        break;
                    case '/dashboard/customers':
                        initCustomerManagementPage();
                        break;
                    case '/dashboard/settings':
                        initSettingsManagementPage();
                        break;
                    case '/dashboard/2fa':
                        init2FAManagementPage();
                        break;
                }
            }
            updateSidebarActiveLink();
        }

        // --- Authentication Logic ---
        async function handleLogin(e) {
            e.preventDefault();
            loginButton.textContent = 'Logging in...';
            loginButton.disabled = true;

            const username = loginUsernameInput.value;
            const password = loginPasswordInput.value;
            const totpCode = loginTotpCodeInput.value;

            try {
                const response = await fetch(LOGIN_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ username, password, totpCode })
                });

                const data = await response.json();

                if (response.ok) {
                    if (data.twoFactorEnabled && !totpCode) {
                        totpInputContainer.classList.remove('hidden');
                        showNotification('Two-Factor Authentication required. Enter code.', 'info');
                    } else {
                        localStorage.setItem('adminToken', data.token);
                        isAuthenticated = true;
                        showNotification('Login successful!', 'success');
                        navigateTo('/dashboard');
                    }
                } else {
                    showNotification(data.message || 'Login failed.', 'error');
                }
            } catch (error) {
                console.error('Login error:', error);
                showNotification('Network error or server unavailable.', 'error');
            } finally {
                loginButton.textContent = 'Login';
                loginButton.disabled = false;
            }
        }

        function handleLogout() {
            localStorage.removeItem('adminToken');
            isAuthenticated = false;
            showNotification('Logged out successfully.', 'success');
            navigateTo('/admin/login');
        }

        function checkAuthentication() {
            const token = localStorage.getItem('adminToken');
            if (token) {
                // Simple check: assume token is valid for now.
                // In a real app, you'd verify with a backend endpoint.
                isAuthenticated = true;
            } else {
                isAuthenticated = false;
            }
        }

        // --- WhatsApp Bot Status Page Logic ---
        function initWhatsAppStatusPage() {
            const whatsappStatusBadge = document.getElementById('whatsapp-status-badge');
            const whatsappStatusText = document.getElementById('whatsapp-status-text');
            const lastAuthenticatedAtElem = document.getElementById('last-authenticated-at');
            const qrCodeImage = document.getElementById('qr-code-image');
            const noQrMessage = document.getElementById('no-qr-message');
            const qrScanMessage = document.getElementById('qr-scan-message');
            const qrExpiryMessage = document.getElementById('qr-expiry-message');
            const whatsappLogsContainer = document.getElementById('whatsapp-logs');
            const reinitializeButton = document.getElementById('reinitialize-session-button');

            function updateStatusUI() {
                whatsappStatusText.textContent = whatsappStatusData.status.replace(/_/g, ' ');
                whatsappStatusBadge.textContent = whatsappStatusData.status.charAt(0).toUpperCase() + whatsappStatusData.status.slice(1);

                // Update badge color
                whatsappStatusBadge.className = `w-24 h-24 rounded-full flex items-center justify-center text-white text-xl font-semibold mb-4`;
                switch (whatsappStatusData.status) {
                    case 'ready': whatsappStatusBadge.classList.add('bg-green-500'); break;
                    case 'authenticated': whatsappStatusBadge.classList.add('bg-yellow-500'); break;
                    case 'qr_received': whatsappStatusBadge.classList.add('bg-blue-500'); break;
                    case 'initializing': whatsappStatusBadge.classList.add('bg-purple-500'); break;
                    case 'auth_failure':
                    case 'qr_error':
                    case 'disconnected': whatsappStatusBadge.classList.add('bg-red-500'); break;
                    default: whatsappStatusBadge.classList.add('bg-gray-500'); break;
                }

                if (whatsappStatusData.lastAuthenticatedAt) {
                    lastAuthenticatedAtElem.textContent = `Last Connected: ${whatsappStatusData.lastAuthenticatedAt}`;
                    lastAuthenticatedAtElem.classList.remove('hidden');
                } else {
                    lastAuthenticatedAtElem.classList.add('hidden');
                }

                if (whatsappStatusData.qrCodeUrl) {
                    qrCodeImage.src = whatsappStatusData.qrCodeUrl;
                    qrCodeImage.classList.remove('hidden');
                    noQrMessage.classList.add('hidden');
                    qrScanMessage.classList.remove('hidden');
                    qrExpiryMessage.classList.remove('hidden');
                } else {
                    qrCodeImage.classList.add('hidden');
                    noQrMessage.classList.remove('hidden');
                    qrScanMessage.classList.add('hidden');
                    qrExpiryMessage.classList.add('hidden');
                }

                whatsappLogsContainer.innerHTML = whatsappStatusData.logs.length > 0
                    ? whatsappStatusData.logs.map(log => `<p class="mb-1">${log}</p>`).join('')
                    : '<p class="text-gray-500">No logs yet.</p>';

                reinitializeButton.disabled = whatsappStatusData.status === 'initializing';
                reinitializeButton.textContent = whatsappStatusData.status === 'initializing' ? 'Initializing...' : 'Re-initialize Session';
            }

            // Initialize Socket.io connection if not already connected
            if (!whatsappSocket) {
                whatsappSocket = io('http://localhost:3000');

                whatsappSocket.on('status', (newStatus) => {
                    whatsappStatusData.status = newStatus;
                    updateStatusUI();
                });

                whatsappSocket.on('qrCode', (qrDataUrl) => {
                    whatsappStatusData.qrCodeUrl = qrDataUrl;
                    updateStatusUI();
                });

                whatsappSocket.on('sessionInfo', (info) => {
                    whatsappStatusData.lastAuthenticatedAt = info.lastAuthenticatedAt ? new Date(info.lastAuthenticatedAt).toLocaleString() : null;
                    updateStatusUI();
                });

                whatsappSocket.on('whatsapp_log', (logMessage) => {
                    whatsappStatusData.logs.push(`[${new Date().toLocaleTimeString()}] ${logMessage}`);
                    whatsappStatusData.logs = whatsappStatusData.logs.slice(-50); // Keep last 50 logs
                    updateStatusUI();
                });
            }

            // Initial fetch of status when component mounts
            async function fetchInitialStatus() {
                try {
                    const response = await fetchWithAuth(`${API_BASE_URL}/bot-status`);
                    const data = await response.json();
                    whatsappStatusData.status = data.status;
                    whatsappStatusData.lastAuthenticatedAt = data.lastAuthenticatedAt ? new Date(data.lastAuthenticatedAt).toLocaleString() : null;
                    // QR code is usually sent via socket.io, but if it's available and socket missed it,
                    // the backend might re-send on re-initialization.
                    // For now, we rely on socket.io for QR.
                    updateStatusUI();
                } catch (error) {
                    console.error('Error fetching initial bot status:', error);
                    showNotification('Failed to fetch bot status.', 'error');
                }
            }
            fetchInitialStatus();

            reinitializeButton.onclick = async () => {
                showNotification('', ''); // Clear any previous notification
                try {
                    const response = await fetchWithAuth(`${API_BASE_URL}/load-session`, { method: 'POST' });
                    const data = await response.json();
                    showNotification(data.message, 'success');
                } catch (error) {
                    console.error('Error loading session:', error);
                    showNotification(error.message || 'Failed to load session.', 'error');
                }
            };
        }

        // --- Menu Management Page Logic ---
        function initMenuManagementPage() {
            const addMenuItemButton = document.getElementById('add-menu-item-button');
            const menuLoadingMessage = document.getElementById('menu-loading-message');
            const menuItemsTableBody = document.getElementById('menu-items-table-body');
            const menuItemModal = document.getElementById('menu-item-modal');
            const menuItemModalTitle = document.getElementById('menu-item-modal-title');
            const menuItemForm = document.getElementById('menu-item-form');
            const menuItemIdInput = document.getElementById('menu-item-id');
            const menuItemNameInput = document.getElementById('menu-item-name');
            const menuItemDescriptionInput = document.getElementById('menu-item-description');
            const menuItemPriceInput = document.getElementById('menu-item-price');
            const menuItemImageUrlInput = document.getElementById('menu-item-image-url');
            const menuItemCategoryInput = document.getElementById('menu-item-category');
            const menuItemIsAvailableInput = document.getElementById('menu-item-is-available');
            const menuItemIsTrendingInput = document.getElementById('menu-item-is-trending');
            const cancelMenuItemButton = document.getElementById('cancel-menu-item-button');
            const submitMenuItemButton = document.getElementById('submit-menu-item-button');

            let currentEditingItem = null; // Stores the item object being edited

            async function fetchMenuItems() {
                menuLoadingMessage.classList.remove('hidden');
                menuItemsTableBody.innerHTML = ''; // Clear table
                try {
                    const response = await fetchWithAuth(`${API_BASE_URL}/menu`);
                    const items = await response.json();
                    menuItemsTableBody.innerHTML = ''; // Clear existing rows
                    if (items.length === 0) {
                        menuItemsTableBody.innerHTML = '<tr><td colspan="7" class="px-6 py-4 text-center text-gray-500">No menu items found.</td></tr>';
                    } else {
                        items.forEach(item => {
                            const row = document.createElement('tr');
                            row.className = 'hover:bg-gray-50';
                            row.innerHTML = `
                                <td class="px-6 py-4 whitespace-nowrap">
                                    <img src="${item.imageUrl || 'https://placehold.co/50x50/cccccc/ffffff?text=No+Img'}" alt="${item.name}" class="h-12 w-12 rounded-full object-cover" onerror="this.onerror=null;this.src='https://placehold.co/50x50/cccccc/ffffff?text=No+Img';" />
                                </td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${item.name}</td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${item.category || 'N/A'}</td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">â‚¹${item.price.toFixed(2)}</td>
                                <td class="px-6 py-4 whitespace-nowrap">
                                    <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${item.isAvailable ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'}">
                                        ${item.isAvailable ? 'Yes' : 'No'}
                                    </span>
                                </td>
                                <td class="px-6 py-4 whitespace-nowrap">
                                    <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${item.isTrending ? 'bg-blue-100 text-blue-800' : 'bg-gray-100 text-gray-800'}">
                                        ${item.isTrending ? 'Yes' : 'No'}
                                    </span>
                                </td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                                    <button data-id="${item._id}" class="edit-item-button text-indigo-600 hover:text-indigo-900 mr-4">Edit</button>
                                    <button data-id="${item._id}" class="delete-item-button text-red-600 hover:text-red-900">Delete</button>
                                </td>
                            `;
                            menuItemsTableBody.appendChild(row);
                        });
                        addEventListenersToMenuButtons();
                    }
                } catch (error) {
                    console.error('Error fetching menu items:', error);
                    showNotification('Failed to fetch menu items.', 'error');
                    menuItemsTableBody.innerHTML = '<tr><td colspan="7" class="px-6 py-4 text-center text-red-500">Error loading menu items.</td></tr>';
                } finally {
                    menuLoadingMessage.classList.add('hidden');
                }
            }

            function addEventListenersToMenuButtons() {
                document.querySelectorAll('.edit-item-button').forEach(button => {
                    button.onclick = () => {
                        const itemId = button.dataset.id;
                        const item = menuItemsTableBody.querySelector(`button[data-id="${itemId}"]`).closest('tr');
                        currentEditingItem = {
                            _id: itemId,
                            name: item.children[1].textContent,
                            description: '', // Desc not in table, will fetch or leave empty
                            price: parseFloat(item.children[3].textContent.replace('â‚¹', '')),
                            imageUrl: item.children[0].querySelector('img').src,
                            category: item.children[2].textContent,
                            isAvailable: item.children[4].textContent.trim() === 'Yes',
                            isTrending: item.children[5].textContent.trim() === 'Yes'
                        };
                        // Fetch full item details for description if needed, or leave empty for quick edit
                        fetch(`${API_BASE_URL}/menu/${itemId}`, {
                            headers: { 'Authorization': `Bearer ${localStorage.getItem('adminToken')}` }
                        })
                        .then(res => res.json())
                        .then(data => {
                            if (data) {
                                currentEditingItem.description = data.description || '';
                            }
                            openMenuItemModal();
                        })
                        .catch(err => {
                            console.error('Error fetching full item details:', err);
                            showNotification('Failed to load full item details.', 'error');
                            openMenuItemModal(); // Open modal with partial data
                        });
                    };
                });
                document.querySelectorAll('.delete-item-button').forEach(button => {
                    button.onclick = () => handleDeleteMenuItem(button.dataset.id);
                });
            }

            function openMenuItemModal() {
                if (currentEditingItem) {
                    menuItemModalTitle.textContent = 'Edit Menu Item';
                    menuItemIdInput.value = currentEditingItem._id;
                    menuItemNameInput.value = currentEditingItem.name;
                    menuItemDescriptionInput.value = currentEditingItem.description;
                    menuItemPriceInput.value = currentEditingItem.price;
                    menuItemImageUrlInput.value = currentEditingItem.imageUrl;
                    menuItemCategoryInput.value = currentEditingItem.category;
                    menuItemIsAvailableInput.checked = currentEditingItem.isAvailable;
                    menuItemIsTrendingInput.checked = currentEditingItem.isTrending;
                    submitMenuItemButton.textContent = 'Update Item';
                } else {
                    menuItemModalTitle.textContent = 'Add New Menu Item';
                    menuItemForm.reset(); // Clear form for new item
                    menuItemIdInput.value = '';
                    menuItemIsAvailableInput.checked = true; // Default to available
                    menuItemIsTrendingInput.checked = false; // Default to not trending
                    submitMenuItemButton.textContent = 'Add Item';
                }
                menuItemModal.classList.remove('hidden');
            }

            async function handleMenuItemSubmit(e) {
                e.preventDefault();
                submitMenuItemButton.disabled = true;
                submitMenuItemButton.textContent = currentEditingItem ? 'Updating...' : 'Adding...';

                const formData = {
                    name: menuItemNameInput.value,
                    description: menuItemDescriptionInput.value,
                    price: parseFloat(menuItemPriceInput.value),
                    imageUrl: menuItemImageUrlInput.value,
                    category: menuItemCategoryInput.value,
                    isAvailable: menuItemIsAvailableInput.checked,
                    isTrending: menuItemIsTrendingInput.checked
                };

                const method = currentEditingItem ? 'PUT' : 'POST';
                const url = currentEditingItem ? `${API_BASE_URL}/menu/${currentEditingItem._id}` : `${API_BASE_URL}/menu`;

                try {
                    const response = await fetchWithAuth(url, {
                        method,
                        body: JSON.stringify(formData)
                    });

                    if (response.ok) {
                        showNotification(`Item ${currentEditingItem ? 'updated' : 'added'} successfully!`, 'success');
                        menuItemModal.classList.add('hidden');
                        fetchMenuItems();
                    } else {
                        const errorData = await response.json();
                        showNotification(errorData.message || `Failed to ${currentEditingItem ? 'update' : 'add'} item.`, 'error');
                    }
                } catch (error) {
                    console.error(`Error ${currentEditingItem ? 'updating' : 'adding'} item:`, error);
                    showNotification('Network error or server unavailable.', 'error');
                } finally {
                    submitMenuItemButton.disabled = false;
                    submitMenuItemButton.textContent = currentEditingItem ? 'Update Item' : 'Add Item';
                }
            }

            async function handleDeleteMenuItem(id) {
                if (!confirm('Are you sure you want to delete this item?')) return;
                try {
                    const response = await fetchWithAuth(`${API_BASE_URL}/menu/${id}`, { method: 'DELETE' });
                    if (response.ok) {
                        showNotification('Item deleted successfully!', 'success');
                        fetchMenuItems();
                    } else {
                        const errorData = await response.json();
                        showNotification(errorData.message || 'Failed to delete item.', 'error');
                    }
                } catch (error) {
                    console.error('Error deleting item:', error);
                    showNotification('Network error or server unavailable.', 'error');
                }
            }

            // Event Listeners
            addMenuItemButton.onclick = () => {
                currentEditingItem = null;
                openMenuItemModal();
            };
            cancelMenuItemButton.onclick = () => menuItemModal.classList.add('hidden');
            menuItemForm.onsubmit = handleMenuItemSubmit;

            fetchMenuItems(); // Initial fetch
        }

        // --- Order Management Page Logic ---
        function initOrderManagementPage() {
            const orderLoadingMessage = document.getElementById('order-loading-message');
            const orderItemsTableBody = document.getElementById('order-items-table-body');
            const orderStatusFilter = document.getElementById('order-status-filter');

            let allOrders = []; // Store all fetched orders for filtering

            async function fetchOrders() {
                orderLoadingMessage.classList.remove('hidden');
                orderItemsTableBody.innerHTML = ''; // Clear table
                try {
                    const response = await fetchWithAuth(`${API_BASE_URL}/orders`);
                    const data = await response.json();
                    allOrders = data.sort((a, b) => new Date(b.orderDate) - new Date(a.orderDate)); // Sort by date descending
                    renderFilteredOrders();
                } catch (error) {
                    console.error('Error fetching orders:', error);
                    showNotification('Failed to fetch orders.', 'error');
                    orderItemsTableBody.innerHTML = '<tr><td colspan="9" class="px-6 py-4 text-center text-red-500">Error loading orders.</td></tr>';
                } finally {
                    orderLoadingMessage.classList.add('hidden');
                }
            }

            function renderFilteredOrders() {
                const filterStatus = orderStatusFilter.value;
                const filteredOrders = filterStatus === 'All'
                    ? allOrders
                    : allOrders.filter(order => order.status === filterStatus);

                orderItemsTableBody.innerHTML = ''; // Clear existing rows
                if (filteredOrders.length === 0) {
                    orderItemsTableBody.innerHTML = '<tr><td colspan="9" class="px-6 py-4 text-center text-gray-500">No orders found for the selected filter.</td></tr>';
                } else {
                    filteredOrders.forEach(order => {
                        const row = document.createElement('tr');
                        row.className = 'hover:bg-gray-50';
                        const statusBadgeClass = getStatusBadgeClass(order.status);
                        row.innerHTML = `
                            <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${order.customOrderId || order._id.substring(0, 8)}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${order.customerName || 'N/A'}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${order.customerPhone || 'N/A'}</td>
                            <td class="px-6 py-4 text-sm text-gray-500">
                                ${order.items.map(item => `${item.name} x ${item.quantity}`).join(', ')}
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">â‚¹${order.totalAmount.toFixed(2)}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                                ${new Date(order.orderDate).toLocaleString('en-IN', { timeZone: 'Asia/Kolkata' })}
                            </td>
                            <td class="px-6 py-4 text-sm text-gray-500 max-w-xs truncate">${order.deliveryAddress || 'N/A'}</td>
                            <td class="px-6 py-4 whitespace-nowrap">
                                <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${statusBadgeClass}">
                                    ${order.status}
                                </span>
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                                <select data-id="${order._id}" class="order-status-select block w-full py-2 px-3 border border-gray-300 bg-white rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm">
                                    <option value="Pending" ${order.status === 'Pending' ? 'selected' : ''}>Pending</option>
                                    <option value="Confirmed" ${order.status === 'Confirmed' ? 'selected' : ''}>Confirmed</option>
                                    <option value="Preparing" ${order.status === 'Preparing' ? 'selected' : ''}>Preparing</option>
                                    <option value="Out for Delivery" ${order.status === 'Out for Delivery' ? 'selected' : ''}>Out for Delivery</option>
                                    <option value="Delivered" ${order.status === 'Delivered' ? 'selected' : ''}>Delivered</option>
                                    <option value="Cancelled" ${order.status === 'Cancelled' ? 'selected' : ''}>Cancelled</option>
                                </select>
                                <button data-id="${order._id}" class="delete-order-button mt-2 text-red-600 hover:text-red-900 text-sm">
                                    Delete
                                </button>
                            </td>
                        `;
                        orderItemsTableBody.appendChild(row);
                    });
                    addEventListenersToOrderButtons();
                }
            }

            function addEventListenersToOrderButtons() {
                document.querySelectorAll('.order-status-select').forEach(select => {
                    select.onchange = (e) => handleOrderStatusChange(select.dataset.id, e.target.value);
                });
                document.querySelectorAll('.delete-order-button').forEach(button => {
                    button.onclick = () => handleDeleteOrder(button.dataset.id);
                });
            }

            function getStatusBadgeClass(status) {
                switch (status) {
                    case 'Pending': return 'bg-yellow-100 text-yellow-800';
                    case 'Confirmed': return 'bg-blue-100 text-blue-800';
                    case 'Preparing': return 'bg-purple-100 text-purple-800';
                    case 'Out for Delivery': return 'bg-indigo-100 text-indigo-800';
                    case 'Delivered': return 'bg-green-100 text-green-800';
                    case 'Cancelled': return 'bg-red-100 text-red-800';
                    default: return 'bg-gray-100 text-gray-800';
                }
            }

            async function handleOrderStatusChange(orderId, newStatus) {
                try {
                    const response = await fetchWithAuth(`${API_BASE_URL}/orders/${orderId}`, {
                        method: 'PUT',
                        body: JSON.stringify({ status: newStatus })
                    });

                    if (response.ok) {
                        showNotification('Order status updated successfully!', 'success');
                        fetchOrders(); // Re-fetch to update the local data
                    } else {
                        const errorData = await response.json();
                        showNotification(errorData.message || 'Failed to update order status.', 'error');
                    }
                } catch (error) {
                    console.error('Error updating order status:', error);
                    showNotification('Network error or server unavailable.', 'error');
                }
            }

            async function handleDeleteOrder(orderId) {
                if (!confirm('Are you sure you want to delete this order? This action cannot be undone.')) return;
                try {
                    const response = await fetchWithAuth(`${API_BASE_URL}/orders/${orderId}`, { method: 'DELETE' });
                    if (response.ok) {
                        showNotification('Order deleted successfully!', 'success');
                        fetchOrders();
                    } else {
                        const errorData = await response.json();
                        showNotification(errorData.message || 'Failed to delete order.', 'error');
                    }
                } catch (error) {
                    console.error('Error deleting order:', error);
                    showNotification('Network error or server unavailable.', 'error');
                }
            }

            // Event Listeners
            orderStatusFilter.onchange = renderFilteredOrders;

            // Listen for new orders via Socket.io
            if (!whatsappSocket) { // Ensure socket is initialized, if not, it will be by whatsapp page
                whatsappSocket = io('http://localhost:3000');
            }
            whatsappSocket.off('new_order'); // Remove previous listener to avoid duplicates
            whatsappSocket.on('new_order', (newOrder) => {
                showNotification(`New Order Received! ID: ${newOrder.customOrderId}`, 'success');
                allOrders.unshift(newOrder); // Add to the beginning
                allOrders.sort((a, b) => new Date(b.orderDate) - new Date(a.orderDate)); // Re-sort
                renderFilteredOrders();
            });

            fetchOrders(); // Initial fetch
        }

        // --- Customer Management Page Logic ---
        function initCustomerManagementPage() {
            const customerLoadingMessage = document.getElementById('customer-loading-message');
            const customerItemsTableBody = document.getElementById('customer-items-table-body');

            async function fetchCustomers() {
                customerLoadingMessage.classList.remove('hidden');
                customerItemsTableBody.innerHTML = ''; // Clear table
                try {
                    const response = await fetchWithAuth(`${API_BASE_URL}/customers`);
                    const customers = await response.json();
                    customerItemsTableBody.innerHTML = ''; // Clear existing rows
                    if (customers.length === 0) {
                        customerItemsTableBody.innerHTML = '<tr><td colspan="6" class="px-6 py-4 text-center text-gray-500">No customers found.</td></tr>';
                    } else {
                        customers.forEach(customer => {
                            const row = document.createElement('tr');
                            row.className = 'hover:bg-gray-50';
                            row.innerHTML = `
                                <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${customer.customerName || 'N/A'}</td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${customer.customerPhone || 'N/A'}</td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${customer.totalOrders || 0}</td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                                    ${customer.lastOrderDate ? new Date(customer.lastOrderDate).toLocaleDateString() : 'N/A'}
                                </td>
                                <td class="px-6 py-4 text-sm text-gray-500 max-w-xs truncate">
                                    ${customer.lastKnownLocation?.address || 'N/A'}
                                </td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                                    <button data-id="${customer._id}" class="delete-customer-button text-red-600 hover:text-red-900">Delete</button>
                                </td>
                            `;
                            customerItemsTableBody.appendChild(row);
                        });
                        addEventListenersToCustomerButtons();
                    }
                } catch (error) {
                    console.error('Error fetching customers:', error);
                    showNotification('Failed to fetch customers.', 'error');
                    customerItemsTableBody.innerHTML = '<tr><td colspan="6" class="px-6 py-4 text-center text-red-500">Error loading customers.</td></tr>';
                } finally {
                    customerLoadingMessage.classList.add('hidden');
                }
            }

            function addEventListenersToCustomerButtons() {
                document.querySelectorAll('.delete-customer-button').forEach(button => {
                    button.onclick = () => handleDeleteCustomer(button.dataset.id);
                });
            }

            async function handleDeleteCustomer(id) {
                if (!confirm('Are you sure you want to delete this customer and their associated data?')) return;
                try {
                    const response = await fetchWithAuth(`${API_BASE_URL}/customers/${id}`, { method: 'DELETE' });
                    if (response.ok) {
                        showNotification('Customer deleted successfully!', 'success');
                        fetchCustomers();
                    } else {
                        const errorData = await response.json();
                        showNotification(errorData.message || 'Failed to delete customer.', 'error');
                    }
                } catch (error) {
                    console.error('Error deleting customer:', error);
                    showNotification('Network error or server unavailable.', 'error');
                }
            }

            fetchCustomers(); // Initial fetch
        }

        // --- Settings Management Page Logic ---
        function initSettingsManagementPage() {
            const settingsLoadingMessage = document.getElementById('settings-loading-message');
            const settingsForm = document.getElementById('settings-form');
            const shopNameInput = document.getElementById('shop-name');
            const shopLatitudeInput = document.getElementById('shop-latitude');
            const shopLongitudeInput = document.getElementById('shop-longitude');
            const deliveryRatesContainer = document.getElementById('delivery-rates-container');
            const addDeliveryRateButton = document.getElementById('add-delivery-rate-button');
            const isDiscountEnabledCheckbox = document.getElementById('is-discount-enabled');
            const minSubtotalForDiscountInput = document.getElementById('min-subtotal-for-discount');
            const discountPercentageInput = document.getElementById('discount-percentage');
            const saveSettingsButton = document.getElementById('save-settings-button');

            let currentSettings = {
                shopName: '',
                shopLocation: { latitude: '', longitude: '' },
                deliveryRates: [],
                minSubtotalForDiscount: 0,
                discountPercentage: 0,
                isDiscountEnabled: true
            };

            async function fetchSettings() {
                settingsLoadingMessage.classList.remove('hidden');
                try {
                    const response = await fetchWithAuth(`${API_BASE_URL}/settings`);
                    const data = await response.json();
                    currentSettings = {
                        shopName: data.shopName || '',
                        shopLocation: {
                            latitude: data.shopLocation?.latitude || '',
                            longitude: data.shopLocation?.longitude || ''
                        },
                        deliveryRates: data.deliveryRates || [],
                        minSubtotalForDiscount: data.minSubtotalForDiscount || 0,
                        discountPercentage: data.discountPercentage || 0,
                        isDiscountEnabled: data.isDiscountEnabled !== undefined ? data.isDiscountEnabled : true
                    };
                    populateSettingsForm();
                } catch (error) {
                    console.error('Error fetching settings:', error);
                    showNotification('Failed to fetch settings.', 'error');
                } finally {
                    settingsLoadingMessage.classList.add('hidden');
                }
            }

            function populateSettingsForm() {
                shopNameInput.value = currentSettings.shopName;
                shopLatitudeInput.value = currentSettings.shopLocation.latitude;
                shopLongitudeInput.value = currentSettings.shopLocation.longitude;
                isDiscountEnabledCheckbox.checked = currentSettings.isDiscountEnabled;
                minSubtotalForDiscountInput.value = currentSettings.minSubtotalForDiscount;
                discountPercentageInput.value = currentSettings.discountPercentage;
                toggleDiscountInputs();
                renderDeliveryRates();
            }

            function renderDeliveryRates() {
                deliveryRatesContainer.innerHTML = '';
                currentSettings.deliveryRates.forEach((rate, index) => {
                    const div = document.createElement('div');
                    div.className = 'flex flex-wrap items-center gap-4 mb-3';
                    div.innerHTML = `
                        <div class="flex-1 min-w-[120px]">
                            <label class="block text-sm font-medium text-gray-700" for="kms-${index}">KMs</label>
                            <input type="number" id="kms-${index}" value="${rate.kms}" data-index="${index}" data-field="kms" class="delivery-rate-input mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2" step="0.1" />
                        </div>
                        <div class="flex-1 min-w-[120px]">
                            <label class="block text-sm font-medium text-gray-700" for="amount-${index}">Amount (â‚¹)</label>
                            <input type="number" id="amount-${index}" value="${rate.amount}" data-index="${index}" data-field="amount" class="delivery-rate-input mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2" step="0.01" />
                        </div>
                        <button type="button" data-index="${index}" class="remove-delivery-rate-button mt-5 px-3 py-2 bg-red-500 text-white rounded-md hover:bg-red-600 transition duration-150 ease-in-out">
                            Remove
                        </button>
                    `;
                    deliveryRatesContainer.appendChild(div);
                });
                addEventListenersToDeliveryRateInputs();
            }

            function addEventListenersToDeliveryRateInputs() {
                document.querySelectorAll('.delivery-rate-input').forEach(input => {
                    input.onchange = (e) => {
                        const index = parseInt(e.target.dataset.index);
                        const field = e.target.dataset.field;
                        const value = e.target.value;
                        currentSettings.deliveryRates[index][field] = parseFloat(value);
                    };
                });
                document.querySelectorAll('.remove-delivery-rate-button').forEach(button => {
                    button.onclick = (e) => {
                        const index = parseInt(e.target.dataset.index);
                        currentSettings.deliveryRates.splice(index, 1);
                        renderDeliveryRates();
                    };
                });
            }

            function toggleDiscountInputs() {
                const isDisabled = !isDiscountEnabledCheckbox.checked;
                minSubtotalForDiscountInput.disabled = isDisabled;
                discountPercentageInput.disabled = isDisabled;
                if (isDisabled) {
                    minSubtotalForDiscountInput.classList.add('opacity-50', 'cursor-not-allowed');
                    discountPercentageInput.classList.add('opacity-50', 'cursor-not-allowed');
                } else {
                    minSubtotalForDiscountInput.classList.remove('opacity-50', 'cursor-not-allowed');
                    discountPercentageInput.classList.remove('opacity-50', 'cursor-not-allowed');
                }
            }

            async function handleSaveSettings(e) {
                e.preventDefault();
                saveSettingsButton.disabled = true;
                saveSettingsButton.textContent = 'Saving...';

                const payload = {
                    shopName: shopNameInput.value,
                    shopLocation: {
                        latitude: parseFloat(shopLatitudeInput.value),
                        longitude: parseFloat(shopLongitudeInput.value)
                    },
                    deliveryRates: currentSettings.deliveryRates.map(rate => ({
                        kms: parseFloat(rate.kms),
                        amount: parseFloat(rate.amount)
                    })),
                    minSubtotalForDiscount: parseFloat(minSubtotalForDiscountInput.value),
                    discountPercentage: parseFloat(discountPercentageInput.value),
                    isDiscountEnabled: isDiscountEnabledCheckbox.checked
                };

                try {
                    const response = await fetchWithAuth(`${API_BASE_URL}/settings`, {
                        method: 'PUT',
                        body: JSON.stringify(payload)
                    });

                    if (response.ok) {
                        showNotification('Settings updated successfully!', 'success');
                        fetchSettings(); // Re-fetch to ensure consistency
                    } else {
                        const errorData = await response.json();
                        showNotification(errorData.message || 'Failed to update settings.', 'error');
                    }
                } catch (error) {
                    console.error('Error saving settings:', error);
                    showNotification('Network error or server unavailable.', 'error');
                } finally {
                    saveSettingsButton.disabled = false;
                    saveSettingsButton.textContent = 'Save Settings';
                }
            }

            // Event Listeners
            addDeliveryRateButton.onclick = () => {
                currentSettings.deliveryRates.push({ kms: 0, amount: 0 });
                renderDeliveryRates();
            };
            isDiscountEnabledCheckbox.onchange = toggleDiscountInputs;
            settingsForm.onsubmit = handleSaveSettings;

            fetchSettings(); // Initial fetch
        }

        // --- 2FA Management Page Logic ---
        function init2FAManagementPage() {
            const twoFaStatusBadge = document.getElementById('2fa-status-badge');
            const enable2FaButton = document.getElementById('enable-2fa-button');
            const disable2FaButton = document.getElementById('disable-2fa-button');
            const twoFaEnableModal = document.getElementById('2fa-enable-modal');
            const twoFaQrImage = document.getElementById('2fa-qr-image');
            const twoFaTotpCodeVerifyInput = document.getElementById('2fa-totp-code-verify');
            const cancel2FaButton = document.getElementById('cancel-2fa-button');
            const verify2FaButton = document.getElementById('verify-2fa-button');

            let is2FAEnabled = false;

            async function fetch2FAStatus() {
                enable2FaButton.disabled = true;
                disable2FaButton.disabled = true;
                try {
                    const response = await fetchWithAuth(`${API_BASE_URL}/2fa/status`);
                    const data = await response.json();
                    is2FAEnabled = data.twoFactorEnabled;
                    update2FAUI();
                } catch (error) {
                    console.error('Error fetching 2FA status:', error);
                    showNotification('Failed to fetch 2FA status.', 'error');
                } finally {
                    enable2FaButton.disabled = false;
                    disable2FaButton.disabled = false;
                }
            }

            function update2FAUI() {
                if (is2FAEnabled) {
                    twoFaStatusBadge.textContent = 'Status: Enabled';
                    twoFaStatusBadge.classList.remove('bg-red-100', 'text-red-800');
                    twoFaStatusBadge.classList.add('bg-green-100', 'text-green-800');
                    enable2FaButton.classList.add('hidden');
                    disable2FaButton.classList.remove('hidden');
                } else {
                    twoFaStatusBadge.textContent = 'Status: Disabled';
                    twoFaStatusBadge.classList.remove('bg-green-100', 'text-green-800');
                    twoFaStatusBadge.classList.add('bg-red-100', 'text-red-800');
                    enable2FaButton.classList.remove('hidden');
                    disable2FaButton.classList.add('hidden');
                }
            }

            async function handleGenerate2FA() {
                enable2FaButton.disabled = true;
                enable2FaButton.textContent = 'Generating...';
                try {
                    const response = await fetchWithAuth(`${API_BASE_URL}/2fa/generate`, { method: 'POST' });
                    const data = await response.json();
                    twoFaQrImage.src = data.qrCodeUrl;
                    twoFactorTempSecret = data.secret; // Store for verification
                    twoFaQrImage.classList.remove('hidden');
                    twoFaEnableModal.classList.remove('hidden');
                } catch (error) {
                    console.error('Error generating 2FA:', error);
                    showNotification('Failed to generate 2FA QR code.', 'error');
                } finally {
                    enable2FaButton.disabled = false;
                    enable2FaButton.textContent = 'Enable 2FA';
                }
            }

            async function handleVerify2FA() {
                verify2FaButton.disabled = true;
                verify2FaButton.textContent = 'Verifying...';
                const totpCode = twoFaTotpCodeVerifyInput.value;
                if (totpCode.length !== 6) {
                    showNotification('Please enter a 6-digit code.', 'error');
                    verify2FaButton.disabled = false;
                    verify2FaButton.textContent = 'Verify & Enable';
                    return;
                }

                try {
                    const response = await fetchWithAuth(`${API_BASE_URL}/2fa/verify`, {
                        method: 'POST',
                        body: JSON.stringify({ totpCode, secret: twoFactorTempSecret })
                    });
                    const data = await response.json();
                    if (response.ok && data.verified) {
                        showNotification('2FA enabled successfully!', 'success');
                        twoFaEnableModal.classList.add('hidden');
                        twoFaTotpCodeVerifyInput.value = '';
                        twoFaQrImage.src = '';
                        twoFaQrImage.classList.add('hidden');
                        twoFactorTempSecret = '';
                        fetch2FAStatus();
                    } else {
                        showNotification(data.message || '2FA verification failed.', 'error');
                    }
                } catch (error) {
                    console.error('Error verifying 2FA:', error);
                    showNotification('Network error or server unavailable.', 'error');
                } finally {
                    verify2FaButton.disabled = false;
                    verify2FaButton.textContent = 'Verify & Enable';
                }
            }

            async function handleDisable2FA() {
                if (!confirm('Are you sure you want to disable Two-Factor Authentication?')) return;
                disable2FaButton.disabled = true;
                disable2FaButton.textContent = 'Disabling...';
                try {
                    const response = await fetchWithAuth(`${API_BASE_URL}/2fa/disable`, { method: 'POST' });
                    if (response.ok) {
                        showNotification('2FA disabled successfully!', 'success');
                        fetch2FAStatus();
                    } else {
                        const errorData = await response.json();
                        showNotification(errorData.message || 'Failed to disable 2FA.', 'error');
                    }
                } catch (error) {
                    console.error('Error disabling 2FA:', error);
                    showNotification('Network error or server unavailable.', 'error');
                } finally {
                    disable2FaButton.disabled = false;
                    disable2FaButton.textContent = 'Disable 2FA';
                }
            }

            // Event Listeners
            enable2FaButton.onclick = handleGenerate2FA;
            disable2FaButton.onclick = handleDisable2FA;
            cancel2FaButton.onclick = () => {
                twoFaEnableModal.classList.add('hidden');
                twoFaTotpCodeVerifyInput.value = '';
                twoFaQrImage.src = '';
                twoFaQrImage.classList.add('hidden');
                twoFactorTempSecret = ''; // Clear temp secret on cancel
            };
            verify2FaButton.onclick = handleVerify2FA;

            fetch2FAStatus(); // Initial fetch
        }

        // --- Initial Setup and Routing ---
        document.addEventListener('DOMContentLoaded', () => {
            checkAuthentication();
            renderPage(); // Render initial page based on auth state and URL hash

            // Event listeners for global elements
            loginForm.addEventListener('submit', handleLogin);
            logoutButton.addEventListener('click', handleLogout);

            sidebarToggle.addEventListener('click', () => {
                sidebar.classList.toggle('-translate-x-full');
            });

            // Handle sidebar link clicks for navigation
            document.querySelectorAll('.sidebar-link').forEach(link => {
                link.addEventListener('click', (e) => {
                    e.preventDefault();
                    const path = e.target.getAttribute('href').substring(1); // Remove '#'
                    navigateTo(path);
                    // Close sidebar on mobile after navigation
                    if (window.innerWidth < 1024) { // Tailwind's 'lg' breakpoint
                        sidebar.classList.add('-translate-x-full');
                    }
                });
            });

            // Listen for hash changes (browser back/forward)
            window.addEventListener('hashchange', () => {
                currentPath = window.location.hash.substring(1) || '/dashboard';
                renderPage();
            });

            // Redirect from old paths to new hash-based paths
            if (window.location.pathname.startsWith('/admin/login.html') || window.location.pathname.startsWith('/admin_login.html')) {
                navigateTo('/admin/login');
            } else if (window.location.pathname.startsWith('/dashboard.html') || window.location.pathname.startsWith('/admin_dashboard.html')) {
                navigateTo('/dashboard');
            } else if (window.location.pathname === '/' && !window.location.hash) {
                // If on root and no hash, redirect to dashboard if authenticated, else login
                if (isAuthenticated) {
                    navigateTo('/dashboard');
                } else {
                    navigateTo('/admin/login');
                }
            }
        });

    </script>
</body>
</html>

