<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Delicious Bites - Admin Dashboard</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f0f2f5;
            color: #333;
        }
        .sidebar {
            background-color: #2c3e50; /* Dark blue-gray */
            color: #ecf0f1;
            width: 250px;
            min-height: 100vh;
            padding: 2rem;
            box-shadow: 2px 0 5px rgba(0,0,0,0.1);
        }
        .sidebar a {
            display: flex;
            align-items: center;
            padding: 0.75rem 1rem;
            margin-bottom: 0.5rem;
            border-radius: 8px;
            transition: background-color 0.2s ease, color 0.2s ease;
        }
        .sidebar a:hover {
            background-color: #34495e;
            color: #ffffff;
        }
        .sidebar a.active {
            background-color: #3498db;
            color: #ffffff;
            font-weight: bold;
        }
        .sidebar a i {
            margin-right: 10px;
            width: 20px;
            text-align: center;
        }
        .header {
            background-color: #ffffff;
            padding: 1.5rem 2rem;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .card {
            background-color: #ffffff;
            border-radius: 12px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.08);
            padding: 1.5rem;
            margin-bottom: 1.5rem;
        }
        .status-indicator {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            display: inline-block;
            margin-right: 8px;
        }
        .status-disconnected { background-color: #e74c3c; } /* Red */
        .status-qr_received { background-color: #f39c12; } /* Orange */
        .status-authenticated { background-color: #3498db; } /* Blue */
        .status-ready { background-color: #2ecc71; } /* Green */
        .status-auth_failure, .status-qr_error { background-color: #c0392b; } /* Darker Red */
        .status-initializing { background-color: #9b59b6; } /* Purple */

        /* Toggle Switch Styling */
        .toggle-switch {
            position: relative;
            display: inline-block;
            width: 60px;
            height: 34px;
        }
        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }
        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            -webkit-transition: .4s;
            transition: .4s;
            border-radius: 34px;
        }
        .slider:before {
            position: absolute;
            content: "";
            height: 26px;
            width: 26px;
            left: 4px;
            bottom: 4px;
            background-color: white;
            -webkit-transition: .4s;
            transition: .4s;
            border-radius: 50%;
        }
        input:checked + .slider {
            background-color: #2196F3;
        }
        input:focus + .slider {
            box-shadow: 0 0 1px #2196F3;
            outline: none; /* Remove default outline */
        }
        input:checked + .slider:before {
            -webkit-transform: translateX(26px);
            -ms-transform: translateX(26px);
            transform: translateX(26px);
        }
        /* Rounded sliders */
        .slider.round {
            border-radius: 34px;
        }
        .slider.round:before {
            border-radius: 50%;
        }

        /* Message Box */
        #messageBox {
            position: fixed;
            top: 20px;
            right: 20px;
            background-color: #4CAF50; /* Green */
            color: white;
            padding: 15px 20px;
            border-radius: 8px;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
            z-index: 1000;
            display: none;
            opacity: 0;
            transition: opacity 0.3s ease-in-out;
        }
        #messageBox.error {
            background-color: #f44336; /* Red */
        }

        /* Table Styling */
        .data-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 1rem;
        }
        .data-table th, .data-table td {
            padding: 0.75rem;
            text-align: left;
            border-bottom: 1px solid #e0e0e0;
        }
        .data-table th {
            background-color: #f8f8f8;
            font-weight: 600;
            color: #555;
            text-transform: uppercase;
            font-size: 0.85rem;
        }
        .data-table tbody tr:hover {
            background-color: #f5f5f5;
        }
        .action-btn {
            padding: 0.4rem 0.8rem;
            border-radius: 6px;
            font-size: 0.8rem;
            font-weight: 500;
            transition: background-color 0.2s ease;
        }
        .action-btn.edit {
            background-color: #3498db;
            color: white;
        }
        .action-btn.edit:hover {
            background-color: #2186c8;
        }
        .action-btn.delete {
            background-color: #e74c3c;
            color: white;
        }
        .action-btn.delete:hover {
            background-color: #c0392b;
        }
    </style>
</head>
<body class="flex">
    <!-- Sidebar -->
    <div class="sidebar">
        <h1 class="text-2xl font-bold mb-8 text-center">Admin Panel</h1>
        <nav>
            <a href="#" id="dashboardLink" class="active">
                <i class="fas fa-tachometer-alt"></i> Dashboard
            </a>
            <a href="#" id="menuLink">
                <i class="fas fa-utensils"></i> Menu Management
            </a>
            <a href="#" id="ordersLink">
                <i class="fas fa-clipboard-list"></i> Order Management
            </a>
            <a href="#" id="customersLink">
                <i class="fas fa-users"></i> Customer Management
            </a>
            <a href="#" id="generalSettingsLink">
                <i class="fas fa-cog"></i> General Settings
            </a>
            <a href="#" id="logoutButton" class="mt-8">
                <i class="fas fa-sign-out-alt"></i> Logout
            </a>
        </nav>
    </div>

    <!-- Main Content Area -->
    <div class="flex-1 flex flex-col">
        <!-- Header -->
        <header class="header">
            <h2 id="pageTitle" class="text-2xl font-semibold text-gray-800">Dashboard Overview</h2>
            <div class="flex items-center">
                <span class="text-gray-600 mr-4">Welcome, Admin!</span>
                <button id="logoutButtonHeader" class="bg-red-500 hover:bg-red-600 text-white px-4 py-2 rounded-lg shadow-md transition duration-200 ease-in-out">
                    <i class="fas fa-sign-out-alt mr-2"></i>Logout
                </button>
            </div>
        </header>

        <!-- Page Content -->
        <main class="p-8 flex-1 overflow-y-auto">
            <!-- Dashboard Section -->
            <section id="dashboardSection" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                <!-- WhatsApp Bot Status Card -->
                <div class="card col-span-1 md:col-span-2 lg:col-span-1">
                    <h3 class="text-xl font-semibold mb-4 text-gray-700"><i class="fab fa-whatsapp text-green-500 mr-2"></i>WhatsApp Bot Status</h3>
                    <p class="text-gray-600 mb-2">Status: <span id="botStatusText" class="font-bold">Loading...</span></p>
                    <p class="text-gray-600 mb-2">Last Authenticated: <span id="lastAuthenticatedAt" class="font-bold">N/A</span></p>
                    <div id="qrCodeContainer" class="text-center my-4" style="display: none;">
                        <p class="text-sm text-gray-500 mb-2">Scan this QR to connect WhatsApp:</p>
                        <img id="qrCodeImage" src="" alt="QR Code" class="mx-auto w-48 h-48 border border-gray-300 rounded-lg p-2">
                    </div>
                    <button id="forceNewSessionBtn" class="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-lg shadow-md transition duration-200 ease-in-out mt-4 w-full">
                        <i class="fas fa-sync-alt mr-2"></i>Force New Session
                    </button>
                    <div class="mt-4 p-3 bg-gray-100 rounded-lg max-h-48 overflow-y-auto text-sm text-gray-700">
                        <h4 class="font-semibold mb-2">Bot Logs:</h4>
                        <div id="botLogs"></div>
                    </div>
                </div>

                <!-- Quick Stats Card -->
                <div class="card col-span-1 md:col-span-2 lg:col-span-1">
                    <h3 class="text-xl font-semibold mb-4 text-gray-700"><i class="fas fa-chart-line text-blue-500 mr-2"></i>Quick Stats</h3>
                    <p class="text-gray-600">More content coming soon!</p>
                    <div class="mt-4 p-3 bg-gray-100 rounded-lg">
                        <p class="text-sm text-gray-700">Total Orders: <span class="font-semibold">500+</span></p>
                        <p class="text-sm text-gray-700">Active Customers: <span class="font-semibold">120</span></p>
                        <p class="text-sm text-gray-700">Revenue (This Month): <span class="font-semibold">â‚¹50,000</span></p>
                    </div>
                </div>
            </section>

            <!-- Menu Management Section -->
            <section id="menuManagementSection" class="hidden">
                <h2 class="text-2xl font-semibold mb-6 text-gray-800"><i class="fas fa-utensils text-orange-500 mr-2"></i>Menu Management</h2>
                <div class="card">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="text-xl font-semibold text-gray-700">All Menu Items</h3>
                        <button id="addMenuItemBtn" class="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-lg shadow-md transition duration-200 ease-in-out">
                            <i class="fas fa-plus mr-2"></i>Add New Item
                        </button>
                    </div>
                    <div class="overflow-x-auto">
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>Name</th>
                                    <th>Category</th>
                                    <th>Price</th>
                                    <th>Available</th>
                                    <th>Trending</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="menuItemsTableBody">
                                <!-- Menu items will be loaded here -->
                                <tr><td colspan="6" class="text-center py-4 text-gray-500">Loading menu items...</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </section>

            <!-- Order Management Section -->
            <section id="orderManagementSection" class="hidden">
                <h2 class="text-2xl font-semibold mb-6 text-gray-800"><i class="fas fa-clipboard-list text-teal-500 mr-2"></i>Order Management</h2>
                <div class="card">
                    <h3 class="text-xl font-semibold text-gray-700 mb-4">Recent Orders</h3>
                    <div class="overflow-x-auto">
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>Order ID</th>
                                    <th>Customer</th>
                                    <th>Total</th>
                                    <th>Status</th>
                                    <th>Date</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="ordersTableBody">
                                <!-- Orders will be loaded here -->
                                <tr><td colspan="6" class="text-center py-4 text-gray-500">Loading orders...</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </section>

            <!-- Customer Management Section -->
            <section id="customerManagementSection" class="hidden">
                <h2 class="text-2xl font-semibold mb-6 text-gray-800"><i class="fas fa-users text-indigo-500 mr-2"></i>Customer Management</h2>
                <div class="card">
                    <h3 class="text-xl font-semibold text-gray-700 mb-4">All Customers</h3>
                    <div class="overflow-x-auto">
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>Name</th>
                                    <th>Phone</th>
                                    <th>Total Orders</th>
                                    <th>Last Order Date</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="customersTableBody">
                                <!-- Customers will be loaded here -->
                                <tr><td colspan="5" class="text-center py-4 text-gray-500">Loading customers...</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </section>

            <!-- General Settings Section -->
            <section id="generalSettingsSection" class="hidden">
                <h2 class="text-2xl font-semibold mb-6 text-gray-800"><i class="fas fa-cog text-gray-600 mr-2"></i>General Settings</h2>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <!-- Discount Settings Card (Moved from Dashboard Overview) -->
                    <div class="card">
                        <h3 class="text-xl font-semibold mb-4 text-gray-700"><i class="fas fa-tags text-purple-500 mr-2"></i>Discount Settings</h3>
                        <div class="mb-4">
                            <label for="minSubtotalForDiscount" class="block text-gray-700 text-sm font-bold mb-2">Minimum Subtotal for Discount (â‚¹):</label>
                            <input type="number" id="minSubtotalForDiscount" class="shadow appearance-none border rounded-lg w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline" value="0" min="0">
                        </div>
                        <div class="mb-4">
                            <label for="discountPercentage" class="block text-gray-700 text-sm font-bold mb-2">Discount Percentage (0.0 - 1.0):</label>
                            <input type="number" id="discountPercentage" class="shadow appearance-none border rounded-lg w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline" value="0.0" min="0" max="1" step="0.01">
                        </div>
                        <div class="flex items-center justify-between mb-4">
                            <label for="isDiscountEnabled" class="block text-gray-700 text-sm font-bold">Enable Discount:</label>
                            <label class="toggle-switch">
                                <input type="checkbox" id="isDiscountEnabled">
                                <span class="slider round"></span>
                            </label>
                        </div>
                        <button id="saveDiscountSettingsBtn" class="bg-green-500 hover:bg-green-600 text-white px-4 py-2 rounded-lg shadow-md transition duration-200 ease-in-out w-full">
                            <i class="fas fa-save mr-2"></i>Save Discount Settings
                        </button>
                    </div>

                    <!-- Other General Settings Placeholder -->
                    <div class="card">
                        <h3 class="text-xl font-semibold mb-4 text-gray-700"><i class="fas fa-store text-red-500 mr-2"></i>Shop Information</h3>
                        <div class="mb-4">
                            <label for="shopName" class="block text-gray-700 text-sm font-bold mb-2">Shop Name:</label>
                            <input type="text" id="shopName" class="shadow appearance-none border rounded-lg w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline" value="Delicious Bites">
                        </div>
                        <div class="mb-4">
                            <label for="shopLatitude" class="block text-gray-700 text-sm font-bold mb-2">Shop Latitude:</label>
                            <input type="number" id="shopLatitude" class="shadow appearance-none border rounded-lg w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline" value="0.0">
                        </div>
                        <div class="mb-4">
                            <label for="shopLongitude" class="block text-gray-700 text-sm font-bold mb-2">Shop Longitude:</label>
                            <input type="number" id="shopLongitude" class="shadow appearance-none border rounded-lg w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline" value="0.0">
                        </div>
                        <button id="saveShopInfoBtn" class="bg-green-500 hover:bg-green-600 text-white px-4 py-2 rounded-lg shadow-md transition duration-200 ease-in-out w-full">
                            <i class="fas fa-save mr-2"></i>Save Shop Info
                        </button>
                    </div>

                    <!-- Delivery Rates Placeholder -->
                    <div class="card col-span-1 md:col-span-2">
                        <h3 class="text-xl font-semibold mb-4 text-gray-700"><i class="fas fa-truck text-blue-500 mr-2"></i>Delivery Rates</h3>
                        <div id="deliveryRatesContainer" class="mb-4">
                            <div class="flex items-center mb-2">
                                <input type="number" placeholder="KMs" class="shadow appearance-none border rounded-lg py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline w-1/2 mr-2">
                                <input type="number" placeholder="Amount (â‚¹)" class="shadow appearance-none border rounded-lg py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline w-1/2">
                            </div>
                            <!-- More rate inputs can be added dynamically -->
                        </div>
                        <button id="addDeliveryRateBtn" class="bg-gray-400 hover:bg-gray-500 text-white px-4 py-2 rounded-lg shadow-md transition duration-200 ease-in-out mr-2">
                            <i class="fas fa-plus mr-2"></i>Add Rate
                        </button>
                        <button id="saveDeliveryRatesBtn" class="bg-green-500 hover:bg-green-600 text-white px-4 py-2 rounded-lg shadow-md transition duration-200 ease-in-out">
                            <i class="fas fa-save mr-2"></i>Save Rates
                        </button>
                    </div>
                </div>
            </section>
        </main>
    </div>

    <!-- Message Box -->
    <div id="messageBox"></div>

    <script src="/socket.io/socket.io.js"></script>
    <script>
        const API_BASE_URL = window.location.origin;
        const socket = io();

        // UI Elements
        const pageTitle = document.getElementById('pageTitle');
        const dashboardLink = document.getElementById('dashboardLink');
        const menuLink = document.getElementById('menuLink');
        const ordersLink = document.getElementById('ordersLink');
        const customersLink = document.getElementById('customersLink');
        const generalSettingsLink = document.getElementById('generalSettingsLink');
        const logoutButton = document.getElementById('logoutButton');
        const logoutButtonHeader = document.getElementById('logoutButtonHeader');
        const messageBox = document.getElementById('messageBox');

        // Sections
        const dashboardSection = document.getElementById('dashboardSection');
        const menuManagementSection = document.getElementById('menuManagementSection');
        const orderManagementSection = document.getElementById('orderManagementSection');
        const customerManagementSection = document.getElementById('customerManagementSection');
        const generalSettingsSection = document.getElementById('generalSettingsSection');

        // Dashboard specific elements
        const botStatusText = document.getElementById('botStatusText');
        const lastAuthenticatedAt = document.getElementById('lastAuthenticatedAt');
        const qrCodeContainer = document.getElementById('qrCodeContainer');
        const qrCodeImage = document.getElementById('qrCodeImage');
        const forceNewSessionBtn = document.getElementById('forceNewSessionBtn');
        const botLogs = document.getElementById('botLogs');

        // Discount Settings elements (now in General Settings section)
        const minSubtotalForDiscountInput = document.querySelector('#generalSettingsSection #minSubtotalForDiscount');
        const discountPercentageInput = document.querySelector('#generalSettingsSection #discountPercentage');
        const isDiscountEnabledToggle = document.querySelector('#generalSettingsSection #isDiscountEnabled');
        const saveDiscountSettingsBtn = document.querySelector('#generalSettingsSection #saveDiscountSettingsBtn');

        // Menu Management elements
        const menuItemsTableBody = document.getElementById('menuItemsTableBody');
        const addMenuItemBtn = document.getElementById('addMenuItemBtn');

        // Order Management elements
        const ordersTableBody = document.getElementById('ordersTableBody');

        // Customer Management elements
        const customersTableBody = document.getElementById('customersTableBody');

        // General Settings - Shop Info elements
        const shopNameInput = document.getElementById('shopName');
        const shopLatitudeInput = document.getElementById('shopLatitude');
        const shopLongitudeInput = document.getElementById('shopLongitude');
        const saveShopInfoBtn = document.getElementById('saveShopInfoBtn');

        // General Settings - Delivery Rates elements
        const deliveryRatesContainer = document.getElementById('deliveryRatesContainer');
        const addDeliveryRateBtn = document.getElementById('addDeliveryRateBtn');
        const saveDeliveryRatesBtn = document.getElementById('saveDeliveryRatesBtn');


        // --- Helper Function for displaying messages ---
        function showMessage(message, isError = false) {
            messageBox.textContent = message;
            messageBox.className = ''; // Clear existing classes
            messageBox.classList.add('fade-in');
            if (isError) {
                messageBox.classList.add('error');
            } else {
                messageBox.classList.add('success');
            }
            messageBox.style.display = 'block';
            messageBox.style.opacity = '1';

            setTimeout(() => {
                messageBox.style.opacity = '0';
                setTimeout(() => {
                    messageBox.style.display = 'none';
                }, 300); // Wait for fade-out to complete
            }, 3000); // Message visible for 3 seconds
        }

        // --- Authentication Helper ---
        async function fetchWithAuth(url, options = {}) {
            const token = localStorage.getItem('jwtToken');
            if (!token) {
                console.error('No JWT token found. Redirecting to login.');
                localStorage.removeItem('jwtToken'); // Ensure token is cleared
                window.location.href = '/admin/login';
                return; // Prevent further execution
            }

            options.headers = {
                ...options.headers,
                'Authorization': `Bearer ${token}`
            };

            const response = await fetch(url, options);

            if (response.status === 401 || response.status === 403) {
                console.error('Authentication failed or session expired. Redirecting to login.');
                localStorage.removeItem('jwtToken');
                window.location.href = '/admin/login';
                return; // Prevent further execution
            }
            return response;
        }

        // --- Section Switching Logic ---
        const sections = {
            dashboard: dashboardSection,
            menu: menuManagementSection,
            orders: orderManagementSection,
            customers: customerManagementSection,
            generalSettings: generalSettingsSection
        };

        const navLinks = {
            dashboard: dashboardLink,
            menu: menuLink,
            orders: ordersLink,
            customers: customersLink,
            generalSettings: generalSettingsLink
        };

        function showSection(sectionName) {
            // Hide all sections
            Object.values(sections).forEach(section => section.classList.add('hidden'));
            // Deactivate all nav links
            Object.values(navLinks).forEach(link => link.classList.remove('active'));

            // Show the requested section
            sections[sectionName].classList.remove('hidden');
            // Activate the corresponding nav link
            navLinks[sectionName].classList.add('active');

            // Update page title
            switch (sectionName) {
                case 'dashboard': pageTitle.textContent = 'Dashboard Overview'; break;
                case 'menu': pageTitle.textContent = 'Menu Management'; fetchMenuItems(); break;
                case 'orders': pageTitle.textContent = 'Order Management'; fetchOrders(); break;
                case 'customers': pageTitle.textContent = 'Customer Management'; fetchCustomers(); break;
                case 'generalSettings': pageTitle.textContent = 'General Settings'; fetchDiscountSettings(); fetchGeneralSettings(); break;
            }
        }

        // --- Event Listeners for Sidebar Navigation ---
        dashboardLink.addEventListener('click', (e) => { e.preventDefault(); showSection('dashboard'); });
        menuLink.addEventListener('click', (e) => { e.preventDefault(); showSection('menu'); });
        ordersLink.addEventListener('click', (e) => { e.preventDefault(); showSection('orders'); });
        customersLink.addEventListener('click', (e) => { e.preventDefault(); showSection('customers'); });
        generalSettingsLink.addEventListener('click', (e) => { e.preventDefault(); showSection('generalSettings'); });


        // --- Initial Authentication Check on Page Load ---
        document.addEventListener('DOMContentLoaded', async () => {
            const token = localStorage.getItem('jwtToken');
            if (!token) {
                window.location.href = '/admin/login';
                return;
            }

            // Verify token by making an authenticated API call
            try {
                const response = await fetchWithAuth(`${API_BASE_URL}/api/admin/bot-status`);
                if (!response || !response.ok) {
                    console.error('Failed to verify token on dashboard load:', response ? response.status : 'No response');
                    localStorage.removeItem('jwtToken');
                    window.location.href = '/admin/login';
                    return;
                }
                console.log('Token validated. Dashboard loaded.');
                // Initial load: show dashboard section and fetch its data
                showSection('dashboard');
                fetchBotStatus();
            } catch (error) {
                console.error('Error during initial token validation:', error);
                localStorage.removeItem('jwtToken');
                window.location.href = '/admin/login';
            }
        });

        // --- Logout Functionality ---
        function logout() {
            localStorage.removeItem('jwtToken');
            window.location.href = '/admin/login';
        }
        logoutButton.addEventListener('click', logout);
        logoutButtonHeader.addEventListener('click', logout);


        // --- WhatsApp Bot Status Functions ---
        async function fetchBotStatus() {
            try {
                const response = await fetchWithAuth(`${API_BASE_URL}/api/admin/bot-status`);
                const data = await response.json();
                updateBotStatusUI(data.status, data.lastAuthenticatedAt);
                if (data.qrCodeAvailable) {
                    // Request QR code if available (socket.io will send it)
                    // No direct fetch here, socket.io handles it.
                } else {
                    qrCodeContainer.style.display = 'none';
                    qrCodeImage.src = '';
                }
            } catch (error) {
                console.error('Error fetching bot status:', error);
                showMessage('Failed to fetch bot status.', true);
            }
        }

        function updateBotStatusUI(status, timestamp) {
            botStatusText.textContent = status.replace(/_/g, ' ').toUpperCase();
            botStatusText.className = 'font-bold status-indicator ' + `status-${status}`;
            lastAuthenticatedAt.textContent = timestamp ? new Date(timestamp).toLocaleString() : 'N/A';
        }

        forceNewSessionBtn.addEventListener('click', async () => {
            if (!confirm('Are you sure you want to force a new WhatsApp session? This will disconnect the current session and require scanning a new QR code.')) {
                return;
            }
            try {
                showMessage('Requesting new WhatsApp session...');
                const response = await fetchWithAuth(`${API_BASE_URL}/api/admin/load-session`, {
                    method: 'POST'
                });
                const data = await response.json();
                if (response.ok) {
                    showMessage(data.message);
                } else {
                    showMessage(data.message || 'Failed to force new session.', true);
                }
            } catch (error) {
                console.error('Error forcing new session:', error);
                showMessage('Error forcing new session.', true);
            }
        });

        // --- Socket.IO Listeners for Real-time Bot Status ---
        socket.on('status', (status) => {
            console.log('Socket.IO: Status update received:', status);
            updateBotStatusUI(status, new Date()); // Use current time for immediate feedback
            // If status is not qr_received, hide QR
            if (status !== 'qr_received') {
                qrCodeContainer.style.display = 'none';
                qrCodeImage.src = '';
            }
        });

        socket.on('qrCode', (qrData) => {
            console.log('Socket.IO: QR Code received.');
            if (qrData) {
                qrCodeImage.src = qrData;
                qrCodeContainer.style.display = 'block';
                showMessage('New QR code received. Please scan with your WhatsApp app.');
            } else {
                qrCodeContainer.style.display = 'none';
                qrCodeImage.src = '';
            }
        });

        socket.on('sessionInfo', (info) => {
            console.log('Socket.IO: Session info received:', info);
            lastAuthenticatedAt.textContent = info.lastAuthenticatedAt ? new Date(info.lastAuthenticatedAt).toLocaleString() : 'N/A';
        });

        socket.on('whatsapp_log', (logMessage) => {
            const logEntry = document.createElement('p');
            logEntry.textContent = `[${new Date().toLocaleTimeString()}] ${logMessage}`;
            botLogs.prepend(logEntry); // Add new logs to the top
            if (botLogs.children.length > 50) { // Keep log history manageable
                botLogs.removeChild(botLogs.lastChild);
            }
        });

        // --- Discount Settings Functions (now part of General Settings) ---
        async function fetchDiscountSettings() {
            try {
                const response = await fetchWithAuth(`${API_BASE_URL}/api/admin/discount-settings`);
                const data = await response.json();
                if (response.ok) {
                    minSubtotalForDiscountInput.value = data.minSubtotalForDiscount || 0;
                    discountPercentageInput.value = data.discountPercentage || 0;
                    isDiscountEnabledToggle.checked = data.isDiscountEnabled;
                } else {
                    showMessage(data.message || 'Failed to fetch discount settings.', true);
                }
            } catch (error) {
                console.error('Error fetching discount settings:', error);
                showMessage('Error fetching discount settings.', true);
            }
        }

        saveDiscountSettingsBtn.addEventListener('click', async () => {
            const minSubtotal = parseFloat(minSubtotalForDiscountInput.value);
            const discountPercent = parseFloat(discountPercentageInput.value);
            const isEnabled = isDiscountEnabledToggle.checked;

            if (isNaN(minSubtotal) || minSubtotal < 0) {
                showMessage('Minimum subtotal must be a non-negative number.', true);
                return;
            }
            if (isNaN(discountPercent) || discountPercent < 0 || discountPercent > 1) {
                showMessage('Discount percentage must be between 0 and 1.', true);
                return;
            }

            try {
                showMessage('Saving discount settings...');
                const response = await fetchWithAuth(`${API_BASE_URL}/api/admin/discount-settings`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        minSubtotalForDiscount: minSubtotal,
                        discountPercentage: discountPercent,
                        isDiscountEnabled: isEnabled
                    })
                });
                const data = await response.json();
                if (response.ok) {
                    showMessage(data.message || 'Discount settings saved successfully!');
                    fetchDiscountSettings(); // Re-fetch to ensure UI is in sync with saved data
                } else {
                    showMessage(data.message || 'Failed to save discount settings.', true);
                }
            } catch (error) {
                console.error('Error saving discount settings:', error);
                showMessage('Error saving discount settings.', true);
            }
        });

        // --- Menu Management Functions ---
        async function fetchMenuItems() {
            menuItemsTableBody.innerHTML = '<tr><td colspan="6" class="text-center py-4 text-gray-500">Loading menu items...</td></tr>';
            try {
                const response = await fetchWithAuth(`${API_BASE_URL}/api/admin/menu`);
                const items = await response.json();
                if (response.ok) {
                    renderMenuItems(items);
                } else {
                    showMessage(items.message || 'Failed to fetch menu items.', true);
                    menuItemsTableBody.innerHTML = '<tr><td colspan="6" class="text-center py-4 text-red-500">Error loading menu items.</td></tr>';
                }
            } catch (error) {
                console.error('Error fetching menu items:', error);
                showMessage('Error fetching menu items.', true);
                menuItemsTableBody.innerHTML = '<tr><td colspan="6" class="text-center py-4 text-red-500">Error loading menu items.</td></tr>';
            }
        }

        function renderMenuItems(items) {
            menuItemsTableBody.innerHTML = ''; // Clear existing rows
            if (items.length === 0) {
                menuItemsTableBody.innerHTML = '<tr><td colspan="6" class="text-center py-4 text-gray-500">No menu items found.</td></tr>';
                return;
            }
            items.forEach(item => {
                const row = `
                    <tr>
                        <td>${item.name}</td>
                        <td>${item.category || 'N/A'}</td>
                        <td>â‚¹${item.price.toFixed(2)}</td>
                        <td>${item.isAvailable ? '<i class="fas fa-check-circle text-green-500"></i>' : '<i class="fas fa-times-circle text-red-500"></i>'}</td>
                        <td>${item.isTrending ? '<i class="fas fa-fire text-orange-500"></i>' : '-'}</td>
                        <td>
                            <button class="action-btn edit mr-2" data-id="${item._id}"><i class="fas fa-edit"></i> Edit</button>
                            <button class="action-btn delete" data-id="${item._id}"><i class="fas fa-trash"></i> Delete</button>
                        </td>
                    </tr>
                `;
                menuItemsTableBody.insertAdjacentHTML('beforeend', row);
            });

            // Add event listeners to action buttons (placeholders)
            menuItemsTableBody.querySelectorAll('.action-btn.edit').forEach(button => {
                button.addEventListener('click', () => showMessage(`Edit item with ID: ${button.dataset.id} (Functionality to be implemented)`, false));
            });
            menuItemsTableBody.querySelectorAll('.action-btn.delete').forEach(button => {
                button.addEventListener('click', () => showMessage(`Delete item with ID: ${button.dataset.id} (Functionality to be implemented)`, true));
            });
        }

        addMenuItemBtn.addEventListener('click', () => {
            showMessage('Add New Item functionality to be implemented.');
        });


        // --- Order Management Functions ---
        async function fetchOrders() {
            ordersTableBody.innerHTML = '<tr><td colspan="6" class="text-center py-4 text-gray-500">Loading orders...</td></tr>';
            try {
                const response = await fetchWithAuth(`${API_BASE_URL}/api/admin/orders`);
                const orders = await response.json();
                if (response.ok) {
                    renderOrders(orders);
                } else {
                    showMessage(orders.message || 'Failed to fetch orders.', true);
                    ordersTableBody.innerHTML = '<tr><td colspan="6" class="text-center py-4 text-red-500">Error loading orders.</td></tr>';
                }
            } catch (error) {
                console.error('Error fetching orders:', error);
                showMessage('Error fetching orders.', true);
                ordersTableBody.innerHTML = '<tr><td colspan="6" class="text-center py-4 text-red-500">Error loading orders.</td></tr>';
            }
        }

        function renderOrders(orders) {
            ordersTableBody.innerHTML = ''; // Clear existing rows
            if (orders.length === 0) {
                ordersTableBody.innerHTML = '<tr><td colspan="6" class="text-center py-4 text-gray-500">No orders found.</td></tr>';
                return;
            }
            orders.forEach(order => {
                const orderDate = new Date(order.orderDate).toLocaleString();
                const displayId = order.customOrderId || order._id.substring(0, 8);
                const row = `
                    <tr>
                        <td>${displayId}</td>
                        <td>${order.customerName || 'N/A'}</td>
                        <td>â‚¹${order.totalAmount.toFixed(2)}</td>
                        <td>${order.status}</td>
                        <td>${orderDate}</td>
                        <td>
                            <button class="action-btn edit mr-2" data-id="${order._id}"><i class="fas fa-eye"></i> View</button>
                            <button class="action-btn delete" data-id="${order._id}"><i class="fas fa-sync-alt"></i> Update Status</button>
                        </td>
                    </tr>
                `;
                ordersTableBody.insertAdjacentHTML('beforeend', row);
            });

            // Add event listeners to action buttons (placeholders)
            ordersTableBody.querySelectorAll('.action-btn.edit').forEach(button => {
                button.addEventListener('click', () => showMessage(`View details for order ID: ${button.dataset.id} (Functionality to be implemented)`, false));
            });
            ordersTableBody.querySelectorAll('.action-btn.delete').forEach(button => {
                button.addEventListener('click', () => showMessage(`Update status for order ID: ${button.dataset.id} (Functionality to be implemented)`, false));
            });
        }


        // --- Customer Management Functions ---
        async function fetchCustomers() {
            customersTableBody.innerHTML = '<tr><td colspan="5" class="text-center py-4 text-gray-500">Loading customers...</td></tr>';
            try {
                const response = await fetchWithAuth(`${API_BASE_URL}/api/admin/customers`);
                const customers = await response.json();
                if (response.ok) {
                    renderCustomers(customers);
                } else {
                    showMessage(customers.message || 'Failed to fetch customers.', true);
                    customersTableBody.innerHTML = '<tr><td colspan="5" class="text-center py-4 text-red-500">Error loading customers.</td></tr>';
                }
            } catch (error) {
                console.error('Error fetching customers:', error);
                showMessage('Error fetching customers.', true);
                customersTableBody.innerHTML = '<tr><td colspan="5" class="text-center py-4 text-red-500">Error loading customers.</td></tr>';
            }
        }

        function renderCustomers(customers) {
            customersTableBody.innerHTML = ''; // Clear existing rows
            if (customers.length === 0) {
                customersTableBody.innerHTML = '<tr><td colspan="5" class="text-center py-4 text-gray-500">No customers found.</td></tr>';
                return;
            }
            customers.forEach(customer => {
                const lastOrderDate = customer.lastOrderDate ? new Date(customer.lastOrderDate).toLocaleDateString() : 'N/A';
                const row = `
                    <tr>
                        <td>${customer.customerName || 'Unknown'}</td>
                        <td>${customer.customerPhone}</td>
                        <td>${customer.totalOrders}</td>
                        <td>${lastOrderDate}</td>
                        <td>
                            <button class="action-btn edit mr-2" data-id="${customer._id}"><i class="fas fa-eye"></i> View</button>
                            <button class="action-btn delete" data-id="${customer._id}"><i class="fas fa-trash"></i> Delete</button>
                        </td>
                    </tr>
                `;
                customersTableBody.insertAdjacentHTML('beforeend', row);
            });

            // Add event listeners to action buttons (placeholders)
            customersTableBody.querySelectorAll('.action-btn.edit').forEach(button => {
                button.addEventListener('click', () => showMessage(`View details for customer ID: ${button.dataset.id} (Functionality to be implemented)`, false));
            });
            customersTableBody.querySelectorAll('.action-btn.delete').forEach(button => {
                button.addEventListener('click', () => showMessage(`Delete customer with ID: ${button.dataset.id} (Functionality to be implemented)`, true));
            });
        }

        // --- General Settings Functions (Shop Info & Delivery Rates) ---
        async function fetchGeneralSettings() {
            try {
                const response = await fetchWithAuth(`${API_BASE_URL}/api/admin/settings`);
                const data = await response.json();
                if (response.ok) {
                    shopNameInput.value = data.shopName || '';
                    shopLatitudeInput.value = data.shopLocation ? data.shopLocation.latitude : '';
                    shopLongitudeInput.value = data.shopLocation ? data.shopLocation.longitude : '';
                    renderDeliveryRates(data.deliveryRates || []);
                } else {
                    showMessage(data.message || 'Failed to fetch general settings.', true);
                }
            } catch (error) {
                console.error('Error fetching general settings:', error);
                showMessage('Error fetching general settings.', true);
            }
        }

        saveShopInfoBtn.addEventListener('click', async () => {
            const shopName = shopNameInput.value;
            const latitude = parseFloat(shopLatitudeInput.value);
            const longitude = parseFloat(shopLongitudeInput.value);

            if (!shopName) {
                showMessage('Shop name cannot be empty.', true);
                return;
            }
            if (isNaN(latitude) || isNaN(longitude)) {
                showMessage('Latitude and Longitude must be valid numbers.', true);
                return;
            }

            try {
                showMessage('Saving shop information...');
                const response = await fetchWithAuth(`${API_BASE_URL}/api/admin/settings`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        shopName: shopName,
                        shopLocation: { latitude, longitude }
                    })
                });
                const data = await response.json();
                if (response.ok) {
                    showMessage(data.message || 'Shop information saved successfully!');
                    fetchGeneralSettings(); // Re-fetch to ensure UI is in sync
                } else {
                    showMessage(data.message || 'Failed to save shop information.', true);
                }
            } catch (error) {
                console.error('Error saving shop information:', error);
                showMessage('Error saving shop information.', true);
            }
        });

        function renderDeliveryRates(rates) {
            deliveryRatesContainer.innerHTML = ''; // Clear existing inputs
            if (rates.length === 0) {
                addEmptyDeliveryRateRow(); // Add one empty row if no rates
                return;
            }
            rates.forEach(rate => {
                addDeliveryRateRow(rate.kms, rate.amount);
            });
        }

        function addEmptyDeliveryRateRow() {
            addDeliveryRateRow('', '');
        }

        function addDeliveryRateRow(kms, amount) {
            const div = document.createElement('div');
            div.className = 'flex items-center mb-2';
            div.innerHTML = `
                <input type="number" placeholder="KMs" value="${kms}" class="shadow appearance-none border rounded-lg py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline w-1/2 mr-2 delivery-kms">
                <input type="number" placeholder="Amount (â‚¹)" value="${amount}" class="shadow appearance-none border rounded-lg py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline w-1/2 delivery-amount">
                <button class="bg-red-500 hover:bg-red-600 text-white px-3 py-2 rounded-lg ml-2 remove-rate-btn"><i class="fas fa-trash"></i></button>
            `;
            deliveryRatesContainer.appendChild(div);

            // Add event listener for remove button
            div.querySelector('.remove-rate-btn').addEventListener('click', () => {
                div.remove();
            });
        }

        addDeliveryRateBtn.addEventListener('click', addEmptyDeliveryRateRow);

        saveDeliveryRatesBtn.addEventListener('click', async () => {
            const rateInputs = deliveryRatesContainer.querySelectorAll('.flex.items-center.mb-2');
            const newRates = [];
            let isValid = true;

            rateInputs.forEach(row => {
                const kmsInput = row.querySelector('.delivery-kms');
                const amountInput = row.querySelector('.delivery-amount');
                const kms = parseFloat(kmsInput.value);
                const amount = parseFloat(amountInput.value);

                if (isNaN(kms) || kms < 0 || isNaN(amount) || amount < 0) {
                    isValid = false;
                    return;
                }
                newRates.push({ kms, amount });
            });

            if (!isValid) {
                showMessage('All delivery rates must be valid non-negative numbers.', true);
                return;
            }

            try {
                showMessage('Saving delivery rates...');
                const response = await fetchWithAuth(`${API_BASE_URL}/api/admin/settings`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        deliveryRates: newRates
                    })
                });
                const data = await response.json();
                if (response.ok) {
                    showMessage(data.message || 'Delivery rates saved successfully!');
                    fetchGeneralSettings(); // Re-fetch to ensure UI is in sync
                } else {
                    showMessage(data.message || 'Failed to save delivery rates.', true);
                }
            } catch (error) {
                console.error('Error saving delivery rates:', error);
                showMessage('Error saving delivery rates.', true);
            }
        });

    </script>
</body>
</html>

