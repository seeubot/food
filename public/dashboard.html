<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Delicious Bites - Admin Dashboard</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f0f2f5;
            color: #333;
        }
        .sidebar {
            background-color: #2c3e50; /* Dark blue-gray */
            color: #ecf0f1;
            width: 250px;
            min-height: 100vh;
            padding: 2rem;
            box-shadow: 2px 0 5px rgba(0,0,0,0.1);
        }
        .sidebar a {
            display: flex;
            align-items: center;
            padding: 0.75rem 1rem;
            margin-bottom: 0.5rem;
            border-radius: 8px;
            transition: background-color 0.2s ease, color 0.2s ease;
        }
        .sidebar a:hover {
            background-color: #34495e;
            color: #ffffff;
        }
        .sidebar a.active {
            background-color: #3498db;
            color: #ffffff;
            font-weight: bold;
        }
        .sidebar a i {
            margin-right: 10px;
            width: 20px;
            text-align: center;
        }
        .header {
            background-color: #ffffff;
            padding: 1.5rem 2rem;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .card {
            background-color: #ffffff;
            border-radius: 12px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.08);
            padding: 1.5rem;
            margin-bottom: 1.5rem;
        }
        .status-indicator {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            display: inline-block;
            margin-right: 8px;
        }
        .status-disconnected { background-color: #e74c3c; } /* Red */
        .status-qr_received { background-color: #f39c12; } /* Orange */
        .status-authenticated { background-color: #3498db; } /* Blue */
        .status-ready { background-color: #2ecc71; } /* Green */
        .status-auth_failure, .status-qr_error { background-color: #c0392b; } /* Darker Red */
        .status-initializing { background-color: #9b59b6; } /* Purple */

        /* Toggle Switch Styling */
        .toggle-switch {
            position: relative;
            display: inline-block;
            width: 60px;
            height: 34px;
        }
        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }
        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            -webkit-transition: .4s;
            transition: .4s;
            border-radius: 34px;
        }
        .slider:before {
            position: absolute;
            content: "";
            height: 26px;
            width: 26px;
            left: 4px;
            bottom: 4px;
            background-color: white;
            -webkit-transition: .4s;
            transition: .4s;
            border-radius: 50%;
        }
        input:checked + .slider {
            background-color: #2196F3;
        }
        input:focus + .slider {
            box-shadow: 0 0 1px #2196F3;
        }
        input:checked + .slider:before {
            -webkit-transform: translateX(26px);
            -ms-transform: translateX(26px);
            transform: translateX(26px);
        }
        /* Rounded sliders */
        .slider.round {
            border-radius: 34px;
        }
        .slider.round:before {
            border-radius: 50%;
        }

        /* Message Box */
        #messageBox {
            position: fixed;
            top: 20px;
            right: 20px;
            background-color: #4CAF50; /* Green */
            color: white;
            padding: 15px 20px;
            border-radius: 8px;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
            z-index: 1000;
            display: none;
            opacity: 0;
            transition: opacity 0.3s ease-in-out;
        }
        #messageBox.error {
            background-color: #f44336; /* Red */
        }
    </style>
</head>
<body class="flex">
    <!-- Sidebar -->
    <div class="sidebar">
        <h1 class="text-2xl font-bold mb-8 text-center">Admin Panel</h1>
        <nav>
            <a href="/dashboard" class="active">
                <i class="fas fa-tachometer-alt"></i> Dashboard
            </a>
            <a href="#" id="menuLink">
                <i class="fas fa-utensils"></i> Menu Management
            </a>
            <a href="#" id="ordersLink">
                <i class="fas fa-clipboard-list"></i> Order Management
            </a>
            <a href="#" id="customersLink">
                <i class="fas fa-users"></i> Customer Management
            </a>
            <a href="#" id="settingsLink">
                <i class="fas fa-cog"></i> General Settings
            </a>
            <a href="#" id="logoutButton" class="mt-8">
                <i class="fas fa-sign-out-alt"></i> Logout
            </a>
        </nav>
    </div>

    <!-- Main Content Area -->
    <div class="flex-1 flex flex-col">
        <!-- Header -->
        <header class="header">
            <h2 class="text-2xl font-semibold text-gray-800">Dashboard Overview</h2>
            <div class="flex items-center">
                <span class="text-gray-600 mr-4">Welcome, Admin!</span>
                <button id="logoutButtonHeader" class="bg-red-500 hover:bg-red-600 text-white px-4 py-2 rounded-lg shadow-md transition duration-200 ease-in-out">
                    <i class="fas fa-sign-out-alt mr-2"></i>Logout
                </button>
            </div>
        </header>

        <!-- Page Content -->
        <main class="p-8 flex-1 overflow-y-auto">
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                <!-- WhatsApp Bot Status Card -->
                <div class="card col-span-1 md:col-span-2 lg:col-span-1">
                    <h3 class="text-xl font-semibold mb-4 text-gray-700"><i class="fab fa-whatsapp text-green-500 mr-2"></i>WhatsApp Bot Status</h3>
                    <p class="text-gray-600 mb-2">Status: <span id="botStatusText" class="font-bold">Loading...</span></p>
                    <p class="text-gray-600 mb-2">Last Authenticated: <span id="lastAuthenticatedAt" class="font-bold">N/A</span></p>
                    <div id="qrCodeContainer" class="text-center my-4" style="display: none;">
                        <p class="text-sm text-gray-500 mb-2">Scan this QR to connect WhatsApp:</p>
                        <img id="qrCodeImage" src="" alt="QR Code" class="mx-auto w-48 h-48 border border-gray-300 rounded-lg p-2">
                    </div>
                    <button id="forceNewSessionBtn" class="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-lg shadow-md transition duration-200 ease-in-out mt-4 w-full">
                        <i class="fas fa-sync-alt mr-2"></i>Force New Session
                    </button>
                    <div class="mt-4 p-3 bg-gray-100 rounded-lg max-h-48 overflow-y-auto text-sm text-gray-700">
                        <h4 class="font-semibold mb-2">Bot Logs:</h4>
                        <div id="botLogs"></div>
                    </div>
                </div>

                <!-- Discount Settings Card -->
                <div class="card col-span-1 md:col-span-2 lg:col-span-1">
                    <h3 class="text-xl font-semibold mb-4 text-gray-700"><i class="fas fa-tags text-purple-500 mr-2"></i>Discount Settings</h3>
                    <div class="mb-4">
                        <label for="minSubtotalForDiscount" class="block text-gray-700 text-sm font-bold mb-2">Minimum Subtotal for Discount (â‚¹):</label>
                        <input type="number" id="minSubtotalForDiscount" class="shadow appearance-none border rounded-lg w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline" value="0" min="0">
                    </div>
                    <div class="mb-4">
                        <label for="discountPercentage" class="block text-gray-700 text-sm font-bold mb-2">Discount Percentage (0.0 - 1.0):</label>
                        <input type="number" id="discountPercentage" class="shadow appearance-none border rounded-lg w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline" value="0.0" min="0" max="1" step="0.01">
                    </div>
                    <div class="flex items-center justify-between mb-4">
                        <label for="isDiscountEnabled" class="block text-gray-700 text-sm font-bold">Enable Discount:</label>
                        <label class="toggle-switch">
                            <input type="checkbox" id="isDiscountEnabled">
                            <span class="slider round"></span>
                        </label>
                    </div>
                    <button id="saveDiscountSettingsBtn" class="bg-green-500 hover:bg-green-600 text-white px-4 py-2 rounded-lg shadow-md transition duration-200 ease-in-out w-full">
                        <i class="fas fa-save mr-2"></i>Save Discount Settings
                    </button>
                </div>

                <!-- Placeholder Card (can be used for analytics, quick stats etc.) -->
                <div class="card col-span-1 md:col-span-2 lg:col-span-1">
                    <h3 class="text-xl font-semibold mb-4 text-gray-700"><i class="fas fa-chart-line text-blue-500 mr-2"></i>Quick Stats</h3>
                    <p class="text-gray-600">More content coming soon!</p>
                    <div class="mt-4 p-3 bg-gray-100 rounded-lg">
                        <p class="text-sm text-gray-700">Total Orders: <span class="font-semibold">500+</span></p>
                        <p class="text-sm text-gray-700">Active Customers: <span class="font-semibold">120</span></p>
                        <p class="text-sm text-gray-700">Revenue (This Month): <span class="font-semibold">â‚¹50,000</span></p>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Message Box -->
    <div id="messageBox"></div>

    <script src="/socket.io/socket.io.js"></script>
    <script>
        const API_BASE_URL = window.location.origin;
        const socket = io();

        const botStatusText = document.getElementById('botStatusText');
        const lastAuthenticatedAt = document.getElementById('lastAuthenticatedAt');
        const qrCodeContainer = document.getElementById('qrCodeContainer');
        const qrCodeImage = document.getElementById('qrCodeImage');
        const forceNewSessionBtn = document.getElementById('forceNewSessionBtn');
        const botLogs = document.getElementById('botLogs');

        const minSubtotalForDiscountInput = document.getElementById('minSubtotalForDiscount');
        const discountPercentageInput = document.getElementById('discountPercentage');
        const isDiscountEnabledToggle = document.getElementById('isDiscountEnabled');
        const saveDiscountSettingsBtn = document.getElementById('saveDiscountSettingsBtn');

        const logoutButton = document.getElementById('logoutButton');
        const logoutButtonHeader = document.getElementById('logoutButtonHeader');
        const messageBox = document.getElementById('messageBox');

        // --- Helper Function for displaying messages ---
        function showMessage(message, isError = false) {
            messageBox.textContent = message;
            messageBox.className = ''; // Clear existing classes
            messageBox.classList.add('fade-in');
            if (isError) {
                messageBox.classList.add('error');
            } else {
                messageBox.classList.add('success');
            }
            messageBox.style.display = 'block';
            messageBox.style.opacity = '1';

            setTimeout(() => {
                messageBox.style.opacity = '0';
                setTimeout(() => {
                    messageBox.style.display = 'none';
                }, 300); // Wait for fade-out to complete
            }, 3000); // Message visible for 3 seconds
        }

        // --- Authentication Helper ---
        async function fetchWithAuth(url, options = {}) {
            const token = localStorage.getItem('jwtToken');
            if (!token) {
                console.error('No JWT token found. Redirecting to login.');
                localStorage.removeItem('jwtToken'); // Ensure token is cleared
                window.location.href = '/admin/login';
                return; // Prevent further execution
            }

            options.headers = {
                ...options.headers,
                'Authorization': `Bearer ${token}`
            };

            const response = await fetch(url, options);

            if (response.status === 401 || response.status === 403) {
                console.error('Authentication failed or session expired. Redirecting to login.');
                localStorage.removeItem('jwtToken');
                window.location.href = '/admin/login';
                return; // Prevent further execution
            }
            return response;
        }

        // --- Initial Authentication Check on Page Load ---
        document.addEventListener('DOMContentLoaded', async () => {
            const token = localStorage.getItem('jwtToken');
            if (!token) {
                // If no token in localStorage, redirect to login
                window.location.href = '/admin/login';
                return;
            }

            // Verify token by making an authenticated API call
            try {
                const response = await fetchWithAuth(`${API_BASE_URL}/api/admin/bot-status`);
                if (!response || !response.ok) {
                    // fetchWithAuth already handles redirect for 401/403
                    // If it's another error, log and redirect
                    console.error('Failed to verify token on dashboard load:', response ? response.status : 'No response');
                    localStorage.removeItem('jwtToken');
                    window.location.href = '/admin/login';
                    return;
                }
                console.log('Token validated. Dashboard loaded.');
                // Proceed to load dashboard data
                fetchBotStatus();
                fetchDiscountSettings();
            } catch (error) {
                console.error('Error during initial token validation:', error);
                localStorage.removeItem('jwtToken');
                window.location.href = '/admin/login';
            }
        });

        // --- Logout Functionality ---
        function logout() {
            localStorage.removeItem('jwtToken');
            window.location.href = '/admin/login';
        }
        logoutButton.addEventListener('click', logout);
        logoutButtonHeader.addEventListener('click', logout);


        // --- WhatsApp Bot Status Functions ---
        async function fetchBotStatus() {
            try {
                const response = await fetchWithAuth(`${API_BASE_URL}/api/admin/bot-status`);
                const data = await response.json();
                updateBotStatusUI(data.status, data.lastAuthenticatedAt);
                if (data.qrCodeAvailable) {
                    // Request QR code if available (socket.io will send it)
                    // No direct fetch here, socket.io handles it.
                } else {
                    qrCodeContainer.style.display = 'none';
                    qrCodeImage.src = '';
                }
            } catch (error) {
                console.error('Error fetching bot status:', error);
                showMessage('Failed to fetch bot status.', true);
            }
        }

        function updateBotStatusUI(status, timestamp) {
            botStatusText.textContent = status.replace(/_/g, ' ').toUpperCase();
            botStatusText.className = 'font-bold status-indicator ' + `status-${status}`;
            lastAuthenticatedAt.textContent = timestamp ? new Date(timestamp).toLocaleString() : 'N/A';
        }

        forceNewSessionBtn.addEventListener('click', async () => {
            if (!confirm('Are you sure you want to force a new WhatsApp session? This will disconnect the current session and require scanning a new QR code.')) {
                return;
            }
            try {
                showMessage('Requesting new WhatsApp session...');
                const response = await fetchWithAuth(`${API_BASE_URL}/api/admin/load-session`, {
                    method: 'POST'
                });
                const data = await response.json();
                if (response.ok) {
                    showMessage(data.message);
                } else {
                    showMessage(data.message || 'Failed to force new session.', true);
                }
            } catch (error) {
                console.error('Error forcing new session:', error);
                showMessage('Error forcing new session.', true);
            }
        });

        // --- Socket.IO Listeners for Real-time Bot Status ---
        socket.on('status', (status) => {
            console.log('Socket.IO: Status update received:', status);
            updateBotStatusUI(status, new Date()); // Use current time for immediate feedback
            // If status is not qr_received, hide QR
            if (status !== 'qr_received') {
                qrCodeContainer.style.display = 'none';
                qrCodeImage.src = '';
            }
        });

        socket.on('qrCode', (qrData) => {
            console.log('Socket.IO: QR Code received.');
            if (qrData) {
                qrCodeImage.src = qrData;
                qrCodeContainer.style.display = 'block';
                showMessage('New QR code received. Please scan with your WhatsApp app.');
            } else {
                qrCodeContainer.style.display = 'none';
                qrCodeImage.src = '';
            }
        });

        socket.on('sessionInfo', (info) => {
            console.log('Socket.IO: Session info received:', info);
            lastAuthenticatedAt.textContent = info.lastAuthenticatedAt ? new Date(info.lastAuthenticatedAt).toLocaleString() : 'N/A';
        });

        socket.on('whatsapp_log', (logMessage) => {
            const logEntry = document.createElement('p');
            logEntry.textContent = `[${new Date().toLocaleTimeString()}] ${logMessage}`;
            botLogs.prepend(logEntry); // Add new logs to the top
            if (botLogs.children.length > 50) { // Keep log history manageable
                botLogs.removeChild(botLogs.lastChild);
            }
        });

        // --- Discount Settings Functions ---
        async function fetchDiscountSettings() {
            try {
                const response = await fetchWithAuth(`${API_BASE_URL}/api/admin/discount-settings`);
                const data = await response.json();
                if (response.ok) {
                    minSubtotalForDiscountInput.value = data.minSubtotalForDiscount || 0;
                    discountPercentageInput.value = data.discountPercentage || 0;
                    isDiscountEnabledToggle.checked = data.isDiscountEnabled;
                } else {
                    showMessage(data.message || 'Failed to fetch discount settings.', true);
                }
            } catch (error) {
                console.error('Error fetching discount settings:', error);
                showMessage('Error fetching discount settings.', true);
            }
        }

        saveDiscountSettingsBtn.addEventListener('click', async () => {
            const minSubtotal = parseFloat(minSubtotalForDiscountInput.value);
            const discountPercent = parseFloat(discountPercentageInput.value);
            const isEnabled = isDiscountEnabledToggle.checked;

            if (isNaN(minSubtotal) || minSubtotal < 0) {
                showMessage('Minimum subtotal must be a non-negative number.', true);
                return;
            }
            if (isNaN(discountPercent) || discountPercent < 0 || discountPercent > 1) {
                showMessage('Discount percentage must be between 0 and 1.', true);
                return;
            }

            try {
                showMessage('Saving discount settings...');
                const response = await fetchWithAuth(`${API_BASE_URL}/api/admin/discount-settings`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        minSubtotalForDiscount: minSubtotal,
                        discountPercentage: discountPercent,
                        isDiscountEnabled: isEnabled
                    })
                });
                const data = await response.json();
                if (response.ok) {
                    showMessage(data.message || 'Discount settings saved successfully!');
                    // Re-fetch to ensure UI is in sync with saved data
                    fetchDiscountSettings();
                } else {
                    showMessage(data.message || 'Failed to save discount settings.', true);
                }
            } catch (error) {
                console.error('Error saving discount settings:', error);
                showMessage('Error saving discount settings.', true);
            }
        });

        // Placeholder for other navigation links (will be implemented later)
        document.getElementById('menuLink').addEventListener('click', (e) => {
            e.preventDefault();
            showMessage('Menu Management section coming soon!');
        });
        document.getElementById('ordersLink').addEventListener('click', (e) => {
            e.preventDefault();
            showMessage('Order Management section coming soon!');
        });
        document.getElementById('customersLink').addEventListener('click', (e) => {
            e.preventDefault();
            showMessage('Customer Management section coming soon!');
        });
        document.getElementById('settingsLink').addEventListener('click', (e) => {
            e.preventDefault();
            showMessage('General Settings section coming soon!');
        });

    </script>
</body>
</html>

