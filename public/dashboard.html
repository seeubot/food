<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard - Delicious Bites</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Font Awesome for icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
    <!-- Socket.io Client CDN -->
    <script src="/socket.io/socket.io.js"></script>
    <style>
        /* Custom Font - Inter */
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
        }

        /* New Sidebar Styling */
        .sidebar {
            width: 280px; /* Fixed width for larger screens */
            transition: transform 0.3s ease-in-out, box-shadow 0.3s ease-in-out;
            transform: translateX(0); /* Always visible by default on desktop */
            z-index: 40;
            background: linear-gradient(180deg, #2d3748 0%, #1a202c 100%); /* Darker gradient */
            box-shadow: 4px 0 10px rgba(0, 0, 0, 0.3); /* Stronger shadow */
            overflow-y: auto; /* ADDED: Allows sidebar content to scroll */
        }
        .sidebar.hidden-mobile {
            transform: translateX(-100%); /* Hide sidebar off-screen on mobile */
            position: fixed; /* Fixed position for mobile sidebar */
            height: 100vh; /* Full viewport height */
            top: 0;
            left: 0;
            box-shadow: 2px 0 5px rgba(0,0,0,0.5);
        }
        .sidebar.active {
            transform: translateX(0); /* Show sidebar on mobile */
        }

        /* Overlay for mobile when sidebar is open */
        .overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 30;
        }

        .content-area {
            flex-grow: 1;
            overflow-y: auto; /* Allow scrolling for content */
            scroll-behavior: smooth; /* Smooth scrolling for navigation */
        }
        /* Custom scrollbar for logs */
        #whatsappLogs::-webkit-scrollbar {
            width: 8px;
        }
        #whatsappLogs::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 10px;
        }
        #whatsappLogs::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 10px;
        }
        #whatsappLogs::-webkit-scrollbar-thumb:hover {
            background: #555;
        }
        .modal {
            background-color: rgba(0, 0, 0, 0.5);
        }
        /* Ensure tables are responsive */
        .overflow-x-auto table {
            min-width: 700px; /* Ensure table doesn't shrink too much */
        }

        /* New Order Alert Modal Specific Styling */
        #newOrderAlertModal .modal-content {
            border: 2px solid #4CAF50; /* Green border for new order */
            animation: pulse-green 1.5s infinite alternate;
            text-align: center;
        }

        #newOrderAlertModal h3 {
            color: #4CAF50; /* Green text for new order */
            margin-bottom: 10px;
        }

        @keyframes pulse-green {
            0% { transform: scale(1); box-shadow: 0 0 0 0 rgba(76, 175, 80, 0.7); }
            100% { transform: scale(1.02); box-shadow: 0 0 0 15px rgba(76, 175, 80, 0); }
        }

        /* Responsive adjustments for smaller screens */
        @media (max-width: 768px) {
            .sidebar {
                width: 250px; /* Slightly smaller sidebar on tablets */
            }
            .dashboard-section {
                padding: 1rem; /* Reduce padding on sections */
            }
            .grid-cols-1\/2 {
                grid-template-columns: 1fr; /* Stack columns on small screens */
            }
        }

        @media (max-width: 640px) { /* Mobile specific adjustments */
            .sidebar {
                position: fixed; /* Fixed position for mobile sidebar */
                left: 0;
                top: 0;
                height: 100vh; /* Full viewport height */
                z-index: 50; /* Ensure it's on top */
                box-shadow: 2px 0 5px rgba(0,0,0,0.5);
            }
            .sidebar:not(.active) {
                transform: translateX(-100%); /* Hide by default */
            }
            .content-area {
                padding: 1rem; /* Adjust padding */
            }
            .dashboard-section {
                margin-bottom: 1rem;
            }
            .text-3xl {
                font-size: 2rem; /* Smaller title */
            }
            .text-2xl {
                font-size: 1.5rem; /* Smaller section titles */
            }
            .px-6 {
                padding-left: 1rem;
                padding-right: 1rem;
            }
            .py-3 {
                padding-top: 0.5rem;
                padding-bottom: 0.5rem;
            }
            .modal-content {
                max-width: 95%; /* Make modal wider on small screens */
            }
            .flex-col-mobile {
                flex-direction: column;
            }
            .space-x-4-mobile > *:not(:first-child) {
                margin-left: 0 !important;
                margin-top: 1rem;
            }
            .action-buttons-group {
                flex-direction: column; /* Stack action buttons vertically on mobile */
                gap: 0.5rem; /* Space between stacked buttons */
            }
        }
    </style>
</head>
<body class="flex min-h-screen bg-gray-100">

    <!-- Mobile Menu Toggle Button -->
    <button id="menuToggleButton" class="md:hidden fixed top-4 left-4 z-50 p-3 bg-indigo-600 text-white rounded-lg shadow-md">
        <i class="fas fa-bars text-xl"></i>
    </button>

    <!-- Sidebar -->
    <aside id="sidebar" class="sidebar text-white p-6 flex flex-col">
        <h1 class="text-3xl font-bold mb-8 text-center text-indigo-300">Delicious Bites</h1>
        <nav class="flex-1">
            <ul class="space-y-3">
                <li>
                    <a href="#botStatus" data-section="botStatus" class="flex items-center space-x-3 p-3 rounded-lg hover:bg-gray-700 transition duration-150 ease-in-out">
                        <i class="fas fa-robot text-xl"></i>
                        <span class="text-lg">Bot Status</span>
                    </a>
                </li>
                <li>
                    <a href="#menuManagement" data-section="menuManagement" class="flex items-center space-x-3 p-3 rounded-lg hover:bg-gray-700 transition duration-150 ease-in-out">
                        <i class="fas fa-utensils text-xl"></i>
                        <span class="text-lg">Menu Management</span>
                    </a>
                </li>
                <li>
                    <a href="#orderManagement" data-section="orderManagement" class="flex items-center space-x-3 p-3 rounded-lg hover:bg-gray-700 transition duration-150 ease-in-out">
                        <i class="fas fa-receipt text-xl"></i>
                        <span class="text-lg">Order Management</span>
                    </a>
                </li>
                <li>
                    <a href="#customerManagement" data-section="customerManagement" class="flex items-center space-x-3 p-3 rounded-lg hover:bg-gray-700 transition duration-150 ease-in-out">
                        <i class="fas fa-users text-xl"></i>
                        <span class="text-lg">Customer Management</span>
                    </a>
                </li>
                <li>
                    <a href="#settings" data-section="settings" class="flex items-center space-x-3 p-3 rounded-lg hover:bg-gray-700 transition duration-150 ease-in-out">
                        <i class="fas fa-cogs text-xl"></i>
                        <span class="text-lg">Settings</span>
                    </a>
                </li>
                <li>
                    <a href="#twoFactorAuth" data-section="twoFactorAuth" class="flex items-center space-x-3 p-3 rounded-lg hover:bg-gray-700 transition duration-150 ease-in-out">
                        <i class="fas fa-shield-alt text-xl"></i>
                        <span class="text-lg">2FA Security</span>
                    </a>
                </li>
                <li>
                    <a href="#whatsappLogs" data-section="whatsappLogs" class="flex items-center space-x-3 p-3 rounded-lg hover:bg-gray-700 transition duration-150 ease-in-out">
                        <i class="fas fa-clipboard-list text-xl"></i>
                        <span class="text-lg">WhatsApp Logs</span>
                    </a>
                </li>
            </ul>
        </nav>
        <button id="logoutButton" class="mt-8 flex items-center justify-center space-x-3 p-3 rounded-lg bg-red-600 hover:bg-red-700 transition duration-150 ease-in-out">
            <i class="fas fa-sign-out-alt text-xl"></i>
            <span class="text-lg">Logout</span>
        </button>
    </aside>

    <!-- Overlay for mobile sidebar -->
    <div id="sidebarOverlay" class="overlay hidden md:hidden"></div>

    <!-- Main Content Area -->
    <main class="content-area p-4 md:p-8 bg-gray-100 w-full">
        <!-- Bot Status Section -->
        <section id="botStatus" class="dashboard-section bg-white p-6 rounded-lg shadow-md mb-8">
            <h2 class="text-2xl font-semibold text-gray-800 mb-4">WhatsApp Bot Status</h2>
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                <div class="flex flex-col items-center justify-center p-4 bg-blue-50 rounded-lg">
                    <p class="text-lg font-medium text-gray-700">Status:</p>
                    <p id="botStatusText" class="text-2xl font-bold text-blue-600 mt-1">Loading...</p>
                </div>
                <div class="flex flex-col items-center justify-center p-4 bg-green-50 rounded-lg">
                    <p class="text-lg font-medium text-gray-700">Last Authenticated:</p>
                    <p id="lastAuthenticatedAt" class="text-xl font-bold text-green-600 mt-1">N/A</p>
                </div>
                <div class="flex flex-col items-center justify-center p-4 bg-yellow-50 rounded-lg">
                    <p class="text-lg font-medium text-gray-700">QR Code:</p>
                    <div id="qrCodeContainer" class="mt-2">
                        <img id="qrCodeImage" src="" alt="QR Code" class="w-48 h-48 border border-gray-300 rounded-lg hidden">
                        <p id="qrMessage" class="text-sm text-gray-500 mt-2">No QR code available.</p>
                    </div>
                </div>
            </div>
            <div class="mt-6 flex flex-col md:flex-row justify-center space-y-4 md:space-y-0 md:space-x-4">
                <button id="loadSessionButton" class="px-6 py-3 bg-indigo-600 text-white rounded-lg shadow-md hover:bg-indigo-700 transition duration-150 ease-in-out text-lg font-semibold">
                    Attempt Reconnect (Load Old Session)
                </button>
                <button id="forceNewSessionButton" class="px-6 py-3 bg-red-600 text-white rounded-lg shadow-md hover:bg-red-700 transition duration-150 ease-in-out text-lg font-semibold">
                    Force New Session (Delete Old)
                </button>
            </div>
        </section>

        <!-- Menu Management Section -->
        <section id="menuManagement" class="dashboard-section bg-white p-6 rounded-lg shadow-md mb-8">
            <div class="flex flex-col sm:flex-row justify-between items-center mb-4 space-y-4 sm:space-y-0">
                <h2 class="text-2xl font-semibold text-gray-800">Menu Management</h2>
                <button id="addMenuItemButton" class="px-4 py-2 bg-green-600 text-white rounded-lg shadow-md hover:bg-green-700 transition duration-150 ease-in-out flex items-center space-x-2 w-full sm:w-auto justify-center">
                    <i class="fas fa-plus"></i>
                    <span>Add New Item</span>
                </button>
            </div>
            <div class="overflow-x-auto rounded-lg border border-gray-200">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="py-3 px-6 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Image</th>
                            <th class="py-3 px-6 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Name</th>
                            <th class="py-3 px-6 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Category</th>
                            <th class="py-3 px-6 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Price</th>
                            <th class="py-3 px-6 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">Available</th>
                            <th class="py-3 px-6 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">Trending</th>
                            <th class="py-3 px-6 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
                        </tr>
                    </thead>
                    <tbody id="menuItemsTableBody" class="bg-white divide-y divide-gray-200">
                        <!-- Menu items will be loaded here -->
                    </tbody>
                </table>
            </div>
        </section>

        <!-- Order Management Section -->
        <section id="orderManagement" class="dashboard-section bg-white p-6 rounded-lg shadow-md mb-8">
            <h2 class="text-2xl font-semibold text-gray-800 mb-4">Order Management</h2>
            <div class="overflow-x-auto rounded-lg border border-gray-200">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="py-3 px-6 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Order ID</th>
                            <th class="py-3 px-6 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Customer</th>
                            <th class="py-3 px-6 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Phone</th>
                            <th class="py-3 px-6 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Total</th>
                            <th class="py-3 px-6 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
                            <th class="py-3 px-6 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">Date</th>
                            <th class="py-3 px-6 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
                        </tr>
                    </thead>
                    <tbody id="ordersTableBody" class="bg-white divide-y divide-gray-200">
                        <!-- Orders will be loaded here -->
                    </tbody>
                </table>
            </div>
        </section>

        <!-- Customer Management Section -->
        <section id="customerManagement" class="dashboard-section bg-white p-6 rounded-lg shadow-md mb-8">
            <h2 class="text-2xl font-semibold text-gray-800 mb-4">Customer Management</h2>
            <div class="overflow-x-auto rounded-lg border border-gray-200">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="py-3 px-6 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Name</th>
                            <th class="py-3 px-6 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Phone</th>
                            <th class="py-3 px-6 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">Total Orders</th>
                            <th class="py-3 px-6 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">Last Order</th>
                            <th class="py-3 px-6 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
                        </tr>
                    </thead>
                    <tbody id="customersTableBody" class="bg-white divide-y divide-gray-200">
                        <!-- Customers will be loaded here -->
                    </tbody>
                </table>
            </div>
        </section>

        <!-- Settings Section -->
        <section id="settings" class="dashboard-section bg-white p-6 rounded-lg shadow-md mb-8">
            <h2 class="text-2xl font-semibold text-gray-800 mb-4">Shop Settings</h2>
            <form id="shopSettingsForm" class="space-y-6">
                <div>
                    <label for="shopName" class="block text-sm font-medium text-gray-700">Shop Name</label>
                    <input type="text" id="shopName" name="shopName" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm" required>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700">Shop Location (Latitude, Longitude)</label>
                    <div class="flex flex-col sm:flex-row space-y-4 sm:space-y-0 sm:space-x-4 mt-1">
                        <input type="number" id="shopLatitude" name="shopLatitude" step="any" class="block w-full sm:w-1/2 px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm" placeholder="Latitude" required>
                        <input type="number" id="shopLongitude" name="shopLongitude" step="any" class="block w-full sm:w-1/2 px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm" placeholder="Longitude" required>
                    </div>
                </div>

                <!-- NEW FIELD FOR NOTIFICATION DAYS -->
                <div>
                    <label for="notificationDays" class="block text-sm font-medium text-gray-700">Re-order Notification Days</label>
                    <input type="number" id="notificationDays" name="notificationDays" min="1" value="7"
                           class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm" required>
                    <p class="mt-1 text-sm text-gray-500">Number of days after which a customer who hasn't ordered will receive a re-order notification.</p>
                </div>

                <h3 class="text-xl font-semibold text-gray-800 mt-6 mb-3">Delivery Rates (by Distance)</h3>
                <div id="deliveryRatesContainer" class="space-y-3">
                    <!-- Delivery rate inputs will be added here by JS -->
                </div>
                <button type="button" id="addDeliveryRate" class="px-4 py-2 bg-blue-600 text-white rounded-lg shadow-md hover:bg-blue-700 transition duration-150 ease-in-out flex items-center space-x-2">
                    <i class="fas fa-plus"></i>
                    <span>Add Delivery Rate</span>
                </button>

                <h2 class="text-2xl font-semibold text-gray-800 mt-8 mb-4">Discount Settings</h2>
                <div>
                    <label for="minSubtotalForDiscount" class="block text-sm font-medium text-gray-700">Minimum Subtotal for Discount (₹)</label>
                    <input type="number" id="minSubtotalForDiscount" name="minSubtotalForDiscount" step="0.01" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm" required>
                </div>
                <div>
                    <label for="discountPercentage" class="block text-sm font-medium text-gray-700">Discount Percentage (0-1, e.g., 0.1 for 10%)</label>
                    <input type="number" id="discountPercentage" name="discountPercentage" step="0.01" min="0" max="1" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm" required>
                </div>
                <div class="flex items-center">
                    <input type="checkbox" id="isDiscountEnabled" name="isDiscountEnabled" class="h-4 w-4 text-indigo-600 focus:ring-indigo-500 border-gray-300 rounded">
                    <label for="isDiscountEnabled" class="ml-2 block text-sm font-medium text-gray-700">Enable Discount</label>
                </div>
                <div class="pt-4">
                    <button type="submit" class="px-6 py-3 bg-indigo-600 text-white rounded-lg shadow-md hover:bg-indigo-700 transition duration-150 ease-in-out text-lg font-semibold w-full sm:w-auto">
                        Save All Settings
                    </button>
                </div>
            </form>
        </section>

        <!-- 2FA Security Section -->
        <section id="twoFactorAuth" class="dashboard-section bg-white p-6 rounded-lg shadow-md mb-8">
            <h2 class="text-2xl font-semibold text-gray-800 mb-4">Two-Factor Authentication (2FA)</h2>
            <div class="space-y-4">
                <p id="2faStatus" class="text-lg font-medium text-gray-700">2FA Status: <span class="font-bold text-red-500">Disabled</span></p>
                <div id="2faActions" class="flex flex-col sm:flex-row space-y-4 sm:space-y-0 sm:space-x-4">
                    <button id="enable2faButton" class="px-4 py-2 bg-green-600 text-white rounded-lg shadow-md hover:bg-green-700 transition duration-150 ease-in-out flex items-center space-x-2 justify-center">
                        <i class="fas fa-check-circle"></i>
                        <span>Enable 2FA</span>
                    </button>
                    <button id="disable2faButton" class="px-4 py-2 bg-red-600 text-white rounded-lg shadow-md hover:bg-red-700 transition duration-150 ease-in-out flex items-center space-x-2 justify-center hidden">
                        <i class="fas fa-times-circle"></i>
                        <span>Disable 2FA</span>
                    </button>
                </div>
            </div>
        </section>

        <!-- WhatsApp Logs Section -->
        <section id="whatsappLogs" class="dashboard-section bg-white p-6 rounded-lg shadow-md mb-8">
            <h2 class="text-2xl font-semibold text-gray-800 mb-4">WhatsApp Bot Logs</h2>
            <div class="bg-gray-800 text-gray-200 p-4 rounded-lg h-96 overflow-y-scroll text-sm font-mono" id="logContainer">
                <!-- Logs will be appended here -->
            </div>
        </section>
    </main>

    <!-- Modals -->
    <!-- Generic Modal for Add/Edit Item, Order Details, 2FA setup, and now custom alerts/confirms -->
    <div id="genericModal" class="modal fixed inset-0 flex items-center justify-center z-50 hidden">
        <div class="bg-white p-8 rounded-lg shadow-xl w-full max-w-lg mx-4 modal-content">
            <div class="flex justify-between items-center mb-6">
                <h3 id="modalTitle" class="text-2xl font-semibold text-gray-800">Modal Title</h3>
                <button id="closeModalButton" class="text-gray-500 hover:text-gray-700 text-3xl">&times;</button>
            </div>
            <div id="modalContent">
                <!-- Content will be dynamically loaded here -->
            </div>
            <div id="modalActions" class="mt-6 flex justify-end space-x-4">
                <!-- Actions will be dynamically loaded here -->
            </div>
        </div>
    </div>

    <!-- Customer Location Map Modal -->
    <div id="customerLocationMapModal" class="modal fixed inset-0 flex items-center justify-center z-50 hidden">
        <div class="bg-white p-8 rounded-lg shadow-xl w-full max-w-2xl mx-4 modal-content">
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-2xl font-semibold text-gray-800">Customer Location</h3>
                <button class="close-button text-gray-500 hover:text-gray-700 text-3xl" data-modal-id="customerLocationMapModal">&times;</button>
            </div>
            <div id="customerLocationMap" class="w-full h-96 rounded-lg border border-gray-300 mb-4"></div>
            <p id="mapLocationDisplay" class="text-gray-700 text-center"></p>
            <div class="mt-6 flex justify-end">
                <button class="px-4 py-2 bg-gray-300 text-gray-800 rounded-lg hover:bg-gray-400" onclick="closeModalById('customerLocationMapModal')">Close</button>
            </div>
        </div>
    </div>

    <!-- New Order Alert Modal -->
    <div id="newOrderAlertModal" class="modal fixed inset-0 flex items-center justify-center z-50 hidden">
        <div class="bg-white p-8 rounded-lg shadow-xl w-full max-w-sm mx-4 modal-content">
            <div class="flex justify-end">
                <button class="close-button text-gray-500 hover:text-gray-700 text-3xl" data-modal-id="newOrderAlertModal">&times;</button>
            </div>
            <lottie-player src="https://lottie.host/e211e031-6e3e-436f-b27e-850d51459a03/P0w652t11n.json" background="transparent" speed="1" loop autoplay style="width: 120px; height: 120px; margin: 0 auto;"></lottie-player>
            <h3 class="text-2xl font-bold text-center mb-2">New Order Received!</h3>
            <p class="text-lg text-gray-700 text-center mb-6">Order ID: <strong id="newOrderAlertId"></strong></p>
            <div class="flex justify-center space-x-4">
                <button id="dismissNewOrderAlertBtn" class="px-4 py-2 bg-gray-300 text-gray-800 rounded-lg hover:bg-gray-400">Dismiss</button>
                <button id="viewNewOrderBtn" class="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700">View Order</button>
            </div>
        </div>
    </div>


    <!-- Leaflet JS -->
    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
    <!-- Lottie Player Script -->
    <script src="https://unpkg.com/@lottiefiles/lottie-player@latest/dist/lottie-player.js"></script>

    <script>
        const API_BASE_URL = ''; // Relative path, assumes same origin
        const WEB_MENU_URL = 'https://jar-menu.vercel.app'; // User provided URL
        const socket = io();
        const jwtToken = localStorage.getItem('jwtToken');

        // Elements
        const dashboardSections = document.querySelectorAll('.dashboard-section');
        const navLinks = document.querySelectorAll('nav a');
        const logoutButton = document.getElementById('logoutButton');

        // Mobile Menu Toggle
        const menuToggleButton = document.getElementById('menuToggleButton');
        const sidebar = document.getElementById('sidebar');
        const sidebarOverlay = document.getElementById('sidebarOverlay');

        // Bot Status Elements
        const botStatusText = document.getElementById('botStatusText');
        const lastAuthenticatedAt = document.getElementById('lastAuthenticatedAt');
        const qrCodeImage = document.getElementById('qrCodeImage');
        const qrMessage = document.getElementById('qrMessage');
        const loadSessionButton = document.getElementById('loadSessionButton');
        const forceNewSessionButton = document.getElementById('forceNewSessionButton');


        // Menu Management Elements
        const addMenuItemButton = document.getElementById('addMenuItemButton');
        const menuItemsTableBody = document.getElementById('menuItemsTableBody');

        // Order Management Elements
        const ordersTableBody = document.getElementById('ordersTableBody');

        // Customer Management Elements
        const customersTableBody = document.getElementById('customersTableBody');

        // Shop Settings Elements (Consolidated)
        const shopSettingsForm = document.getElementById('shopSettingsForm');
        const shopNameInput = document.getElementById('shopName');
        const shopLatitudeInput = document.getElementById('shopLatitude');
        const shopLongitudeInput = document.getElementById('shopLongitude');
        const notificationDaysInput = document.getElementById('notificationDays'); // NEW
        const deliveryRatesContainer = document.getElementById('deliveryRatesContainer');
        const addDeliveryRateButton = document.getElementById('addDeliveryRate');

        // Discount Settings Elements (now part of shopSettingsForm)
        const minSubtotalForDiscountInput = document.getElementById('minSubtotalForDiscount');
        const discountPercentageInput = document.getElementById('discountPercentage');
        const isDiscountEnabledCheckbox = document.getElementById('isDiscountEnabled');

        // 2FA Elements
        const twoFactorAuthSection = document.getElementById('twoFactorAuth');
        const twoFaStatusSpan = document.getElementById('2faStatus');
        const enable2faButton = document.getElementById('enable2faButton');
        const disable2faButton = document.getElementById('disable2faButton');

        // WhatsApp Logs Elements
        const logContainer = document.getElementById('logContainer');

        // Modal Elements
        const genericModal = document.getElementById('genericModal');
        const modalTitle = document.getElementById('modalTitle');
        const modalContent = document.getElementById('modalContent');
        const modalActions = document.getElementById('modalActions');
        const closeModalButton = document.getElementById('closeModalButton');

        // New Modals
        const customerLocationMapModal = document.getElementById('customerLocationMapModal');
        const customerLocationMapDiv = document.getElementById('customerLocationMap');
        const mapLocationDisplay = document.getElementById('mapLocationDisplay');
        const newOrderAlertModal = document.getElementById('newOrderAlertModal');
        const newOrderAlertId = document.getElementById('newOrderAlertId');
        const dismissNewOrderAlertBtn = document.getElementById('dismissNewOrderAlertBtn');
        const viewNewOrderBtn = document.getElementById('viewNewOrderBtn');


        // Global Map Instance
        let currentMapInstance = null;
        let currentMapMarker = null;

        // --- Authentication Check ---
        if (!jwtToken) {
            window.location.href = '/admin/login';
        }

        // --- Helper Functions ---
        async function fetchData(url, options = {}) {
            const headers = {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${jwtToken}`,
                ...options.headers
            };
            const response = await fetch(url, { ...options, headers });
            if (response.status === 401 || response.status === 403) {
                localStorage.removeItem('jwtToken');
                window.location.href = '/admin/login';
                return null; // Prevent further processing
            }
            if (!response.ok) {
                const errorData = await response.json();
                throw new Error(errorData.message || `HTTP error! Status: ${response.status}`);
            }
            return response.json();
        }

        // Modified showSection to scroll instead of hide/show
        function showSection(sectionId) {
            // Hide all sections first
            dashboardSections.forEach(section => {
                section.style.display = 'none';
            });

            const targetSection = document.getElementById(sectionId);
            if (targetSection) {
                targetSection.style.display = 'block'; // Show the selected section
                targetSection.scrollIntoView({ behavior: 'smooth' }); // Scroll to it

                // Special handling for sections that need data loaded
                if (sectionId === 'botStatus') {
                    fetchBotStatus();
                } else if (sectionId === 'menuManagement') {
                    fetchMenuItems();
                } else if (sectionId === 'orderManagement') {
                    fetchOrders();
                } else if (sectionId === 'customerManagement') {
                    fetchCustomers();
                } else if (sectionId === 'settings') {
                    fetchSettings(); // Load all settings
                } else if (sectionId === 'twoFactorAuth') {
                    fetch2FAStatus();
                }
                // whatsappLogs doesn't need specific fetch, it's real-time
            }

            navLinks.forEach(link => {
                if (link.dataset.section === sectionId) {
                    link.classList.add('bg-gray-700');
                } else {
                    link.classList.remove('bg-gray-700');
                }
            });

            // Hide sidebar on mobile after selection
            if (window.innerWidth < 768) {
                sidebar.classList.remove('active');
                sidebar.classList.add('hidden-mobile');
                sidebarOverlay.classList.add('hidden');
            }
        }

        /**
         * Opens the generic modal with custom content and actions.
         * @param {string} title - The title for the modal.
         * @param {string} contentHtml - The HTML content for the modal body.
         * @param {string} actionsHtml - The HTML for action buttons in the modal footer.
         */
        function openGenericModal(title, contentHtml, actionsHtml = '') {
            modalTitle.textContent = title;
            modalContent.innerHTML = contentHtml;
            modalActions.innerHTML = actionsHtml;
            genericModal.classList.remove('hidden');
            genericModal.classList.add('flex'); // Ensure flex for centering
        }

        /**
         * Closes the generic modal.
         */
        function closeModalGeneric() {
            genericModal.classList.add('hidden');
            genericModal.classList.remove('flex');
            modalTitle.textContent = '';
            modalContent.innerHTML = '';
            modalActions.innerHTML = '';
        }

        /**
         * Displays a custom alert message using the generic modal.
         * @param {string} message - The message to display.
         * @param {string} title - The title of the alert. Defaults to 'Alert'.
         */
        function showCustomAlert(message, title = 'Alert') {
            const content = `<p class="text-gray-700">${message}</p>`;
            const actions = `<button id="alertOkButton" class="px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700">OK</button>`;
            openGenericModal(title, content, actions);
            document.getElementById('alertOkButton').addEventListener('click', closeModalGeneric);
        }

        /**
         * Displays a custom confirmation dialog using the generic modal.
         * @param {string} message - The confirmation message.
         * @param {string} title - The title of the confirmation dialog. Defaults to 'Confirm'.
         * @param {function} onConfirmCallback - Callback function to execute if confirmed.
         */
        function showCustomConfirm(message, title = 'Confirm', onConfirmCallback) {
            const content = `<p class="text-gray-700">${message}</p>`;
            const actions = `
                <button id="confirmCancelButton" class="px-4 py-2 bg-gray-300 text-gray-800 rounded-lg hover:bg-gray-400">Cancel</button>
                <button id="confirmOkButton" class="px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700">Confirm</button>
            `;
            openGenericModal(title, content, actions);

            document.getElementById('confirmOkButton').addEventListener('click', () => {
                closeModalGeneric();
                if (typeof onConfirmCallback === 'function') {
                    onConfirmCallback();
                }
            });
            document.getElementById('confirmCancelButton').addEventListener('click', closeModalGeneric);
        }


        function openModalById(modalElementId) {
            document.getElementById(modalElementId).classList.remove('hidden');
            document.getElementById(modalElementId).classList.add('flex'); // Ensure flex for centering
        }

        function closeModalById(modalElementId) {
            document.getElementById(modalElementId).classList.add('hidden');
            document.getElementById(modalElementId).classList.remove('flex');
            // Clean up map if it's the map modal
            if (modalElementId === 'customerLocationMapModal' && currentMapInstance) {
                currentMapInstance.remove();
                currentMapInstance = null;
                currentMapMarker = null;
            }
        }

        closeModalButton.addEventListener('click', closeModalGeneric);
        genericModal.addEventListener('click', (e) => {
            if (e.target === genericModal) {
                closeModalGeneric();
            }
        });
        // Event listeners for close buttons on new modals
        document.querySelectorAll('.close-button').forEach(button => {
            button.addEventListener('click', (e) => {
                const modalId = e.currentTarget.dataset.modalId;
                closeModalById(modalId);
            });
        });


        function formatDateTime(dateString) {
            if (!dateString) return 'N/A';
            const date = new Date(dateString);
            return date.toLocaleString('en-IN', {
                year: 'numeric', month: 'short', day: 'numeric',
                hour: '2-digit', minute: '2-digit', second: '2-digit',
                hour12: true, timeZone: 'Asia/Kolkata'
            });
        }

        function appendLog(message) {
            const logEntry = document.createElement('p');
            logEntry.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
            logContainer.appendChild(logEntry);
            logContainer.scrollTop = logContainer.scrollHeight; // Auto-scroll to bottom
        }

        // --- Event Listeners for Navigation ---
        navLinks.forEach(link => {
            link.addEventListener('click', (e) => {
                e.preventDefault();
                showSection(link.dataset.section);
            });
        });

        logoutButton.addEventListener('click', () => {
            localStorage.removeItem('jwtToken');
            window.location.href = '/admin/login';
        });

        // --- Mobile Menu Toggle ---
        menuToggleButton.addEventListener('click', () => {
            sidebar.classList.toggle('active');
            sidebar.classList.toggle('hidden-mobile');
            sidebarOverlay.classList.toggle('hidden');
        });

        sidebarOverlay.addEventListener('click', () => {
            sidebar.classList.remove('active');
            sidebar.classList.add('hidden-mobile');
            sidebarOverlay.classList.add('hidden');
        });

        // --- Socket.io Listeners ---
        socket.on('status', (status) => {
            botStatusText.textContent = status.replace(/_/g, ' ').toUpperCase();
            botStatusText.className = 'text-2xl font-bold mt-1'; // Reset classes
            if (status === 'ready') {
                botStatusText.classList.add('text-green-600');
            } else if (status === 'disconnected' || status === 'auth_failure' || status === 'qr_error') {
                botStatusText.classList.add('text-red-600');
            } else {
                botStatusText.classList.add('text-yellow-600');
            }
        });

        socket.on('qrCode', (qrData) => {
            if (qrData) {
                qrCodeImage.src = qrData;
                qrCodeImage.classList.remove('hidden');
                qrMessage.textContent = 'Scan this QR code with your WhatsApp app.';
            } else {
                qrCodeImage.src = '';
                qrCodeImage.classList.add('hidden');
                qrMessage.textContent = 'No QR code available.';
            }
        });

        socket.on('sessionInfo', (info) => {
            lastAuthenticatedAt.textContent = info.lastAuthenticatedAt ? formatDateTime(info.lastAuthenticatedAt) : 'N/A';
        });

        socket.on('new_order', (order) => {
            appendLog(`NEW ORDER: ${order.customOrderId || order._id} from ${order.customerName} - Total: ₹${order.totalAmount.toFixed(2)}`);
            newOrderAlertId.textContent = order.customOrderId || order._id;
            openModalById('newOrderAlertModal'); // Show the dedicated new order alert modal
            fetchOrders(); // Refresh orders table
        });

        dismissNewOrderAlertBtn.addEventListener('click', () => {
            closeModalById('newOrderAlertModal');
        });

        viewNewOrderBtn.addEventListener('click', () => {
            closeModalById('newOrderAlertModal');
            showSection('orderManagement'); // Navigate to order management
        });

        socket.on('whatsapp_log', (message) => {
            appendLog(message);
        });

        // --- Bot Status Functions ---
        async function fetchBotStatus() {
            try {
                const data = await fetchData(`${API_BASE_URL}/api/admin/bot-status`);
                if (data) {
                    socket.emit('status', data.status); // Update local status based on API
                    socket.emit('sessionInfo', { lastAuthenticatedAt: data.lastAuthenticatedAt });
                    socket.emit('qrCode', data.qrCodeAvailable ? qrCodeImage.src : null); // Re-emit QR if available
                }
            } catch (error) {
                console.error('Error fetching bot status:', error);
                appendLog(`Error fetching bot status: ${error.message}`);
                showCustomAlert(`Failed to fetch bot status: ${error.message}`, 'Bot Status Error');
            }
        }

        loadSessionButton.addEventListener('click', async () => {
            try {
                await fetchData(`${API_BASE_URL}/api/admin/load-session`, { method: 'POST' });
                appendLog('Requested to attempt reconnect with existing WhatsApp session.');
                showCustomAlert('Attempting to reconnect with existing WhatsApp session. Check logs for updates.', 'Reconnect Initiated');
            } catch (error) {
                console.error('Error attempting reconnect:', error);
                appendLog(`Error attempting reconnect: ${error.message}`);
                showCustomAlert(`Failed to reconnect: ${error.message}`, 'Reconnect Error');
            }
        });

        forceNewSessionButton.addEventListener('click', async () => {
            showCustomConfirm('Are you sure you want to force a NEW WhatsApp session? This will delete any existing session data and require a new QR scan.', 'Confirm New Session', async () => {
                try {
                    await fetchData(`${API_BASE_URL}/api/admin/force-new-session`, { method: 'POST' });
                    appendLog('Requested to force a new WhatsApp session. A new QR code should appear shortly.');
                    showCustomAlert('Forcing a new WhatsApp session. A new QR code should appear shortly. Check logs for updates.', 'New Session Initiated');
                } catch (error) {
                    console.error('Error forcing new session:', error);
                    appendLog(`Error forcing new session: ${error.message}`);
                    showCustomAlert(`Failed to force new session: ${error.message}`, 'New Session Error');
                }
            });
        });


        // --- Menu Management Functions ---
        async function fetchMenuItems() {
            try {
                const items = await fetchData(`${API_BASE_URL}/api/admin/menu`);
                menuItemsTableBody.innerHTML = '';
                if (items.length === 0) {
                    menuItemsTableBody.innerHTML = `<tr><td colspan="7" class="py-3 px-6 text-center text-gray-500">No menu items added yet.</td></tr>`;
                    return;
                }
                items.forEach(item => {
                    const row = `
                        <tr class="border-b border-gray-200 hover:bg-gray-100">
                            <td class="py-3 px-6 text-left">
                                <img src="${item.imageUrl || 'https://placehold.co/50x50/cccccc/ffffff?text=No+Img'}" alt="${item.name}" class="w-12 h-12 rounded-lg object-cover">
                            </td>
                            <td class="py-3 px-6 text-left whitespace-nowrap">${item.name}</td>
                            <td class="py-3 px-6 text-left">${item.category || 'N/A'}</td>
                            <td class="py-3 px-6 text-right">₹${item.price.toFixed(2)}</td>
                            <td class="py-3 px-6 text-center">
                                <i class="fas ${item.isAvailable ? 'fa-check-circle text-green-500' : 'fa-times-circle text-red-500'}"></i>
                            </td>
                            <td class="py-3 px-6 text-center">
                                <i class="fas ${item.isTrending ? 'fa-fire text-orange-500' : 'fa-minus-circle text-gray-400'}"></i>
                            </td>
                            <td class="py-3 px-6 text-center">
                                <div class="flex item-center justify-center space-x-2">
                                    <button class="edit-item-btn text-blue-600 hover:text-blue-800 p-1 rounded-md" data-id="${item._id}" title="Edit Item">
                                        <i class="fas fa-edit"></i>
                                    </button>
                                    <button class="delete-item-btn text-red-600 hover:text-red-800 p-1 rounded-md" data-id="${item._id}" title="Delete Item">
                                        <i class="fas fa-trash-alt"></i>
                                    </button>
                                </div>
                            </td>
                        </tr>
                    `;
                    menuItemsTableBody.insertAdjacentHTML('beforeend', row);
                });
                addMenuItemEventListeners();
            } catch (error) {
                console.error('Error fetching menu items:', error);
                appendLog(`Error fetching menu items: ${error.message}`);
                showCustomAlert(`Failed to fetch menu items: ${error.message}`, 'Menu Error');
            }
        }

        function addMenuItemEventListeners() {
            document.querySelectorAll('.edit-item-btn').forEach(button => {
                button.onclick = (e) => openMenuItemModal(e.currentTarget.dataset.id);
            });
            document.querySelectorAll('.delete-item-btn').forEach(button => {
                button.onclick = (e) => deleteMenuItem(e.currentTarget.dataset.id);
            });
        }

        addMenuItemButton.addEventListener('click', () => openMenuItemModal());

        async function openMenuItemModal(itemId = null) {
            let item = {};
            let modalAction = 'Add';
            if (itemId) {
                modalAction = 'Edit';
                try {
                    item = await fetchData(`${API_BASE_URL}/api/admin/menu/${itemId}`);
                } catch (error) {
                    console.error('Error fetching item for edit:', error);
                    appendLog(`Error fetching item for edit: ${error.message}`);
                    showCustomAlert(`Failed to load item for editing: ${error.message}`, 'Edit Item Error');
                    return;
                }
            }

            const content = `
                <form id="menuItemForm" class="space-y-4">
                    <div>
                        <label for="itemName" class="block text-sm font-medium text-gray-700">Name</label>
                        <input type="text" id="itemName" name="name" value="${item.name || ''}" required
                               class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md">
                    </div>
                    <div>
                        <label for="itemDescription" class="block text-sm font-medium text-gray-700">Description</label>
                        <textarea id="itemDescription" name="description"
                                  class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md">${item.description || ''}</textarea>
                    </div>
                    <div>
                        <label for="itemPrice" class="block text-sm font-medium text-gray-700">Price</label>
                        <input type="number" id="itemPrice" name="price" value="${item.price || ''}" step="0.01" required
                               class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md">
                    </div>
                    <div>
                        <label for="itemImageUrl" class="block text-sm font-medium text-gray-700">Image URL</label>
                        <input type="text" id="itemImageUrl" name="imageUrl" value="${item.imageUrl || ''}"
                               class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md">
                    </div>
                    <div>
                        <label for="itemCategory" class="block text-sm font-medium text-gray-700">Category</label>
                        <input type="text" id="itemCategory" name="category" value="${item.category || ''}"
                               class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md">
                    </div>
                    <div class="flex items-center space-x-4">
                        <input type="checkbox" id="itemIsAvailable" name="isAvailable" ${item.isAvailable !== false ? 'checked' : ''}
                               class="h-4 w-4 text-indigo-600 border-gray-300 rounded">
                        <label for="itemIsAvailable" class="text-sm font-medium text-gray-700">Available</label>
                        <input type="checkbox" id="itemIsTrending" name="isTrending" ${item.isTrending ? 'checked' : ''}
                               class="h-4 w-4 text-indigo-600 border-gray-300 rounded">
                        <label for="itemIsTrending" class="text-sm font-medium text-gray-700">Trending</label>
                    </div>
                </form>
            `;
            const actions = `
                <button id="saveMenuItemButton" class="px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700">Save</button>
                <button id="cancelMenuItemButton" class="px-4 py-2 bg-gray-300 text-gray-800 rounded-lg hover:bg-gray-400">Cancel</button>
            `;
            openGenericModal(`${modalAction} Menu Item`, content, actions);

            document.getElementById('saveMenuItemButton').addEventListener('click', async () => {
                const form = document.getElementById('menuItemForm');
                const formData = new FormData(form);
                const data = Object.fromEntries(formData.entries());
                data.isAvailable = document.getElementById('itemIsAvailable').checked;
                data.isTrending = document.getElementById('itemIsTrending').checked;
                data.price = parseFloat(data.price);

                try {
                    if (itemId) {
                        await fetchData(`${API_BASE_URL}/api/admin/menu/${itemId}`, {
                            method: 'PUT',
                            body: JSON.stringify(data)
                        });
                        appendLog(`Menu item ${data.name} updated.`);
                        showCustomAlert(`Menu item "${data.name}" updated successfully!`, 'Success');
                    } else {
                        await fetchData(`${API_BASE_URL}/api/admin/menu`, {
                            method: 'POST',
                            body: JSON.stringify(data)
                        });
                        appendLog(`Menu item ${data.name} added.`);
                        showCustomAlert(`Menu item "${data.name}" added successfully!`, 'Success');
                    }
                    closeModalGeneric();
                    fetchMenuItems();
                } catch (error) {
                    console.error(`Error ${modalAction.toLowerCase()}ing menu item:`, error);
                    appendLog(`Error ${modalAction.toLowerCase()}ing menu item: ${error.message}`);
                    showCustomAlert(`Error ${modalAction.toLowerCase()}ing menu item: ${error.message}`, 'Operation Failed');
                }
            });
            document.getElementById('cancelMenuItemButton').addEventListener('click', closeModalGeneric);
        }

        async function deleteMenuItem(itemId) {
            showCustomConfirm('Are you sure you want to delete this item? This action cannot be undone.', 'Confirm Deletion', async () => {
                try {
                    await fetchData(`${API_BASE_URL}/api/admin/menu/${itemId}`, { method: 'DELETE' });
                    appendLog(`Menu item ${itemId} deleted.`);
                    showCustomAlert('Menu item deleted successfully!', 'Success');
                    fetchMenuItems();
                } catch (error) {
                    console.error('Error deleting menu item:', error);
                    appendLog(`Error deleting menu item: ${error.message}`);
                    showCustomAlert(`Error deleting menu item: ${error.message}`, 'Deletion Failed');
                }
            });
        }

        // --- Order Management Functions ---
        async function fetchOrders() {
            try {
                const orders = await fetchData(`${API_BASE_URL}/api/admin/orders`);
                ordersTableBody.innerHTML = '';
                if (orders.length === 0) {
                    ordersTableBody.innerHTML = `<tr><td colspan="7" class="py-3 px-6 text-center text-gray-500">No orders yet.</td></tr>`;
                    return;
                }
                orders.forEach(order => {
                    // Clean customer phone for call link
                    const cleanedPhone = order.customerPhone.replace(/\D/g, '');
                    const callLink = `tel:+${cleanedPhone}`;
                    const trackLink = `${WEB_MENU_URL}/track?orderId=${order.pinId || order.customOrderId}`;

                    const row = `
                        <tr class="border-b border-gray-200 hover:bg-gray-100">
                            <td class="py-3 px-6 text-left whitespace-nowrap">${order.customOrderId || order._id.substring(0, 8) + '...'}</td>
                            <td class="py-3 px-6 text-left">${order.customerName}</td>
                            <td class="py-3 px-6 text-left">${order.customerPhone}</td>
                            <td class="py-3 px-6 text-right">₹${order.totalAmount.toFixed(2)}</td>
                            <td class="py-3 px-6 text-center">
                                <span class="px-3 py-1 rounded-full text-xs font-semibold
                                    ${order.status === 'Pending' ? 'bg-yellow-200 text-yellow-800' : ''}
                                    ${order.status === 'Confirmed' || order.status === 'Preparing' ? 'bg-blue-200 text-blue-800' : ''}
                                    ${order.status === 'Out for Delivery' ? 'bg-purple-200 text-purple-800' : ''}
                                    ${order.status === 'Delivered' ? 'bg-green-200 text-green-800' : ''}
                                    ${order.status === 'Cancelled' ? 'bg-red-200 text-red-800' : ''}">
                                    ${order.status}
                                </span>
                            </td>
                            <td class="py-3 px-6 text-center">${new Date(order.orderDate).toLocaleDateString('en-IN', { timeZone: 'Asia/Kolkata' })}</td>
                            <td class="py-3 px-6 text-center">
                                <div class="flex flex-col sm:flex-row items-center justify-center space-y-2 sm:space-y-0 sm:space-x-2 action-buttons-group">
                                    <button class="view-order-btn text-indigo-600 hover:text-indigo-800 p-1 rounded-md" data-id="${order._id}" title="View Details">
                                        <i class="fas fa-eye"></i>
                                    </button>
                                    <a href="${callLink}" class="text-green-600 hover:text-green-800 p-1 rounded-md" title="Call Customer">
                                        <i class="fas fa-phone"></i>
                                    </a>
                                    <button class="view-location-btn text-blue-600 hover:text-blue-800 p-1 rounded-md" data-lat="${order.customerLocation?.latitude}" data-lng="${order.customerLocation?.longitude}" data-address="${order.customerLocation?.address || order.deliveryAddress}" title="View Location">
                                        <i class="fas fa-map-marker-alt"></i>
                                    </button>
                                    <select class="status-select bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 p-1" data-id="${order._id}">
                                        <option value="Pending" ${order.status === 'Pending' ? 'selected' : ''}>Pending</option>
                                        <option value="Confirmed" ${order.status === 'Confirmed' ? 'selected' : ''}>Confirmed</option>
                                        <option value="Preparing" ${order.status === 'Preparing' ? 'selected' : ''}>Preparing</option>
                                        <option value="Out for Delivery" ${order.status === 'Out for Delivery' ? 'selected' : ''}>Out for Delivery</option>
                                        <option value="Delivered" ${order.status === 'Delivered' ? 'selected' : ''}>Delivered</option>
                                        <option value="Cancelled" ${order.status === 'Cancelled' ? 'selected' : ''}>Cancelled</option>
                                    </select>
                                    <button class="delete-order-btn text-red-600 hover:text-red-800 p-1 rounded-md" data-id="${order._id}" title="Delete Order">
                                        <i class="fas fa-trash-alt"></i>
                                    </button>
                                </div>
                            </td>
                        </tr>
                    `;
                    ordersTableBody.insertAdjacentHTML('beforeend', row);
                });
                addOrderEventListeners();
            } catch (error) {
                console.error('Error fetching orders:', error);
                appendLog(`Error fetching orders: ${error.message}`);
                showCustomAlert(`Failed to fetch orders: ${error.message}`, 'Orders Error');
            }
        }

        function addOrderEventListeners() {
            document.querySelectorAll('.view-order-btn').forEach(button => {
                button.onclick = (e) => viewOrderDetails(e.currentTarget.dataset.id);
            });
            document.querySelectorAll('.status-select').forEach(select => {
                select.onchange = (e) => updateOrderStatus(e.currentTarget.dataset.id, e.currentTarget.value);
            });
            document.querySelectorAll('.view-location-btn').forEach(button => {
                button.onclick = (e) => {
                    const lat = parseFloat(e.currentTarget.dataset.lat);
                    const lng = parseFloat(e.currentTarget.dataset.lng);
                    const address = e.currentTarget.dataset.address;
                    showCustomerLocationOnMap(lat, lng, address);
                };
            });
            document.querySelectorAll('.delete-order-btn').forEach(button => {
                button.onclick = (e) => deleteOrder(e.currentTarget.dataset.id);
            });
        }

        async function viewOrderDetails(orderId) {
            try {
                const order = await fetchData(`${API_BASE_URL}/api/admin/orders/${orderId}`);
                const itemsList = order.items.map(item => `<li>${item.name} x ${item.quantity} (₹${item.price.toFixed(2)})</li>`).join('');
                const content = `
                    <p><strong>Order ID:</strong> ${order.customOrderId || order._id}</p>
                    <p><strong>PIN:</strong> ${order.pinId}</p>
                    <p><strong>Customer Name:</strong> ${order.customerName}</p>
                    <p><strong>Customer Phone:</strong> ${order.customerPhone}</p>
                    <p><strong>Delivery Address:</strong> ${order.deliveryAddress}</p>
                    <p><strong>Order Date:</strong> ${formatDateTime(order.orderDate)}</p>
                    <p><strong>Status:</strong> ${order.status}</p>
                    <p><strong>Payment Method:</strong> ${order.paymentMethod}</p>
                    <p><strong>Subtotal:</strong> ₹${order.subtotal.toFixed(2)}</p>
                    <p><strong>Transport Tax:</strong> ₹${order.transportTax.toFixed(2)}</p>
                    <p><strong>Discount:</strong> ₹${order.discountAmount.toFixed(2)}</p>
                    <p><strong>Total Amount:</strong> ₹${order.totalAmount.toFixed(2)}</p>
                    <h4 class="font-semibold mt-4">Items:</h4>
                    <ul class="list-disc list-inside ml-5">${itemsList}</ul>
                `;
                openGenericModal('Order Details', content);
            } catch (error) {
                console.error('Error viewing order details:', error);
                appendLog(`Error viewing order details: ${error.message}`);
                showCustomAlert(`Failed to view order details: ${error.message}`, 'Order Details Error');
            }
        }

        async function updateOrderStatus(orderId, newStatus) {
            try {
                await fetchData(`${API_BASE_URL}/api/admin/orders/${orderId}`, {
                    method: 'PUT',
                    body: JSON.stringify({ status: newStatus })
                });
                appendLog(`Order ${orderId} status updated to ${newStatus}.`);
                showCustomAlert(`Order ${orderId} status updated to ${newStatus}.`, 'Status Updated');
                fetchOrders(); // Refresh table
            } catch (error) {
                console.error('Error updating order status:', error);
                appendLog(`Error updating order status: ${error.message}`);
                showCustomAlert(`Failed to update order status: ${error.message}`, 'Status Update Error');
            }
        }

        async function deleteOrder(orderId) {
            showCustomConfirm('Are you sure you want to delete this order? This action is irreversible.', 'Confirm Deletion', async () => {
                try {
                    await fetchData(`${API_BASE_URL}/api/admin/orders/${orderId}`, { method: 'DELETE' });
                    appendLog(`Order ${orderId} deleted.`);
                    showCustomAlert('Order deleted successfully!', 'Success');
                    fetchOrders();
                } catch (error) {
                    console.error('Error deleting order:', error);
                    appendLog(`Error deleting order: ${error.message}`);
                    showCustomAlert(`Failed to delete order: ${error.message}`, 'Deletion Failed');
                }
            });
        }

        function showCustomerLocationOnMap(lat, lng, address) {
            if (isNaN(lat) || isNaN(lng)) {
                showCustomAlert('Customer location coordinates are not available for this order.', 'Location Unavailable');
                return;
            }
            openModalById('customerLocationMapModal');
            mapLocationDisplay.textContent = `Location: ${address || 'Coordinates provided'}`;

            setTimeout(() => {
                if (currentMapInstance) {
                    currentMapInstance.remove(); // Remove existing map instance
                }
                currentMapInstance = L.map('customerLocationMap').setView([lat, lng], 16); // Zoom level 16

                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                    attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
                }).addTo(currentMapInstance);

                if (currentMapMarker) {
                    currentMapInstance.removeLayer(currentMapMarker);
                }
                currentMapMarker = L.marker([lat, lng]).addTo(currentMapInstance)
                    .bindPopup(`<b>Customer Location:</b><br>${address || `Lat: ${lat.toFixed(4)}, Lng: ${lng.toFixed(4)}`}`)
                    .openPopup();

                currentMapInstance.invalidateSize(); // Crucial for map rendering in hidden modals
            }, 100); // Small delay to ensure modal is visible
        }

        // --- Customer Management Functions ---
        async function fetchCustomers() {
            try {
                const customers = await fetchData(`${API_BASE_URL}/api/admin/customers`);
                customersTableBody.innerHTML = '';
                if (customers.length === 0) {
                    customersTableBody.innerHTML = `<tr><td colspan="5" class="py-3 px-6 text-center text-gray-500">No customers found.</td></tr>`;
                    return;
                }
                customers.forEach(customer => {
                    // Clean customer phone for call link
                    const cleanedPhone = customer.customerPhone.replace(/\D/g, '');
                    const callLink = `tel:+${cleanedPhone}`;

                    const row = `
                        <tr class="border-b border-gray-200 hover:bg-gray-100">
                            <td class="py-3 px-6 text-left whitespace-nowrap">${customer.customerName || 'N/A'}</td>
                            <td class="py-3 px-6 text-left">${customer.customerPhone}</td>
                            <td class="py-3 px-6 text-center">${customer.totalOrders}</td>
                            <td class="py-3 px-6 text-center">${customer.lastOrderDate ? new Date(customer.lastOrderDate).toLocaleDateString('en-IN', { timeZone: 'Asia/Kolkata' }) : 'N/A'}</td>
                            <td class="py-3 px-6 text-center">
                                <div class="flex flex-col sm:flex-row items-center justify-center space-y-2 sm:space-y-0 sm:space-x-2 action-buttons-group">
                                    <button class="view-customer-orders-btn text-blue-600 hover:text-blue-800 p-1 rounded-md" data-phone="${customer.customerPhone}" title="View All Orders">
                                        <i class="fas fa-history"></i> Orders
                                    </button>
                                    <a href="${callLink}" class="text-green-600 hover:text-green-800 p-1 rounded-md" title="Call Customer">
                                        <i class="fas fa-phone"></i> Call
                                    </a>
                                    <button class="delete-customer-btn text-red-600 hover:text-red-800 p-1 rounded-md" data-id="${customer._id}" title="Delete Customer">
                                        <i class="fas fa-trash-alt"></i> Delete
                                    </button>
                                </div>
                            </td>
                        </tr>
                    `;
                    customersTableBody.insertAdjacentHTML('beforeend', row);
                });
                addCustomerEventListeners();
            } catch (error) {
                console.error('Error fetching customers:', error);
                appendLog(`Error fetching customers: ${error.message}`);
                showCustomAlert(`Failed to fetch customers: ${error.message}`, 'Customers Error');
            }
        }

        function addCustomerEventListeners() {
            document.querySelectorAll('.view-customer-orders-btn').forEach(button => {
                button.onclick = (e) => viewCustomerOrders(e.currentTarget.dataset.phone);
            });
            document.querySelectorAll('.delete-customer-btn').forEach(button => {
                button.onclick = (e) => deleteCustomer(e.currentTarget.dataset.id);
            });
        }

        async function viewCustomerOrders(customerPhone) {
            try {
                const orders = await fetchData(`${API_BASE_URL}/api/admin/customers/${customerPhone}/orders`);
                let content = '';
                if (orders.length === 0) {
                    content = '<p>No orders found for this customer.</p>';
                } else {
                    content = orders.map(order => `
                        <div class="border-b border-gray-200 pb-4 mb-4 last:border-b-0 last:pb-0 last:mb-0">
                            <p><strong>Order ID:</strong> ${order.customOrderId || order._id}</p>
                            <p><strong>Total:</strong> ₹${order.totalAmount.toFixed(2)}</p>
                            <p><strong>Status:</strong> ${order.status}</p>
                            <p><strong>Date:</strong> ${formatDateTime(order.orderDate)}</p>
                            <h5 class="font-medium mt-2">Items:</h5>
                            <ul class="list-disc list-inside ml-5">
                                ${order.items.map(item => `<li>${item.name} x ${item.quantity}</li>`).join('')}
                            </ul>
                        </div>
                    `).join('');
                }
                openGenericModal(`Orders for ${customerPhone}`, content);
            } catch (error) {
                console.error('Error viewing customer orders:', error);
                appendLog(`Error viewing customer orders: ${error.message}`);
                showCustomAlert(`Failed to view customer orders: ${error.message}`, 'Customer Orders Error');
            }
        }

        async function deleteCustomer(customerId) {
            showCustomConfirm('Are you sure you want to delete this customer and all their associated data? This action is irreversible.', 'Confirm Deletion', async () => {
                try {
                    await fetchData(`${API_BASE_URL}/api/admin/customers/${customerId}`, { method: 'DELETE' });
                    appendLog(`Customer ${customerId} deleted.`);
                    showCustomAlert('Customer and associated data deleted successfully!', 'Success');
                    fetchCustomers();
                } catch (error) {
                    console.error('Error deleting customer:', error);
                    appendLog(`Error deleting customer: ${error.message}`);
                    showCustomAlert(`Failed to delete customer: ${error.message}`, 'Deletion Failed');
                }
            });
        }

        // --- Settings Functions ---
        async function fetchSettings() {
            try {
                const settings = await fetchData(`${API_BASE_URL}/api/admin/settings`);
                if (settings) {
                    shopNameInput.value = settings.shopName || '';
                    shopLatitudeInput.value = settings.shopLocation ? settings.shopLocation.latitude : '';
                    shopLongitudeInput.value = settings.shopLocation ? settings.shopLocation.longitude : '';
                    notificationDaysInput.value = settings.notificationDays || 7; // NEW: Populate notificationDays

                    // Populate Delivery Rates
                    deliveryRatesContainer.innerHTML = ''; // Clear existing rows
                    if (settings.deliveryRates && settings.deliveryRates.length > 0) {
                        settings.deliveryRates.forEach(rate => addDeliveryRateRow(rate.kms, rate.amount));
                    } else {
                        addDeliveryRateRow(); // Add an empty row if no rates exist
                    }

                    // Populate Discount Settings
                    minSubtotalForDiscountInput.value = settings.minSubtotalForDiscount || 0;
                    discountPercentageInput.value = settings.discountPercentage || 0;
                    isDiscountEnabledCheckbox.checked = settings.isDiscountEnabled || false;
                }
            } catch (error) {
                console.error('Error fetching settings:', error);
                appendLog(`Error fetching settings: ${error.message}`);
                showCustomAlert(`Failed to fetch shop settings: ${error.message}`, 'Settings Error');
            }
        }

        function addDeliveryRateRow(kms = '', amount = '') {
            const div = document.createElement('div');
            div.className = 'flex flex-col sm:flex-row space-y-2 sm:space-y-0 sm:space-x-2 items-center';
            div.innerHTML = `
                <input type="number" class="block w-full sm:w-1/3 px-3 py-2 border border-gray-300 rounded-md delivery-range-start" placeholder="Start KM" value="${kms}" step="0.1" required>
                <input type="number" class="block w-full sm:w-1/3 px-3 py-2 border border-gray-300 rounded-md delivery-amount" placeholder="Amount (₹)" value="${amount}" step="0.01" required>
                <button type="button" class="remove-delivery-rate text-red-600 hover:text-red-800 px-2 py-1 rounded-md" title="Remove Rate">
                    <i class="fas fa-minus-circle"></i>
                </button>
            `;
            deliveryRatesContainer.appendChild(div);
            // Add event listener to the newly created remove button
            div.querySelector('.remove-delivery-rate').addEventListener('click', (e) => {
                if (deliveryRatesContainer.children.length > 1) { // Don't remove the last one
                    e.target.closest('.flex').remove();
                } else {
                    showCustomAlert('You must have at least one delivery rate.', 'Cannot Remove Last Rate');
                }
            });
        }

        addDeliveryRateButton.addEventListener('click', () => addDeliveryRateRow());

        shopSettingsForm.addEventListener('submit', async (e) => {
            e.preventDefault();

            const shopName = shopNameInput.value.trim();
            const latitude = parseFloat(shopLatitudeInput.value);
            const longitude = parseFloat(shopLongitudeInput.value);
            const notificationDays = parseInt(notificationDaysInput.value, 10); // NEW

            // Basic validation for shop settings
            if (!shopName) {
                showCustomAlert('Shop Name is required.', 'Validation Error');
                return;
            }
            if (isNaN(latitude) || isNaN(longitude)) {
                showCustomAlert('Shop Latitude and Longitude must be valid numbers.', 'Validation Error');
                return;
            }
            if (isNaN(notificationDays) || notificationDays < 1) { // NEW
                showCustomAlert('Re-order Notification Days must be a positive number.', 'Validation Error');
                return;
            }


            const deliveryRates = [];
            let isValidRates = true;
            Array.from(deliveryRatesContainer.children).forEach(div => {
                const startInput = div.querySelector('.delivery-range-start'); // Note: Your HTML has .delivery-range-start/.delivery-range-end but JS only uses .delivery-range-start
                const amountInput = div.querySelector('.delivery-amount');

                // Assuming 'start' is the 'kms' value as per backend schema
                const kms = parseFloat(startInput.value);
                const amount = parseFloat(amountInput.value);

                // Frontend validation for delivery rates
                if (isNaN(kms) || kms < 0 || isNaN(amount) || amount < 0) {
                    isValidRates = false;
                    return; // Exit forEach early
                }
                deliveryRates.push({ kms: kms, amount: amount }); // Ensure 'kms' is the key for backend
            });

            if (!isValidRates) {
                showCustomAlert('Please ensure all delivery rate KMs and Amounts are valid non-negative numbers.', 'Invalid Delivery Rates');
                return;
            }

            // Discount Settings Validation
            const minSubtotalForDiscount = parseFloat(minSubtotalForDiscountInput.value);
            const discountPercentage = parseFloat(discountPercentageInput.value);
            const isDiscountEnabled = isDiscountEnabledCheckbox.checked;

            if (isNaN(minSubtotalForDiscount) || minSubtotalForDiscount < 0) {
                showCustomAlert('Minimum Subtotal for Discount must be a non-negative number.', 'Validation Error');
                return;
            }
            if (isNaN(discountPercentage) || discountPercentage < 0 || discountPercentage > 1) {
                showCustomAlert('Discount Percentage must be a number between 0 and 1 (e.g., 0.1 for 10%).', 'Validation Error');
                return;
            }

            const settingsPayload = {
                shopName: shopName,
                shopLocation: { latitude: latitude, longitude: longitude },
                notificationDays: notificationDays, // NEW
                deliveryRates: deliveryRates,
                minSubtotalForDiscount: minSubtotalForDiscount,
                discountPercentage: discountPercentage,
                isDiscountEnabled: isDiscountEnabled
            };

            try {
                const data = await fetchData(`${API_BASE_URL}/api/admin/settings`, {
                    method: 'PUT',
                    body: JSON.stringify(settingsPayload)
                });
                appendLog('Shop settings updated successfully.');
                showCustomAlert('Shop settings updated successfully!', 'Success');
            } catch (error) {
                console.error('Error updating shop settings:', error);
                appendLog(`Error updating shop settings: ${error.message}`);
                showCustomAlert(`Failed to update shop settings: ${error.message}`, 'Update Failed');
            }
        });

        // --- 2FA Management Functions ---
        async function fetch2FAStatus() {
            try {
                const data = await fetchData(`${API_BASE_URL}/api/admin/2fa/status`);
                if (data.twoFactorEnabled) {
                    twoFaStatusSpan.textContent = 'Enabled';
                    twoFaStatusSpan.classList.remove('text-red-500');
                    twoFaStatusSpan.classList.add('text-green-500');
                    enable2faButton.classList.add('hidden');
                    disable2faButton.classList.remove('hidden');
                } else {
                    twoFaStatusSpan.textContent = 'Disabled';
                    twoFaStatusSpan.classList.remove('text-green-500');
                    twoFaStatusSpan.classList.add('text-red-500');
                    enable2faButton.classList.remove('hidden');
                    disable2faButton.classList.add('hidden');
                }
            } catch (error) {
                console.error('Error fetching 2FA status:', error);
                appendLog(`Error fetching 2FA status: ${error.message}`);
                showCustomAlert(`Failed to fetch 2FA status: ${error.message}`, '2FA Error');
            }
        }

        enable2faButton.addEventListener('click', async () => {
            try {
                const data = await fetchData(`${API_BASE_URL}/api/admin/2fa/generate`, { method: 'POST' });
                const content = `
                    <p class="mb-4">Scan this QR code with your authenticator app (e.g., Google Authenticator).</p>
                    <div class="flex justify-center mb-4">
                        <img src="${data.qrCodeUrl}" alt="2FA QR Code" class="w-48 h-48 border border-gray-300 rounded-lg">
                    </div>
                    <p class="text-center text-sm text-gray-600 mb-4">Or manually enter this secret: <strong class="font-mono break-all">${data.secret}</strong></p>
                    <div>
                        <label for="2faCodeInput" class="block text-sm font-medium text-gray-700">Enter 6-digit code from app</label>
                        <input type="text" id="2faCodeInput" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md" placeholder="123456">
                    </div>
                    <p id="2faVerifyMessage" class="text-red-600 text-sm mt-2 hidden"></p>
                `;
                const actions = `
                    <button id="verify2faButton" class="px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700">Verify & Enable</button>
                    <button id="cancel2faButton" class="px-4 py-2 bg-gray-300 text-gray-800 rounded-lg hover:bg-gray-400">Cancel</button>
                `;
                openGenericModal('Enable Two-Factor Authentication', content, actions);

                document.getElementById('verify2faButton').addEventListener('click', async () => {
                    const totpCode = document.getElementById('2faCodeInput').value;
                    const verifyMessage = document.getElementById('2faVerifyMessage');
                    verifyMessage.classList.add('hidden');
                    try {
                        const verifyData = await fetchData(`${API_BASE_URL}/api/admin/2fa/verify`, {
                            method: 'POST',
                            body: JSON.stringify({ totpCode, secret: data.secret })
                        });
                        if (verifyData.verified) {
                            showCustomAlert('2FA enabled successfully!', 'Success');
                            closeModalGeneric();
                            fetch2FAStatus();
                            appendLog('2FA enabled successfully.');
                        } else {
                            verifyMessage.textContent = verifyData.message || 'Invalid 2FA code.';
                            verifyMessage.classList.remove('hidden');
                        }
                    } catch (error) {
                        console.error('Error verifying 2FA:', error);
                        verifyMessage.textContent = error.message || 'Error verifying 2FA code.';
                        verifyMessage.classList.remove('hidden');
                        appendLog(`Error verifying 2FA: ${error.message}`);
                    }
                });
                document.getElementById('cancel2faButton').addEventListener('click', closeModalGeneric);

            } catch (error) {
                console.error('Error generating 2FA QR:', error);
                appendLog(`Error generating 2FA QR: ${error.message}`);
                showCustomAlert(`Error generating 2FA QR: ${error.message}`, '2FA Setup Error');
            }
        });

        disable2faButton.addEventListener('click', async () => {
            showCustomConfirm('Are you sure you want to disable Two-Factor Authentication? This will reduce your account security.', 'Confirm Disable 2FA', async () => {
                try {
                    await fetchData(`${API_BASE_URL}/api/admin/2fa/disable`, { method: 'POST' });
                    showCustomAlert('2FA disabled successfully!', 'Success');
                    fetch2FAStatus();
                    appendLog('2FA disabled successfully.');
                } catch (error) {
                    console.error('Error disabling 2FA:', error);
                    appendLog(`Error disabling 2FA: ${error.message}`);
                    showCustomAlert(`Error disabling 2FA: ${error.message}`, '2FA Disable Failed');
                }
            });
        });

        // --- Initial Load ---
        document.addEventListener('DOMContentLoaded', () => {
            // Hide all sections initially
            dashboardSections.forEach(section => {
                section.style.display = 'none';
            });

            // Determine the initial section to show (e.g., 'botStatus' or 'orderManagement')
            const initialSectionId = 'botStatus'; // You can change this to any section ID

            // Show the initial section and load its data
            showSection(initialSectionId);

            // Initial state for mobile sidebar
            if (window.innerWidth < 768) {
                sidebar.classList.add('hidden-mobile');
            }
        });
    </script>
</body>
</html>
