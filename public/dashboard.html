<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard - Delicious Bites</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Font Awesome for icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <!-- Socket.io Client CDN -->
    <script src="/socket.io/socket.io.js"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
        }
        .sidebar {
            width: 280px; /* Fixed width for sidebar */
        }
        .content-area {
            flex-grow: 1;
            overflow-y: auto; /* Allow scrolling for content */
        }
        /* Custom scrollbar for logs */
        #whatsappLogs::-webkit-scrollbar {
            width: 8px;
        }
        #whatsappLogs::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 10px;
        }
        #whatsappLogs::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 10px;
        }
        #whatsappLogs::-webkit-scrollbar-thumb:hover {
            background: #555;
        }
        .modal {
            background-color: rgba(0, 0, 0, 0.5);
        }
    </style>
</head>
<body class="flex min-h-screen bg-gray-100">

    <!-- Sidebar -->
    <aside class="sidebar bg-gray-800 text-white p-6 flex flex-col shadow-lg">
        <h1 class="text-3xl font-bold mb-8 text-center text-indigo-400">Delicious Bites</h1>
        <nav class="flex-1">
            <ul class="space-y-3">
                <li>
                    <a href="#" data-section="botStatus" class="flex items-center space-x-3 p-3 rounded-lg hover:bg-gray-700 transition duration-150 ease-in-out">
                        <i class="fas fa-robot text-xl"></i>
                        <span class="text-lg">Bot Status</span>
                    </a>
                </li>
                <li>
                    <a href="#" data-section="menuManagement" class="flex items-center space-x-3 p-3 rounded-lg hover:bg-gray-700 transition duration-150 ease-in-out">
                        <i class="fas fa-utensils text-xl"></i>
                        <span class="text-lg">Menu Management</span>
                    </a>
                </li>
                <li>
                    <a href="#" data-section="orderManagement" class="flex items-center space-x-3 p-3 rounded-lg hover:bg-gray-700 transition duration-150 ease-in-out">
                        <i class="fas fa-receipt text-xl"></i>
                        <span class="text-lg">Order Management</span>
                    </a>
                </li>
                <li>
                    <a href="#" data-section="customerManagement" class="flex items-center space-x-3 p-3 rounded-lg hover:bg-gray-700 transition duration-150 ease-in-out">
                        <i class="fas fa-users text-xl"></i>
                        <span class="text-lg">Customer Management</span>
                    </a>
                </li>
                <li>
                    <a href="#" data-section="settings" class="flex items-center space-x-3 p-3 rounded-lg hover:bg-gray-700 transition duration-150 ease-in-out">
                        <i class="fas fa-cogs text-xl"></i>
                        <span class="text-lg">Settings</span>
                    </a>
                </li>
                <li>
                    <a href="#" data-section="twoFactorAuth" class="flex items-center space-x-3 p-3 rounded-lg hover:bg-gray-700 transition duration-150 ease-in-out">
                        <i class="fas fa-shield-alt text-xl"></i>
                        <span class="text-lg">2FA Security</span>
                    </a>
                </li>
                <li>
                    <a href="#" data-section="whatsappLogs" class="flex items-center space-x-3 p-3 rounded-lg hover:bg-gray-700 transition duration-150 ease-in-out">
                        <i class="fas fa-clipboard-list text-xl"></i>
                        <span class="text-lg">WhatsApp Logs</span>
                    </a>
                </li>
            </ul>
        </nav>
        <button id="logoutButton" class="mt-8 flex items-center justify-center space-x-3 p-3 rounded-lg bg-red-600 hover:bg-red-700 transition duration-150 ease-in-out">
            <i class="fas fa-sign-out-alt text-xl"></i>
            <span class="text-lg">Logout</span>
        </button>
    </aside>

    <!-- Main Content Area -->
    <main class="content-area p-8 bg-gray-100 overflow-auto">
        <!-- Bot Status Section -->
        <section id="botStatus" class="dashboard-section bg-white p-6 rounded-lg shadow-md mb-8">
            <h2 class="text-2xl font-semibold text-gray-800 mb-4">WhatsApp Bot Status</h2>
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                <div class="flex flex-col items-center justify-center p-4 bg-blue-50 rounded-lg">
                    <p class="text-lg font-medium text-gray-700">Status:</p>
                    <p id="botStatusText" class="text-2xl font-bold text-blue-600 mt-1">Loading...</p>
                </div>
                <div class="flex flex-col items-center justify-center p-4 bg-green-50 rounded-lg">
                    <p class="text-lg font-medium text-gray-700">Last Authenticated:</p>
                    <p id="lastAuthenticatedAt" class="text-xl font-bold text-green-600 mt-1">N/A</p>
                </div>
                <div class="flex flex-col items-center justify-center p-4 bg-yellow-50 rounded-lg">
                    <p class="text-lg font-medium text-gray-700">QR Code:</p>
                    <div id="qrCodeContainer" class="mt-2">
                        <img id="qrCodeImage" src="" alt="QR Code" class="w-48 h-48 border border-gray-300 rounded-lg hidden">
                        <p id="qrMessage" class="text-sm text-gray-500 mt-2">No QR code available.</p>
                    </div>
                </div>
            </div>
            <div class="mt-6 text-center">
                <button id="loadSessionButton" class="px-6 py-3 bg-indigo-600 text-white rounded-lg shadow-md hover:bg-indigo-700 transition duration-150 ease-in-out text-lg font-semibold">
                    Load New Session / Generate QR
                </button>
            </div>
        </section>

        <!-- Menu Management Section -->
        <section id="menuManagement" class="dashboard-section bg-white p-6 rounded-lg shadow-md mb-8 hidden">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-2xl font-semibold text-gray-800">Menu Management</h2>
                <button id="addMenuItemButton" class="px-4 py-2 bg-green-600 text-white rounded-lg shadow-md hover:bg-green-700 transition duration-150 ease-in-out flex items-center space-x-2">
                    <i class="fas fa-plus"></i>
                    <span>Add New Item</span>
                </button>
            </div>
            <div class="overflow-x-auto">
                <table class="min-w-full bg-white rounded-lg shadow-sm">
                    <thead>
                        <tr class="bg-gray-200 text-gray-700 uppercase text-sm leading-normal">
                            <th class="py-3 px-6 text-left">Image</th>
                            <th class="py-3 px-6 text-left">Name</th>
                            <th class="py-3 px-6 text-left">Category</th>
                            <th class="py-3 px-6 text-right">Price</th>
                            <th class="py-3 px-6 text-center">Available</th>
                            <th class="py-3 px-6 text-center">Trending</th>
                            <th class="py-3 px-6 text-center">Actions</th>
                        </tr>
                    </thead>
                    <tbody id="menuItemsTableBody" class="text-gray-600 text-sm font-light">
                        <!-- Menu items will be loaded here -->
                    </tbody>
                </table>
            </div>
        </section>

        <!-- Order Management Section -->
        <section id="orderManagement" class="dashboard-section bg-white p-6 rounded-lg shadow-md mb-8 hidden">
            <h2 class="text-2xl font-semibold text-gray-800 mb-4">Order Management</h2>
            <div class="overflow-x-auto">
                <table class="min-w-full bg-white rounded-lg shadow-sm">
                    <thead>
                        <tr class="bg-gray-200 text-gray-700 uppercase text-sm leading-normal">
                            <th class="py-3 px-6 text-left">Order ID</th>
                            <th class="py-3 px-6 text-left">Customer</th>
                            <th class="py-3 px-6 text-left">Phone</th>
                            <th class="py-3 px-6 text-right">Total</th>
                            <th class="py-3 px-6 text-center">Status</th>
                            <th class="py-3 px-6 text-center">Date</th>
                            <th class="py-3 px-6 text-center">Actions</th>
                        </tr>
                    </thead>
                    <tbody id="ordersTableBody" class="text-gray-600 text-sm font-light">
                        <!-- Orders will be loaded here -->
                    </tbody>
                </table>
            </div>
        </section>

        <!-- Customer Management Section -->
        <section id="customerManagement" class="dashboard-section bg-white p-6 rounded-lg shadow-md mb-8 hidden">
            <h2 class="text-2xl font-semibold text-gray-800 mb-4">Customer Management</h2>
            <div class="overflow-x-auto">
                <table class="min-w-full bg-white rounded-lg shadow-sm">
                    <thead>
                        <tr class="bg-gray-200 text-gray-700 uppercase text-sm leading-normal">
                            <th class="py-3 px-6 text-left">Name</th>
                            <th class="py-3 px-6 text-left">Phone</th>
                            <th class="py-3 px-6 text-center">Total Orders</th>
                            <th class="py-3 px-6 text-center">Last Order</th>
                            <th class="py-3 px-6 text-center">Actions</th>
                        </tr>
                    </thead>
                    <tbody id="customersTableBody" class="text-gray-600 text-sm font-light">
                        <!-- Customers will be loaded here -->
                    </tbody>
                </table>
            </div>
        </section>

        <!-- Settings Section -->
        <section id="settings" class="dashboard-section bg-white p-6 rounded-lg shadow-md mb-8 hidden">
            <h2 class="text-2xl font-semibold text-gray-800 mb-4">Shop Settings</h2>
            <form id="shopSettingsForm" class="space-y-6">
                <div>
                    <label for="shopName" class="block text-sm font-medium text-gray-700">Shop Name</label>
                    <input type="text" id="shopName" name="shopName" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700">Shop Location (Latitude, Longitude)</label>
                    <div class="flex space-x-4 mt-1">
                        <input type="number" id="shopLatitude" name="shopLatitude" step="any" class="block w-1/2 px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm" placeholder="Latitude">
                        <input type="number" id="shopLongitude" name="shopLongitude" step="any" class="block w-1/2 px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm" placeholder="Longitude">
                    </div>
                </div>
                <h3 class="text-xl font-semibold text-gray-800 mt-6 mb-3">Delivery Rates</h3>
                <div id="deliveryRatesContainer" class="space-y-3">
                    <!-- Delivery rate inputs will be added here -->
                </div>
                <button type="button" id="addDeliveryRate" class="px-4 py-2 bg-blue-600 text-white rounded-lg shadow-md hover:bg-blue-700 transition duration-150 ease-in-out flex items-center space-x-2">
                    <i class="fas fa-plus"></i>
                    <span>Add Delivery Rate</span>
                </button>
                <div class="pt-4">
                    <button type="submit" class="px-6 py-3 bg-indigo-600 text-white rounded-lg shadow-md hover:bg-indigo-700 transition duration-150 ease-in-out text-lg font-semibold">
                        Save Shop Settings
                    </button>
                </div>
            </form>

            <h2 class="text-2xl font-semibold text-gray-800 mt-8 mb-4">Discount Settings</h2>
            <form id="discountSettingsForm" class="space-y-6">
                <div>
                    <label for="minSubtotalForDiscount" class="block text-sm font-medium text-gray-700">Minimum Subtotal for Discount (₹)</label>
                    <input type="number" id="minSubtotalForDiscount" name="minSubtotalForDiscount" step="0.01" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm">
                </div>
                <div>
                    <label for="discountPercentage" class="block text-sm font-medium text-gray-700">Discount Percentage (0-1, e.g., 0.1 for 10%)</label>
                    <input type="number" id="discountPercentage" name="discountPercentage" step="0.01" min="0" max="1" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm">
                </div>
                <div class="flex items-center">
                    <input type="checkbox" id="isDiscountEnabled" name="isDiscountEnabled" class="h-4 w-4 text-indigo-600 focus:ring-indigo-500 border-gray-300 rounded">
                    <label for="isDiscountEnabled" class="ml-2 block text-sm font-medium text-gray-700">Enable Discount</label>
                </div>
                <div class="pt-4">
                    <button type="submit" class="px-6 py-3 bg-indigo-600 text-white rounded-lg shadow-md hover:bg-indigo-700 transition duration-150 ease-in-out text-lg font-semibold">
                        Save Discount Settings
                    </button>
                </div>
            </form>
        </section>

        <!-- 2FA Security Section -->
        <section id="twoFactorAuth" class="dashboard-section bg-white p-6 rounded-lg shadow-md mb-8 hidden">
            <h2 class="text-2xl font-semibold text-gray-800 mb-4">Two-Factor Authentication (2FA)</h2>
            <div class="space-y-4">
                <p id="2faStatus" class="text-lg font-medium text-gray-700">2FA Status: <span class="font-bold text-red-500">Disabled</span></p>
                <div id="2faActions" class="flex space-x-4">
                    <button id="enable2faButton" class="px-4 py-2 bg-green-600 text-white rounded-lg shadow-md hover:bg-green-700 transition duration-150 ease-in-out flex items-center space-x-2">
                        <i class="fas fa-check-circle"></i>
                        <span>Enable 2FA</span>
                    </button>
                    <button id="disable2faButton" class="px-4 py-2 bg-red-600 text-white rounded-lg shadow-md hover:bg-red-700 transition duration-150 ease-in-out flex items-center space-x-2 hidden">
                        <i class="fas fa-times-circle"></i>
                        <span>Disable 2FA</span>
                    </button>
                </div>
            </div>
        </section>

        <!-- WhatsApp Logs Section -->
        <section id="whatsappLogs" class="dashboard-section bg-white p-6 rounded-lg shadow-md mb-8 hidden">
            <h2 class="text-2xl font-semibold text-gray-800 mb-4">WhatsApp Bot Logs</h2>
            <div class="bg-gray-800 text-gray-200 p-4 rounded-lg h-96 overflow-y-scroll text-sm font-mono" id="logContainer">
                <!-- Logs will be appended here -->
            </div>
        </section>
    </main>

    <!-- Modals -->
    <!-- Generic Modal for Add/Edit Item, Order Details, 2FA setup -->
    <div id="genericModal" class="modal fixed inset-0 flex items-center justify-center z-50 hidden">
        <div class="bg-white p-8 rounded-lg shadow-xl w-full max-w-lg mx-4">
            <div class="flex justify-between items-center mb-6">
                <h3 id="modalTitle" class="text-2xl font-semibold text-gray-800">Modal Title</h3>
                <button id="closeModalButton" class="text-gray-500 hover:text-gray-700 text-3xl">&times;</button>
            </div>
            <div id="modalContent">
                <!-- Content will be dynamically loaded here -->
            </div>
            <div id="modalActions" class="mt-6 flex justify-end space-x-4">
                <!-- Actions will be dynamically loaded here -->
            </div>
        </div>
    </div>


    <script>
        const API_BASE_URL = ''; // Relative path, assumes same origin
        const socket = io();
        const jwtToken = localStorage.getItem('jwtToken');

        // Elements
        const dashboardSections = document.querySelectorAll('.dashboard-section');
        const navLinks = document.querySelectorAll('nav a');
        const logoutButton = document.getElementById('logoutButton');

        // Bot Status Elements
        const botStatusText = document.getElementById('botStatusText');
        const lastAuthenticatedAt = document.getElementById('lastAuthenticatedAt');
        const qrCodeImage = document.getElementById('qrCodeImage');
        const qrMessage = document.getElementById('qrMessage');
        const loadSessionButton = document.getElementById('loadSessionButton');

        // Menu Management Elements
        const addMenuItemButton = document.getElementById('addMenuItemButton');
        const menuItemsTableBody = document.getElementById('menuItemsTableBody');

        // Order Management Elements
        const ordersTableBody = document.getElementById('ordersTableBody');

        // Customer Management Elements
        const customersTableBody = document.getElementById('customersTableBody');

        // Shop Settings Elements
        const shopSettingsForm = document.getElementById('shopSettingsForm');
        const shopNameInput = document.getElementById('shopName');
        const shopLatitudeInput = document.getElementById('shopLatitude');
        const shopLongitudeInput = document.getElementById('shopLongitude');
        const deliveryRatesContainer = document.getElementById('deliveryRatesContainer');
        const addDeliveryRateButton = document.getElementById('addDeliveryRate');

        // Discount Settings Elements
        const discountSettingsForm = document.getElementById('discountSettingsForm');
        const minSubtotalForDiscountInput = document.getElementById('minSubtotalForDiscount');
        const discountPercentageInput = document.getElementById('discountPercentage');
        const isDiscountEnabledCheckbox = document.getElementById('isDiscountEnabled');

        // 2FA Elements
        const twoFactorAuthSection = document.getElementById('twoFactorAuth');
        const twoFaStatusSpan = document.getElementById('2faStatus');
        const enable2faButton = document.getElementById('enable2faButton');
        const disable2faButton = document.getElementById('disable2faButton');

        // WhatsApp Logs Elements
        const logContainer = document.getElementById('logContainer');

        // Modal Elements
        const genericModal = document.getElementById('genericModal');
        const modalTitle = document.getElementById('modalTitle');
        const modalContent = document.getElementById('modalContent');
        const modalActions = document.getElementById('modalActions');
        const closeModalButton = document.getElementById('closeModalButton');

        // --- Authentication Check ---
        if (!jwtToken) {
            window.location.href = '/admin/login';
        }

        // --- Helper Functions ---
        async function fetchData(url, options = {}) {
            const headers = {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${jwtToken}`,
                ...options.headers
            };
            const response = await fetch(url, { ...options, headers });
            if (response.status === 401 || response.status === 403) {
                localStorage.removeItem('jwtToken');
                window.location.href = '/admin/login';
                return null; // Prevent further processing
            }
            if (!response.ok) {
                const errorData = await response.json();
                throw new Error(errorData.message || `HTTP error! Status: ${response.status}`);
            }
            return response.json();
        }

        function showSection(sectionId) {
            dashboardSections.forEach(section => {
                section.classList.add('hidden');
            });
            document.getElementById(sectionId).classList.remove('hidden');

            navLinks.forEach(link => {
                if (link.dataset.section === sectionId) {
                    link.classList.add('bg-gray-700');
                } else {
                    link.classList.remove('bg-gray-700');
                }
            });
        }

        function openModal(title, contentHtml, actionsHtml = '') {
            modalTitle.textContent = title;
            modalContent.innerHTML = contentHtml;
            modalActions.innerHTML = actionsHtml;
            genericModal.classList.remove('hidden');
        }

        function closeModal() {
            genericModal.classList.add('hidden');
            modalTitle.textContent = '';
            modalContent.innerHTML = '';
            modalActions.innerHTML = '';
        }

        closeModalButton.addEventListener('click', closeModal);
        genericModal.addEventListener('click', (e) => {
            if (e.target === genericModal) {
                closeModal();
            }
        });

        function formatDateTime(dateString) {
            if (!dateString) return 'N/A';
            const date = new Date(dateString);
            return date.toLocaleString('en-IN', {
                year: 'numeric', month: 'short', day: 'numeric',
                hour: '2-digit', minute: '2-digit', second: '2-digit',
                hour12: true, timeZone: 'Asia/Kolkata'
            });
        }

        function appendLog(message) {
            const logEntry = document.createElement('p');
            logEntry.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
            logContainer.appendChild(logEntry);
            logContainer.scrollTop = logContainer.scrollHeight; // Auto-scroll to bottom
        }

        // --- Event Listeners for Navigation ---
        navLinks.forEach(link => {
            link.addEventListener('click', (e) => {
                e.preventDefault();
                showSection(link.dataset.section);
                // Load data for the section when it's shown
                switch (link.dataset.section) {
                    case 'botStatus': fetchBotStatus(); break;
                    case 'menuManagement': fetchMenuItems(); break;
                    case 'orderManagement': fetchOrders(); break;
                    case 'customerManagement': fetchCustomers(); break;
                    case 'settings': fetchSettings(); fetchDiscountSettings(); break;
                    case 'twoFactorAuth': fetch2FAStatus(); break;
                    // Logs are updated via socket, no initial fetch needed
                }
            });
        });

        logoutButton.addEventListener('click', () => {
            localStorage.removeItem('jwtToken');
            window.location.href = '/admin/login';
        });

        // --- Socket.io Listeners ---
        socket.on('status', (status) => {
            botStatusText.textContent = status.replace(/_/g, ' ').toUpperCase();
            botStatusText.className = 'text-2xl font-bold mt-1'; // Reset classes
            if (status === 'ready') {
                botStatusText.classList.add('text-green-600');
            } else if (status === 'disconnected' || status === 'auth_failure' || status === 'qr_error') {
                botStatusText.classList.add('text-red-600');
            } else {
                botStatusText.classList.add('text-yellow-600');
            }
        });

        socket.on('qrCode', (qrData) => {
            if (qrData) {
                qrCodeImage.src = qrData;
                qrCodeImage.classList.remove('hidden');
                qrMessage.textContent = 'Scan this QR code with your WhatsApp app.';
            } else {
                qrCodeImage.src = '';
                qrCodeImage.classList.add('hidden');
                qrMessage.textContent = 'No QR code available.';
            }
        });

        socket.on('sessionInfo', (info) => {
            lastAuthenticatedAt.textContent = info.lastAuthenticatedAt ? formatDateTime(info.lastAuthenticatedAt) : 'N/A';
        });

        socket.on('new_order', (order) => {
            appendLog(`NEW ORDER: ${order.customOrderId || order._id} from ${order.customerName} - Total: ₹${order.totalAmount.toFixed(2)}`);
            fetchOrders(); // Refresh orders table
        });

        socket.on('whatsapp_log', (message) => {
            appendLog(message);
        });

        // --- Bot Status Functions ---
        async function fetchBotStatus() {
            try {
                const data = await fetchData(`${API_BASE_URL}/api/admin/bot-status`);
                if (data) {
                    socket.emit('status', data.status); // Update local status based on API
                    socket.emit('sessionInfo', { lastAuthenticatedAt: data.lastAuthenticatedAt });
                    socket.emit('qrCode', data.qrCodeAvailable ? qrCodeImage.src : null); // Re-emit QR if available
                }
            } catch (error) {
                console.error('Error fetching bot status:', error);
                appendLog(`Error fetching bot status: ${error.message}`);
            }
        }

        loadSessionButton.addEventListener('click', async () => {
            try {
                await fetchData(`${API_BASE_URL}/api/admin/load-session`, { method: 'POST' });
                appendLog('Requested new WhatsApp session initialization.');
            } catch (error) {
                console.error('Error loading session:', error);
                appendLog(`Error loading session: ${error.message}`);
            }
        });

        // --- Menu Management Functions ---
        async function fetchMenuItems() {
            try {
                const items = await fetchData(`${API_BASE_URL}/api/admin/menu`);
                menuItemsTableBody.innerHTML = '';
                items.forEach(item => {
                    const row = `
                        <tr class="border-b border-gray-200 hover:bg-gray-100">
                            <td class="py-3 px-6 text-left">
                                <img src="${item.imageUrl || 'https://placehold.co/50x50/cccccc/ffffff?text=No+Img'}" alt="${item.name}" class="w-12 h-12 rounded-lg object-cover">
                            </td>
                            <td class="py-3 px-6 text-left whitespace-nowrap">${item.name}</td>
                            <td class="py-3 px-6 text-left">${item.category || 'N/A'}</td>
                            <td class="py-3 px-6 text-right">₹${item.price.toFixed(2)}</td>
                            <td class="py-3 px-6 text-center">
                                <i class="fas ${item.isAvailable ? 'fa-check-circle text-green-500' : 'fa-times-circle text-red-500'}"></i>
                            </td>
                            <td class="py-3 px-6 text-center">
                                <i class="fas ${item.isTrending ? 'fa-fire text-orange-500' : 'fa-minus-circle text-gray-400'}"></i>
                            </td>
                            <td class="py-3 px-6 text-center">
                                <div class="flex item-center justify-center space-x-2">
                                    <button class="edit-item-btn text-blue-600 hover:text-blue-800" data-id="${item._id}">
                                        <i class="fas fa-edit"></i>
                                    </button>
                                    <button class="delete-item-btn text-red-600 hover:text-red-800" data-id="${item._id}">
                                        <i class="fas fa-trash-alt"></i>
                                    </button>
                                </div>
                            </td>
                        </tr>
                    `;
                    menuItemsTableBody.insertAdjacentHTML('beforeend', row);
                });
                addMenuItemEventListeners();
            } catch (error) {
                console.error('Error fetching menu items:', error);
                appendLog(`Error fetching menu items: ${error.message}`);
            }
        }

        function addMenuItemEventListeners() {
            document.querySelectorAll('.edit-item-btn').forEach(button => {
                button.onclick = (e) => openMenuItemModal(e.currentTarget.dataset.id);
            });
            document.querySelectorAll('.delete-item-btn').forEach(button => {
                button.onclick = (e) => deleteMenuItem(e.currentTarget.dataset.id);
            });
        }

        addMenuItemButton.addEventListener('click', () => openMenuItemModal());

        async function openMenuItemModal(itemId = null) {
            let item = {};
            let modalAction = 'Add';
            if (itemId) {
                modalAction = 'Edit';
                try {
                    item = await fetchData(`${API_BASE_URL}/api/admin/menu/${itemId}`);
                } catch (error) {
                    console.error('Error fetching item for edit:', error);
                    appendLog(`Error fetching item for edit: ${error.message}`);
                    return;
                }
            }

            const content = `
                <form id="menuItemForm" class="space-y-4">
                    <div>
                        <label for="itemName" class="block text-sm font-medium text-gray-700">Name</label>
                        <input type="text" id="itemName" name="name" value="${item.name || ''}" required
                               class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md">
                    </div>
                    <div>
                        <label for="itemDescription" class="block text-sm font-medium text-gray-700">Description</label>
                        <textarea id="itemDescription" name="description"
                                  class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md">${item.description || ''}</textarea>
                    </div>
                    <div>
                        <label for="itemPrice" class="block text-sm font-medium text-gray-700">Price</label>
                        <input type="number" id="itemPrice" name="price" value="${item.price || ''}" step="0.01" required
                               class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md">
                    </div>
                    <div>
                        <label for="itemImageUrl" class="block text-sm font-medium text-gray-700">Image URL</label>
                        <input type="text" id="itemImageUrl" name="imageUrl" value="${item.imageUrl || ''}"
                               class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md">
                    </div>
                    <div>
                        <label for="itemCategory" class="block text-sm font-medium text-gray-700">Category</label>
                        <input type="text" id="itemCategory" name="category" value="${item.category || ''}"
                               class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md">
                    </div>
                    <div class="flex items-center space-x-4">
                        <input type="checkbox" id="itemIsAvailable" name="isAvailable" ${item.isAvailable !== false ? 'checked' : ''}
                               class="h-4 w-4 text-indigo-600 border-gray-300 rounded">
                        <label for="itemIsAvailable" class="text-sm font-medium text-gray-700">Available</label>
                        <input type="checkbox" id="itemIsTrending" name="isTrending" ${item.isTrending ? 'checked' : ''}
                               class="h-4 w-4 text-indigo-600 border-gray-300 rounded">
                        <label for="itemIsTrending" class="text-sm font-medium text-gray-700">Trending</label>
                    </div>
                </form>
            `;
            const actions = `
                <button id="saveMenuItemButton" class="px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700">Save</button>
                <button id="cancelMenuItemButton" class="px-4 py-2 bg-gray-300 text-gray-800 rounded-lg hover:bg-gray-400">Cancel</button>
            `;
            openModal(`${modalAction} Menu Item`, content, actions);

            document.getElementById('saveMenuItemButton').addEventListener('click', async () => {
                const form = document.getElementById('menuItemForm');
                const formData = new FormData(form);
                const data = Object.fromEntries(formData.entries());
                data.isAvailable = document.getElementById('itemIsAvailable').checked;
                data.isTrending = document.getElementById('itemIsTrending').checked;
                data.price = parseFloat(data.price);

                try {
                    if (itemId) {
                        await fetchData(`${API_BASE_URL}/api/admin/menu/${itemId}`, {
                            method: 'PUT',
                            body: JSON.stringify(data)
                        });
                        appendLog(`Menu item ${data.name} updated.`);
                    } else {
                        await fetchData(`${API_BASE_URL}/api/admin/menu`, {
                            method: 'POST',
                            body: JSON.stringify(data)
                        });
                        appendLog(`Menu item ${data.name} added.`);
                    }
                    closeModal();
                    fetchMenuItems();
                } catch (error) {
                    console.error(`Error ${modalAction.toLowerCase()}ing menu item:`, error);
                    appendLog(`Error ${modalAction.toLowerCase()}ing menu item: ${error.message}`);
                }
            });
            document.getElementById('cancelMenuItemButton').addEventListener('click', closeModal);
        }

        async function deleteMenuItem(itemId) {
            if (!confirm('Are you sure you want to delete this item?')) return;
            try {
                await fetchData(`${API_BASE_URL}/api/admin/menu/${itemId}`, { method: 'DELETE' });
                appendLog(`Menu item ${itemId} deleted.`);
                fetchMenuItems();
            } catch (error) {
                console.error('Error deleting menu item:', error);
                appendLog(`Error deleting menu item: ${error.message}`);
            }
        }

        // --- Order Management Functions ---
        async function fetchOrders() {
            try {
                const orders = await fetchData(`${API_BASE_URL}/api/admin/orders`);
                ordersTableBody.innerHTML = '';
                orders.forEach(order => {
                    const row = `
                        <tr class="border-b border-gray-200 hover:bg-gray-100">
                            <td class="py-3 px-6 text-left whitespace-nowrap">${order.customOrderId || order._id.substring(0, 8) + '...'}</td>
                            <td class="py-3 px-6 text-left">${order.customerName}</td>
                            <td class="py-3 px-6 text-left">${order.customerPhone}</td>
                            <td class="py-3 px-6 text-right">₹${order.totalAmount.toFixed(2)}</td>
                            <td class="py-3 px-6 text-center">
                                <span class="px-3 py-1 rounded-full text-xs font-semibold
                                    ${order.status === 'Pending' ? 'bg-yellow-200 text-yellow-800' : ''}
                                    ${order.status === 'Confirmed' || order.status === 'Preparing' ? 'bg-blue-200 text-blue-800' : ''}
                                    ${order.status === 'Out for Delivery' ? 'bg-purple-200 text-purple-800' : ''}
                                    ${order.status === 'Delivered' ? 'bg-green-200 text-green-800' : ''}
                                    ${order.status === 'Cancelled' ? 'bg-red-200 text-red-800' : ''}">
                                    ${order.status}
                                </span>
                            </td>
                            <td class="py-3 px-6 text-center">${new Date(order.orderDate).toLocaleDateString('en-IN', { timeZone: 'Asia/Kolkata' })}</td>
                            <td class="py-3 px-6 text-center">
                                <div class="flex item-center justify-center space-x-2">
                                    <button class="view-order-btn text-indigo-600 hover:text-indigo-800" data-id="${order._id}">
                                        <i class="fas fa-eye"></i>
                                    </button>
                                    <select class="status-select bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 p-1" data-id="${order._id}">
                                        <option value="Pending" ${order.status === 'Pending' ? 'selected' : ''}>Pending</option>
                                        <option value="Confirmed" ${order.status === 'Confirmed' ? 'selected' : ''}>Confirmed</option>
                                        <option value="Preparing" ${order.status === 'Preparing' ? 'selected' : ''}>Preparing</option>
                                        <option value="Out for Delivery" ${order.status === 'Out for Delivery' ? 'selected' : ''}>Out for Delivery</option>
                                        <option value="Delivered" ${order.status === 'Delivered' ? 'selected' : ''}>Delivered</option>
                                        <option value="Cancelled" ${order.status === 'Cancelled' ? 'selected' : ''}>Cancelled</option>
                                    </select>
                                </div>
                            </td>
                        </tr>
                    `;
                    ordersTableBody.insertAdjacentHTML('beforeend', row);
                });
                addOrderEventListeners();
            } catch (error) {
                console.error('Error fetching orders:', error);
                appendLog(`Error fetching orders: ${error.message}`);
            }
        }

        function addOrderEventListeners() {
            document.querySelectorAll('.view-order-btn').forEach(button => {
                button.onclick = (e) => viewOrderDetails(e.currentTarget.dataset.id);
            });
            document.querySelectorAll('.status-select').forEach(select => {
                select.onchange = (e) => updateOrderStatus(e.currentTarget.dataset.id, e.currentTarget.value);
            });
        }

        async function viewOrderDetails(orderId) {
            try {
                const order = await fetchData(`${API_BASE_URL}/api/admin/orders/${orderId}`);
                const itemsList = order.items.map(item => `<li>${item.name} x ${item.quantity} (₹${item.price.toFixed(2)})</li>`).join('');
                const content = `
                    <p><strong>Order ID:</strong> ${order.customOrderId || order._id}</p>
                    <p><strong>PIN:</strong> ${order.pinId}</p>
                    <p><strong>Customer Name:</strong> ${order.customerName}</p>
                    <p><strong>Customer Phone:</strong> ${order.customerPhone}</p>
                    <p><strong>Delivery Address:</strong> ${order.deliveryAddress}</p>
                    <p><strong>Order Date:</strong> ${formatDateTime(order.orderDate)}</p>
                    <p><strong>Status:</strong> ${order.status}</p>
                    <p><strong>Payment Method:</strong> ${order.paymentMethod}</p>
                    <p><strong>Subtotal:</strong> ₹${order.subtotal.toFixed(2)}</p>
                    <p><strong>Transport Tax:</strong> ₹${order.transportTax.toFixed(2)}</p>
                    <p><strong>Discount:</strong> ₹${order.discountAmount.toFixed(2)}</p>
                    <p><strong>Total Amount:</strong> ₹${order.totalAmount.toFixed(2)}</p>
                    <h4 class="font-semibold mt-4">Items:</h4>
                    <ul class="list-disc list-inside">${itemsList}</ul>
                `;
                openModal('Order Details', content);
            } catch (error) {
                console.error('Error viewing order details:', error);
                appendLog(`Error viewing order details: ${error.message}`);
            }
        }

        async function updateOrderStatus(orderId, newStatus) {
            try {
                await fetchData(`${API_BASE_URL}/api/admin/orders/${orderId}`, {
                    method: 'PUT',
                    body: JSON.stringify({ status: newStatus })
                });
                appendLog(`Order ${orderId} status updated to ${newStatus}.`);
                fetchOrders(); // Refresh table
            } catch (error) {
                console.error('Error updating order status:', error);
                appendLog(`Error updating order status: ${error.message}`);
            }
        }

        // --- Customer Management Functions ---
        async function fetchCustomers() {
            try {
                const customers = await fetchData(`${API_BASE_URL}/api/admin/customers`);
                customersTableBody.innerHTML = '';
                customers.forEach(customer => {
                    const row = `
                        <tr class="border-b border-gray-200 hover:bg-gray-100">
                            <td class="py-3 px-6 text-left whitespace-nowrap">${customer.customerName || 'N/A'}</td>
                            <td class="py-3 px-6 text-left">${customer.customerPhone}</td>
                            <td class="py-3 px-6 text-center">${customer.totalOrders}</td>
                            <td class="py-3 px-6 text-center">${customer.lastOrderDate ? new Date(customer.lastOrderDate).toLocaleDateString('en-IN', { timeZone: 'Asia/Kolkata' }) : 'N/A'}</td>
                            <td class="py-3 px-6 text-center">
                                <div class="flex item-center justify-center space-x-2">
                                    <button class="view-latest-order-btn text-blue-600 hover:text-blue-800" data-phone="${customer.customerPhone}">
                                        <i class="fas fa-history"></i> Latest Order
                                    </button>
                                    <button class="delete-customer-btn text-red-600 hover:text-red-800" data-id="${customer._id}">
                                        <i class="fas fa-trash-alt"></i>
                                    </button>
                                </div>
                            </td>
                        </tr>
                    `;
                    customersTableBody.insertAdjacentHTML('beforeend', row);
                });
                addCustomerEventListeners();
            } catch (error) {
                console.error('Error fetching customers:', error);
                appendLog(`Error fetching customers: ${error.message}`);
            }
        }

        function addCustomerEventListeners() {
            document.querySelectorAll('.view-latest-order-btn').forEach(button => {
                button.onclick = (e) => viewLatestCustomerOrder(e.currentTarget.dataset.phone);
            });
            document.querySelectorAll('.delete-customer-btn').forEach(button => {
                button.onclick = (e) => deleteCustomer(e.currentTarget.dataset.id);
            });
        }

        async function viewLatestCustomerOrder(customerPhone) {
            try {
                const order = await fetchData(`${API_BASE_URL}/api/admin/customers/${customerPhone}/latest-order`);
                const itemsList = order.items.map(item => `<li>${item.name} x ${item.quantity} (₹${item.price.toFixed(2)})</li>`).join('');
                const content = `
                    <p><strong>Order ID:</strong> ${order.customOrderId || order._id}</p>
                    <p><strong>PIN:</strong> ${order.pinId}</p>
                    <p><strong>Customer Name:</strong> ${order.customerName}</p>
                    <p><strong>Customer Phone:</strong> ${order.customerPhone}</p>
                    <p><strong>Delivery Address:</strong> ${order.deliveryAddress}</p>
                    <p><strong>Order Date:</strong> ${formatDateTime(order.orderDate)}</p>
                    <p><strong>Status:</strong> ${order.status}</p>
                    <p><strong>Payment Method:</strong> ${order.paymentMethod}</p>
                    <p><strong>Subtotal:</strong> ₹${order.subtotal.toFixed(2)}</p>
                    <p><strong>Transport Tax:</strong> ₹${order.transportTax.toFixed(2)}</p>
                    <p><strong>Discount:</strong> ₹${order.discountAmount.toFixed(2)}</p>
                    <p><strong>Total Amount:</strong> ₹${order.totalAmount.toFixed(2)}</p>
                    <h4 class="font-semibold mt-4">Items:</h4>
                    <ul class="list-disc list-inside">${itemsList}</ul>
                `;
                openModal('Latest Order Details', content);
            } catch (error) {
                console.error('Error viewing latest customer order:', error);
                appendLog(`Error viewing latest customer order: ${error.message}`);
                openModal('Error', `<p class="text-red-600">${error.message}</p>`);
            }
        }

        async function deleteCustomer(customerId) {
            if (!confirm('Are you sure you want to delete this customer and all their associated data? This action is irreversible.')) return;
            try {
                await fetchData(`${API_BASE_URL}/api/admin/customers/${customerId}`, { method: 'DELETE' });
                appendLog(`Customer ${customerId} deleted.`);
                fetchCustomers();
            } catch (error) {
                console.error('Error deleting customer:', error);
                appendLog(`Error deleting customer: ${error.message}`);
            }
        }

        // --- Settings Functions ---
        async function fetchSettings() {
            try {
                const settings = await fetchData(`${API_BASE_URL}/api/admin/settings`);
                if (settings) {
                    shopNameInput.value = settings.shopName || '';
                    shopLatitudeInput.value = settings.shopLocation ? settings.shopLocation.latitude : '';
                    shopLongitudeInput.value = settings.shopLocation ? settings.shopLocation.longitude : '';
                    renderDeliveryRates(settings.deliveryRates || []);
                }
            } catch (error) {
                console.error('Error fetching settings:', error);
                appendLog(`Error fetching settings: ${error.message}`);
            }
        }

        function renderDeliveryRates(rates) {
            deliveryRatesContainer.innerHTML = '';
            rates.forEach((rate, index) => {
                const div = document.createElement('div');
                div.className = 'flex space-x-2 items-center';
                div.innerHTML = `
                    <input type="number" class="block w-1/2 px-3 py-2 border border-gray-300 rounded-md delivery-kms" placeholder="KMs" value="${rate.kms}" step="0.1">
                    <input type="number" class="block w-1/2 px-3 py-2 border border-gray-300 rounded-md delivery-amount" placeholder="Amount (₹)" value="${rate.amount}" step="0.01">
                    <button type="button" class="remove-delivery-rate text-red-600 hover:text-red-800 px-2 py-1 rounded-md">
                        <i class="fas fa-minus-circle"></i>
                    </button>
                `;
                deliveryRatesContainer.appendChild(div);
            });
            addDeliveryRateEventListeners();
        }

        function addDeliveryRateEventListeners() {
            document.querySelectorAll('.remove-delivery-rate').forEach(button => {
                button.onclick = (e) => e.target.closest('.flex').remove();
            });
        }

        addDeliveryRateButton.addEventListener('click', () => {
            renderDeliveryRates([...Array.from(deliveryRatesContainer.children).map(div => ({
                kms: parseFloat(div.querySelector('.delivery-kms').value),
                amount: parseFloat(div.querySelector('.delivery-amount').value)
            })).filter(r => !isNaN(r.kms) && !isNaN(r.amount)), { kms: '', amount: '' }]);
        });

        shopSettingsForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const shopName = shopNameInput.value;
            const latitude = parseFloat(shopLatitudeInput.value);
            const longitude = parseFloat(shopLongitudeInput.value);
            const deliveryRates = Array.from(deliveryRatesContainer.children).map(div => ({
                kms: parseFloat(div.querySelector('.delivery-kms').value),
                amount: parseFloat(div.querySelector('.delivery-amount').value)
            })).filter(r => !isNaN(r.kms) && !isNaN(r.amount));

            try {
                await fetchData(`${API_BASE_URL}/api/admin/settings`, {
                    method: 'PUT',
                    body: JSON.stringify({
                        shopName,
                        shopLocation: { latitude, longitude },
                        deliveryRates
                    })
                });
                appendLog('Shop settings updated successfully.');
                alert('Shop settings updated successfully!');
            } catch (error) {
                console.error('Error updating shop settings:', error);
                appendLog(`Error updating shop settings: ${error.message}`);
                alert(`Error updating shop settings: ${error.message}`);
            }
        });

        // Discount Settings
        async function fetchDiscountSettings() {
            try {
                const settings = await fetchData(`${API_BASE_URL}/api/admin/discount-settings`);
                if (settings) {
                    minSubtotalForDiscountInput.value = settings.minSubtotalForDiscount;
                    discountPercentageInput.value = settings.discountPercentage;
                    isDiscountEnabledCheckbox.checked = settings.isDiscountEnabled;
                }
            } catch (error) {
                console.error('Error fetching discount settings:', error);
                appendLog(`Error fetching discount settings: ${error.message}`);
            }
        }

        discountSettingsForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const minSubtotalForDiscount = parseFloat(minSubtotalForDiscountInput.value);
            const discountPercentage = parseFloat(discountPercentageInput.value);
            const isDiscountEnabled = isDiscountEnabledCheckbox.checked;

            try {
                await fetchData(`${API_BASE_URL}/api/admin/discount-settings`, {
                    method: 'PUT',
                    body: JSON.stringify({
                        minSubtotalForDiscount,
                        discountPercentage,
                        isDiscountEnabled
                    })
                });
                appendLog('Discount settings updated successfully.');
                alert('Discount settings updated successfully!');
            } catch (error) {
                console.error('Error updating discount settings:', error);
                appendLog(`Error updating discount settings: ${error.message}`);
                alert(`Error updating discount settings: ${error.message}`);
            }
        });

        // --- 2FA Management Functions ---
        async function fetch2FAStatus() {
            try {
                const data = await fetchData(`${API_BASE_URL}/api/admin/2fa/status`);
                if (data.twoFactorEnabled) {
                    twoFaStatusSpan.textContent = 'Enabled';
                    twoFaStatusSpan.classList.remove('text-red-500');
                    twoFaStatusSpan.classList.add('text-green-500');
                    enable2faButton.classList.add('hidden');
                    disable2faButton.classList.remove('hidden');
                } else {
                    twoFaStatusSpan.textContent = 'Disabled';
                    twoFaStatusSpan.classList.remove('text-green-500');
                    twoFaStatusSpan.classList.add('text-red-500');
                    enable2faButton.classList.remove('hidden');
                    disable2faButton.classList.add('hidden');
                }
            } catch (error) {
                console.error('Error fetching 2FA status:', error);
                appendLog(`Error fetching 2FA status: ${error.message}`);
            }
        }

        enable2faButton.addEventListener('click', async () => {
            try {
                const data = await fetchData(`${API_BASE_URL}/api/admin/2fa/generate`, { method: 'POST' });
                const content = `
                    <p class="mb-4">Scan this QR code with your authenticator app (e.g., Google Authenticator).</p>
                    <div class="flex justify-center mb-4">
                        <img src="${data.qrCodeUrl}" alt="2FA QR Code" class="w-48 h-48 border border-gray-300 rounded-lg">
                    </div>
                    <p class="text-center text-sm text-gray-600 mb-4">Or manually enter this secret: <strong class="font-mono break-all">${data.secret}</strong></p>
                    <div>
                        <label for="2faCodeInput" class="block text-sm font-medium text-gray-700">Enter 6-digit code from app</label>
                        <input type="text" id="2faCodeInput" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md" placeholder="123456">
                    </div>
                    <p id="2faVerifyMessage" class="text-red-600 text-sm mt-2 hidden"></p>
                `;
                const actions = `
                    <button id="verify2faButton" class="px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700">Verify & Enable</button>
                    <button id="cancel2faButton" class="px-4 py-2 bg-gray-300 text-gray-800 rounded-lg hover:bg-gray-400">Cancel</button>
                `;
                openModal('Enable Two-Factor Authentication', content, actions);

                document.getElementById('verify2faButton').addEventListener('click', async () => {
                    const totpCode = document.getElementById('2faCodeInput').value;
                    const verifyMessage = document.getElementById('2faVerifyMessage');
                    verifyMessage.classList.add('hidden');
                    try {
                        const verifyData = await fetchData(`${API_BASE_URL}/api/admin/2fa/verify`, {
                            method: 'POST',
                            body: JSON.stringify({ totpCode, secret: data.secret })
                        });
                        if (verifyData.verified) {
                            alert('2FA enabled successfully!');
                            closeModal();
                            fetch2FAStatus();
                            appendLog('2FA enabled successfully.');
                        } else {
                            verifyMessage.textContent = verifyData.message || 'Invalid 2FA code.';
                            verifyMessage.classList.remove('hidden');
                        }
                    } catch (error) {
                        console.error('Error verifying 2FA:', error);
                        verifyMessage.textContent = error.message || 'Error verifying 2FA code.';
                        verifyMessage.classList.remove('hidden');
                        appendLog(`Error verifying 2FA: ${error.message}`);
                    }
                });
                document.getElementById('cancel2faButton').addEventListener('click', closeModal);

            } catch (error) {
                console.error('Error generating 2FA QR:', error);
                appendLog(`Error generating 2FA QR: ${error.message}`);
                alert(`Error generating 2FA QR: ${error.message}`);
            }
        });

        disable2faButton.addEventListener('click', async () => {
            if (!confirm('Are you sure you want to disable Two-Factor Authentication? This will reduce your account security.')) return;
            try {
                await fetchData(`${API_BASE_URL}/api/admin/2fa/disable`, { method: 'POST' });
                alert('2FA disabled successfully!');
                fetch2FAStatus();
                appendLog('2FA disabled successfully.');
            } catch (error) {
                console.error('Error disabling 2FA:', error);
                appendLog(`Error disabling 2FA: ${error.message}`);
                alert(`Error disabling 2FA: ${error.message}`);
            }
        });

        // --- Initial Load ---
        document.addEventListener('DOMContentLoaded', () => {
            showSection('botStatus'); // Show bot status by default
            fetchBotStatus();
        });
    </script>
</body>
</html>

