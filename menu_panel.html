<!DOCTYPE html>
<html lang="en" class="dark"> <!-- Default to dark mode -->
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Our Delicious Menu - Food Business</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Google Fonts - Inter -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <!-- Font Awesome for Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            transition: background-color 0.3s ease, color 0.3s ease;
        }
        /* Base dark mode styles for elements not covered by dark: utility */
        html.dark {
            background-color: #1a202c; /* Dark background for the entire page */
            color: #e2e8f0; /* Light text color */
        }
        html.dark .bg-white {
            background-color: #2d3748; /* Darker background for cards/panels */
        }
        html.dark .text-gray-800 {
            color: #e2e8f0; /* Ensure headings are light */
        }
        html.dark .text-gray-700 {
            color: #cbd5e0; /* Slightly darker light text */
        }
        html.dark .text-gray-600 {
            color: #a0aec0; /* Even darker light text */
        }
        html.dark .border-gray-200 {
            border-color: #4a5568; /* Darker borders */
        }
        html.dark .bg-gray-50 {
            background-color: #4a5568; /* Darker background for inner elements */
        }
        html.dark .bg-gray-700 {
            background-color: #2d3748; /* Darker background for nested cards */
        }
        html.dark .shadow-lg {
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.3), 0 4px 6px -2px rgba(0, 0, 0, 0.2);
        }
        /* Custom scrollbar for dark mode */
        html.dark ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        html.dark ::-webkit-scrollbar-track {
            background: #2d3748;
            border-radius: 10px;
        }
        html.dark ::-webkit-scrollbar-thumb {
            background: #4a5568;
            border-radius: 10px;
        }
        html.dark ::-webkit-scrollbar-thumb:hover {
            background: #6b7280;
        }

        /* Specific styles for cart items */
        .cart-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0.75rem 0;
            border-bottom: 1px solid #e2e8f0;
        }
        html.dark .cart-item {
            border-bottom: 1px solid #4a5568;
        }
        .cart-item:last-child {
            border-bottom: none;
        }

        /* View sections */
        .app-view {
            display: none;
        }
    </style>
</head>
<body class="bg-gray-100 dark:bg-gray-900 min-h-screen flex flex-col">
    <!-- Header/Navbar -->
    <header class="bg-white dark:bg-gray-800 shadow-sm py-4 px-6 md:px-8">
        <div class="container mx-auto flex justify-between items-center">
            <h1 class="text-2xl font-extrabold text-green-600 dark:text-green-400">Delicious Bites</h1>
            <!-- Dark Mode Toggle -->
            <button id="theme-toggle" class="p-2 rounded-full bg-gray-200 dark:bg-gray-700 text-gray-800 dark:text-gray-200 hover:bg-gray-300 dark:hover:bg-gray-600 transition duration-200">
                <i class="fas fa-moon hidden dark:inline-block"></i>
                <i class="fas fa-sun dark:hidden"></i>
            </button>
        </div>
    </header>

    <!-- Main Content Area -->
    <main class="flex-grow container mx-auto p-4 md:p-8">

        <!-- Menu View -->
        <section id="view-menu" class="app-view">
            <h2 class="text-3xl font-bold text-gray-800 dark:text-white mb-6 text-center">Our Delicious Menu</h2>

            <div id="menu-items-display" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 mb-8">
                <!-- Menu items will be loaded here via JavaScript -->
                <p class="text-gray-600 dark:text-gray-400 col-span-full text-center py-8">Loading menu...</p>
            </div>

            <hr class="my-8 border-gray-200 dark:border-gray-700">

            <div class="bg-white dark:bg-gray-800 rounded-lg shadow-lg p-6">
                <h2 class="text-2xl font-semibold text-gray-800 dark:text-white mb-4">Your Order</h2>
                <div id="cart-items" class="mb-4 max-h-60 overflow-y-auto pr-2">
                    <!-- Cart items will be displayed here -->
                    <p class="text-gray-600 dark:text-gray-400">Your cart is empty.</p>
                </div>
                <div class="text-right text-lg font-bold text-gray-800 dark:text-white mb-2">Subtotal: ₹<span id="subtotal">0.00</span></div>
                <div class="text-right text-lg font-bold text-gray-800 dark:text-white mb-2">Transport Tax: ₹<span id="transport-tax">0.00</span></div>
                <div class="text-right text-2xl font-extrabold text-green-600 mb-6">Total: ₹<span id="total-amount">0.00</span></div>

                <form id="order-form" class="space-y-4">
                    <div>
                        <label for="customerName" class="block text-gray-700 dark:text-gray-300 text-sm font-bold mb-2">Your Name:</label>
                        <input type="text" id="customerName" name="customerName" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline dark:bg-gray-700 dark:border-gray-600 dark:text-white" required>
                    </div>
                    <div>
                        <label for="customerPhone" class="block text-gray-700 dark:text-gray-300 text-sm font-bold mb-2">Your WhatsApp Number (e.g., 91XXXXXXXXXX):</label>
                        <input type="tel" id="customerPhone" name="customerPhone" pattern="[0-9]{10,15}" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline dark:bg-gray-700 dark:border-gray-600 dark:text-white" required>
                    </div>
                    <div>
                        <label for="deliveryAddress" class="block text-gray-700 dark:text-gray-300 text-sm font-bold mb-2">Delivery Address:</label>
                        <textarea id="deliveryAddress" name="deliveryAddress" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline dark:bg-gray-700 dark:border-gray-600 dark:text-white" required></textarea>
                    </div>
                    <button type="button" id="get-location-btn" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded focus:outline-none focus:shadow-outline transition duration-300 ease-in-out flex items-center gap-2">
                        <i class="fas fa-map-marker-alt"></i> Get My Location for Tax
                    </button>
                    <p id="location-status" class="text-sm text-gray-600 dark:text-gray-400 mt-2"></p>
                    <input type="hidden" id="customerLat" name="customerLat">
                    <input type="hidden" id="customerLon" name="customerLon">

                    <button type="submit" class="bg-green-500 hover:bg-green-700 text-white font-bold py-3 px-6 rounded focus:outline-none focus:shadow-outline w-full transition duration-300 ease-in-out">Place Order</button>
                </form>
            </div>
        </section>

        <!-- Order Tracking View -->
        <section id="view-tracking" class="app-view hidden">
            <div class="bg-white dark:bg-gray-800 rounded-lg shadow-lg p-6">
                <h2 class="text-3xl font-bold text-gray-800 dark:text-white mb-6 text-center">Order Tracking</h2>
                <div id="tracking-input-section" class="mb-8 space-y-4">
                    <div>
                        <label for="trackOrderId" class="block text-gray-700 dark:text-gray-300 text-sm font-bold mb-2">Enter Order ID:</label>
                        <input type="text" id="trackOrderId" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline dark:bg-gray-700 dark:border-gray-600 dark:text-white" placeholder="e.g., 65c3b0...">
                    </div>
                    <button id="track-order-btn" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded focus:outline-none focus:shadow-outline w-full transition duration-300 ease-in-out flex items-center justify-center gap-2">
                        <i class="fas fa-search"></i> Track Order
                    </button>
                </div>

                <div id="order-details-section" class="hidden">
                    <h3 class="text-xl font-semibold text-gray-800 dark:text-white mb-4">Order <span id="displayOrderId"></span> Details</h3>
                    <div class="bg-gray-50 dark:bg-gray-700 p-4 rounded-lg shadow-inner mb-6 space-y-2">
                        <p class="text-gray-700 dark:text-gray-300"><span class="font-semibold">Status:</span> <span id="orderStatus" class="font-bold text-lg"></span></p>
                        <p class="text-gray-700 dark:text-gray-300"><span class="font-semibold">Delivery Address:</span> <span id="orderAddress"></span></p>
                        <p class="text-gray-700 dark:text-gray-300"><span class="font-semibold">Total Amount:</span> ₹<span id="orderTotal"></span></p>
                        <p class="text-gray-700 dark:text-gray-300 text-sm">Ordered on: <span id="orderDate"></span></p>
                        <h4 class="font-semibold text-gray-800 dark:text-white mt-4">Items:</h4>
                        <ul id="orderItemsList" class="list-disc list-inside text-gray-700 dark:text-gray-300"></ul>
                    </div>

                    <!-- Tracking Map/Progress -->
                    <h3 class="text-xl font-semibold text-gray-800 dark:text-white mb-4">Delivery Progress</h3>
                    <div class="bg-gray-50 dark:bg-gray-700 p-4 rounded-lg shadow-inner mb-6">
                        <div id="map-placeholder" class="w-full h-64 bg-gray-200 dark:bg-gray-600 rounded-md flex items-center justify-center text-gray-500 dark:text-gray-400 text-center">
                            <p>Map integration would go here (e.g., Google Maps API)</p>
                            <p>Delivery from: <span id="shopLocationDisplay"></span></p>
                            <p>Delivering to: <span id="customerLocationDisplay"></span></p>
                        </div>
                        <div class="mt-4 text-center">
                            <p class="text-lg font-semibold text-gray-800 dark:text-white">Estimated Delivery: <span id="estimatedDeliveryTime">Calculating...</span></p>
                            <p class="text-sm text-gray-600 dark:text-gray-400" id="deliveryDistanceDisplay"></p>
                        </div>
                    </div>

                    <div class="flex flex-col sm:flex-row gap-4 justify-center">
                        <button class="bg-red-500 hover:bg-red-600 text-white font-bold py-2 px-4 rounded-lg transition duration-300 ease-in-out flex-1"><i class="fas fa-times-circle mr-2"></i> Cancel Order</button>
                        <a href="https://wa.me/${ADMIN_NUMBER}" target="_blank" class="bg-green-500 hover:bg-green-600 text-white font-bold py-2 px-4 rounded-lg transition duration-300 ease-in-out flex-1 text-center"><i class="fab fa-whatsapp mr-2"></i> Contact Support</a>
                    </div>
                </div>
                <p id="tracking-message" class="text-red-500 dark:text-red-400 text-center mt-4 hidden">Order not found or an error occurred.</p>
            </div>
        </section>

    </main>

    <!-- Floating Cart/Tracking Button -->
    <div class="fixed bottom-4 right-4 z-40 flex flex-col items-end space-y-3">
        <button id="view-cart-btn" class="bg-green-600 hover:bg-green-700 text-white p-4 rounded-full shadow-lg transition duration-300 ease-in-out transform hover:scale-110">
            <i class="fas fa-shopping-cart text-xl"></i>
            <span id="cart-count" class="absolute top-0 right-0 inline-flex items-center justify-center px-2 py-1 text-xs font-bold leading-none text-red-100 bg-red-600 rounded-full">0</span>
        </button>
        <button id="view-tracking-btn" class="bg-blue-600 hover:bg-blue-700 text-white p-4 rounded-full shadow-lg transition duration-300 ease-in-out transform hover:scale-110">
            <i class="fas fa-map-marker-alt text-xl"></i>
        </button>
    </div>

    <!-- Footer -->
    <footer class="bg-white dark:bg-gray-800 shadow-inner py-4 mt-8">
        <div class="container mx-auto text-center text-gray-600 dark:text-gray-400 text-sm">
            &copy; 2025 Delicious Bites. All rights reserved.
        </div>
    </footer>

    <!-- Socket.IO Client Script (for potential future real-time tracking updates) -->
    <script src="/socket.io/socket.io.js"></script>
    <script>
        // --- Dark Mode Logic ---
        const themeToggleBtn = document.getElementById('theme-toggle');
        const htmlElement = document.documentElement; // The <html> tag

        function setTheme(theme) {
            if (theme === 'dark') {
                htmlElement.classList.add('dark');
                localStorage.setItem('theme', 'dark');
            } else {
                htmlElement.classList.remove('dark');
                localStorage.setItem('theme', 'light');
            }
        }

        const savedTheme = localStorage.getItem('theme');
        if (savedTheme) {
            setTheme(savedTheme);
        } else if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
            setTheme('dark');
        } else {
            setTheme('light');
        }

        themeToggleBtn.addEventListener('click', () => {
            if (htmlElement.classList.contains('dark')) {
                setTheme('light');
            } else {
                setTheme('dark');
            }
        });

        // --- View Switching Logic ---
        const menuView = document.getElementById('view-menu');
        const trackingView = document.getElementById('view-tracking');
        const viewCartBtn = document.getElementById('view-cart-btn');
        const viewTrackingBtn = document.getElementById('view-tracking-btn');

        function showAppView(viewId) {
            menuView.classList.add('hidden');
            trackingView.classList.add('hidden');
            document.getElementById(viewId).classList.remove('hidden');

            // Optionally highlight active button
            if (viewId === 'view-menu') {
                viewCartBtn.classList.add('bg-green-700');
                viewTrackingBtn.classList.remove('bg-blue-700');
            } else if (viewId === 'view-tracking') {
                viewTrackingBtn.classList.add('bg-blue-700');
                viewCartBtn.classList.remove('bg-green-700');
            }
        }

        viewCartBtn.addEventListener('click', () => showAppView('view-menu'));
        viewTrackingBtn.addEventListener('click', () => showAppView('view-tracking'));

        // Initial view
        showAppView('view-menu');


        // --- Menu Panel Specific JavaScript ---
        const menuItemsDisplay = document.getElementById('menu-items-display');
        const cartItemsContainer = document.getElementById('cart-items');
        const subtotalSpan = document.getElementById('subtotal');
        const transportTaxSpan = document.getElementById('transport-tax');
        const totalAmountSpan = document.getElementById('total-amount');
        const orderForm = document.getElementById('order-form');
        const getLocationBtn = document.getElementById('get-location-btn');
        const locationStatus = document.getElementById('location-status');
        const customerLatField = document.getElementById('customerLat');
        const customerLonField = document.getElementById('customerLon');
        const cartCountSpan = document.getElementById('cart-count');

        let cart = [];
        let menu = [];
        let currentTransportTax = 0;
        let shopLocation = { latitude: 0, longitude: 0 };
        let deliveryRates = [];
        const ADMIN_NUMBER = '918897350151'; // Hardcoded for frontend use, ensure consistency with backend

        async function fetchMenu() {
            try {
                const response = await fetch('/api/menu');
                if (!response.ok) throw new Error('Failed to fetch menu');
                menu = await response.json();
                renderMenu();
            } catch (error) {
                console.error('Error fetching menu:', error);
                menuItemsDisplay.innerHTML = '<p class="text-red-500 dark:text-red-400 col-span-full text-center py-8"><i class="fas fa-exclamation-triangle mr-2"></i> Failed to load menu items.</p>';
            }
        }

        async function fetchShopSettings() {
            try {
                const response = await fetch('/api/public/settings');
                if (!response.ok) throw new Error('Failed to fetch shop settings');
                const settings = await response.json();
                if (settings) {
                    shopLocation = settings.shopLocation;
                    deliveryRates = settings.deliveryRates.sort((a, b) => a.kms - b.kms);
                }
            } catch (error) {
                console.error('Error fetching shop settings:', error);
            }
        }

        function renderMenu() {
            menuItemsDisplay.innerHTML = '';
            if (menu.length === 0) {
                menuItemsDisplay.innerHTML = '<p class="text-gray-600 dark:text-gray-400 col-span-full text-center py-8">No menu items available at the moment.</p>';
                return;
            }
            menu.forEach(item => {
                if (!item.isAvailable) return;
                const itemCard = document.createElement('div');
                itemCard.className = 'bg-white dark:bg-gray-800 p-4 rounded-lg shadow-lg flex flex-col';
                itemCard.innerHTML = \`
                    <img src="\${item.imageUrl}" onerror="this.onerror=null;this.src='https://placehold.co/300x200/cccccc/333333?text=No+Image';" alt="\${item.name}" class="w-full h-40 object-cover rounded-md mb-3">
                    <h3 class="font-bold text-xl mb-1 text-gray-800 dark:text-white">\${item.name}</h3>
                    <p class="text-gray-700 dark:text-gray-300 text-sm mb-2 flex-grow">\${item.description}</p>
                    <div class="flex justify-between items-center mt-auto">
                        <span class="font-bold text-lg text-green-600">₹\${item.price.toFixed(2)}</span>
                        <button onclick="addToCart('\${item._id}')" class="bg-green-500 hover:bg-green-600 text-white text-sm py-2 px-4 rounded-lg transition duration-300 ease-in-out">Add to Cart</button>
                    </div>
                \`;
                menuItemsDisplay.appendChild(itemCard);
            });
        }

        function addToCart(productId) {
            const product = menu.find(p => p._id === productId);
            if (!product) return;

            const existingItem = cart.find(item => item.productId === productId);
            if (existingItem) {
                existingItem.quantity++;
            } else {
                cart.push({
                    productId: product._id,
                    name: product.name,
                    price: product.price,
                    quantity: 1
                });
            }
            renderCart();
        }

        function updateCartQuantity(productId, change) {
            const itemIndex = cart.findIndex(item => item.productId === productId);
            if (itemIndex > -1) {
                cart[itemIndex].quantity += change;
                if (cart[itemIndex].quantity <= 0) {
                    cart.splice(itemIndex, 1);
                }
            }
            renderCart();
        }

        function renderCart() {
            cartItemsContainer.innerHTML = '';
            let subtotal = 0;
            let totalItemsInCart = 0;

            if (cart.length === 0) {
                cartItemsContainer.innerHTML = '<p class="text-gray-600 dark:text-gray-400">Your cart is empty.</p>';
            } else {
                cart.forEach(item => {
                    subtotal += item.price * item.quantity;
                    totalItemsInCart += item.quantity;
                    const cartItemDiv = document.createElement('div');
                    cartItemDiv.className = 'cart-item text-gray-800 dark:text-gray-300';
                    cartItemDiv.innerHTML = \`
                        <span>\${item.name} (₹\${item.price.toFixed(2)}) x \${item.quantity}</span>
                        <div class="flex items-center space-x-2">
                            <button onclick="updateCartQuantity('\${item.productId}', -1)" class="bg-red-400 hover:bg-red-500 text-white text-xs py-1 px-2 rounded-md"><i class="fas fa-minus"></i></button>
                            <span class="font-semibold">₹\${(item.price * item.quantity).toFixed(2)}</span>
                            <button onclick="updateCartQuantity('\${item.productId}', 1)" class="bg-green-400 hover:bg-green-500 text-white text-xs py-1 px-2 rounded-md"><i class="fas fa-plus"></i></button>
                        </div>
                    \`;
                    cartItemsContainer.appendChild(cartItemDiv);
                });
            }
            subtotalSpan.textContent = subtotal.toFixed(2);
            cartCountSpan.textContent = totalItemsInCart;
            calculateTotal();
        }

        async function calculateDeliveryTax(customerLat, customerLon) {
            if (!customerLat || !customerLon || !shopLocation.latitude || !shopLocation.longitude) {
                currentTransportTax = 0;
                locationStatus.textContent = 'Shop location or your location is missing for tax calculation.';
                calculateTotal();
                return;
            }
            try {
                const response = await fetch('/api/calculate-delivery-cost', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        customerLocation: { latitude: customerLat, longitude: customerLon }
                    })
                });
                if (!response.ok) throw new Error('Failed to calculate delivery cost');
                const data = await response.json();
                if (data.transportTax !== undefined) {
                    currentTransportTax = data.transportTax;
                    locationStatus.textContent = \`Delivery distance: \${data.distance.toFixed(2)} km. Tax: ₹\${data.transportTax.toFixed(2)}\`;
                } else {
                    currentTransportTax = 0;
                    locationStatus.textContent = 'Could not calculate delivery tax.';
                }
            } catch (error) {
                console.error('Error calculating delivery tax:', error);
                currentTransportTax = 0;
                locationStatus.textContent = 'Error calculating delivery tax.';
            }
            calculateTotal();
        }

        function calculateTotal() {
            const subtotal = parseFloat(subtotalSpan.textContent);
            const total = subtotal + currentTransportTax;
            transportTaxSpan.textContent = currentTransportTax.toFixed(2);
            totalAmountSpan.textContent = total.toFixed(2);
        }

        getLocationBtn.addEventListener('click', () => {
            locationStatus.textContent = 'Getting your location...';
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(position => {
                    const lat = position.coords.latitude;
                    const lon = position.coords.longitude;
                    customerLatField.value = lat;
                    customerLonField.value = lon;
                    locationStatus.textContent = 'Location obtained! Calculating tax...';
                    calculateDeliveryTax(lat, lon);
                }, error => {
                    console.error('Geolocation error:', error);
                    locationStatus.textContent = 'Location access denied or error. Please allow location access to calculate transport tax.';
                    customerLatField.value = '';
                    customerLonField.value = '';
                    currentTransportTax = 0;
                    calculateTotal();
                }, { enableHighAccuracy: true, timeout: 10000, maximumAge: 0 }); // Options for better accuracy
            } else {
                locationStatus.textContent = 'Geolocation is not supported by your browser.';
                currentTransportTax = 0;
                calculateTotal();
            }
        });

        orderForm.addEventListener('submit', async (event) => {
            event.preventDefault();
            if (cart.length === 0) {
                showNotification('Your cart is empty. Please add items before placing an order.', 'error');
                return;
            }

            const customerName = document.getElementById('customerName').value;
            const customerPhone = document.getElementById('customerPhone').value;
            const deliveryAddress = document.getElementById('deliveryAddress').value;
            const customerLat = customerLatField.value ? parseFloat(customerLatField.value) : undefined;
            const customerLon = customerLonField.value ? parseFloat(customerLonField.value) : undefined;

            const orderData = {
                items: cart,
                customerName,
                customerPhone,
                deliveryAddress,
                customerLocation: (customerLat && customerLon) ? { latitude: customerLat, longitude: customerLon } : undefined,
                subtotal: parseFloat(subtotalSpan.textContent),
                transportTax: currentTransportTax,
                totalAmount: parseFloat(totalAmountSpan.textContent)
            };

            try {
                const response = await fetch('/api/order', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(orderData)
                });

                if (response.ok) {
                    const result = await response.json();
                    showNotification('Order placed successfully! We will contact you shortly.', 'success');
                    // Store order ID for tracking
                    localStorage.setItem('lastOrderId', result.orderId);
                    localStorage.setItem('lastOrderCustomerPhone', customerPhone);

                    cart = []; // Clear cart
                    renderCart();
                    orderForm.reset();
                    customerLatField.value = '';
                    customerLonField.value = '';
                    locationStatus.textContent = '';
                    currentTransportTax = 0;
                    calculateTotal();

                    // Automatically switch to tracking view
                    showAppView('view-tracking');
                    loadLastOrderForTracking();

                } else {
                    const errorData = await response.json();
                    showNotification(`Failed to place order: ${errorData.message || 'Unknown error'}`, 'error');
                }
            } catch (error) {
                console.error('Error placing order:', error);
                showNotification('An error occurred while placing your order. Please try again.', 'error');
            }
        });

        // Initial loads for public menu
        fetchMenu();
        fetchShopSettings();
        renderCart(); // Render empty cart initially


        // --- Order Tracking Specific JavaScript ---
        const trackOrderIdInput = document.getElementById('trackOrderId');
        const trackOrderBtn = document.getElementById('track-order-btn');
        const orderDetailsSection = document.getElementById('order-details-section');
        const trackingMessage = document.getElementById('tracking-message');
        const displayOrderId = document.getElementById('displayOrderId');
        const orderStatus = document.getElementById('orderStatus');
        const orderAddress = document.getElementById('orderAddress');
        const orderTotal = document.getElementById('orderTotal');
        const orderDate = document.getElementById('orderDate');
        const orderItemsList = document.getElementById('orderItemsList');
        const shopLocationDisplay = document.getElementById('shopLocationDisplay');
        const customerLocationDisplay = document.getElementById('customerLocationDisplay');
        const estimatedDeliveryTime = document.getElementById('estimatedDeliveryTime');
        const deliveryDistanceDisplay = document.getElementById('deliveryDistanceDisplay');

        // Function to get status color class (re-used from admin dashboard)
        function getStatusColorClass(status) {
            switch (status) {
                case 'Pending': return 'text-yellow-500';
                case 'Confirmed': return 'text-blue-500';
                case 'Preparing': return 'text-orange-500';
                case 'Out for Delivery': return 'text-purple-500';
                case 'Delivered': return 'text-green-500';
                case 'Cancelled': return 'text-red-500';
                default: return 'text-gray-500';
            }
        }

        async function fetchOrderDetailsForTracking(orderId) {
            orderDetailsSection.classList.add('hidden');
            trackingMessage.classList.add('hidden');
            if (!orderId) {
                trackingMessage.textContent = 'Please enter an Order ID.';
                trackingMessage.classList.remove('hidden');
                return;
            }

            try {
                const response = await fetch(`/api/order/${orderId}`);
                if (!response.ok) {
                    if (response.status === 404) {
                        trackingMessage.textContent = 'Order not found. Please check the ID.';
                    } else {
                        trackingMessage.textContent = 'Error fetching order details. Please try again.';
                    }
                    trackingMessage.classList.remove('hidden');
                    return;
                }

                const order = await response.json();
                displayOrderId.textContent = order._id.substring(0, 8);
                orderStatus.textContent = order.status;
                orderStatus.className = `font-bold text-lg ${getStatusColorClass(order.status)}`;
                orderAddress.textContent = order.deliveryAddress;
                orderTotal.textContent = order.totalAmount.toFixed(2);
                orderDate.textContent = new Date(order.orderDate).toLocaleString();

                orderItemsList.innerHTML = '';
                order.items.forEach(item => {
                    const li = document.createElement('li');
                    li.textContent = `${item.name} x ${item.quantity} (₹${item.price.toFixed(2)})`;
                    orderItemsList.appendChild(li);
                });

                // Display shop and customer locations (for map placeholder)
                shopLocationDisplay.textContent = order.deliveryFromLocation ? `Lat: ${order.deliveryFromLocation.latitude.toFixed(4)}, Lon: ${order.deliveryFromLocation.longitude.toFixed(4)}` : 'N/A';
                customerLocationDisplay.textContent = order.customerLocation ? `Lat: ${order.customerLocation.latitude.toFixed(4)}, Lon: ${order.customerLocation.longitude.toFixed(4)}` : 'N/A';

                // Simulate delivery time/distance (replace with actual logic if using map APIs)
                if (order.customerLocation && order.deliveryFromLocation) {
                    const distance = calculateHaversineDistance(
                        order.deliveryFromLocation.latitude, order.deliveryFromLocation.longitude,
                        order.customerLocation.latitude, order.customerLocation.longitude
                    );
                    deliveryDistanceDisplay.textContent = `Distance: ${distance.toFixed(2)} km`;
                    // Simple estimate: 1 km = 2 minutes, plus 5 mins prep
                    const estimatedMinutes = Math.round(distance * 2) + 5;
                    estimatedDeliveryTime.textContent = `${estimatedMinutes} mins`;
                } else {
                    deliveryDistanceDisplay.textContent = '';
                    estimatedDeliveryTime.textContent = 'N/A';
                }


                orderDetailsSection.classList.remove('hidden');

            } catch (error) {
                console.error('Error tracking order:', error);
                trackingMessage.textContent = 'An error occurred while tracking your order. Please try again.';
                trackingMessage.classList.remove('hidden');
            }
        }

        // Haversine function (re-implemented for client-side to avoid extra API call)
        function calculateHaversineDistance(lat1, lon1, lat2, lon2) {
            const R = 6371; // Radius of Earth in kilometers
            const dLat = (lat2 - lat1) * Math.PI / 180;
            const dLon = (lon2 - lon1) * Math.PI / 180;
            const a =
                Math.sin(dLat / 2) * Math.sin(dLat / 2) +
                Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
                Math.sin(dLon / 2) * Math.sin(dLon / 2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
            return R * c; // Distance in km
        }

        trackOrderBtn.addEventListener('click', () => {
            const orderId = trackOrderIdInput.value.trim();
            fetchOrderDetailsForTracking(orderId);
        });

        // Load last order if available from localStorage
        function loadLastOrderForTracking() {
            const lastOrderId = localStorage.getItem('lastOrderId');
            const lastOrderCustomerPhone = localStorage.getItem('lastOrderCustomerPhone');
            if (lastOrderId) {
                trackOrderIdInput.value = lastOrderId;
                document.getElementById('customerPhone').value = lastOrderCustomerPhone; // Pre-fill phone for convenience
                fetchOrderDetailsForTracking(lastOrderId);
            }
        }
        loadLastOrderForTracking(); // Call on page load


        // --- Global / Utility Functions ---

        // Simple Notification Function (replaces alert)
        function showNotification(message, type = 'info') {
            const notificationContainer = document.createElement('div');
            notificationContainer.className = \`fixed bottom-4 right-4 p-4 rounded-lg shadow-xl text-white z-50 transition-transform transform duration-300 ease-out \${type === 'success' ? 'bg-green-500' : type === 'error' ? 'bg-red-500' : 'bg-blue-500'}\`;
            notificationContainer.textContent = message;
            document.body.appendChild(notificationContainer);

            setTimeout(() => {
                notificationContainer.classList.add('translate-y-full');
                notificationContainer.addEventListener('transitionend', () => notificationContainer.remove());
            }, 5000); // Notification disappears after 5 seconds
        }
    </script>
</body>
</html>

